<!DOCTYPE html>
<!-- saved from url=(0059)file:///C:/Users/HenryWatson/Downloads/cage-tracker-v8.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cage Tracker ‚Äî Facility Management</title>
<link href="./Cage Tracker ‚Äî Facility Management1_files/css2" rel="stylesheet">
<script src="./Cage Tracker ‚Äî Facility Management1_files/xlsx.full.min.js.download"></script>
<style>
:root {
  --bg-deep: #f0f2f5;
  --bg-base: #ffffff;
  --bg-card: #ffffff;
  --bg-elevated: #f6f7f9;
  --bg-input: #f0f2f5;
  --border: #dfe2e8;
  --border-light: #e8eaef;
  --text-primary: #1a1f2e;
  --text-secondary: #4a5568;
  --text-muted: #8895a7;
  --accent: #c08520;
  --accent-dim: rgba(192,133,32,0.08);
  --green: #1a8a4a;
  --blue: #2563b0;
  --red: #c93030;
  --orange: #b85c1a;
  --purple: #7040c0;
  --yellow: #9a7b10;
  --font-display: 'Outfit', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 8px;
  --radius-lg: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: var(--font-display);
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background: var(--bg-base); }
::-webkit-scrollbar-thumb { background: var(--border-light); border-radius:3px; }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  background: #1a2235;
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 56px;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-shrink: 0;
}
.header-logo {
  width: 34px; height: 34px; border-radius: var(--radius);
  background: linear-gradient(135deg, var(--accent), #b8862d);
  display: flex; align-items: center; justify-content: center;
  font: 700 15px var(--font-mono); color: #1a2235;
}
.header-title { font-weight: 700; font-size: 17px; color: #fff; letter-spacing: -0.02em; }
.header-sub { font: 600 10px var(--font-mono); color: #8899aa; letter-spacing: 0.08em; }

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.layout { display: flex; flex: 1; overflow: hidden; }
.sidebar {
  width: 190px; background: var(--bg-base); border-right: 1px solid var(--border);
  padding: 14px 0; flex-shrink: 0; overflow-y: auto;
}
.sidebar-btn {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 18px; border: none; width: 100%;
  background: transparent; color: var(--text-muted);
  font: 500 13px var(--font-display); cursor: pointer;
  border-left: 3px solid transparent; transition: all 0.12s;
  text-align: left;
}
.sidebar-btn:hover { color: var(--text-secondary); background: rgba(255,255,255,0.02); }
.sidebar-btn.active {
  color: var(--accent); background: var(--accent-dim);
  border-left-color: var(--accent); font-weight: 600;
}
.sidebar-icon { font-size: 15px; width: 22px; text-align: center; }
.main { flex:1; overflow-y: auto; padding: 24px 30px; max-height: calc(100vh - 56px); }
.tab-content { display: none; animation: fadeIn 0.2s ease; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

/* ‚îÄ‚îÄ Components ‚îÄ‚îÄ */
.section-title { font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; letter-spacing: -0.02em; }
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.card-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 12px; }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 12px;
  font: 600 11px var(--font-mono); letter-spacing: 0.02em;
}
.badge-accent { color: var(--accent); background: #f5e6c8; border: 1px solid #e0c880; }
.badge-green { color: var(--green); background: #e6f5ec; border: 1px solid #b0dcc0; }
.badge-blue { color: var(--blue); background: #e6f0fa; border: 1px solid #a0c8e8; }
.badge-red { color: var(--red); background: #fce8e8; border: 1px solid #e8b0b0; }
.badge-orange { color: var(--orange); background: #fef0e6; border: 1px solid #e8c8a0; }
.badge-purple { color: var(--purple); background: #f0e8fa; border: 1px solid #c8b0e8; }
.badge-yellow { color: var(--yellow); background: #fdf5dc; border: 1px solid #e0d8a0; }

.stat-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.stat-card { background: var(--bg-card); border:1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; text-align: center; flex: 1; min-width: 120px; }
.stat-val { font: 700 26px var(--font-mono); }
.stat-lbl { font-size: 11px; color: var(--text-muted); font-weight: 600; margin-top: 4px; }

.btn {
  border: none; border-radius: 6px; padding: 8px 16px; font: 600 13px var(--font-display);
  cursor: pointer; transition: all 0.12s; display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: linear-gradient(135deg, #e8a830, #c08520); color: #fff; }
.btn-primary:hover { filter: brightness(1.1); }
.btn-secondary { background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--border-light); color: var(--text-primary); }
.btn-danger { background: var(--bg-elevated); color: var(--red); border: 1px solid rgba(224,85,85,0.2); }
.btn-sm { padding: 4px 10px; font-size: 11px; }
.btn-xs { padding: 3px 8px; font-size: 10px; }
.btn-block { width: 100%; justify-content: center; }

input, select, textarea {
  background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
  padding: 8px 12px; color: var(--text-primary); font: 400 13px var(--font-display);
  width: 100%; transition: border-color 0.12s;
}
input:focus, select:focus { outline: none; border-color: var(--accent); }
label {
  display: block; font: 600 10px var(--font-mono); color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;
}
.form-grid { display: grid; gap: 12px; }
.form-grid-3 { grid-template-columns: repeat(3, 1fr); }
.form-grid-2 { grid-template-columns: repeat(2, 1fr); }
.form-actions { display: flex; gap: 8px; margin-top: 12px; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }
th {
  text-align: left; padding: 8px 10px; font: 600 10px var(--font-mono);
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em;
  border-bottom: 2px solid var(--border); background: var(--bg-elevated);
}
td { padding: 10px; border-bottom: 1px solid var(--border); }
tr:hover td { background: #f8f9fb; }

.filter-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.filter-btn {
  padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--bg-elevated); color: var(--text-muted); cursor: pointer;
  font: 500 12px var(--font-display); transition: all 0.12s;
}
.filter-btn.active { background: #f5e6c8; color: var(--accent); border-color: #e0c880; font-weight:600; }

.flex-between { display: flex; justify-content: space-between; align-items: center; }

/* ‚îÄ‚îÄ RMD Grid ‚îÄ‚îÄ */
.rmd-grid { display: flex; flex-direction: column; gap: 14px; }
.rmd-spatial-row { display: flex; gap: 10px; align-items: flex-start; }
.rmd-spatial-spacer { width: 60px; flex-shrink: 0; }
.rmd-spatial-label { font: 600 9px var(--font-mono); color: var(--text-muted); text-align: center; margin-bottom: 2px; text-transform: uppercase; }

/* Spatial layout for site-matching RMD view */
.rmd-site-layout { display: flex; flex-direction: column; gap: 18px; }
.rmd-site-row { display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; }
.rmd-site-row.row-top { justify-content: flex-start; }
.rmd-site-row.row-mid { justify-content: flex-start; padding-left: 0; }
.rmd-site-row.row-bot { justify-content: flex-start; }
.rmd-site-card { min-width: 180px; flex: 0 0 auto; }
.rmd-site-card .card { margin-bottom: 0; padding: 12px; }

/* Mini spatial for dashboard */
.rmd-site-mini { display: flex; flex-direction: column; gap: 10px; }
.rmd-site-mini-row { display: flex; gap: 6px; align-items: flex-start; flex-wrap: wrap; }

/* Planner sidebar compact spatial */
.planner-rmd-spatial { display: flex; flex-direction: column; gap: 8px; }
.planner-rmd-row { display: flex; gap: 4px; flex-wrap: wrap; }
.rmd-slot {
  display: flex; align-items: center; gap: 8px; background: var(--bg-input);
  border-radius: 6px; padding: 6px 10px; border: 1px solid var(--border); margin-bottom: 4px;
}
.rmd-slot-label { font: 600 10px var(--font-mono); color: var(--text-muted); width: 52px; flex-shrink:0; }
.rmd-slot-content { flex: 1; display: flex; justify-content: space-between; align-items: center; }
.rmd-slot select { font-size: 11px; padding: 4px 8px; }
.rmd-cage-info { font-size: 12px; }
.rmd-cage-name { font-weight: 600; color: var(--text-primary); }
.rmd-cage-detail { color: var(--text-muted); margin-left: 6px; }
.remove-btn { background:none; border:none; color:var(--red); cursor:pointer; font-size:15px; padding:0 4px; }

/* ‚îÄ‚îÄ Frame Cards ‚îÄ‚îÄ */
.frame-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 10px; }
.frame-card { padding: 13px; }
.frame-card.shipping-ready { border-color: #c0a050; background: #fdfaf0; }
.frame-name { font: 700 15px var(--font-mono); color: var(--text-primary); }
.frame-meta { font-size: 11px; color: var(--text-muted); margin: 4px 0 8px; }
.frame-cage-item {
  display: flex; justify-content: space-between; align-items: center;
  background: var(--bg-input); border-radius: 4px; padding: 4px 8px; margin-bottom: 4px; font-size: 12px;
}
.frame-actions { display: flex; flex-direction: column; gap: 5px; margin-top: 8px; }
.frame-actions select, .frame-actions .btn { font-size: 11px; }

/* ‚îÄ‚îÄ Week View ‚îÄ‚îÄ */
.week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.week-label { font: 600 14px var(--font-mono); color: var(--accent); }
.week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
.week-day {
  background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 8px; min-height: 110px;
}
.week-day.today { background: #fdf8ee; border-color: #e0c880; }
.week-day.weekend { opacity: 0.45; }
.week-day.weekend.has-moves { opacity: 1; }
.week-day-hdr { font: 700 10px var(--font-mono); color: var(--text-muted); margin-bottom: 4px; }
.week-day.today .week-day-hdr { color: var(--accent); }
.week-move-count { font: 600 10px var(--font-display); margin-bottom: 4px; }
.week-move-item {
  font-size: 10px; padding: 3px 5px; margin-bottom: 2px; border-radius: 4px;
  background: var(--bg-elevated); color: var(--text-secondary); cursor: default;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.week-move-item.completed { background: #e6f5ec; color: var(--green); text-decoration: line-through; }
.over-limit { color: var(--red) !important; }

/* ‚îÄ‚îÄ Shipping ‚îÄ‚îÄ */
.ship-frame-select {
  display: inline-flex; padding: 8px 12px; border-radius: 6px;
  background: var(--bg-input); border: 1px solid var(--border); cursor: pointer;
  margin: 0 6px 6px 0; transition: all 0.1s;
}
.ship-frame-select.selected { border: 2px solid var(--accent); background: var(--accent-dim); }
.ship-frame-name { font: 700 13px var(--font-mono); }
.ship-frame-cage { font-size: 11px; color: var(--text-muted); }

.shipment-row { padding: 12px 0; border-bottom: 1px solid var(--border); }
.shipment-row:last-child { border:none; }

/* ‚îÄ‚îÄ Report ‚îÄ‚îÄ */
.report-day-header {
  font: 700 13px var(--font-mono); color: var(--accent);
  padding: 8px 0; border-bottom: 1px solid var(--border); margin-bottom: 4px;
}
.report-move-row { display: flex; gap: 12px; padding: 7px 0; border-bottom: 1px solid rgba(30,42,58,0.5); font-size: 12px; align-items: center; }
.report-move-num { font: 400 12px var(--font-mono); color: var(--text-muted); width: 24px; }
.report-move-desc { flex:1; font-weight: 600; color: var(--text-primary); }
.report-move-type { color: var(--text-muted); }
.report-summary-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.report-summary-cell { background: var(--bg-input); border-radius: 6px; padding: 8px; text-align: center; }
.report-summary-val { font: 700 16px var(--font-mono); }
.report-summary-lbl { font-size: 10px; color: var(--text-muted); }

.empty-msg { color: var(--text-muted); font-size: 13px; font-style: italic; padding: 10px 0; }

/* ‚îÄ‚îÄ Inline cell editing ‚îÄ‚îÄ */
.editable-cell {
  cursor: pointer;
  border-radius: 4px;
  padding: 2px 4px;
  margin: -2px -4px;
  transition: background 0.1s;
  display: inline-block;
}
.editable-cell:hover {
  background: var(--accent-dim);
  outline: 1px dashed var(--accent);
}
.editable-cell::after {
  content: ' ‚úé';
  font-size: 9px;
  color: var(--accent);
  opacity: 0;
  transition: opacity 0.1s;
}
.editable-cell:hover::after { opacity: 1; }
.inline-edit-input {
  background: var(--bg-base) !important;
  border: 2px solid var(--accent) !important;
  border-radius: 4px;
  padding: 2px 6px !important;
  font-size: 12px;
  width: auto;
  min-width: 60px;
}

/* ‚îÄ‚îÄ Boat Planner ‚îÄ‚îÄ */
.bp-cage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; margin-bottom: 16px; }
.bp-cage-card {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  border: 2px solid var(--border); border-radius: 8px; background: var(--bg-elevated);
  cursor: pointer; transition: all 0.12s; user-select: none;
}
.bp-cage-card:hover { border-color: var(--accent); background: var(--accent-dim); }
.bp-cage-card.selected { border-color: var(--accent); background: var(--accent-dim); }
.bp-cage-card.selected .bp-check { background: var(--accent); border-color: var(--accent); color: #fff; }
.bp-check { width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;transition:all 0.1s; }
.bp-cage-info { flex:1; min-width:0; }
.bp-cage-name { font:700 13px var(--font-mono);color:var(--text-primary); }
.bp-cage-meta { font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.bp-movement-list { list-style:none; counter-reset: move-counter; }
.bp-movement-list li { counter-increment: move-counter; display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px; }
.bp-movement-list li:last-child { border:none; }
.bp-movement-list li::before { content: counter(move-counter); display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--accent-dim);color:var(--accent);font:700 11px var(--font-mono);flex-shrink:0;margin-top:1px; }
.bp-movement-desc { flex:1; }
.bp-movement-type { font-weight:600;color:var(--accent); }
.bp-warning { background:#fef0e6;border:1px solid #e8c8a0;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--orange);margin-bottom:8px; }

/* ‚îÄ‚îÄ RMD Dashboard mini ‚îÄ‚îÄ */
.rmd-mini-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.rmd-mini {
  background: var(--bg-input); border-radius: 6px; padding: 8px; text-align: center;
  border: 1px solid var(--border); cursor: pointer; transition: all 0.1s;
}
.rmd-mini:hover { border-color: var(--border-light); }
.rmd-mini-name { font: 600 11px var(--font-mono); color: var(--text-muted); }
.rmd-mini-count { font: 700 16px var(--font-mono); }
.rmd-mini-count.empty { color: #d0d0d0; }

/* ‚îÄ‚îÄ Planner side panels ‚îÄ‚îÄ */
.planner-layout { display: grid; grid-template-columns: 1fr 340px; gap: 16px; }
.planner-sidebar { max-height: calc(100vh - 140px); overflow-y: auto; }
.planner-sidebar .card { padding: 12px; margin-bottom: 8px; }
.planner-mini-title { font: 700 12px var(--font-mono); color: var(--accent); margin-bottom: 6px; }
.planner-mini-slot {
  display: flex; justify-content: space-between; align-items: center;
  padding: 3px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px;
  background: var(--bg-elevated); border: 1px solid var(--border);
}
.planner-mini-slot .cage-name { font-weight: 600; }
.planner-mini-slot .cage-meta { color: var(--text-muted); font-size: 10px; }
.planner-frame-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 3px;
  background: var(--bg-elevated); border: 1px solid var(--border);
}

/* ‚îÄ‚îÄ Overview / Presentation tab ‚îÄ‚îÄ */
.overview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
.overview-rmd-row {
  display: grid; grid-template-columns: 72px 1fr 1fr; gap: 8px; align-items: start;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.overview-rmd-label { font: 700 14px var(--font-mono); color: var(--accent); padding-top: 4px; }
.overview-side-box {
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px;
  padding: 6px 10px; min-height: 36px;
}
.overview-side-label { font: 600 9px var(--font-mono); color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
.overview-cage-chip {
  display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px;
  font-weight: 600; margin: 1px 2px; border: 1px solid;
}
.overview-cage-chip.short { background: #e6f5ec; color: var(--green); border-color: #b0dcc0; }
.overview-cage-chip.medium { background: #fdf5dc; color: var(--yellow); border-color: #e0d8a0; }
.overview-cage-chip.tall { background: #fce8e8; color: var(--red); border-color: #e8b0b0; }
.overview-frame-card {
  display: flex; align-items: center; gap: 10px; padding: 8px 12px;
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px;
}
.overview-frame-card.has-cage { background: #e6f0fa; border-color: #a0c8e8; }
.overview-frame-card.shipping { background: #fdf8ee; border-color: #e0c880; }
.overview-frame-name { font: 700 13px var(--font-mono); width: 50px; }
.overview-frame-info { flex:1; font-size: 12px; }
.overview-frame-badges { display: flex; gap: 4px; flex-wrap: wrap; }

@media (max-width: 1100px) {
  .planner-layout { grid-template-columns: 1fr; }
  .overview-grid { grid-template-columns: 1fr; }
}

@media (max-width: 900px) {
  .sidebar { width: 52px; }
  .sidebar-btn span:not(.sidebar-icon) { display: none; }
  .sidebar-btn { padding: 9px 14px; justify-content: center; }
  .main { padding: 16px; }
  .form-grid-3 { grid-template-columns: 1fr 1fr; }
  .week-grid { grid-template-columns: repeat(4, 1fr); }
  .rmd-grid { grid-template-columns: 1fr; }
  .frame-grid { grid-template-columns: 1fr 1fr; }
  .stat-row { gap: 6px; }
  .stat-card { min-width: 90px; padding: 10px; }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-logo">CT</div>
  <div>
    <div class="header-title">Cage Tracker</div>
    <div class="header-sub">FACILITY MANAGEMENT SYSTEM</div>
  </div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <button class="sidebar-btn active" onclick="switchTab(&#39;dashboard&#39;)">
      <span class="sidebar-icon">‚óâ</span><span>Dashboard</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;cages&#39;)">
      <span class="sidebar-icon">‚òê</span><span>Cages</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;frames&#39;)">
      <span class="sidebar-icon">‚äû</span><span>Frames</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;rmd&#39;)">
      <span class="sidebar-icon">‚ñ¶</span><span>RMD Storage</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;planner&#39;)">
      <span class="sidebar-icon">‚áÑ</span><span>Planner</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;boatplan&#39;)">
      <span class="sidebar-icon">üö¢</span><span>Boat Planner</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;shipping&#39;)">
      <span class="sidebar-icon">‚õ¥</span><span>Shipping</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;report&#39;)">
      <span class="sidebar-icon">‚éô</span><span>Report</span>
    </button>
  </nav>
  <main class="main" id="main-content">
    <div class="tab-content active" id="tab-dashboard">
      
    <h2 class="section-title">Dashboard Overview</h2>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)">270</div><div class="stat-lbl">Total Cages</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">228</div><div class="stat-lbl">In Facility</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--green)">35</div><div class="stat-lbl">In RMD</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">7</div><div class="stat-lbl">In Frames</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--red)">6</div><div class="stat-lbl">Ready to Ship</div></div>
    </div>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)">13</div><div class="stat-lbl">Frames at Facility</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">0</div><div class="stat-lbl">Frames on Boat</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--purple)">37</div><div class="stat-lbl">Frames w/ Client</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">0</div><div class="stat-lbl">Today's Moves</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--yellow)">0</div><div class="stat-lbl">Pending Plans</div></div>
    </div>
    <div class="card" style="margin-bottom:14px;border-color:var(--red)">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">
        üì¶ Next Due for Delivery
        <span style="background:var(--red);color:#fff;font:700 10px var(--font-mono);padding:2px 7px;border-radius:10px;margin-left:8px">1 OVERDUE</span>
        <span style="background:var(--orange);color:#fff;font:700 10px var(--font-mono);padding:2px 7px;border-radius:10px;margin-left:8px">3 URGENT</span>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="switchTab(&#39;boatplan&#39;)">Boat Planner ‚Üí</button>
    </div>
    <div style="display:flex;gap:6px;font:600 9px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0 12px;margin-bottom:6px">
      <span style="min-width:110px">Cage</span><span style="flex:1">Dimensions ¬∑ Weight</span>
      <span style="min-width:80px">Location</span><span style="min-width:100px">Prop. Ship Day</span>
      <span style="min-width:90px">Leaves Facility</span><span style="min-width:90px;text-align:right">Due In</span>
    </div>
    <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(90deg,rgba(201,48,48,0.12) 0%,rgba(201,48,48,0.04) 100%);border-left:3px solid var(--red);border-radius:0 6px 6px 0;margin-bottom:4px">
      <div style="min-width:110px"><span style="font:700 13px var(--font-mono);color:var(--text-primary)">281</span></div>
      <div style="flex:1;font-size:11px;color:var(--text-muted)">1.85m √ó 4.9m √ó 10m ¬∑ 15.16t</div>
      <div style="min-width:80px"><span class="badge badge-blue" style="font-size:9px">In Facility</span></div>
      <div style="min-width:100px"></div>
      <div style="font:600 11px var(--font-mono);color:var(--text-secondary);min-width:90px">Fri 20 Feb</div>
      <div style="min-width:90px;text-align:right"><span style="background:#c93030;color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">OVERDUE</span></div>
    </div><div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(90deg,rgba(154,123,16,0.10) 0%,rgba(154,123,16,0.04) 100%);border-left:3px solid var(--yellow);border-radius:0 6px 6px 0;margin-bottom:4px">
      <div style="min-width:110px"><span style="font:700 13px var(--font-mono);color:var(--text-primary)">392</span></div>
      <div style="flex:1;font-size:11px;color:var(--text-muted)">1.1m √ó 6.9m √ó 4.5m ¬∑ 4.52t</div>
      <div style="min-width:80px"><span class="badge badge-blue" style="font-size:9px">In Facility</span></div>
      <div style="min-width:100px"></div>
      <div style="font:600 11px var(--font-mono);color:var(--text-secondary);min-width:90px">Mon 23 Feb</div>
      <div style="min-width:90px;text-align:right"><span style="background:var(--yellow);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">2d</span></div>
    </div><div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(90deg,rgba(154,123,16,0.10) 0%,rgba(154,123,16,0.04) 100%);border-left:3px solid var(--yellow);border-radius:0 6px 6px 0;margin-bottom:4px">
      <div style="min-width:110px"><span style="font:700 13px var(--font-mono);color:var(--text-primary)">478</span></div>
      <div style="flex:1;font-size:11px;color:var(--text-muted)">1.38m √ó 4m √ó 11.5m ¬∑ 9.99t</div>
      <div style="min-width:80px"><span class="badge badge-blue" style="font-size:9px">In Facility</span></div>
      <div style="min-width:100px"></div>
      <div style="font:600 11px var(--font-mono);color:var(--text-secondary);min-width:90px">Mon 23 Feb</div>
      <div style="min-width:90px;text-align:right"><span style="background:var(--yellow);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">2d</span></div>
    </div><div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(90deg,rgba(154,123,16,0.10) 0%,rgba(154,123,16,0.04) 100%);border-left:3px solid var(--yellow);border-radius:0 6px 6px 0;margin-bottom:4px">
      <div style="min-width:110px"><span style="font:700 13px var(--font-mono);color:var(--text-primary)">424</span></div>
      <div style="flex:1;font-size:11px;color:var(--text-muted)">0.98m √ó 3.1m √ó 10.3m ¬∑ 4.5t</div>
      <div style="min-width:80px"><span class="badge badge-blue" style="font-size:9px">In Facility</span></div>
      <div style="min-width:100px"></div>
      <div style="font:600 11px var(--font-mono);color:var(--text-secondary);min-width:90px">Mon 23 Feb</div>
      <div style="min-width:90px;text-align:right"><span style="background:var(--yellow);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">2d</span></div>
    </div>
  </div>
    <div class="card" style="margin-bottom:14px">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">Frames at Facility (13)</div>
      <button class="btn btn-secondary btn-sm" onclick="switchTab(&#39;frames&#39;)">Manage Frames ‚Üí</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
      <div class="card" style="padding:10px;border-color:#c0a050;background:#fdfaf0">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-7</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--accent)">‚úì SHIP READY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">474</span>
            <span style="color:var(--text-muted)">Tall</span>
          </div>
    </div><div class="card" style="padding:10px;">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-13</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--text-muted)">EMPTY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>
    </div><div class="card" style="padding:10px;border-color:#c0a050;background:#fdfaf0">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-19</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--accent)">‚úì SHIP READY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">2.5m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">320</span>
            <span style="color:var(--text-muted)">Tall</span>
          </div>
    </div><div class="card" style="padding:10px;">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-25</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--text-muted)">EMPTY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>
    </div><div class="card" style="padding:10px;">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-28</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--text-muted)">EMPTY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.5m frame</div>
      <div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>
    </div><div class="card" style="padding:10px;">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-30</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--text-muted)">EMPTY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>
    </div><div class="card" style="padding:10px;border-color:#c0a050;background:#fdfaf0">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-33</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--accent)">‚úì SHIP READY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">481</span>
            <span style="color:var(--text-muted)">Tall</span>
          </div>
    </div><div class="card" style="padding:10px;border-color:#b0dcc0;background:#f0faf4">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-38</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--green)">1 CAGE</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">2.5m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">426</span>
            <span style="color:var(--text-muted)">Medium</span>
          </div>
    </div><div class="card" style="padding:10px;">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-39</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--text-muted)">EMPTY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>
    </div><div class="card" style="padding:10px;border-color:#c0a050;background:#fdfaf0">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-41</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--accent)">‚úì SHIP READY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.5m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">431</span>
            <span style="color:var(--text-muted)">Tall</span>
          </div>
    </div><div class="card" style="padding:10px;border-color:#c0a050;background:#fdfaf0">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-43</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--accent)">‚úì SHIP READY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">613</span>
            <span style="color:var(--text-muted)">Tall</span>
          </div>
    </div><div class="card" style="padding:10px;">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-45</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--text-muted)">EMPTY</span>
          
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">2.5m frame</div>
      <div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>
    </div><div class="card" style="padding:10px;border-color:#c0a050;background:#fdfaf0">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">TF-49</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:var(--accent)">‚úì SHIP READY</span>
          <span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">1.1m frame</div>
      <div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">418</span>
            <span style="color:var(--text-muted)">Tall</span>
          </div>
    </div>
    </div>
  </div>
    <div style="display:grid;grid-template-columns:1fr;gap:14px">
      <div class="card" style="overflow-x:auto">
        <div class="card-title">RMD Storage ‚Äî Live View <span style="font-size:11px;font-weight:400;color:var(--text-muted)">(click any bay to manage)</span></div>
        <div class="rmd-site-layout" style="min-width:700px"><div class="rmd-site-row row-top"><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-12</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">398</span><span class="rmd-cage-detail">6.325m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">919</span><span class="rmd-cage-detail">4.7m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">957</span><span class="rmd-cage-detail">4.8m Tall</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-11</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">599</span><span class="rmd-cage-detail">3.5m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">437</span><span class="rmd-cage-detail">6m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">961</span><span class="rmd-cage-detail">4.9m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-10</span>
            <span style="font-size:10px;color:var(--text-muted)">1/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">415</span><span class="rmd-cage-detail">4.9m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-9</span>
            <span style="font-size:10px;color:var(--text-muted)">2/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">401</span><span class="rmd-cage-detail">5.5m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">383</span><span class="rmd-cage-detail">5.8m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>
        </div>
      </div></div><div class="rmd-site-row row-mid"><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-8</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">433</span><span class="rmd-cage-detail">5.96m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">901</span><span class="rmd-cage-detail">4.6m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">587</span><span class="rmd-cage-detail">3.5m Medium</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-7</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">389</span><span class="rmd-cage-detail">7m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">410</span><span class="rmd-cage-detail">4.49m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">589</span><span class="rmd-cage-detail">3.5m Medium</span></span>
        </div>
      </div>
        </div>
      </div></div><div class="rmd-site-row row-bot"><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-6</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">962</span><span class="rmd-cage-detail">4.8m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">368</span><span class="rmd-cage-detail">3.1m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">910</span><span class="rmd-cage-detail">3.095m Medium</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-5</span>
            <span style="font-size:10px;color:var(--text-muted)">4/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">956</span><span class="rmd-cage-detail">4.85m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">955</span><span class="rmd-cage-detail">4.785m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">597</span><span class="rmd-cage-detail">3.2m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">591</span><span class="rmd-cage-detail">3.2m Medium</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-4</span>
            <span style="font-size:10px;color:var(--text-muted)">4/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">417</span><span class="rmd-cage-detail">7m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">416</span><span class="rmd-cage-detail">7m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">950</span><span class="rmd-cage-detail">4.8m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">595</span><span class="rmd-cage-detail">3.2m Medium</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-3</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">445</span><span class="rmd-cage-detail">4.1m Medium</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">479</span><span class="rmd-cage-detail">4.1m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">440</span><span class="rmd-cage-detail">3.9m Medium</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-2</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">407</span><span class="rmd-cage-detail">5.8m Tall</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">951</span><span class="rmd-cage-detail">4.7m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">500</span><span class="rmd-cage-detail">3.4m Medium</span></span>
        </div>
      </div>
        </div>
      </div><div class="rmd-site-card" onclick="switchTab(&#39;rmd&#39;)" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-1</span>
            <span style="font-size:10px;color:var(--text-muted)">3/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">A Out</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">916</span><span class="rmd-cage-detail">3m Medium</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">A In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">406</span><span class="rmd-cage-detail">4.1m Medium</span></span>
        </div>
      </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          <div class="rmd-slot">
        <span class="rmd-slot-label">B In</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">454</span><span class="rmd-cage-detail">6.5m Tall</span></span>
        </div>
      </div><div class="rmd-slot">
        <span class="rmd-slot-label">B Out</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>
        </div>
      </div></div></div>
      </div>
      <div class="card">
        <div class="card-title">Today's Planned Movements</div>
        <div class="empty-msg">No movements planned for today</div>
      </div>
    </div>
  
    </div>
  </main>
</div>
<input type="file" id="excel-import" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcelImport(this)">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODEL & CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FRAME_COUNT = 50;
const FRAME_WIDTHS = [1.1, 1.5, 2.3, 2.5];
const RMD_COUNT = 12;
const SIDES = ['A','B'];
const MAX_MOVES = 4;
const H_SHORT = 2.7, H_MED = 4.7;
const DOUBLE_SPARE = 0.3, DOUBLE_WT = 14;

const TABS = [
  {id:'dashboard', label:'Dashboard', icon:'‚óâ'},
  {id:'cages', label:'Cages', icon:'‚òê'},
  {id:'frames', label:'Frames', icon:'‚äû'},
  {id:'rmd', label:'RMD Storage', icon:'‚ñ¶'},
  {id:'planner', label:'Planner', icon:'‚áÑ'},
  {id:'boatplan', label:'Boat Planner', icon:'üö¢'},
  {id:'shipping', label:'Shipping', icon:'‚õ¥'},
  {id:'report', label:'Report', icon:'‚éô'},
];

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function hCat(h) { return h < H_SHORT ? 'Short' : h <= H_MED ? 'Medium' : 'Tall'; }
function hBadge(h) { const c = hCat(h); return c === 'Short' ? 'green' : c === 'Medium' ? 'yellow' : 'red'; }
function locBadge(l) { return {facility:'blue', rmd:'green', frame:'orange', shipped:'purple'}[l] || 'accent'; }
function locLabel(c) {
  if (c.location === 'facility') return 'In Facility';
  if (c.location === 'rmd') return 'RMD ' + (c.locationDetail||'');
  if (c.location === 'frame') return 'Frame ' + (c.locationDetail||'');
  if (c.location === 'shipped') return 'Shipped';
  return c.location;
}
function canPairRMD(c1,c2) {
  const a=hCat(c1.height), b=hCat(c2.height);
  return ['Short-Tall','Tall-Short','Medium-Medium','Short-Medium','Medium-Short'].includes(a+'-'+b);
}
function canFitTwo(c1,c2,fw) {
  return c1.width+c2.width+DOUBLE_SPARE<=fw && c1.weight<=DOUBLE_WT && c2.weight<=DOUBLE_WT;
}
function needsWaler(cage) { return cage && cage.length < 6.5; }

// RMD spatial layout matching site: top=[12,11,10,gap,9] mid=[8,7] bot=[6,5,4,3,gap,2,1]
const RMD_LAYOUT = [
  {row:'top', items:[12,11,10,9]},
  {row:'mid', items:[8,7]},
  {row:'bot', items:[6,5,4,3,2,1]},
];
function getRMDByNum(n) { return STATE.rmdSlots.find(r=>r.number===n); }
function toISO(d) { return new Date(d).toISOString().split('T')[0]; }
function todayStr() { return toISO(new Date()); }
function fmt(d) { if(!d) return ''; return new Date(d+'T12:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}); }
function fmtShort(d) { if(!d) return ''; const dt=new Date(d+'T12:00:00'); return dt.toLocaleDateString('en-GB',{weekday:'short'})+' '+dt.getDate(); }
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

const PRELOAD_STATE = {"cages":[{"id":"19c76b4946ei9fmfw","name":"320","height":5.35,"width":1.84,"length":8.5,"weight":18.83,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4946fw9hcxa","name":"415","height":4.9,"width":1.5,"length":6.45,"weight":6.4,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4946fcrxl9j","name":"416","height":7.0,"width":0.85,"length":4.2,"weight":5.86,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49470okyutr","name":"445","height":4.1,"width":1.35,"length":11.45,"weight":11.3,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494701p7nuh","name":"433","height":5.96,"width":1.35,"length":7.1,"weight":8.3,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-08A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49471abpxbw","name":"589","height":3.5,"width":0.35,"length":5.1,"weight":1.11,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494713v1kk5","name":"454","height":6.5,"width":0.95,"length":9.4,"weight":9.22,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-01B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49472pf9hgm","name":"591","height":3.2,"width":0.66,"length":10.2,"weight":3.08,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49472ense8a","name":"597","height":3.2,"width":0.7,"length":10.0,"weight":3.13,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49473ixap4y","name":"914","height":0,"width":0,"length":0,"weight":1.66,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49473khk1l2","name":"915","height":0,"width":0,"length":0,"weight":0.84,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49474ps17zl","name":"917","height":0,"width":0,"length":0,"weight":1.53,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49474kod0zj","name":"918","height":0,"width":0,"length":0,"weight":0.81,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49475gh3x47","name":"911","height":3.05,"width":0.7,"length":5.95,"weight":2.79,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494752xbxyr","name":"410","height":4.49,"width":1.71,"length":6.03,"weight":4.91,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-07B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49476z7wc8o","name":"910","height":3.095,"width":0.74,"length":5.95,"weight":2.89,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-06B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49476lfbc8d","name":"955","height":4.785,"width":0.36,"length":4.5,"weight":2.16,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494773mvbs6","name":"957","height":4.8,"width":0.45,"length":6.4,"weight":2.96,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-12B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49477sk6twf","name":"407","height":5.8,"width":1.0,"length":9.6,"weight":6.49,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-02A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494783i24wf","name":"956","height":4.85,"width":0.36,"length":4.3,"weight":1.7,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49479yaw0d2","name":"950","height":4.8,"width":1.7,"length":11.0,"weight":15.07,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49479jnq6p1","name":"431","height":6.3,"width":1.4,"length":11.0,"weight":19.49,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-10A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947arldwi3","name":"406","height":4.1,"width":1.5,"length":5.9,"weight":5.04,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-01A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947aelzyy6","name":"398","height":6.325,"width":0.38,"length":8.46,"weight":6.43,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-12A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947bl05qd6","name":"901","height":4.6,"width":1.74,"length":10.8,"weight":19.62,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-08B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947b5av12x","name":"368","height":3.1,"width":0.88,"length":8.3,"weight":3.51,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-06B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947c9bxhvh","name":"919","height":4.7,"width":0.68,"length":5.95,"weight":4.58,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-12B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947c4ubj57","name":"389","height":7.0,"width":0.38,"length":9.6,"weight":15.15,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-07A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947dik2kvy","name":"595","height":3.2,"width":0.65,"length":6.0,"weight":1.78,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947eomqqa2","name":"500","height":3.4,"width":0.4,"length":5.1,"weight":0.97,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-02B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947evqyjps","name":"916","height":3.0,"width":0.75,"length":6.4,"weight":3.51,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-01A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947f2mn8q2","name":"587","height":3.5,"width":0.36,"length":5.3,"weight":1.15,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-08B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947fzfoumf","name":"599","height":3.5,"width":0.35,"length":6.2,"weight":1.16,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-11A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49480dsffuq","name":"961","height":4.9,"width":0.4,"length":7.0,"weight":3.45,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-11B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49480n7jj8d","name":"383","height":5.8,"width":1.06,"length":5.3,"weight":4.38,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-09B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494812ytp1g","name":"437","height":6.0,"width":1.4,"length":7.1,"weight":6.27,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-11A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49481ju2zpj","name":"951","height":4.7,"width":1.7,"length":11.0,"weight":18.07,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-02B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49482a27le4","name":"401","height":5.5,"width":0.68,"length":6.8,"weight":4.54,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-09A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948357ve62","name":"417","height":7.0,"width":0.85,"length":4.0,"weight":5.07,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49483oc4mr3","name":"440","height":3.9,"width":1.35,"length":11.5,"weight":11.36,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-03A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49484p0s5o3","name":"962","height":4.8,"width":1.7,"length":10.0,"weight":17.93,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-06A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49484jid8cu","name":"479","height":4.1,"width":1.4,"length":11.5,"weight":10.13,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-03B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49485whx2pe","name":"334","height":5.4,"width":0.84,"length":4.15,"weight":3.89,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49485kjycqu","name":"392","height":6.9,"width":1.1,"length":4.5,"weight":4.52,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494865qaq29","name":"418","height":6.0,"width":0.85,"length":4.0,"weight":7.03,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494862a4slt","name":"426","height":3.8,"width":0.95,"length":9.3,"weight":5.39,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49487k7woqz","name":"612","height":6.3,"width":0.35,"length":9.6,"weight":8.79,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49487i3dd1l","name":"639","height":6.6,"width":0.35,"length":9.6,"weight":7.77,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49488z7ody3","name":"474","height":6.9,"width":1.0,"length":7.4,"weight":6.68,"notes":"Imported from Excel","location":"frame","locationDetail":"TF-38","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494884kzx2r","name":"481","height":5.8,"width":0.95,"length":6.9,"weight":5.39,"notes":"Imported from Excel","location":"frame","locationDetail":"TF-33","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49489gzju80","name":"478","height":4.0,"width":1.38,"length":11.5,"weight":9.99,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948aoqdkmv","name":"281","height":4.9,"width":1.85,"length":10.0,"weight":15.16,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948aisoyfj","name":"424","height":3.1,"width":0.98,"length":10.3,"weight":4.5,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948bw6vxji","name":"429","height":3.1,"width":0.95,"length":4.4,"weight":2.32,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948b8e5aev","name":"439","height":5.9,"width":1.35,"length":5.4,"weight":12.8,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948crio165","name":"470","height":3.7,"width":0.96,"length":5.7,"weight":3.27,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948cfvk782","name":"604","height":6.6,"width":0.35,"length":9.6,"weight":9.06,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948d2f8htb","name":"613","height":5.0,"width":0.35,"length":9.6,"weight":7.73,"notes":"Imported from Excel","location":"frame","locationDetail":"TF-43","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948e2qul4b","name":"619","height":6.6,"width":0.35,"length":9.3,"weight":9.53,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948eyaq7is","name":"633","height":6.3,"width":0.35,"length":9.6,"weight":8.92,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948f3tv8f2","name":"921","height":0,"width":0,"length":0,"weight":2.88,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948fwj4iyx","name":"972","height":0,"width":0,"length":0,"weight":2.93,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49490tkql55","name":"483","height":0,"width":0,"length":0,"weight":12.8,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494900hubx3","name":"432","height":3.7,"width":0.95,"length":5.9,"weight":3.6,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49491tu82ia","name":"624","height":6.6,"width":0.35,"length":9.6,"weight":9.06,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49491jw6k7a","name":"632","height":4.96,"width":0.35,"length":9.6,"weight":7.29,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49492le77ab","name":"920","height":0,"width":0,"length":0,"weight":3.36,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494933gj2bt","name":"472","height":0,"width":0,"length":0,"weight":3.42,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49493u2uljp","name":"966","height":0,"width":0,"length":0,"weight":19.02,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49494wfb8xm","name":"968","height":0,"width":0,"length":0,"weight":17.18,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494940l7ki8","name":"971","height":0,"width":0,"length":0,"weight":7.96,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494955ta20o","name":"979","height":0,"width":0,"length":0,"weight":1.12,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49495tj6upf","name":"977","height":0,"width":0,"length":0,"weight":6.89,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49496j8iph1","name":"438","height":3.7,"width":0.95,"length":10.3,"weight":6.11,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49496ff8r1r","name":"441","height":3.7,"width":0.95,"length":4.4,"weight":2.86,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49497lx0gyw","name":"471","height":3.6,"width":0,"length":7.2,"weight":3.83,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49497qgj965","name":"908","height":0,"width":0,"length":0,"weight":2.57,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494982q36ba","name":"909","height":0,"width":0,"length":0,"weight":2.82,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49499f6p592","name":"964","height":0,"width":0,"length":0,"weight":18.22,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49499vhop2j","name":"965","height":0,"width":0,"length":0,"weight":19.31,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949abbfi6n","name":"976","height":0,"width":0,"length":0,"weight":3.77,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949afzvfps","name":"954","height":0,"width":0,"length":0,"weight":4.35,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949b9qrzcd","name":"1800","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949ba2hbcd","name":"1801","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949c1yd4as","name":"967","height":0,"width":0,"length":0,"weight":19.23,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949c58tixd","name":"969","height":0,"width":0,"length":0,"weight":19.64,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949d1gl6zj","name":"970","height":0,"width":0,"length":0,"weight":19.34,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949e0iytbz","name":"975","height":0,"width":0,"length":0,"weight":4.78,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949efqgn1k","name":"978","height":0,"width":0,"length":0,"weight":6.46,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949f33grph","name":"974","height":0,"width":0,"length":0,"weight":3.04,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949fj3kmke","name":"405","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a01q98sv","name":"482","height":0,"width":0,"length":0,"weight":10.03,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a091ub3y","name":"1804","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a1dhifd6","name":"1802","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a119oo4j","name":"1808","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a2ts3f33","name":"1809","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a27wgpax","name":"1803","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a3tn0v98","name":"1806","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a3uljaj0","name":"1807","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a4aos93w","name":"446","height":0,"width":0,"length":0,"weight":10.69,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a4rlpz62","name":"1810","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a5p4fqvv","name":"1100","height":0,"width":0,"length":0,"weight":18.83,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a67j3v9h","name":"1812","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a6gwj5c3","name":"1101","height":0,"width":0,"length":0,"weight":16.43,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a7nbxsae","name":"1811","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a7r0rwna","name":"1813","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a84lac7a","name":"973","height":0,"width":0,"length":0,"weight":2.12,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a8wo4c3h","name":"1814","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a9577v1j","name":"1600","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aalz4u2p","name":"1602","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aa4m23y4","name":"1601","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494abaw0rmg","name":"1603","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ab8j9dao","name":"1815","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ac4bxlop","name":"1821","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494adkwcm4a","name":"1816","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494adtm5pbd","name":"1818","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aeph9o8u","name":"1700","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aejj0dcq","name":"1701","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494afkjssrj","name":"1702","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b04m9aes","name":"1819","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b06x3hq3","name":"1823","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b1buhh8x","name":"1822","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b1rv2qek","name":"1817","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b2wpntgu","name":"1820","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b22a369h","name":"1824","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b3jva3uo","name":"1703","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b4z8cjep","name":"1300","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b4ze4q6m","name":"1301","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b5yp25zw","name":"1302","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b54acjj4","name":"1304","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b6f2p49e","name":"1104","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b6bl3375","name":"1825","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b77fjdme","name":"1826","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b7wsksbf","name":"1827","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b8p0bxbv","name":"1828","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b9wev51q","name":"1904","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b9o6e4e6","name":"1905","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ba3yjuhd","name":"1704","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bap9vxfo","name":"1705","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bbd4pb0i","name":"1916","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bblngs34","name":"1103","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bc2nt4n6","name":"1106","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bcz787a6","name":"1105","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bdnbbsea","name":"1108","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bdd74b6p","name":"1829","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494be3pyccl","name":"1830","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bflkilvt","name":"1831","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bf8k0aos","name":"1107","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c0yg84cm","name":"1400","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c14kt1si","name":"1832","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c14vx49n","name":"1833","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c296tht0","name":"1109","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c2yu3juy","name":"1915","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c3ef6o76","name":"1917","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c371dcyy","name":"1911","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c4zrh8ch","name":"1708","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c54arkka","name":"1709","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c598z4zo","name":"1710","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c6d2qytf","name":"1401","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c70qe2iw","name":"1607","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c7vgog8m","name":"1608","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c8en79jx","name":"1303","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c9fi8ytt","name":"1706","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494caz6xmda","name":"1707","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ca11nqg2","name":"1613","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cbl1xyon","name":"1834","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cbbbveks","name":"1604","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cchyeg9c","name":"1605","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ccmtlo11","name":"1835","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cdgnwfbp","name":"1609","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cdecbk3x","name":"1610","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cesobnhq","name":"1919","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cfkbikch","name":"1900","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cfppy1g9","name":"1918","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d0y7wj2h","name":"1402","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d0xx64pa","name":"1404","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d1olj72c","name":"1611","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d140lwix","name":"1606","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d21fw310","name":"1711","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d2hu9ua1","name":"1902","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d3ebeaqn","name":"1903","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d3dyp09l","name":"1403","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d432gyaj","name":"1901","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d4jqtyoc","name":"1908","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d5tqpzzl","name":"1909","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d685wx1y","name":"1612","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d86pwwm8","name":"1906","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d9pd4rfi","name":"1907","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d9uvpu1u","name":"1912","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494dau7us61","name":"1910","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494darjj9ft","name":"1913","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494db5rgrq3","name":"1200","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494db7emy8m","name":"1201","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e0o27pk3","name":"655","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e1zgrc2b","name":"664","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e1hcvxks","name":"665","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e2v5tukn","name":"670","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e29usfl8","name":"675","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e3wu9f6h","name":"684","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e3gsz1zf","name":"1914","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e6q31ol1","name":"651","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e607luas","name":"652","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e7c50kjx","name":"656","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e7y0wrxt","name":"685","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e8g44g45","name":"690","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e85wuuaa","name":"1405","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e9xl43xx","name":"1305","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ebvwzdxp","name":"653","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494eckzi2oo","name":"657","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ec0m4g2l","name":"658","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ed80nro6","name":"659","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494edaqu3kh","name":"660","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ee9ckbu0","name":"666","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ee50c6uy","name":"1406","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494efj1lfqx","name":"1202","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f0q8jnub","name":"1203","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f05c0nvu","name":"661","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f1onvovs","name":"667","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f1pua1wq","name":"668","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f2op4gi7","name":"671","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f2p9p5wy","name":"676","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f3knn1ux","name":"678","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f32ueujk","name":"1408","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f4sxixxv","name":"1409","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f4nf1gny","name":"1204","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f56pxiqp","name":"1205","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f5gcrx00","name":"672","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f6unab1z","name":"673","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f7r0azpw","name":"680","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f7mvhofl","name":"1410","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f8073dtq","name":"1411","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f8c4rzf1","name":"1306","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f99a9p0y","name":"1307","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f9hbxhh0","name":"1308","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fa9y74ee","name":"1309","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fbmjab6f","name":"677","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fby5bgbm","name":"679","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fcy5kq4z","name":"681","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fd5wox9o","name":"686","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fdiv42kq","name":"687","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fe4m4l8n","name":"688","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ff8ve0nu","name":"1310","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49500a3vnvj","name":"1206","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495008o0ye2","name":"1413","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49501cnf9wo","name":"1311","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49504ur679u","name":"1407","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950659sfo3","name":"1412","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495089mn8a0","name":"1314","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49508opcgig","name":"1207","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49509g6yeju","name":"1208","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950bdsa47y","name":"1414","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950dhun7er","name":"1312","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950e5olkop","name":"1313","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950e7imvbd","name":"1209","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950f3kd6zl","name":"1210","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49516rs8qzt","name":"654","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495179zvfzu","name":"662","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951bkable5","name":"663","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951bgucnri","name":"1211","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951c3goyxx","name":"1212","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951cv2n33x","name":"1213","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495217hvmxa","name":"669","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4952134i15p","name":"674","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49522snygbh","name":"682","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49522q6bwg7","name":"683","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49523fw1c85","name":"689","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495234jws3d","name":"1214","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49524868p96","name":"1215","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495529u1m8y","name":"1805","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4958ct5xpsr","name":"1102","height":0,"width":0,"length":0,"weight":17.16,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4958d7zcsj3","name":"=COUNT(B4:B537)","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4958fe9trb7","name":"Production Number","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49607cea4fv","name":"=COUNT(B542:B765)","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49609smpho4","name":"Production Number","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49685pzi58f","name":"=COUNT(B770:B999)","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"}],"frames":[{"id":"19c76b49685vf2t3w","name":"TF-1","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685i3m9nw","name":"TF-2","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b4968547tyoy","name":"TF-3","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685iqw9r5","name":"TF-4","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496854uslgg","name":"TF-5","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685gdcbpt","name":"TF-6","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685p8fqo4","name":"TF-7","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496854b7xy5","name":"TF-8","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685r0rzvz","name":"TF-9","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685gj8x19","name":"TF-10","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685eln1gm","name":"TF-11","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685bfpfvl","name":"TF-12","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685asrzm1","name":"TF-13","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685mvmrb3","name":"TF-14","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496858z4v2o","name":"TF-15","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496858z0il7","name":"TF-16","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496853yq149","name":"TF-17","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685e5wixe","name":"TF-18","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685j1uiq7","name":"TF-19","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685fudpmy","name":"TF-20","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685dpm1bb","name":"TF-21","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496852qrymi","name":"TF-22","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685n2cyay","name":"TF-23","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ojnfts","name":"TF-24","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685spnqe9","name":"TF-25","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685i51qbb","name":"TF-26","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685wgqfye","name":"TF-27","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496855dwzkw","name":"TF-28","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685fj8w0j","name":"TF-29","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685s3s3sh","name":"TF-30","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496857x06z9","name":"TF-31","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685xdd72e","name":"TF-32","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685yvwh4j","name":"TF-33","width":1.1,"location":"facility","cages":["19c76b494884kzx2r"],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685tlbfsu","name":"TF-34","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685skx3ia","name":"TF-35","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685hd8bqb","name":"TF-36","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685vm82n4","name":"TF-37","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685ly11ks","name":"TF-38","width":2.5,"location":"facility","cages":["19c76b49488z7ody3"],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b4968503mtlz","name":"TF-39","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685mcw8yk","name":"TF-40","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685265vko","name":"TF-41","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685p0e9xc","name":"TF-42","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ycmvy4","name":"TF-43","width":1.1,"location":"facility","cages":["19c76b4948d2f8htb"],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496855ssvl0","name":"TF-44","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685gormow","name":"TF-45","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ixtgt1","name":"TF-46","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685rrayhh","name":"TF-47","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685iq13hq","name":"TF-48","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ssy2th","name":"TF-49","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b4968585hv1k","name":"TF-50","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false}],"rmdSlots":[{"number":1,"A":{"cage1":"19c76b4947arldwi3","cage2":"19c76b4947evqyjps","overridden":false},"B":{"cage1":"19c76b494713v1kk5","cage2":null,"overridden":false}},{"number":2,"A":{"cage1":"19c76b49477sk6twf","cage2":null,"overridden":false},"B":{"cage1":"19c76b4947eomqqa2","cage2":"19c76b49481ju2zpj","overridden":false}},{"number":3,"A":{"cage1":"19c76b49483oc4mr3","cage2":null,"overridden":false},"B":{"cage1":"19c76b49484jid8cu","cage2":null,"overridden":false}},{"number":4,"A":{"cage1":"19c76b4946fcrxl9j","cage2":"19c76b4948357ve62","overridden":false},"B":{"cage1":"19c76b49475gh3x47","cage2":"19c76b49479yaw0d2","overridden":false}},{"number":5,"A":{"cage1":"19c76b49476lfbc8d","cage2":"19c76b494783i24wf","overridden":false},"B":{"cage1":"19c76b49472pf9hgm","cage2":"19c76b49472ense8a","overridden":false}},{"number":6,"A":{"cage1":"19c76b49484p0s5o3","cage2":null,"overridden":false},"B":{"cage1":"19c76b49476z7wc8o","cage2":"19c76b4947b5av12x","overridden":false}},{"number":7,"A":{"cage1":"19c76b4947c4ubj57","cage2":null,"overridden":false},"B":{"cage1":"19c76b494752xbxyr","cage2":null,"overridden":false}},{"number":8,"A":{"cage1":"19c76b494701p7nuh","cage2":null,"overridden":false},"B":{"cage1":"19c76b4947bl05qd6","cage2":"19c76b4947f2mn8q2","overridden":false}},{"number":9,"A":{"cage1":"19c76b49482a27le4","cage2":null,"overridden":false},"B":{"cage1":"19c76b49480n7jj8d","cage2":null,"overridden":false}},{"number":10,"A":{"cage1":"19c76b49479jnq6p1","cage2":null,"overridden":false},"B":{"cage1":null,"cage2":null,"overridden":false}},{"number":11,"A":{"cage1":"19c76b4947fzfoumf","cage2":"19c76b494812ytp1g","overridden":false},"B":{"cage1":"19c76b49480dsffuq","cage2":null,"overridden":false}},{"number":12,"A":{"cage1":"19c76b4947aelzyy6","cage2":null,"overridden":false},"B":{"cage1":"19c76b494773mvbs6","cage2":"19c76b4947c9bxhvh","overridden":false}}],"plannedMovements":[],"shipments":[],"settings":{"movementsPerDay":4}};

function initState() {
  return {
    cages: [],
    frames: Array.from({length:FRAME_COUNT},(_,i)=>({
      id:uid(), name:`TF-${i+1}`, width:2.5, location:'facility', cages:[], fixedForShipping:false, hasWaler:false
    })),
    rmdSlots: Array.from({length:RMD_COUNT},(_,i)=>{
      let o={number:i+1};
      SIDES.forEach(s=>{ o[s]={cage1:null,cage2:null,overridden:false}; });
      return o;
    }),
    plannedMovements: [],
    shipments: [],
    settings: { movementsPerDay: MAX_MOVES }
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let STATE = initState();
let activeTab = 'dashboard';

// ‚îÄ‚îÄ API config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Set this to your Worker URL, e.g. https://cage-tracker-api.yourname.workers.dev
const API_BASE = 'https://cage-tracker-api.exposurephotographer0.workers.dev';

async function api(path, method = 'GET', body = null) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API_BASE + path, opts);
  if (!res.ok) {
    const e = await res.json().catch(() => ({}));
    throw new Error(e.error || `HTTP ${res.status}`);
  }
  return res.json();
}

// ‚îÄ‚îÄ Load all state from D1 on startup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadState() {
  try {
    showLoadingOverlay(true);
    console.log('[CageTracker] Fetching state from API...');
    const data = await api('/api/state');
    console.log('[CageTracker] API response:', data);
    STATE = {
      ...initState(),
      cages: data.cages.map(normaliseCage),
      frames: data.frames,
      rmdSlots: data.rmdSlots,
      plannedMovements: data.plannedMovements,
      shipments: data.shipments,
      settings: { movementsPerDay: parseInt(data.settings?.movementsPerDay) || MAX_MOVES }
    };
    console.log('[CageTracker] State loaded:', STATE.cages.length, 'cages');
  } catch(e) {
    console.error('[CageTracker] Failed to load state from API:', e);
    showError('Could not connect to database: ' + e.message);
    STATE = initState();
  } finally {
    showLoadingOverlay(false);
  }
}

function normaliseCage(c) {
  return {
    id: c.id, name: c.name,
    height: c.height || 0, width: c.width || 0, length: c.length || 0, weight: c.weight || 0,
    location: c.location || 'facility',
    locationDetail: c.location_detail || c.locationDetail || '',
    departureDate: c.departure_date || c.departureDate || null,
    proposedShipDay: c.proposed_ship_day || c.proposedShipDay || null,
    notes: c.notes || '',
    createdAt: c.created_at || c.createdAt || new Date().toISOString(),
  };
}

// saveState is now a no-op ‚Äî we save directly to the API on each mutation
function saveState() {}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoadingOverlay(show) {
  if (!document.body) return; // DOM not ready yet
  let el = document.getElementById('api-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'api-loading';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(26,34,53,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;color:#fff;font:600 15px var(--font-display);gap:10px;';
    el.innerHTML = '<div style="width:22px;height:22px;border:3px solid rgba(255,255,255,0.3);border-top-color:#e8a830;border-radius:50%;animation:spin 0.8s linear infinite"></div> Loading‚Ä¶';
    document.body.appendChild(el);
    const style = document.createElement('style');
    style.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
    document.head.appendChild(style);
  }
  el.style.display = show ? 'flex' : 'none';
}

function showError(msg) {
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:16px;right:16px;background:#fce8e8;border:1px solid #e8b0b0;color:#c93030;padding:12px 18px;border-radius:8px;font-size:13px;z-index:9999;max-width:380px;box-shadow:0 4px 12px rgba(0,0,0,0.15)';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 6000);
}

function showSuccess(msg) {
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:16px;right:16px;background:#e6f5ec;border:1px solid #b0dcc0;color:#1a8a4a;padding:12px 18px;border-radius:8px;font-size:13px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15)';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ‚îÄ‚îÄ Granular save helpers (called after each mutation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveCage(cage) {
  try { await api('/api/cages', 'PUT', cage); }
  catch(e) { showError('Failed to save cage: ' + e.message); }
}
async function addCageToAPI(cage) {
  try { await api('/api/cages', 'POST', cage); }
  catch(e) { showError('Failed to add cage: ' + e.message); }
}
async function deleteCageFromAPI(id) {
  try { await api('/api/cages', 'DELETE', { id }); }
  catch(e) { showError('Failed to delete cage: ' + e.message); }
}
async function saveFrame(frame) {
  try { await api('/api/frames', 'PUT', frame); }
  catch(e) { showError('Failed to save frame: ' + e.message); }
}
async function saveRMD() {
  try { await api('/api/rmd', 'PUT', STATE.rmdSlots); }
  catch(e) { showError('Failed to save RMD: ' + e.message); }
}
async function addMovementToAPI(m) {
  try { await api('/api/movements', 'POST', m); }
  catch(e) { showError('Failed to add movement: ' + e.message); }
}
async function updateMovementInAPI(m) {
  try { await api('/api/movements', 'PUT', m); }
  catch(e) { showError('Failed to update movement: ' + e.message); }
}
async function deleteMovementFromAPI(id) {
  try { await api('/api/movements', 'DELETE', { id }); }
  catch(e) { showError('Failed to delete movement: ' + e.message); }
}
async function deleteAllMovementsFromAPI() {
  try { await api('/api/movements', 'DELETE', { deleteAll: true }); }
  catch(e) { showError('Failed to clear movements: ' + e.message); }
}
async function addShipmentToAPI(s) {
  try { await api('/api/shipments', 'POST', s); }
  catch(e) { showError('Failed to add shipment: ' + e.message); }
}
async function updateShipmentInAPI(s) {
  try { await api('/api/shipments', 'PUT', s); }
  catch(e) { showError('Failed to update shipment: ' + e.message); }
}
async function deleteShipmentFromAPI(id) {
  try { await api('/api/shipments', 'DELETE', { id }); }
  catch(e) { showError('Failed to delete shipment: ' + e.message); }
}

function getCage(id) { return STATE.cages.find(c=>c.id===id); }
function getFrame(id) { return STATE.frames.find(f=>f.id===id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSidebar() {
  document.getElementById('sidebar').innerHTML = TABS.map(t=>`
    <button class="sidebar-btn ${activeTab===t.id?'active':''}" onclick="switchTab('${t.id}')">
      <span class="sidebar-icon">${t.icon}</span><span>${t.label}</span>
    </button>
  `).join('');
}

function switchTab(id) { activeTab=id; renderSidebar(); renderMain(); }

function renderMain() {
  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="tab-content active" id="tab-${activeTab}">
      ${renderTab(activeTab)}
    </div>
  `;
}

function renderTab(id) {
  switch(id) {
    case 'dashboard': return renderDashboard();
    case 'cages': return renderCages();
    case 'frames': return renderFrames();
    case 'rmd': return renderRMD();
    case 'planner': return renderPlanner();
    case 'boatplan': return renderBoatPlanner();
    case 'shipping': return renderShipping();
    case 'overview': return renderOverview();
    case 'report': return renderReport();
    default: return '';
  }
}

function render() { renderSidebar(); renderMain(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const cages = STATE.cages;
  const inFac = cages.filter(c=>c.location==='facility').length;
  const inRMD = cages.filter(c=>c.location==='rmd').length;
  const inFrm = cages.filter(c=>c.location==='frame').length;
  const shipped = cages.filter(c=>c.location==='shipped').length;
  const fFac = STATE.frames.filter(f=>f.location==='facility').length;
  const fBoat = STATE.frames.filter(f=>f.location==='boat').length;
  const fClient = STATE.frames.filter(f=>f.location==='client').length;
  const ready = STATE.frames.filter(f=>f.fixedForShipping && f.location==='facility').length;
  const todayMoves = STATE.plannedMovements.filter(m=>m.date===todayStr()&&!m.completed).length;
  const pending = STATE.plannedMovements.filter(m=>!m.completed).length;

  function renderRMDSlot(side, slot, posLabel, r) {
    const cid = r[side][slot];
    const cage = cid ? getCage(cid) : null;
    if (cage) {
      return `<div class="rmd-slot">
        <span class="rmd-slot-label">${posLabel}</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name">${esc(cage.name)}</span><span class="rmd-cage-detail">${cage.height}m ${hCat(cage.height)}</span></span>
        </div>
      </div>`;
    } else {
      return `<div class="rmd-slot">
        <span class="rmd-slot-label">${posLabel}</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>`;
    }
  }

  let rmdMiniHTML = RMD_LAYOUT.map(row=>{
    let items = row.items.map(item=>{
      const r = getRMDByNum(item);
      if (!r) return '';
      const cnt = [r.A.cage1,r.A.cage2,r.B.cage1,r.B.cage2].filter(Boolean).length;
      const sideA = renderRMDSlot('A','cage2','A Out',r) + renderRMDSlot('A','cage1','A In',r);
      const sideB = renderRMDSlot('B','cage1','B In',r) + renderRMDSlot('B','cage2','B Out',r);
      return `<div class="rmd-site-card" onclick="switchTab('rmd')" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-${item}</span>
            <span style="font-size:10px;color:var(--text-muted)">${cnt}/4</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          ${sideA}
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:6px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          ${sideB}
        </div>
      </div>`;
    }).join('');
    return `<div class="rmd-site-row row-${row.row}">${items}</div>`;
  }).join('');

  let todayMovesHTML = STATE.plannedMovements.filter(m=>m.date===todayStr()&&!m.completed).map(m=>`
    <div style="padding:7px 0;border-bottom:1px solid var(--border);font-size:13px">
      <span style="color:var(--accent);font-weight:600">${esc(m.type)}</span> ‚Äî ${esc(m.description)}
    </div>
  `).join('') || '<div class="empty-msg">No movements planned for today</div>';

  return `
    <h2 class="section-title">Dashboard Overview</h2>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)">${cages.length}</div><div class="stat-lbl">Total Cages</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${inFac}</div><div class="stat-lbl">In Facility</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--green)">${inRMD}</div><div class="stat-lbl">In RMD</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">${inFrm}</div><div class="stat-lbl">In Frames</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--red)">${ready}</div><div class="stat-lbl">Ready to Ship</div></div>
    </div>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)">${fFac}</div><div class="stat-lbl">Frames at Facility</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${fBoat}</div><div class="stat-lbl">Frames on Boat</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--purple)">${fClient}</div><div class="stat-lbl">Frames w/ Client</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">${todayMoves}</div><div class="stat-lbl">Today's Moves</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--yellow)">${pending}</div><div class="stat-lbl">Pending Plans</div></div>
    </div>
    ${renderNextDueDelivery()}
    ${renderDashboardFrames()}
    <div style="display:grid;grid-template-columns:1fr;gap:14px">
      <div class="card" style="overflow-x:auto">
        <div class="card-title">RMD Storage ‚Äî Live View <span style="font-size:11px;font-weight:400;color:var(--text-muted)">(click any bay to manage)</span></div>
        <div class="rmd-site-layout" style="min-width:700px">${rmdMiniHTML}</div>
      </div>
      <div class="card">
        <div class="card-title">Today's Planned Movements</div>
        ${todayMovesHTML}
      </div>
    </div>
  `;
}

function renderNextDueDelivery() {
  const today = new Date();
  const activeCages = STATE.cages.filter(c => c.location !== 'shipped' && c.departureDate);
  if (activeCages.length === 0) return '';

  const sorted = [...activeCages].sort((a, b) => a.departureDate.localeCompare(b.departureDate));
  const earliestDate = sorted[0].departureDate;

  const cageRows = sorted.map(c => {
    const depDate = new Date(c.departureDate + 'T12:00:00');
    const daysLeft = Math.ceil((depDate - today) / 86400000);
    const isNext = c.departureDate === earliestDate;
    const isOverdue = daysLeft < 0;
    const isUrgent = !isOverdue && daysLeft <= 3;
    const isWarning = !isOverdue && !isUrgent && daysLeft <= 7;

    let rowBg, highlightBar, urgencyBadge;
    if (isOverdue) {
      rowBg = 'background:linear-gradient(90deg,rgba(201,48,48,0.12) 0%,rgba(201,48,48,0.04) 100%);';
      highlightBar = 'border-left:3px solid var(--red);';
      urgencyBadge = `<span style="background:#c93030;color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">OVERDUE</span>`;
    } else if (isNext) {
      rowBg = 'background:linear-gradient(90deg,rgba(184,92,26,0.13) 0%,rgba(184,92,26,0.04) 100%);';
      highlightBar = 'border-left:3px solid var(--orange);';
      urgencyBadge = `<span style="background:var(--orange);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">NEXT UP ¬∑ ${daysLeft}d</span>`;
    } else if (isUrgent) {
      rowBg = 'background:linear-gradient(90deg,rgba(154,123,16,0.10) 0%,rgba(154,123,16,0.04) 100%);';
      highlightBar = 'border-left:3px solid var(--yellow);';
      urgencyBadge = `<span style="background:var(--yellow);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">${daysLeft}d</span>`;
    } else if (isWarning) {
      rowBg = '';
      highlightBar = 'border-left:3px solid var(--border);';
      urgencyBadge = `<span style="font:600 11px var(--font-mono);color:var(--text-muted)">${daysLeft}d</span>`;
    } else {
      rowBg = '';
      highlightBar = 'border-left:3px solid transparent;';
      urgencyBadge = `<span style="font:600 11px var(--font-mono);color:var(--text-muted)">${daysLeft}d</span>`;
    }

    return `<div style="display:flex;align-items:center;gap:12px;padding:8px 12px;${rowBg}${highlightBar}border-radius:0 6px 6px 0;margin-bottom:4px">
      <div style="min-width:110px"><span style="font:700 13px var(--font-mono);color:var(--text-primary)">${esc(c.name)}</span></div>
      <div style="flex:1;font-size:11px;color:var(--text-muted)">${c.width}m √ó ${c.height}m √ó ${c.length}m ¬∑ ${c.weight}t</div>
      <div style="min-width:80px"><span class="badge badge-${locBadge(c.location)}" style="font-size:9px">${esc(locLabel(c))}</span></div>
      ${c.proposedShipDay ? `<div style="font:600 10px var(--font-mono);color:var(--purple);min-width:100px">üö¢ ${fmt(c.proposedShipDay)}</div>` : '<div style="min-width:100px"></div>'}
      <div style="font:600 11px var(--font-mono);color:var(--text-secondary);min-width:90px">${fmt(c.departureDate)}</div>
      <div style="min-width:90px;text-align:right">${urgencyBadge}</div>
    </div>`;
  }).join('');

  const overdueCount = sorted.filter(c => Math.ceil((new Date(c.departureDate+'T12:00:00') - today) / 86400000) < 0).length;
  const urgentCount = sorted.filter(c => { const d = Math.ceil((new Date(c.departureDate+'T12:00:00') - today) / 86400000); return d >= 0 && d <= 3; }).length;

  return `<div class="card" style="margin-bottom:14px;border-color:${overdueCount > 0 ? 'var(--red)' : urgentCount > 0 ? '#e8c8a0' : 'var(--border)'}">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">
        üì¶ Next Due for Delivery
        ${overdueCount > 0 ? `<span style="background:var(--red);color:#fff;font:700 10px var(--font-mono);padding:2px 7px;border-radius:10px;margin-left:8px">${overdueCount} OVERDUE</span>` : ''}
        ${urgentCount > 0 ? `<span style="background:var(--orange);color:#fff;font:700 10px var(--font-mono);padding:2px 7px;border-radius:10px;margin-left:8px">${urgentCount} URGENT</span>` : ''}
      </div>
      <button class="btn btn-secondary btn-sm" onclick="switchTab('boatplan')">Boat Planner ‚Üí</button>
    </div>
    <div style="display:flex;gap:6px;font:600 9px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0 12px;margin-bottom:6px">
      <span style="min-width:110px">Cage</span><span style="flex:1">Dimensions ¬∑ Weight</span>
      <span style="min-width:80px">Location</span><span style="min-width:100px">Prop. Ship Day</span>
      <span style="min-width:90px">Leaves Facility</span><span style="min-width:90px;text-align:right">Due In</span>
    </div>
    ${cageRows}
  </div>`;
}

function renderDashboardFrames() {
  const facilityFrames = STATE.frames.filter(f => f.location === 'facility');
  if (facilityFrames.length === 0) return '';

  const frameCards = facilityFrames.map(f => {
    const fCages = f.cages.map(cid => getCage(cid)).filter(Boolean);
    const status = f.fixedForShipping ? 'ready' : f.cages.length === 0 ? 'empty' : 'loaded';
    const statusColor = status === 'ready' ? 'var(--accent)' : status === 'empty' ? 'var(--text-muted)' : 'var(--green)';
    const statusLabel = status === 'ready' ? '‚úì SHIP READY' : status === 'empty' ? 'EMPTY' : `${fCages.length} CAGE${fCages.length>1?'S':''}`;
    const borderStyle = status === 'ready' ? 'border-color:#c0a050;background:#fdfaf0' : status === 'empty' ? '' : 'border-color:#b0dcc0;background:#f0faf4';

    const cageList = fCages.length > 0
      ? fCages.map(c => {
          const dep = c.departureDate;
          const daysLeft = dep ? Math.ceil((new Date(dep+'T12:00:00') - new Date()) / 86400000) : null;
          const depStr = dep ? ` ¬∑ ${fmt(dep)} (${daysLeft}d)` : '';
          const depColor = daysLeft !== null && daysLeft <= 3 ? 'var(--red)' : 'var(--orange)';
          return `<div style="font-size:11px;padding:2px 0;display:flex;justify-content:space-between">
            <span style="font-weight:600;font-family:var(--font-mono)">${esc(c.name)}</span>
            <span style="color:${dep ? depColor : 'var(--text-muted)'}">${hCat(c.height)}${depStr}</span>
          </div>`;
        }).join('')
      : '<div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>';

    return `<div class="card" style="padding:10px;${borderStyle}">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">${esc(f.name)}</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:${statusColor}">${statusLabel}</span>
          ${f.hasWaler ? '<span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>' : ''}
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">${f.width}m frame</div>
      ${cageList}
    </div>`;
  }).join('');

  return `<div class="card" style="margin-bottom:14px">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">Frames at Facility (${facilityFrames.length})</div>
      <button class="btn btn-secondary btn-sm" onclick="switchTab('frames')">Manage Frames ‚Üí</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
      ${frameCards}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cageFormOpen = false;
let cageSearch = '';
let cageFilter = 'all';
let cageEditing = null;
let cageSelected = new Set(); // for multi-delete

function renderCages() {
  const filtered = STATE.cages.filter(c=>{
    if (cageSearch && !c.name.toLowerCase().includes(cageSearch.toLowerCase())) return false;
    if (cageFilter !== 'all' && c.location !== cageFilter) return false;
    return true;
  });

  let formHTML = '';
  if (cageFormOpen) {
    formHTML = `<div class="card">
      <div class="form-grid form-grid-3">
        <div><label>Cage Name / ID</label><input id="cf-name" placeholder="e.g. CAGE-001"/></div>
        <div><label>Height (m) ‚Äî max 10</label><input id="cf-h" type="number" step="0.1" max="10"/></div>
        <div><label>Width (m) ‚Äî max 2.5</label><input id="cf-w" type="number" step="0.1" max="2.5"/></div>
        <div><label>Length (m) ‚Äî max 11.5</label><input id="cf-l" type="number" step="0.1" max="11.5"/></div>
        <div><label>Weight (t) ‚Äî max 28</label><input id="cf-wt" type="number" step="0.1" max="28"/></div>
        <div><label>Notes</label><input id="cf-notes"/></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addCage()">Save Cage</button>
        <button class="btn btn-secondary" onclick="cageFormOpen=false;render()">Cancel</button>
      </div>
    </div>`;
  }

  // Build per-cage location options based on compatibility
  function cageLocationOpts(c) {
    // Frame options: cage must fit by width
    let frameOpts = STATE.frames.filter(f=>{
      if(f.location!=='facility') return false;
      if(f.cages.length >= 2) return false;
      // If frame already has a cage, check double-fit rules
      if(f.cages.length === 1) {
        const existing = getCage(f.cages[0]);
        if(!existing) return false;
        return canFitTwo(existing, c, f.width);
      }
      // Empty frame: cage width must fit
      return c.width <= f.width;
    }).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>{
      const existing = f.cages.length===1 ? getCage(f.cages[0]) : null;
      const note = existing ? ` [with ${existing.name}]` : '';
      return `<option value="frame:${f.id}">‚Üí ${esc(f.name)} (${f.width}m)${note}</option>`;
    }).join('');

    // RMD options: check height pairing rules
    let rmdOptsList = [];
    STATE.rmdSlots.forEach(r=>{
      SIDES.forEach(side=>{
        ['cage1','cage2'].forEach(slot=>{
          if(r[side][slot]) return; // slot occupied
          const otherSlot = slot==='cage1' ? 'cage2' : 'cage1';
          const otherCid = r[side][otherSlot];
          const posLabel = slot==='cage1' ? 'inside' : 'outside';
          if(otherCid) {
            const other = getCage(otherCid);
            if(other && canPairRMD(other, c)) {
              rmdOptsList.push(`<option value="rmd:${r.number}:${side}:${slot}">‚Üí RMD-${r.number}${side} (${posLabel}) [with ${other.name}]</option>`);
            }
            // Don't show incompatible slots
          } else {
            // Empty side, any cage can go
            rmdOptsList.push(`<option value="rmd:${r.number}:${side}:${slot}">‚Üí RMD-${r.number}${side} (${posLabel})</option>`);
          }
        });
      });
    });
    let rmdOpts = rmdOptsList.sort((a,b)=>{
      const na = parseInt(a.match(/RMD-(\d+)/)?.[1]||0), nb = parseInt(b.match(/RMD-(\d+)/)?.[1]||0);
      return na!==nb ? na-nb : a.localeCompare(b);
    }).join('');

    let opts = '<option value="">Move to...</option>';
    if(c.location !== 'facility') opts += '<option value="facility">‚Üí Facility</option>';
    if(frameOpts) opts += `<optgroup label="Frames (${STATE.frames.filter(f=>f.location==='facility'&&c.width<=f.width&&f.cages.length<2).length} available)">${frameOpts}</optgroup>`;
    if(rmdOpts) opts += `<optgroup label="RMD Storage">${rmdOpts}</optgroup>`;
    return opts;
  }

  let rows = filtered.length === 0
    ? `<tr><td colspan="11" style="text-align:center;padding:20px" class="empty-msg">No cages found</td></tr>`
    : filtered.map(c=>{
      if (cageEditing === c.id) {
        return `<tr style="background:#fdf8ee">
          <td></td>
          <td><input id="ce-name-${c.id}" value="${esc(c.name)}" style="width:90px;font-size:12px"/></td>
          <td><input id="ce-h-${c.id}" type="number" step="0.01" value="${c.height}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-w-${c.id}" type="number" step="0.01" value="${c.width}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-l-${c.id}" type="number" step="0.01" value="${c.length}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-wt-${c.id}" type="number" step="0.01" value="${c.weight}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-dep-${c.id}" type="date" value="${c.departureDate||''}" style="width:130px;font-size:12px"/></td>
          <td><input id="ce-ship-${c.id}" type="date" value="${c.proposedShipDay||''}" style="width:130px;font-size:12px"/></td>
          <td><span class="badge badge-${hBadge(c.height)}">${hCat(c.height)}</span></td>
          <td><span class="badge badge-${locBadge(c.location)}">${esc(locLabel(c))}</span></td>
          <td colspan="2" style="white-space:nowrap">
            <button class="btn btn-primary btn-xs" onclick="saveCageEdit('${c.id}')">‚úì Save</button>
            <button class="btn btn-secondary btn-xs" style="margin-left:4px" onclick="cageEditing=null;render()">Cancel</button>
          </td>
        </tr>`;
      }
      const sel = cageSelected.has(c.id);
      const daysLeft = c.departureDate ? Math.ceil((new Date(c.departureDate+'T12:00:00') - new Date()) / 86400000) : null;
      const depBadge = daysLeft !== null ? (daysLeft < 0 ? '<span style="color:var(--red);font-size:10px">OVERDUE</span>' : daysLeft <= 7 ? `<span style="color:var(--orange);font-size:10px">‚ö† ${daysLeft}d</span>` : `<span style="color:var(--text-muted);font-size:10px">${daysLeft}d</span>`) : '';
      return `<tr style="${sel?'background:#fdf8ee':''}">
        <td style="width:32px;text-align:center">
          <input type="checkbox" ${sel?'checked':''} onchange="toggleCageSelect('${c.id}',this.checked)" style="width:14px;height:14px;cursor:pointer;accent-color:var(--accent)"/>
        </td>
        <td style="font-weight:600;color:var(--text-primary)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','name',this)">${esc(c.name)}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','height',this)">${c.height}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','width',this)">${c.width}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','length',this)">${c.length}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','weight',this)">${c.weight}</span></td>
        <td style="font-size:11px"><span class="editable-cell" onclick="startInlineEdit('${c.id}','departureDate',this)" title="Click to edit departure date">${c.departureDate ? fmt(c.departureDate) : '<span style="color:var(--text-muted)">‚Äî</span>'}</span> ${depBadge}</td>
        <td style="font-size:11px"><span class="editable-cell" onclick="startInlineEdit('${c.id}','proposedShipDay',this)" title="Click to edit proposed ship day">${c.proposedShipDay ? `<span style="color:var(--purple);font-family:var(--font-mono)">${fmt(c.proposedShipDay)}</span>` : '<span style="color:var(--text-muted)">‚Äî</span>'}</span></td>
        <td><span class="badge badge-${hBadge(c.height)}">${hCat(c.height)}</span></td>
        <td><span class="badge badge-${locBadge(c.location)}">${esc(locLabel(c))}</span></td>
        <td style="white-space:nowrap">
          <select style="font-size:11px;padding:3px 6px;max-width:180px" onchange="changeCageLocation('${c.id}',this.value);this.value=''">
            ${cageLocationOpts(c)}
          </select>
        </td>
        <td style="white-space:nowrap">
          <button class="btn btn-danger btn-xs" onclick="deleteCage('${c.id}')">‚úï</button>
        </td>
      </tr>`;
    }).join('');

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Cage Inventory</h2>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary" onclick="document.getElementById('excel-import').click()">üì• Import from Excel</button>
        <button class="btn btn-primary" onclick="cageFormOpen=!cageFormOpen;render()">+ Add Cage</button>
      </div>
    </div>
    ${formHTML}
    <div class="filter-bar">
      <div style="display:flex;gap:4px;align-items:center;max-width:280px;flex:1">
        <input id="cage-search-input" style="flex:1" placeholder="Search cages‚Ä¶ (Enter)" value="${esc(cageSearch)}"
          onkeydown="if(event.key==='Enter'){cageSearch=this.value;render();}"
          onkeyup="if(this.value===''){cageSearch='';render();}"/>
        ${cageSearch ? `<button class="btn btn-secondary btn-sm" style="white-space:nowrap;padding:4px 8px" onclick="cageSearch='';render()">‚úï</button>` : ''}
      </div>
      <button class="filter-btn ${cageFilter==='all'?'active':''}" onclick="cageFilter='all';render()">All</button>
      <button class="filter-btn ${cageFilter==='facility'?'active':''}" onclick="cageFilter='facility';render()">Facility</button>
      <button class="filter-btn ${cageFilter==='rmd'?'active':''}" onclick="cageFilter='rmd';render()">RMD</button>
      <button class="filter-btn ${cageFilter==='frame'?'active':''}" onclick="cageFilter='frame';render()">Frame</button>
      <button class="filter-btn ${cageFilter==='shipped'?'active':''}" onclick="cageFilter='shipped';render()">Shipped</button>
    </div>
    ${cageSelected.size > 0 ? `<div style="display:flex;align-items:center;gap:12px;background:#fef0e6;border:1px solid #e8c8a0;border-radius:8px;padding:8px 14px;margin-bottom:10px">
      <span style="font-weight:600;font-size:13px;color:var(--orange)">${cageSelected.size} cage${cageSelected.size>1?'s':''} selected</span>
      <button class="btn btn-danger btn-sm" onclick="deleteSelectedCages()">üóë Delete Selected</button>
      <button class="btn btn-secondary btn-sm" onclick="cageSelected.clear();render()">‚úï Clear Selection</button>
    </div>` : ''}
    <div class="card" style="overflow-x:auto">
      <table>
        <thead><tr>
          <th style="width:32px"><input type="checkbox" id="cage-select-all" style="width:14px;height:14px;cursor:pointer;accent-color:var(--accent)" onchange="toggleAllCages(this.checked,${JSON.stringify(filtered.map(c=>c.id))})"/></th>
          <th>Name <span style="font-weight:400;font-size:9px;color:var(--accent)">click to edit</span></th><th>H(m)</th><th>W(m)</th><th>L(m)</th><th>Wt(t)</th><th>Leaves Facility</th><th>Prop. Ship Day</th><th>Category</th><th>Location</th><th>Move</th><th>Del</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function addCage() {
  const name = document.getElementById('cf-name').value.trim();
  const h = parseFloat(document.getElementById('cf-h').value);
  const w = parseFloat(document.getElementById('cf-w').value);
  const l = parseFloat(document.getElementById('cf-l').value);
  const wt = parseFloat(document.getElementById('cf-wt').value);
  const notes = document.getElementById('cf-notes').value.trim();
  if (!name||isNaN(h)||isNaN(w)||isNaN(l)||isNaN(wt)) return alert('Please fill all required fields.');
  const cage = {id:uid(),name,height:h,width:w,length:l,weight:wt,notes,departureDate:null,location:'facility',locationDetail:'',createdAt:new Date().toISOString()};
  STATE.cages.push(cage);
  cageFormOpen = false;
  render();
  await addCageToAPI(cage);
}
function toggleCageSelect(id, checked) {
  if (checked) cageSelected.add(id);
  else cageSelected.delete(id);
  // Update select-all checkbox state
  render();
}

function toggleAllCages(checked, ids) {
  if (checked) ids.forEach(id => cageSelected.add(id));
  else ids.forEach(id => cageSelected.delete(id));
  render();
}

async function deleteSelectedCages() {
  if (cageSelected.size === 0) return;
  if (!confirm(`Delete ${cageSelected.size} selected cage${cageSelected.size>1?'s':''}? This cannot be undone.`)) return;
  const ids = [...cageSelected];
  ids.forEach(id => {
    STATE.cages = STATE.cages.filter(c => c.id !== id);
    STATE.frames.forEach(f => { f.cages = f.cages.filter(cid => cid !== id); });
    STATE.rmdSlots.forEach(r => {
      SIDES.forEach(s => {
        if (r[s].cage1 === id) r[s].cage1 = null;
        if (r[s].cage2 === id) r[s].cage2 = null;
      });
    });
  });
  cageSelected.clear();
  render();
  await Promise.all(ids.map(id => deleteCageFromAPI(id)));
  // Sync affected frames and RMD
  const affectedFrames = STATE.frames.filter(f => ids.some(id => f.cages.includes(id)));
  await Promise.all(affectedFrames.map(f => saveFrame(f)));
  await saveRMD();
}

function startInlineEdit(cageId, field, spanEl) {
  const c = getCage(cageId);
  if (!c) return;
  const isDate = field === 'departureDate' || field === 'proposedShipDay';
  const isNumber = ['height','width','length','weight'].includes(field);
  const currentVal = c[field] != null ? c[field] : '';
  const input = document.createElement('input');
  input.type = isDate ? 'date' : isNumber ? 'number' : 'text';
  input.value = currentVal;
  input.className = 'inline-edit-input';
  if (isNumber) { input.step = '0.01'; input.style.width = '75px'; }
  else if (isDate) { input.style.width = '145px'; }
  else { input.style.width = Math.max(80, (spanEl.offsetWidth || 80) + 20) + 'px'; }
  spanEl.replaceWith(input);
  input.focus();
  if (!isDate) input.select();
  const save = () => {
    const raw = input.value.trim();
    if (isNumber) { const n = parseFloat(raw); if (!isNaN(n)) c[field] = n; }
    else if (isDate) { c[field] = raw || null; }
    else { if (raw) c[field] = raw; }
    render();
    saveCage(c);
  };
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') { input.blur(); }
    if (e.key === 'Escape') { render(); }
  });
}

function saveCageEdit(id) {
  const c = getCage(id);
  if (!c) return;
  const name = document.getElementById('ce-name-'+id).value.trim();
  const h = parseFloat(document.getElementById('ce-h-'+id).value);
  const w = parseFloat(document.getElementById('ce-w-'+id).value);
  const l = parseFloat(document.getElementById('ce-l-'+id).value);
  const wt = parseFloat(document.getElementById('ce-wt-'+id).value);
  const dep = document.getElementById('ce-dep-'+id).value;
  const shipEl = document.getElementById('ce-ship-'+id);
  const ship = shipEl ? shipEl.value : '';
  if (!name) return alert('Name required.');
  c.name = name;
  if (!isNaN(h)) c.height = h;
  if (!isNaN(w)) c.width = w;
  if (!isNaN(l)) c.length = l;
  if (!isNaN(wt)) c.weight = wt;
  c.departureDate = dep || null;
  c.proposedShipDay = ship || null;
  cageEditing = null;
  render();
  saveCage(c);
}

async function deleteCage(id) {
  if (!confirm('Delete this cage? It will be removed from any frame or RMD slot.')) return;
  STATE.cages = STATE.cages.filter(c=>c.id!==id);
  STATE.frames.forEach(f=>{ f.cages = f.cages.filter(cid=>cid!==id); });
  STATE.rmdSlots.forEach(r=>{
    SIDES.forEach(s=>{
      if(r[s].cage1===id) r[s].cage1=null;
      if(r[s].cage2===id) r[s].cage2=null;
    });
  });
  render();
  await deleteCageFromAPI(id);
  await saveRMD();
  const affectedFrames = STATE.frames.filter(f => !f.cages.includes(id)); // already removed above
  // Save all frames to sync cage lists
  await Promise.all(STATE.frames.map(f => saveFrame(f)));
}

// Remove a cage from whatever frame/RMD it's currently in
function clearCageFromCurrentLocation(cid) {
  STATE.frames.forEach(f=>{ f.cages = f.cages.filter(id=>id!==cid); if(f.cages.length===0) f.fixedForShipping=false; });
  STATE.rmdSlots.forEach(r=>{
    SIDES.forEach(s=>{
      if(r[s].cage1===cid) r[s].cage1=null;
      if(r[s].cage2===cid) r[s].cage2=null;
    });
  });
}

function changeCageLocation(cid, target) {
  if(!target) return;
  const cage = getCage(cid);
  if(!cage) return;

  // Clear from current location first
  clearCageFromCurrentLocation(cid);

  if (target === 'facility') {
    cage.location = 'facility';
    cage.locationDetail = '';
  } else if (target.startsWith('frame:')) {
    const frameId = target.split(':')[1];
    const frame = getFrame(frameId);
    if (!frame) return alert('Frame not found.');
    if (frame.cages.length >= 2) return alert('Frame already has max cages.');
    if (frame.cages.length === 1) {
      const existing = getCage(frame.cages[0]);
      if (existing && !canFitTwo(existing, cage, frame.width)) {
        return alert(`Cannot fit both cages. Need combined width + 0.3m ‚â§ ${frame.width}m and each cage ‚â§ 14t.`);
      }
    }
    frame.cages.push(cid);
    cage.location = 'frame';
    cage.locationDetail = frame.name;
    cage.departureDate = null; // already in frame ‚Äî no longer "leaving facility"
  } else if (target.startsWith('rmd:')) {
    const parts = target.split(':');
    const rmdNum = parseInt(parts[1]);
    const side = parts[2];
    const slot = parts[3];
    const rmdIdx = STATE.rmdSlots.findIndex(r=>r.number===rmdNum);
    if (rmdIdx === -1) return alert('RMD not found.');
    const r = STATE.rmdSlots[rmdIdx];
    const otherSlot = slot==='cage1'?'cage2':'cage1';
    const otherCid = r[side][otherSlot];
    if (otherCid) {
      const other = getCage(otherCid);
      if (other && !canPairRMD(other, cage)) {
        if (!confirm(`Height pairing ${hCat(cage.height)} + ${hCat(other.height)} not standard. Override?`)) {
          // Re-add to old location ‚Äî just set facility as fallback
          cage.location = 'facility'; cage.locationDetail = '';
          render(); saveCage(cage); return;
        }
        r[side].overridden = true;
      }
    }
    r[side][slot] = cid;
    cage.location = 'rmd';
    cage.locationDetail = `RMD-${rmdNum}${side}`;
    cage.departureDate = null; // in RMD ‚Äî no longer "leaving facility"
  }

  render();
  await saveCage(cage);
  await saveRMD();
  const affectedFrame = STATE.frames.find(f => f.cages.includes(cage.id));
  if (affectedFrame) await saveFrame(affectedFrame);
}(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];

      // Convert to array of arrays to find the header row
      const allRows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});

      // Find the header row by looking for "Production Number" in any row
      let headerIdx = -1;
      let headers = [];
      for (let i = 0; i < Math.min(20, allRows.length); i++) {
        const row = allRows[i];
        const found = row.findIndex(cell => String(cell).toLowerCase().includes('production number'));
        if (found !== -1) {
          headerIdx = i;
          headers = row.map(h => String(h).trim());
          break;
        }
      }
      if (headerIdx === -1) return alert('Could not find a "Production Number" column header in the first 20 rows.');

      // Map column indices
      const findIdx = (...keywords) => {
        for (const kw of keywords) {
          const idx = headers.findIndex(h => h.toLowerCase().includes(kw.toLowerCase()));
          if (idx !== -1) return idx;
        }
        return -1;
      };

      const colProdNum = findIdx('production number');
      const colLength = findIdx('armf length', 'length');
      const colWidth = findIdx('armf width', 'width');
      const colHeight = findIdx('armf height', 'height');
      const colWeight = findIdx('pw rof weight', 'pw rof');

      if (colProdNum === -1) return alert('Could not find "Production Number" column. Found headers: ' + headers.join(', '));

      let imported = 0, skipped = 0, duplicates = 0;
      const existingNames = new Set(STATE.cages.map(c => String(c.name).toLowerCase().trim()));

      const dataRows = allRows.slice(headerIdx + 1);
      dataRows.forEach(row => {
        const rawProd = row[colProdNum];
        if (rawProd === undefined || rawProd === null || String(rawProd).trim() === '') {
          skipped++;
          return;
        }
        const name = String(rawProd).trim();

        if (existingNames.has(name.toLowerCase())) {
          duplicates++;
          return;
        }

        // Parse dimensions: mm to m
        const parseMM = (val) => {
          if (val === undefined || val === null || String(val).trim() === '') return 0;
          const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
          return isNaN(n) ? 0 : Math.round((n / 1000) * 1000) / 1000;
        };
        const parseWt = (val) => {
          if (val === undefined || val === null || String(val).trim() === '') return 0;
          const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
          if (isNaN(n)) return 0;
          return n > 100 ? Math.round((n / 1000) * 100) / 100 : Math.round(n * 100) / 100;
        };

        const height = colHeight !== -1 ? parseMM(row[colHeight]) : 0;
        const width = colWidth !== -1 ? parseMM(row[colWidth]) : 0;
        const length = colLength !== -1 ? parseMM(row[colLength]) : 0;
        const weight = colWeight !== -1 ? parseWt(row[colWeight]) : 0;

        STATE.cages.push({
          id: uid(), name, height, width, length, weight,
          notes: 'Imported from Excel',
          location: 'facility', locationDetail: '',
          createdAt: new Date().toISOString()
        });
        existingNames.add(name.toLowerCase());
        imported++;
      });

      let msg = `Import complete!\n\n‚úì ${imported} cages imported`;
      if (duplicates > 0) msg += `\n‚ö† ${duplicates} duplicates skipped`;
      if (skipped > 0) msg += `\n‚Äî ${skipped} rows skipped (no production number)`;
      if (colHeight === -1) msg += `\n‚ö† Height column not found`;
      if (colWidth === -1) msg += `\n‚ö† Width column not found`;
      if (colLength === -1) msg += `\n‚ö† Length column not found`;
      if (colWeight === -1) msg += `\n‚ö† Weight column not found`;
      alert(msg);

      render();
      // Batch-insert new cages via API
      const newCages = STATE.cages.slice(-imported);
      for (const cage of newCages) {
        await addCageToAPI(cage);
      }
    } catch(err) {
      alert('Error reading Excel file: ' + err.message);
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
  input.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRAMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let frameFilter = 'all';
let frameEditing = null;

function renderFrames() {
  const filtered = STATE.frames.filter(f=> frameFilter==='all' || f.location===frameFilter);
  const counts = {all:STATE.frames.length, facility:STATE.frames.filter(f=>f.location==='facility').length, boat:STATE.frames.filter(f=>f.location==='boat').length, client:STATE.frames.filter(f=>f.location==='client').length};
  const availCages = STATE.cages.filter(c=>c.location==='facility'||c.location==='rmd').sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));

  let cardsHTML = filtered.map(f=>{
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    const isEditing = frameEditing===f.id;
    const locColors = {facility:'green',boat:'blue',client:'purple'};

    let cageListHTML = fCages.map(c=>`
      <div class="frame-cage-item">
        <span>${esc(c.name)} (${c.width}m, ${c.weight}t)${needsWaler(c) ? ' <span style="color:var(--yellow);font-size:10px" title="Cage < 6.5m needs waler for shipping">‚ö† waler req.</span>' : ''}</span>
        ${f.location==='facility'&&!f.fixedForShipping ? `<button class="remove-btn" onclick="removeCageFromFrame('${f.id}','${c.id}')">√ó</button>` : ''}
      </div>
    `).join('');

    let actionsHTML = '';
    if (f.location==='facility' && !isEditing) {
      actionsHTML = `<button class="btn btn-secondary btn-sm btn-block" onclick="frameEditing='${f.id}';render()">Actions ‚ñæ</button>`;
    }
    if (isEditing && f.location==='facility') {
      let cageOpts = availCages.map(c=>`<option value="${c.id}">${esc(c.name)} (${c.width}m, ${c.weight}t)</option>`).join('');
      let widthOpts = FRAME_WIDTHS.map(w=>`<option value="${w}" ${f.width===w?'selected':''}>${w}m wide</option>`).join('');
      actionsHTML = `<div class="frame-actions">
        <select onchange="updateFrameWidth('${f.id}',this.value)">${widthOpts}</select>
        ${f.cages.length < 2 ? `<select onchange="assignCageToFrame('${f.id}',this.value);this.value=''"><option value="">+ Add cage...</option>${cageOpts}</select>` : ''}
        <button class="btn ${f.hasWaler?'btn-blue btn-secondary':'btn-secondary'} btn-sm" style="${f.hasWaler?'color:var(--blue);border-color:rgba(91,156,238,0.3)':''}" onclick="toggleWaler('${f.id}')">${f.hasWaler?'üî© Remove Waler':'+ Add Waler'}</button>
        ${f.cages.length === 1 ? `<button class="btn ${f.fixedForShipping?'btn-danger':'btn-primary'} btn-sm" onclick="toggleShipping('${f.id}')">${f.fixedForShipping?'Unfix from Shipping':'Fix for Shipping'}</button>` : ''}
        <select onchange="updateFrameLoc('${f.id}',this.value)">
          <option value="facility" selected>At Facility</option><option value="boat">On Boat</option><option value="client">With Client</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="frameEditing=null;render()">Close</button>
      </div>`;
    }
    if (f.location === 'boat') {
      actionsHTML = `<button class="btn btn-secondary btn-sm btn-block" style="margin-top:6px" onclick="updateFrameLoc('${f.id}','facility')">Return to Facility</button>`;
    }
    if (f.location === 'client') {
      actionsHTML = `<button class="btn btn-primary btn-sm btn-block" style="margin-top:6px" onclick="returnFromClient('${f.id}')">üè≠ Return to Facility (unload cage)</button>`;
    }

    return `<div class="card frame-card ${f.fixedForShipping?'shipping-ready':''}">
      <div class="flex-between" style="margin-bottom:4px">
        <span class="frame-name">${esc(f.name)}</span>
        <span class="badge badge-${locColors[f.location]||'accent'}">${f.location}</span>
      </div>
      <div class="frame-meta">
        Width: <span style="color:var(--text-secondary);font-family:var(--font-mono)">${f.width}m</span>
        ${f.hasWaler ? '<span class="badge badge-blue" style="margin-left:6px">üî© WALER</span>' : '<span class="badge badge-yellow" style="margin-left:6px;opacity:0.5">NO WALER</span>'}
        ${f.fixedForShipping ? '<span class="badge badge-accent" style="margin-left:6px">‚úì SHIPPING</span>' : ''}
      </div>
      ${cageListHTML}
      ${actionsHTML}
    </div>`;
  }).join('');

  return `
    <h2 class="section-title">Frame Management</h2>
    <div class="filter-bar">
      ${['all','facility','boat','client'].map(f=>`
        <button class="filter-btn ${frameFilter===f?'active':''}" onclick="frameFilter='${f}';render()">${f==='all'?'All':f.charAt(0).toUpperCase()+f.slice(1)} (${counts[f]})</button>
      `).join('')}
    </div>
    <div class="frame-grid">${cardsHTML}</div>
  `;
}

function updateFrameWidth(fid,w) { const f=getFrame(fid); f.width=parseFloat(w); render(); saveFrame(f); }
async function updateFrameLoc(fid,loc) {
  const f=getFrame(fid);
  f.location=loc;
  if(loc!=='facility') f.fixedForShipping=false;
  if(loc!=='facility') {
    f.cages.forEach(cid=>{
      const c=getCage(cid);
      if(c) { c.location = loc==='boat'||loc==='client' ? 'shipped' : 'facility'; c.locationDetail = loc==='boat'?'In transit':loc==='client'?'With client':''; if (loc!=='facility') c.departureDate = null; }
    });
  }
  render();
  await saveFrame(f);
  await Promise.all(f.cages.map(cid => { const c=getCage(cid); return c ? saveCage(c) : Promise.resolve(); }));
}
async function assignCageToFrame(fid,cid) {
  if(!cid) return;
  const f=getFrame(fid), c=getCage(cid);
  if(f.cages.length>=2) return alert('Frame already has max cages.');
  if(f.cages.length===1) {
    const ex=getCage(f.cages[0]);
    if(ex && !canFitTwo(ex,c,f.width)) return alert(`Cannot fit both cages. Need combined width + 0.3m ‚â§ ${f.width}m and each ‚â§ 14t.`);
  }
  f.cages.push(cid);
  c.location='frame'; c.locationDetail=f.name;
  // Remove from any RMD slot
  STATE.rmdSlots.forEach(r=>{ SIDES.forEach(s=>{ if(r[s].cage1===cid) r[s].cage1=null; if(r[s].cage2===cid) r[s].cage2=null; }); });
  render();
  await saveFrame(f);
  await saveCage(c);
  await saveRMD();
}
async function removeCageFromFrame(fid,cid) {
  const f=getFrame(fid), c=getCage(cid);
  f.cages=f.cages.filter(id=>id!==cid); f.fixedForShipping=false;
  if(c) { c.location='facility'; c.locationDetail=''; }
  render();
  await saveFrame(f);
  if(c) await saveCage(c);
}
function toggleWaler(fid) {
  const f=getFrame(fid);
  f.hasWaler = !f.hasWaler;
  render(); saveFrame(f);
}
function toggleShipping(fid) {
  const f=getFrame(fid);
  if(!f.fixedForShipping && f.cages.length!==1) return alert('Exactly 1 cage must be in frame for shipping.');
  if(!f.fixedForShipping) {
    const cage = getCage(f.cages[0]);
    if(cage && needsWaler(cage) && !f.hasWaler) {
      return alert(`Cage "${cage.name}" is ${cage.length}m long (< 6.5m) and requires a waler on the frame for shipping. Please add a waler first.`);
    }
  }
  f.fixedForShipping = !f.fixedForShipping;
  render(); saveFrame(f);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RMD STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRMD() {
  const avail = STATE.cages.filter(c=>c.location==='facility').sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
  let cageOpts = avail.map(c=>`<option value="${c.id}">${esc(c.name)} (${hCat(c.height)}, ${c.height}m)</option>`).join('');

  let rmdHTML = STATE.rmdSlots.map((r,idx)=>{
    const cnt = [r.A.cage1,r.A.cage2,r.B.cage1,r.B.cage2].filter(Boolean).length;
    let sidesHTML = SIDES.map(side=>{
      let slotsHTML = ['cage1','cage2'].map((slot,si)=>{
        const cid = r[side][slot];
        const cage = cid ? getCage(cid) : null;
        if (cage) {
          return `<div class="rmd-slot">
            <span class="rmd-slot-label">${si===0?'INSIDE':'OUTSIDE'}</span>
            <div class="rmd-slot-content">
              <span class="rmd-cage-info"><span class="rmd-cage-name">${esc(cage.name)}</span><span class="rmd-cage-detail">${cage.height}m ${hCat(cage.height)}</span></span>
              <button class="remove-btn" onclick="removeFromRMD(${idx},'${side}','${slot}')">√ó</button>
            </div>
          </div>`;
        } else {
          return `<div class="rmd-slot">
            <span class="rmd-slot-label">${si===0?'INSIDE':'OUTSIDE'}</span>
            <select class="rmd-slot" style="flex:1;font-size:11px;padding:4px 8px" onchange="assignToRMD(${idx},'${side}','${slot}',this.value);this.value=''">
              <option value="">‚Äî empty ‚Äî</option>${cageOpts}
            </select>
          </div>`;
        }
      }).join('');
      return `<div style="margin-bottom:8px">
        <div style="font:700 10px var(--font-mono);color:var(--text-muted);margin-bottom:5px">SIDE ${side}</div>
        ${slotsHTML}
      </div>`;
    }).join('');

    return `<div class="card">
      <div class="flex-between" style="margin-bottom:10px">
        <span style="font:700 16px var(--font-mono);color:var(--accent)">RMD-${r.number}</span>
        <span style="font-size:11px;color:var(--text-muted)">${cnt}/4 occupied</span>
      </div>
      ${sidesHTML}
      ${r.A.overridden||r.B.overridden ? '<span class="badge badge-yellow">‚ö† Override Active</span>' : ''}
    </div>`;
  }).join('');

  return `
    <h2 class="section-title">RMD Storage Bays</h2>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Pairing rules: Short+Tall, Medium+Medium, Short+Medium ‚Äî taller cage goes inside. Override available. Side A = top, Side B = bottom.</div>
    <div class="rmd-site-layout">
      ${RMD_LAYOUT.map(row=>{
        let items = row.items.map(item=>{
          const idx = STATE.rmdSlots.findIndex(r=>r.number===item);
          const r = STATE.rmdSlots[idx];
          if(!r) return '';
          const cnt = [r.A.cage1,r.A.cage2,r.B.cage1,r.B.cage2].filter(Boolean).length;

          // Side A: outside (cage2) on top, inside (cage1) below
          // Side B: inside (cage1) on top, outside (cage2) below
          function renderSlot(side, slot, posLabel) {
            const cid = r[side][slot];
            const cage = cid ? getCage(cid) : null;
            if(cage) {
              return '<div class="rmd-slot"><span class="rmd-slot-label">'+posLabel+'</span><div class="rmd-slot-content"><span class="rmd-cage-info"><span class="rmd-cage-name">'+esc(cage.name)+'</span><span class="rmd-cage-detail">'+cage.height+'m '+hCat(cage.height)+'</span></span><button class="remove-btn" onclick="removeFromRMD('+idx+',\''+side+'\',\''+slot+'\')">√ó</button></div></div>';
            } else {
              return '<div class="rmd-slot"><span class="rmd-slot-label">'+posLabel+'</span><select class="rmd-slot" style="flex:1;font-size:11px;padding:4px 8px" onchange="assignToRMD('+idx+',\''+side+'\',\''+slot+'\',this.value);this.value=\'\'"><option value="">‚Äî empty ‚Äî</option>'+cageOpts+'</select></div>';
            }
          }

          let sideA = '<div style="margin-bottom:4px"><div style="font:700 10px var(--font-mono);color:var(--text-muted);margin-bottom:4px">SIDE A</div>'
            + renderSlot('A','cage2','OUTSIDE')
            + renderSlot('A','cage1','INSIDE')
            + '</div>';
          let sideB = '<div><div style="font:700 10px var(--font-mono);color:var(--text-muted);margin-bottom:4px">SIDE B</div>'
            + renderSlot('B','cage1','INSIDE')
            + renderSlot('B','cage2','OUTSIDE')
            + '</div>';

          return '<div class="rmd-site-card"><div class="card"><div class="flex-between" style="margin-bottom:8px"><span style="font:700 16px var(--font-mono);color:var(--accent)">RMD-'+r.number+'</span><span style="font-size:11px;color:var(--text-muted)">'+cnt+'/4</span></div>'+sideA+sideB+(r.A.overridden||r.B.overridden?'<span class="badge badge-yellow">‚ö† Override</span>':'')+'</div></div>';
        }).join('');
        return '<div class="rmd-site-row row-'+row.row+'">'+items+'</div>';
      }).join('')}
    </div>
  `;
}

async function assignToRMD(idx,side,slot,cid) {
  if(!cid) return;
  const r = STATE.rmdSlots[idx];
  const otherSlot = slot==='cage1'?'cage2':'cage1';
  const otherCid = r[side][otherSlot];
  const cage = getCage(cid);
  if (otherCid) {
    const other = getCage(otherCid);
    if (other && cage && !canPairRMD(other,cage)) {
      if (!confirm(`Height pairing ${hCat(cage.height)} + ${hCat(other.height)} not standard. Override?`)) return;
      r[side].overridden = true;
    }
  }
  r[side][slot] = cid;
  cage.location = 'rmd';
  cage.locationDetail = `${r.number}${side}`;
  render();
  await saveCage(cage);
  await saveRMD();
}
async function removeFromRMD(idx,side,slot) {
  const cid = STATE.rmdSlots[idx][side][slot];
  if(!cid) return;
  STATE.rmdSlots[idx][side][slot] = null;
  const c = getCage(cid);
  if(c) { c.location='facility'; c.locationDetail=''; }
  render();
  if(c) await saveCage(c);
  await saveRMD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOVEMENT PLANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let planFormOpen = false;
let planFormType = 'facility-to-frame';
let planWeekStart = (() => { const d=new Date(); d.setDate(d.getDate()-d.getDay()+1); return toISO(d); })();

const MOVE_TYPES = [
  {value:'facility-to-frame', label:'Facility ‚Üí Frame (out of facility)'},
  {value:'frame-to-rmd', label:'Frame ‚Üí RMD Storage'},
  {value:'rmd-to-frame', label:'RMD ‚Üí Frame'},
  {value:'frame-fix-shipping', label:'Fix cage to frame for shipping'},
];

function onPlanTypeChange(val) {
  planFormType = val;
  render();
}

// Called when cage is selected in RMD‚ÜíFrame form ‚Äî auto-selects best fitting frame
function updateFrameSuggestion(cageId) {
  const cage = getCage(cageId);
  const frameEl = document.getElementById('pf-frame');
  if (!cage || !frameEl) return;

  // Find best frame: must fit cage width, prefer smallest adequate frame, check waler
  const sortedFrames = [...STATE.frames]
    .filter(f => f.location === 'facility' && f.cages.length < 2 && cage.width <= f.width)
    .sort((a, b) => {
      // Prefer frames that already have a compatible cage (better space usage)
      const aHas = a.cages.length;
      const bHas = b.cages.length;
      if (aHas !== bHas) return bHas - aHas; // prefer frames that already have one cage
      return a.width - b.width; // then smallest adequate width
    });

  // Waler check ‚Äî prefer frames with waler if needed
  let best = null;
  if (needsWaler(cage)) {
    best = sortedFrames.find(f => f.hasWaler && (f.cages.length === 0 || canFitTwo(getCage(f.cages[0]), cage, f.width)));
  }
  if (!best) {
    best = sortedFrames.find(f => f.cages.length === 0 || canFitTwo(getCage(f.cages[0]), cage, f.width));
  }

  if (best) {
    frameEl.value = best.id;
    // Briefly highlight the dropdown
    frameEl.style.borderColor = 'var(--accent)';
    frameEl.style.background = '#fdfaf0';
    setTimeout(() => { frameEl.style.borderColor = ''; frameEl.style.background = ''; }, 2000);
  }
}

function renderPlanner() {
  const typeOpts = MOVE_TYPES.map(t=>`<option value="${t.value}" ${planFormType===t.value?'selected':''}>${t.label}</option>`).join('');

  // Build cage options based on movement type
  let cageOpts = '';
  let frameOpts = '';
  let showFrame = true;
  let showRmd = false;

  if (planFormType === 'facility-to-frame') {
    // Cages in facility
    cageOpts = [...STATE.cages.filter(c=>c.location==='facility')].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(c=>`<option value="${c.id}">${esc(c.name)} (${hCat(c.height)}, ${c.width}m)</option>`).join('');
    frameOpts = STATE.frames.filter(f=>f.location==='facility'&&f.cages.length<2).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>`<option value="${f.id}">${esc(f.name)} (${f.width}m)</option>`).join('');
    showRmd = false;
  } else if (planFormType === 'frame-to-rmd') {
    // Cages in frames
    cageOpts = [...STATE.cages.filter(c=>c.location==='frame')].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(c=>`<option value="${c.id}">${esc(c.name)} (${c.locationDetail})</option>`).join('');
    showFrame = false;
    showRmd = true;
  } else if (planFormType === 'rmd-to-frame') {
    // Cages in RMD
    cageOpts = [...STATE.cages.filter(c=>c.location==='rmd')].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(c=>`<option value="${c.id}">${esc(c.name)} (${c.locationDetail})</option>`).join('');
    frameOpts = STATE.frames.filter(f=>f.location==='facility'&&f.cages.length<2).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>`<option value="${f.id}">${esc(f.name)} (${f.width}m)</option>`).join('');
    showRmd = false;
  } else if (planFormType === 'frame-fix-shipping') {
    // Only cages that are alone in a frame (exactly 1 cage in frame)
    const singleCageFrames = STATE.frames.filter(f=>f.location==='facility' && f.cages.length===1 && !f.fixedForShipping);
    cageOpts = singleCageFrames.map(f=>{
      const c = getCage(f.cages[0]);
      return c ? `<option value="${c.id}">${esc(c.name)} (in ${esc(f.name)})</option>` : '';
    }).filter(Boolean).join('');
    showFrame = false;
    showRmd = false;
  }

  // Build RMD slot dropdown options for Frame‚ÜíRMD
  let rmdSlotOpts = '';
  if (planFormType === 'frame-to-rmd') {
    const seenSides = new Set();
    const sortedRmd = [...STATE.rmdSlots].sort((a,b)=>a.number-b.number);
    sortedRmd.forEach(r => {
      [...SIDES].sort().forEach(side => {
        const sideKey = r.number + side;
        if (seenSides.has(sideKey)) return;
        const hasFree = !r[side].cage1 || !r[side].cage2;
        if (!hasFree) return;
        seenSides.add(sideKey);
        const occupiedCount = [r[side].cage1, r[side].cage2].filter(Boolean).length;
        const otherCid = r[side].cage1 || r[side].cage2;
        const other = otherCid ? getCage(otherCid) : null;
        const pairNote = other ? ` ‚Äî pairs with ${other.name} (${hCat(other.height)})` : ` ‚Äî empty side`;
        const freeSlots = occupiedCount === 0 ? '2 free' : '1 slot free';
        rmdSlotOpts += `<option value="${sideKey}">RMD-${r.number}${side} (${freeSlots}${pairNote})</option>`;
      });
    });
    if (!rmdSlotOpts) rmdSlotOpts = '<option value="" disabled>No free RMD slots</option>';
  }

  // For RMD‚ÜíFrame, annotate frames with suitability note
  if (planFormType === 'rmd-to-frame') {
    frameOpts = STATE.frames.filter(f => f.location === 'facility' && f.cages.length < 2).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f => {
      const existing = f.cages.length === 1 ? getCage(f.cages[0]) : null;
      const note = existing ? ` [has ${existing.name}]` : ' [empty]';
      return `<option value="${f.id}">${esc(f.name)} (${f.width}m${f.hasWaler ? ' üî©' : ''})${note}</option>`;
    }).join('');
  }

  let formHTML = '';
  if (planFormOpen) {
    const cageOnChange = planFormType === 'rmd-to-frame' ? 'onchange="updateFrameSuggestion(this.value)"' : '';
    formHTML = `<div class="card">
      <div class="form-grid form-grid-3">
        <div><label>Movement Type</label><select id="pf-type" onchange="onPlanTypeChange(this.value)">${typeOpts}</select></div>
        <div><label>Cage</label><select id="pf-cage" ${cageOnChange}><option value="">Select cage...</option>${cageOpts}</select></div>
        ${showFrame ? `<div><label>Frame${planFormType==='rmd-to-frame'?' <span style="font-size:9px;color:var(--accent)">(auto-highlights on cage select)</span>':''}</label><select id="pf-frame"><option value="">Select frame...</option>${frameOpts}</select></div>` : '<div id="pf-frame-placeholder"></div>'}
        <div><label>Date</label><input id="pf-date" type="date" value="${todayStr()}"/></div>
        <div><label>Shift</label><select id="pf-shift"><option value="day">Day Shift</option><option value="night">Night Shift</option></select></div>
        ${showRmd ? `<div><label>RMD Slot (Suggested)</label><select id="pf-rmd"><option value="">Select slot...</option>${rmdSlotOpts}</select></div>` : '<div id="pf-rmd-placeholder"></div>'}
        <div style="grid-column:span 3"><label>Notes</label><input id="pf-notes"/></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addMovement()">Add to Plan</button>
        <button class="btn btn-secondary" onclick="planFormOpen=false;render()">Cancel</button>
      </div>
    </div>`;
  }

  // 2-week days
  const ws = new Date(planWeekStart + 'T12:00:00');
  let weekDays = [];
  for(let i=0;i<14;i++) { const d=new Date(ws); d.setDate(d.getDate()+i); weekDays.push(toISO(d)); }

  // Build departure-date index for visible window
  const depByDay = {};
  STATE.cages.forEach(c => {
    if (c.departureDate && c.location === 'facility') {
      if (!depByDay[c.departureDate]) depByDay[c.departureDate] = [];
      depByDay[c.departureDate].push(c.name);
    }
  });

  function renderWeekDay(day) {
    const dayMoves = STATE.plannedMovements.filter(m=>m.date===day);
    const pending = dayMoves.filter(m=>!m.completed).length;
    const isToday = day===todayStr();
    const dow = new Date(day+'T12:00:00').getDay();
    const isWeekend = dow===0||dow===6;
    const hasMoves = dayMoves.length > 0;
    const departures = depByDay[day] || [];

    let movesHTML = dayMoves.map(m=>`
      <div class="week-move-item ${m.completed?'completed':''}" title="${esc(m.notes||m.description)}">
        ${m.shift==='night'?'üåô ':''}${esc(m.description.slice(0,22))}
      </div>
    `).join('');

    return `<div class="week-day ${isToday?'today':''} ${isWeekend&&!hasMoves?'weekend':''} ${hasMoves?'has-moves':''}">
      <div class="week-day-hdr">${fmtShort(day)}</div>
      ${pending>0 ? `<div class="week-move-count ${pending>MAX_MOVES?'over-limit':''}" style="color:${pending>MAX_MOVES?'var(--red)':'var(--green)'}">${pending} moves${pending>MAX_MOVES?' ‚ö† OVER':''}</div>` : ''}
      ${departures.map(n=>`<div style="font-size:9px;padding:2px 4px;margin-bottom:1px;border-radius:3px;background:#fce8e8;color:var(--red);border:1px solid #e8b0b0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="Cage ${n} leaves facility">üöö ${esc(n)}</div>`).join('')}
      ${movesHTML}
    </div>`;
  }
  const week1HTML = weekDays.slice(0,7).map(renderWeekDay).join('');
  const week2HTML = weekDays.slice(7).map(renderWeekDay).join('');

  // All movements table
  let sorted = [...STATE.plannedMovements].sort((a,b)=>a.date.localeCompare(b.date));
  let tableRows = sorted.length === 0
    ? '<tr><td colspan="7" class="empty-msg" style="text-align:center;padding:20px">No movements planned</td></tr>'
    : sorted.map(m=>`
      <tr style="opacity:${m.completed?'0.5':'1'}">
        <td style="font-family:var(--font-mono)">${fmt(m.date)}</td>
        <td>${m.shift==='night'?'üåô Night':'‚òÄ Day'}</td>
        <td>${esc(m.type)}</td>
        <td style="font-weight:600;color:var(--text-primary)">${esc(m.description)}</td>
        <td style="color:var(--text-muted)">${esc(m.notes||'')}</td>
        <td><span class="badge ${m.completed?'badge-green':'badge-yellow'}">${m.completed?'Done':'Pending'}</span></td>
        <td style="white-space:nowrap">
          ${!m.completed ? `<button class="btn btn-primary btn-xs" onclick="completeMove('${m.id}')">‚úì</button> ` : ''}
          <button class="btn btn-danger btn-xs" onclick="deleteMove('${m.id}')">Del</button>
        </td>
      </tr>
    `).join('');

  // Build RMD & Frame summary sidebar for planner
  let rmdSummary = STATE.rmdSlots.map(r => {
    const slots4 = [
      {side:'A', slot:'cage2', lbl:'A Outside'},
      {side:'A', slot:'cage1', lbl:'A Inside'},
      {side:'B', slot:'cage1', lbl:'B Inside'},
      {side:'B', slot:'cage2', lbl:'B Outside'},
    ];
    const occupied = slots4.map(s => {
      const cid = r[s.side][s.slot];
      const c = cid ? getCage(cid) : null;
      return { ...s, c };
    });
    const hasAnyCage = occupied.some(s => s.c);
    if (!hasAnyCage) return `<div style="padding:6px 8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;opacity:0.45">
      <div style="font:700 11px var(--font-mono);color:var(--text-muted)">RMD-${r.number} ‚Äî empty</div>
    </div>`;
    const slotsHTML = occupied.map(s => {
      if (!s.c) return `<div style="display:flex;justify-content:space-between;padding:3px 6px;font-size:11px;color:var(--text-muted);font-style:italic">
        <span>${s.lbl}</span><span>‚Äî</span>
      </div>`;
      // Determine minimum frame size needed for shipping
      const minFrame = FRAME_WIDTHS.find(w => w >= s.c.width) || FRAME_WIDTHS[FRAME_WIDTHS.length-1];
      const walerNote = needsWaler(s.c) ? ' + waler' : '';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 6px;background:${s.side==='A'?'rgba(37,99,176,0.06)':'rgba(26,138,74,0.06)'};border-radius:4px;margin-bottom:2px">
        <span style="font:600 11px var(--font-mono);color:var(--text-primary)">${esc(s.c.name)}</span>
        <span style="font-size:10px;color:var(--text-muted)">${s.lbl} ¬∑ ${s.c.height}m ¬∑ ${hCat(s.c.height)}</span>
        <span style="font-size:9px;background:#fdf5dc;color:var(--yellow);border:1px solid #e0d8a0;border-radius:3px;padding:1px 5px;margin-left:4px" title="Minimum frame size needed for shipping">‚ñ£ ${minFrame}m${walerNote}</span>
      </div>`;
    }).join('');
    return `<div style="padding:8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;margin-bottom:6px">
      <div style="font:700 12px var(--font-mono);color:var(--accent);margin-bottom:5px">RMD-${r.number} <span style="font-weight:400;color:var(--text-muted);font-size:10px">${occupied.filter(s=>s.c).length}/4 occupied</span></div>
      ${slotsHTML}
    </div>`;
  }).join('');

  let frameSummary = STATE.frames.filter(f=>f.cages.length>0 && f.location==='facility').map(f=>{
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    let cageChips = fCages.map(c=>`<span style="font-size:11px">${esc(c.name)} (${c.weight}t)</span>`).join(', ');
    return `<div class="planner-frame-item">
      <span style="font-weight:700;font-family:var(--font-mono)">${esc(f.name)}</span>
      <span>${cageChips}</span>
      <span style="font-size:10px;color:var(--text-muted)">${f.width}m${f.hasWaler?' üî©':''}${f.fixedForShipping?' ‚úìSHIP':''}</span>
    </div>`;
  }).join('') || '<div class="empty-msg">No cages in frames</div>';

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Movement Planner</h2>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="openDashboardWindow()" title="Open Dashboard in a second window">üìä Open Dashboard</button>
        <button class="btn btn-secondary btn-sm" onclick="autoplanDepartures()" title="Auto-plan cages due to leave the facility into suitable frames">‚ö° Auto-Plan Departures</button>
        <button class="btn btn-danger btn-sm" onclick="blankCanvasPlanner()" title="Clear all planned movements and reset calendar">üóë Blank Canvas</button>
        <button class="btn btn-primary" onclick="planFormOpen=!planFormOpen;render()">+ Plan Movement</button>
      </div>
    </div>
    ${formHTML}
    <div class="planner-layout" style="grid-template-columns:1fr 420px">
      <div>
        <div class="card">
          <div class="week-nav">
            <button class="btn btn-secondary btn-sm" onclick="shiftWeek(-1)">‚óÑ Prev 2 Weeks</button>
            <span class="week-label">${fmt(weekDays[0])} ‚Äî ${fmt(weekDays[13])}</span>
            <button class="btn btn-secondary btn-sm" onclick="shiftWeek(1)">Next 2 Weeks ‚ñ∫</button>
          </div>
          <div style="display:flex;gap:12px;margin-bottom:8px;font-size:10px;align-items:center">
            <span style="padding:2px 6px;background:#fce8e8;color:var(--red);border:1px solid #e8b0b0;border-radius:3px">üöö Cage leaves facility</span>
            <span style="color:var(--text-muted)">Shown in calendar from cage "Leaves Facility" dates</span>
          </div>
          <div style="font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Week 1</div>
          <div class="week-grid" style="margin-bottom:10px">${week1HTML}</div>
          <div style="font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Week 2</div>
          <div class="week-grid">${week2HTML}</div>
        </div>
        <div class="card">
          <div class="card-title">All Planned Movements</div>
          <div style="overflow-x:auto">
            <table><thead><tr>
              <th>Date</th><th>Shift</th><th>Type</th><th>Description</th><th>Notes</th><th>Status</th><th>Actions</th>
            </tr></thead><tbody>${tableRows}</tbody></table>
          </div>
        </div>
      </div>
      <div class="planner-sidebar" style="max-height:calc(100vh - 140px);overflow-y:auto">
        <div class="card">
          <div class="card-title">Cages in RMD Storage</div>
          <div>
          ${rmdSummary}
          </div>
        </div>
        <div class="card">
          <div class="card-title">Cages in Frames (at facility)</div>
          ${frameSummary}
        </div>
      </div>
    </div>
  `;
}

function openDashboardWindow() {
  // Serialize current page HTML and open as blob so it has same-origin access
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const win = window.open(url, 'cage-tracker-dashboard', 'width=1280,height=860,scrollbars=yes,resizable=yes');
  if (!win) { alert('Pop-up blocked. Please allow pop-ups for this page.'); return; }
  win.addEventListener('load', () => {
    try {
      // Sync localStorage state to the new window
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) win.localStorage.setItem(STORAGE_KEY, data);
      // Switch to dashboard tab
      setTimeout(() => {
        try { win.activeTab = 'dashboard'; win.render(); } catch(e) {}
      }, 100);
    } catch(e) { console.warn('Dashboard sync error:', e); }
  });
}

function addMovement() {
  const type = document.getElementById('pf-type').value;
  const cageId = document.getElementById('pf-cage').value;
  const frameEl = document.getElementById('pf-frame');
  const frameId = frameEl ? frameEl.value : '';
  const date = document.getElementById('pf-date').value;
  const shift = document.getElementById('pf-shift').value;
  const rmdEl = document.getElementById('pf-rmd');
  const rmdSlot = rmdEl ? rmdEl.value.trim() : '';
  const notes = document.getElementById('pf-notes').value.trim();
  if(!date) return alert('Please select a date.');

  const cage = getCage(cageId);

  // For fix-shipping, auto-find the frame the cage is in
  let resolvedFrameId = frameId;
  if (type === 'frame-fix-shipping' && cage) {
    const autoFrame = STATE.frames.find(f=>f.cages.includes(cageId));
    if(autoFrame) resolvedFrameId = autoFrame.id;
  }

  const frame = getFrame(resolvedFrameId);
  const parts = [];
  if(cage) parts.push(cage.name);
  if(frame) parts.push(frame.name);
  if(rmdSlot) parts.push('RMD-'+rmdSlot);
  const desc = parts.join(' ‚Üí ') || notes || 'Movement';
  const typeLabel = MOVE_TYPES.find(t=>t.value===type)?.label || type;

  const move = {
    id:uid(), type:typeLabel, typeKey:type, cageId, frameId:resolvedFrameId, rmdSlot,
    date, shift, notes, completed:false, description:desc, createdAt:new Date().toISOString()
  };
  STATE.plannedMovements.push(move);
  planFormOpen = false;
  render();
  await addMovementToAPI(move);
}
function completeMove(id) {
  const m = STATE.plannedMovements.find(x=>x.id===id);
  if(!m) return;

  const cage = getCage(m.cageId);
  const frame = getFrame(m.frameId);

  // Execute the actual movement based on type
  if (m.typeKey === 'facility-to-frame' && cage && frame) {
    // Clear cage from any current location
    clearCageFromCurrentLocation(cage.id);
    // Check frame capacity
    if (frame.cages.length >= 2) { alert(`Cannot complete: ${frame.name} already has max cages.`); return; }
    if (frame.cages.length === 1) {
      const existing = getCage(frame.cages[0]);
      if (existing && !canFitTwo(existing, cage, frame.width)) {
        alert(`Cannot complete: cages don't fit together in ${frame.name}.`); return;
      }
    }
    frame.cages.push(cage.id);
    cage.location = 'frame';
    cage.locationDetail = frame.name;
    cage.departureDate = null; // cage has left facility
  }
  else if (m.typeKey === 'frame-to-rmd' && cage && m.rmdSlot) {
    // Parse RMD slot like "3A" or "3a"
    const rmdMatch = m.rmdSlot.match(/^(\d+)\s*([ABab])/);
    if (rmdMatch) {
      const rmdNum = parseInt(rmdMatch[1]);
      const side = rmdMatch[2].toUpperCase();
      const rmdIdx = STATE.rmdSlots.findIndex(r=>r.number===rmdNum);
      if (rmdIdx !== -1) {
        const r = STATE.rmdSlots[rmdIdx];
        const slot = !r[side].cage1 ? 'cage1' : !r[side].cage2 ? 'cage2' : null;
        if (!slot) { alert(`Cannot complete: RMD-${rmdNum}${side} is full.`); return; }
        clearCageFromCurrentLocation(cage.id);
        r[side][slot] = cage.id;
        cage.location = 'rmd';
        cage.locationDetail = `RMD-${rmdNum}${side}`;
      }
    } else {
      // Just move to facility if can't parse RMD
      clearCageFromCurrentLocation(cage.id);
      cage.location = 'facility';
      cage.locationDetail = '';
    }
  }
  else if (m.typeKey === 'rmd-to-frame' && cage && frame) {
    clearCageFromCurrentLocation(cage.id);
    if (frame.cages.length >= 2) { alert(`Cannot complete: ${frame.name} already has max cages.`); return; }
    if (frame.cages.length === 1) {
      const existing = getCage(frame.cages[0]);
      if (existing && !canFitTwo(existing, cage, frame.width)) {
        alert(`Cannot complete: cages don't fit together in ${frame.name}.`); return;
      }
    }
    frame.cages.push(cage.id);
    cage.location = 'frame';
    cage.locationDetail = frame.name;
    cage.departureDate = null;
  }
  else if (m.typeKey === 'frame-fix-shipping' && frame) {
    if (frame.cages.length === 1) {
      const c = getCage(frame.cages[0]);
      if (c && needsWaler(c) && !frame.hasWaler) {
        alert(`Cannot complete: cage ${c.name} is ${c.length}m (< 6.5m) and requires a waler.`); return;
      }
      frame.fixedForShipping = true;
    } else {
      alert('Frame must have exactly 1 cage to fix for shipping.'); return;
    }
  }

  // Clear departure date whenever a cage physically leaves the facility
  if (cage && cage.location !== 'facility') {
    cage.departureDate = null;
  }

  m.completed = true;
  m.completedAt = new Date().toISOString();
  render();
  await updateMovementInAPI(m);
  if (cage) await saveCage(cage);
  if (frame) await saveFrame(frame);
  await saveRMD();
}
function autoplanDepartures() {
  // Find all cages in 'facility' that have a departureDate set
  const dueToLeave = STATE.cages.filter(c => c.location === 'facility' && c.departureDate);

  if (dueToLeave.length === 0) {
    return alert('No facility cages have a departure date set. Edit cages to add expected departure dates.');
  }

  // Sort by departure date ascending
  dueToLeave.sort((a, b) => a.departureDate.localeCompare(b.departureDate));

  const warnings = [];
  const newMovements = [];
  const DAILY_LIMIT = STATE.settings.movementsPerDay || MAX_MOVES;

  // Build daily count from existing planned movements
  const existingCounts = {};
  STATE.plannedMovements.forEach(m => {
    if (!m.completed) existingCounts[m.date] = (existingCounts[m.date] || 0) + 1;
  });

  // Track frames being used across this auto-plan run (in addition to already loaded frames)
  // A frame is "in use" if it already has cages, or we've assigned it in this run
  const frameAssignments = {}; // cageId -> frameId (planned this run)

  // Available frames at facility (not currently fixed for shipping)
  const facilityFrames = STATE.frames.filter(f => f.location === 'facility' && !f.fixedForShipping);

  // Helper to find the best fitting frame for a cage, considering this run's assignments
  function findFrameForCage(cage) {
    const cageNeedsWaler = needsWaler(cage);
    const sorted = [...facilityFrames].sort((a, b) => a.width - b.width);

    // Count how many cages are virtually assigned to each frame this run
    const virtualCounts = {};
    Object.values(frameAssignments).forEach(fid => {
      virtualCounts[fid] = (virtualCounts[fid] || 0) + 1;
    });

    for (const f of sorted) {
      if (cage.width > f.width) continue;
      const realCount = f.cages.length;
      const virtualExtra = virtualCounts[f.id] || 0;
      const totalCount = realCount + virtualExtra;
      if (totalCount >= 2) continue;

      // Check waler
      if (cageNeedsWaler && !f.hasWaler) continue;

      // Check if pairing fits
      if (totalCount === 1) {
        // Find the partner cage (real or planned)
        const partnerCid = f.cages[0] || Object.keys(frameAssignments).find(cid => frameAssignments[cid] === f.id);
        if (partnerCid) {
          const partner = getCage(partnerCid);
          if (partner && !canFitTwo(partner, cage, f.width)) continue;
        }
      }
      return f;
    }

    // Relax waler restriction
    for (const f of sorted) {
      if (cage.width > f.width) continue;
      const realCount = f.cages.length;
      const virtualExtra = (Object.values(frameAssignments).filter(fid => fid === f.id).length);
      const totalCount = realCount + virtualExtra;
      if (totalCount >= 2) continue;
      if (totalCount === 1) {
        const partnerCid = f.cages[0] || Object.keys(frameAssignments).find(cid => frameAssignments[cid] === f.id);
        if (partnerCid) {
          const partner = getCage(partnerCid);
          if (partner && !canFitTwo(partner, cage, f.width)) continue;
        }
      }
      return f;
    }
    return null;
  }

  // Helper: find a free working day on or before a target date, respecting daily limits
  function findWorkingDay(targetDateStr, lookBackDays = 7) {
    // Try from target date backwards
    let d = new Date(targetDateStr + 'T12:00:00');
    for (let i = 0; i <= lookBackDays; i++) {
      const attempt = new Date(d);
      attempt.setDate(attempt.getDate() - i);
      const dow = attempt.getDay();
      if (dow === 0 || dow === 6) continue; // skip weekends
      const iso = toISO(attempt);
      if ((existingCounts[iso] || 0) < DAILY_LIMIT) return iso;
    }
    // Fallback: try days after target date
    d = new Date(targetDateStr + 'T12:00:00');
    for (let i = 1; i <= lookBackDays; i++) {
      const attempt = new Date(d);
      attempt.setDate(attempt.getDate() + i);
      const dow = attempt.getDay();
      if (dow === 0 || dow === 6) continue;
      const iso = toISO(attempt);
      if ((existingCounts[iso] || 0) < DAILY_LIMIT) return iso;
    }
    return targetDateStr; // last resort
  }

  let planned = 0;
  let skipped = 0;

  for (const cage of dueToLeave) {
    // Check if this cage already has a planned facility-to-frame movement
    const alreadyPlanned = STATE.plannedMovements.some(m =>
      m.cageId === cage.id && !m.completed &&
      (m.typeKey === 'facility-to-frame' || (m.type && m.type.includes('Facility') && m.type.includes('Frame')))
    );
    if (alreadyPlanned) {
      skipped++;
      continue;
    }

    // Find a suitable frame
    const frame = findFrameForCage(cage);
    if (!frame) {
      warnings.push(`‚ö† No suitable frame found for cage ${cage.name} (${cage.width}m wide${needsWaler(cage) ? ' + needs waler' : ''}). Check frame availability.`);
      continue;
    }

    // Schedule the movement on the departure date itself (or nearest working day)
    const depDate = cage.departureDate;
    const plannedDate = findWorkingDay(depDate, 10);

    // Register in existingCounts
    existingCounts[plannedDate] = (existingCounts[plannedDate] || 0) + 1;
    frameAssignments[cage.id] = frame.id;

    const walerNote = needsWaler(cage) && !frame.hasWaler ? ' [‚ö† waler may be needed]' : '';
    const desc = `${cage.name} ‚Üí ${frame.name} (${frame.width}m${frame.hasWaler ? ' üî©' : ''})`;

    newMovements.push({
      id: uid(),
      type: 'Facility ‚Üí Frame',
      typeKey: 'facility-to-frame',
      cageId: cage.id,
      frameId: frame.id,
      date: plannedDate,
      shift: 'day',
      notes: `Auto-planned ¬∑ Departs ${fmt(depDate)}${walerNote}`,
      completed: false,
      description: desc,
      createdAt: new Date().toISOString()
    });

    // Also add a fix-for-shipping step if only 1 cage will be in frame after this
    // (schedule it on the same day, it counts as 1 move)
    // We'll let the user manually fix ‚Äî don't auto-generate fix steps to avoid confusion

    planned++;
  }

  if (planned === 0 && skipped === 0 && warnings.length === 0) {
    return alert('No cages need auto-planning at this time.');
  }

  STATE.plannedMovements.push(...newMovements);

  let msg = `‚úÖ Auto-planned ${planned} movement${planned !== 1 ? 's' : ''}.`;
  if (skipped > 0) msg += ` ${skipped} cage${skipped !== 1 ? 's' : ''} already had planned movements (skipped).`;
  if (warnings.length > 0) msg += '\n\n' + warnings.join('\n');

  render();
  alert(msg);
  await Promise.all(newMovements.map(m => addMovementToAPI(m)));
}

async function blankCanvasPlanner() {
  const count = STATE.plannedMovements.length;
  if (count === 0) return alert('No planned movements to clear.');
  if (!confirm(`Clear all ${count} planned movement${count!==1?'s':''}? This cannot be undone.`)) return;
  STATE.plannedMovements = [];
  planWeekStart = (() => { const d=new Date(); d.setDate(d.getDate()-d.getDay()+1); return toISO(d); })();
  render();
  await deleteAllMovementsFromAPI();
}

async function deleteMove(id) {
  STATE.plannedMovements = STATE.plannedMovements.filter(m=>m.id!==id);
  render();
  await deleteMovementFromAPI(id);
}
function shiftWeek(dir) {
  const d = new Date(planWeekStart+'T12:00:00');
  d.setDate(d.getDate()+dir*14);
  planWeekStart = toISO(d);
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHIPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let shipFormOpen = false;
let shipSelected = [];

function renderShipping() {
  const ready = STATE.frames.filter(f=>f.fixedForShipping && f.location==='facility');

  let readyHTML = ready.length === 0
    ? '<div class="empty-msg">No frames fixed for shipping. Go to Frames tab to fix cages to frames.</div>'
    : '<div style="display:flex;flex-wrap:wrap;gap:0">' + ready.map(f=>{
      const cage = f.cages.map(cid=>getCage(cid)).filter(Boolean)[0];
      const sel = shipSelected.includes(f.id);
      return `<div class="ship-frame-select ${sel?'selected':''}" onclick="${shipFormOpen?`toggleShipSelect('${f.id}')`:''}" style="cursor:${shipFormOpen?'pointer':'default'};opacity:${shipFormOpen?1:0.7}">
        <div><div class="ship-frame-name">${esc(f.name)}</div>${cage ? `<div class="ship-frame-cage">${esc(cage.name)}${f.hasWaler?' üî©':''}</div>` : ''}</div>
      </div>`;
    }).join('') + '</div>';

  let formHTML = '';
  if (shipFormOpen) {
    formHTML = `<div class="card">
      <div class="form-grid form-grid-2">
        <div><label>Ship Date</label><input id="sf-date" type="date" value="${todayStr()}"/></div>
        <div><label>Notes</label><input id="sf-notes"/></div>
      </div>
      <div style="font-size:12px;color:var(--text-muted);margin:8px 0">Selected: ${shipSelected.length} frames ‚Äî click frames above to select</div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="createShipment()">Ship ${shipSelected.length} Frames</button>
        <button class="btn btn-secondary" onclick="shipFormOpen=false;shipSelected=[];render()">Cancel</button>
      </div>
    </div>`;
  }

  let historyHTML = STATE.shipments.length === 0
    ? '<div class="empty-msg">No shipments yet</div>'
    : [...STATE.shipments].sort((a,b)=>b.date.localeCompare(a.date)).map(sh=>{
      const statusBadge = {['in-transit']:'blue', delivered:'purple', ['frames-returned']:'green'}[sh.status]||'accent';
      const frameNames = sh.frameIds.map(fid=>{ const f=getFrame(fid); return f?f.name:'?'; }).join(', ');
      let actions = '';
      if(sh.status==='in-transit') actions = `<button class="btn btn-secondary btn-xs" onclick="markDelivered('${sh.id}')">Mark Delivered</button>`;
      if(sh.status==='delivered') actions = `<button class="btn btn-secondary btn-xs" onclick="returnFrames('${sh.id}')">Frames Returned</button>`;
      return `<div class="shipment-row">
        <div class="flex-between">
          <div>
            <span style="font-weight:600;color:var(--text-primary)">${fmt(sh.date)}</span>
            <span style="margin-left:12px;font-size:12px;color:var(--text-muted)">${sh.frameIds.length} frames: ${esc(frameNames)}</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="badge badge-${statusBadge}">${sh.status}</span>
            ${actions}
          </div>
        </div>
        ${sh.notes ? `<div style="font-size:12px;color:var(--text-muted);margin-top:4px">${esc(sh.notes)}</div>` : ''}
      </div>`;
    }).join('');

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Shipping Management</h2>
      <button class="btn btn-primary" onclick="shipFormOpen=!shipFormOpen;shipSelected=[];render()">+ New Shipment</button>
    </div>
    <div class="card">
      <div class="card-title">Ready to Ship (${ready.length} frames fixed)</div>
      ${readyHTML}
    </div>
    ${formHTML}
    <div class="card">
      <div class="flex-between" style="margin-bottom:12px">
        <div class="card-title" style="margin:0">Shipment History</div>
        ${STATE.shipments.length > 0 ? `<button class="btn btn-danger btn-sm" onclick="clearShipmentHistory()">üóë Clear History</button>` : ''}
      </div>
      ${historyHTML}
    </div>
  `;
}

function toggleShipSelect(fid) {
  if(shipSelected.includes(fid)) shipSelected=shipSelected.filter(id=>id!==fid);
  else shipSelected.push(fid);
  render();
}
async function createShipment() {
  if(shipSelected.length===0) return alert('Select frames to ship.');
  const date = document.getElementById('sf-date').value;
  const notes = document.getElementById('sf-notes').value.trim();
  const shipment = {id:uid(), date, notes, frameIds:[...shipSelected], status:'in-transit', createdAt:new Date().toISOString()};
  STATE.shipments.push(shipment);
  const updatedFrames = [];
  const updatedCages = [];
  shipSelected.forEach(fid=>{
    const f=getFrame(fid);
    f.location='boat';
    updatedFrames.push(f);
    f.cages.forEach(cid=>{ const c=getCage(cid); if(c){c.location='shipped';c.locationDetail='In transit'; updatedCages.push(c);} });
  });
  shipFormOpen=false; shipSelected=[];
  render();
  await addShipmentToAPI(shipment);
  await Promise.all(updatedFrames.map(f => saveFrame(f)));
  await Promise.all(updatedCages.map(c => saveCage(c)));
}
async function markDelivered(sid) {
  const sh = STATE.shipments.find(s=>s.id===sid);
  sh.status = 'delivered';
  const updatedFrames = [];
  sh.frameIds.forEach(fid=>{ const f=getFrame(fid); if(f) { f.location='client'; updatedFrames.push(f); } });
  render();
  await updateShipmentInAPI(sh);
  await Promise.all(updatedFrames.map(f => saveFrame(f)));
}
async function clearShipmentHistory() {
  const count = STATE.shipments.length;
  if (count === 0) return;
  if (!confirm(`Clear all ${count} shipment record${count!==1?'s':''}? This cannot be undone.`)) return;
  const ids = STATE.shipments.map(s=>s.id);
  STATE.shipments = [];
  render();
  await Promise.all(ids.map(id => deleteShipmentFromAPI(id)));
}

async function returnFrames(sid) {
  const sh = STATE.shipments.find(s=>s.id===sid);
  sh.status = 'frames-returned';
  const updatedFrames = [];
  sh.frameIds.forEach(fid=>{
    const f=getFrame(fid);
    if(f){ f.location='facility'; f.cages=[]; f.fixedForShipping=false; f.hasWaler=false; updatedFrames.push(f); }
  });
  render();
  await updateShipmentInAPI(sh);
  await Promise.all(updatedFrames.map(f => saveFrame(f)));
}

async function returnFromClient(fid) {
  const f = getFrame(fid);
  if (!f) return;
  const updatedCages = [];
  f.cages.forEach(cid => {
    const c = getCage(cid);
    if (c) { c.location = 'facility'; c.locationDetail = ''; c.departureDate = null; updatedCages.push(c); }
  });
  f.cages = [];
  f.fixedForShipping = false;
  f.hasWaler = false;
  f.location = 'boat';
  render();
  await saveFrame(f);
  await Promise.all(updatedCages.map(c => saveCage(c)));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let reportFrom = todayStr();
let reportTo = (() => { const d=new Date(); d.setDate(d.getDate()+7); return toISO(d); })();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW / PRESENTATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview() {
  const chipClass = (h) => hCat(h).toLowerCase();
  const cageChip = (c) => `<span class="overview-cage-chip ${chipClass(c.height)}">${esc(c.name)}</span>`;

  // RMD section - spatial layout, A on top, B on bottom, inside slots face each other
  let rmdRows = RMD_LAYOUT.map(row=>{
    let items = row.items.map(item=>{
      const r = getRMDByNum(item);
      if(!r) return '';
      // Side A: outside (cage2) on top row, inside (cage1) on bottom row
      // Side B: inside (cage1) on top row, outside (cage2) on bottom row
      function chipOrEmpty(side, slot) {
        const cid = r[side][slot];
        if(!cid) return '';
        const c = getCage(cid);
        return c ? cageChip(c) : '';
      }
      let aOut = chipOrEmpty('A','cage2');
      let aIn = chipOrEmpty('A','cage1');
      let bIn = chipOrEmpty('B','cage1');
      let bOut = chipOrEmpty('B','cage2');

      return `<div style="flex:0 0 auto;min-width:160px">
        <div style="font:700 13px var(--font-mono);color:var(--accent);text-align:center;margin-bottom:4px">RMD-${item}</div>
        <div class="overview-side-box" style="margin-bottom:2px">
          <div class="overview-side-label">A outside</div>${aOut || '<span style="font-size:10px;color:var(--text-muted)">‚Äî</span>'}
        </div>
        <div class="overview-side-box" style="margin-bottom:2px;border-color:var(--accent);border-style:dashed">
          <div class="overview-side-label">A inside / B inside</div>${aIn} ${bIn || ''} ${!aIn && !bIn ? '<span style="font-size:10px;color:var(--text-muted)">‚Äî</span>' : ''}
        </div>
        <div class="overview-side-box">
          <div class="overview-side-label">B outside</div>${bOut || '<span style="font-size:10px;color:var(--text-muted)">‚Äî</span>'}
        </div>
      </div>`;
    }).join('');
    return `<div class="rmd-site-row row-${row.row}">${items}</div>`;
  }).join('');

  // Frames with cages
  let framesWithCages = STATE.frames.filter(f=>f.cages.length>0).map(f=>{
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    const cls = f.fixedForShipping ? 'shipping' : 'has-cage';
    let badges = `<div class="overview-frame-badges">`;
    badges += `<span class="badge badge-blue" style="font-size:9px;padding:1px 6px">${f.width}m</span>`;
    if(f.hasWaler) badges += `<span class="badge badge-blue" style="font-size:9px;padding:1px 6px">üî©</span>`;
    if(f.fixedForShipping) badges += `<span class="badge badge-accent" style="font-size:9px;padding:1px 6px">SHIP</span>`;
    const locBdg = f.location!=='facility' ? `<span class="badge badge-purple" style="font-size:9px;padding:1px 6px">${f.location}</span>` : '';
    badges += locBdg + `</div>`;
    let cageInfo = fCages.map(c=>`${cageChip(c)} <span style="font-size:10px;color:var(--text-muted)">${c.height}m √ó ${c.width}m √ó ${c.length}m | ${c.weight}t</span>`).join('<br/>');
    return `<div class="overview-frame-card ${cls}">
      <div class="overview-frame-name">${esc(f.name)}</div>
      <div class="overview-frame-info">${cageInfo}</div>
      ${badges}
    </div>`;
  }).join('') || '<div class="empty-msg">No cages in any frames</div>';

  // Empty frames at facility
  let emptyFrames = STATE.frames.filter(f=>f.cages.length===0 && f.location==='facility');
  let emptyFramesSummary = emptyFrames.length > 0
    ? `<div style="font-size:12px;color:var(--text-muted);margin-top:8px">${emptyFrames.length} empty frames at facility: <span style="font-family:var(--font-mono);font-size:11px">${emptyFrames.map(f=>f.name).join(', ')}</span></div>`
    : '';

  // Stats
  const totalInRMD = STATE.cages.filter(c=>c.location==='rmd').length;
  const totalInFrames = STATE.cages.filter(c=>c.location==='frame').length;
  const totalReady = STATE.frames.filter(f=>f.fixedForShipping).length;

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Storage & Frame Overview</h2>
      <div style="display:flex;gap:12px;font-size:13px">
        <span><strong style="color:var(--green)">${totalInRMD}</strong> in RMD</span>
        <span><strong style="color:var(--blue)">${totalInFrames}</strong> in Frames</span>
        <span><strong style="color:var(--accent)">${totalReady}</strong> ready to ship</span>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">RMD Storage Bays</div>
        <div style="display:flex;gap:8px;margin-bottom:10px;font-size:10px">
          <span class="overview-cage-chip short">Short &lt;${H_SHORT}m</span>
          <span class="overview-cage-chip medium">Medium ‚â§${H_MED}m</span>
          <span class="overview-cage-chip tall">Tall &gt;${H_MED}m</span>
        </div>
        <div class="rmd-site-layout">${rmdRows}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
        <div class="card">
          <div class="card-title">Frames with Cages (${STATE.frames.filter(f=>f.cages.length>0).length})</div>
          ${framesWithCages}
        </div>
        <div class="card">
          <div class="card-title">Empty Frames at Facility (${emptyFrames.length})</div>
          ${emptyFramesSummary || '<div class="empty-msg">None</div>'}
        </div>
      </div>
    </div>
  `;
}

async function clearReportMovements() {
  const inRange = STATE.plannedMovements.filter(m => m.date >= reportFrom && m.date <= reportTo);
  if (inRange.length === 0) return alert('No movements in the selected date range.');
  if (!confirm(`Clear ${inRange.length} movement${inRange.length!==1?'s':''} between ${fmt(reportFrom)} and ${fmt(reportTo)}? This cannot be undone.`)) return;
  const ids = inRange.map(m=>m.id);
  STATE.plannedMovements = STATE.plannedMovements.filter(m => !(m.date >= reportFrom && m.date <= reportTo));
  render();
  await Promise.all(ids.map(id => deleteMovementFromAPI(id)));
}

function renderReport() {
  const planned = STATE.plannedMovements.filter(m=>m.date>=reportFrom && m.date<=reportTo);
  const grouped = {};
  planned.forEach(m=>{ if(!grouped[m.date]) grouped[m.date]=[]; grouped[m.date].push(m); });

  const inFac = STATE.cages.filter(c=>c.location==='facility').length;
  const inRMD = STATE.cages.filter(c=>c.location==='rmd').length;
  const inFrm = STATE.cages.filter(c=>c.location==='frame').length;
  const shipped = STATE.cages.filter(c=>c.location==='shipped').length;

  let daysHTML = Object.keys(grouped).sort().map(date=>{
    const moves = grouped[date];
    const pending = moves.filter(m=>!m.completed).length;
    let movesHTML = moves.map((m,i)=>`
      <div class="report-move-row" style="opacity:${m.completed?0.5:1}">
        <span class="report-move-num">${i+1}.</span>
        <span class="report-move-desc">${esc(m.description)}</span>
        <span class="report-move-type">(${esc(m.type)})</span>
        <span style="color:var(--text-muted)">${m.shift==='night'?'üåô Night':'‚òÄ Day'}</span>
        <span class="badge ${m.completed?'badge-green':'badge-yellow'}">${m.completed?'Done':'Pending'}</span>
      </div>
    `).join('');

    return `<div style="margin-bottom:16px">
      <div class="report-day-header">${fmt(date)} ‚Äî ${pending} pending${pending>MAX_MOVES?` <span style="color:var(--red)">‚ö† Exceeds daily limit!</span>`:''}</div>
      ${movesHTML}
    </div>`;
  }).join('') || '<div class="empty-msg">No movements in this date range</div>';

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Printable Report</h2>
      <div style="display:flex;gap:8px">
        <button class="btn btn-danger btn-sm" onclick="clearReportMovements()">üóë Clear Range Data</button>
        <button class="btn btn-primary" onclick="printReport()">üñ® Print Report</button>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;gap:12px;align-items:end">
        <div><label>From</label><input type="date" value="${reportFrom}" onchange="reportFrom=this.value;render()"/></div>
        <div><label>To</label><input type="date" value="${reportTo}" onchange="reportTo=this.value;render()"/></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Report Preview</div>
      ${daysHTML}
      <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:14px">
        <div class="card-title">Inventory Summary</div>
        <div class="report-summary-grid">
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--blue)">${inFac}</div><div class="report-summary-lbl">In Facility</div></div>
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--green)">${inRMD}</div><div class="report-summary-lbl">In RMD</div></div>
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--orange)">${inFrm}</div><div class="report-summary-lbl">In Frames</div></div>
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--purple)">${shipped}</div><div class="report-summary-lbl">Shipped</div></div>
        </div>
      </div>
    </div>
  `;
}

function printReport() {
  const planned = STATE.plannedMovements.filter(m=>m.date>=reportFrom && m.date<=reportTo);
  const grouped = {};
  planned.forEach(m=>{ if(!grouped[m.date]) grouped[m.date]=[]; grouped[m.date].push(m); });

  let daysHTML = Object.keys(grouped).sort().map(date=>{
    const moves = grouped[date];
    return `<h2>${fmt(date)} (${moves.filter(m=>!m.completed).length} pending)</h2>
    <table><tr><th>#</th><th>Type</th><th>Description</th><th>Shift</th><th>Notes</th><th>Status</th></tr>
    ${moves.map((m,i)=>`<tr class="${m.completed?'done':''}"><td>${i+1}</td><td>${esc(m.type)}</td><td>${esc(m.description)}</td><td>${m.shift}</td><td>${esc(m.notes||'-')}</td><td>${m.completed?'‚úì Done':'Pending'}</td></tr>`).join('')}
    </table>`;
  }).join('') || '<p style="color:#999">No movements planned in this date range.</p>';

  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>Movement Report</title><style>
    body{font-family:Arial,sans-serif;padding:20px;color:#333}
    h1{font-size:20px;border-bottom:2px solid #333;padding-bottom:8px}
    h2{font-size:16px;margin-top:20px;color:#555}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #ccc;padding:6px 10px;text-align:left;font-size:13px}
    th{background:#f5f5f5;font-weight:bold}
    .done{text-decoration:line-through;color:#999}
    @media print{body{padding:0}}
  </style></head><body>
    <h1>Cage Movement Report ‚Äî ${fmt(reportFrom)} to ${fmt(reportTo)}</h1>
    <p>Generated: ${new Date().toLocaleString('en-GB')} | Max movements/day: ${MAX_MOVES}</p>
    ${daysHTML}
    <hr style="margin-top:24px"/>
    <h2>Current Inventory Summary</h2>
    <table><tr><th>Location</th><th>Count</th></tr>
    <tr><td>In Facility</td><td>${STATE.cages.filter(c=>c.location==='facility').length}</td></tr>
    <tr><td>In RMD Storage</td><td>${STATE.cages.filter(c=>c.location==='rmd').length}</td></tr>
    <tr><td>In Frames</td><td>${STATE.cages.filter(c=>c.location==='frame').length}</td></tr>
    <tr><td>Shipped</td><td>${STATE.cages.filter(c=>c.location==='shipped').length}</td></tr></table>
    <h2>Frame Status</h2>
    <table><tr><th>Location</th><th>Count</th></tr>
    <tr><td>At Facility</td><td>${STATE.frames.filter(f=>f.location==='facility').length}</td></tr>
    <tr><td>On Boat</td><td>${STATE.frames.filter(f=>f.location==='boat').length}</td></tr>
    <tr><td>With Client</td><td>${STATE.frames.filter(f=>f.location==='client').length}</td></tr>
    <tr><td>Fixed for Shipping</td><td>${STATE.frames.filter(f=>f.fixedForShipping).length}</td></tr>
    <tr><td>Frames with Waler</td><td>${STATE.frames.filter(f=>f.hasWaler).length}</td></tr></table>
  </body></html>`);
  w.document.close();
  w.print();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOAT PLANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bpBoatDate = todayStr();
let bpSelectedCages = new Set();
let bpGeneratedMovements = null;

function toggleBPCage(id) {
  if (bpSelectedCages.has(id)) bpSelectedCages.delete(id);
  else bpSelectedCages.add(id);
  bpGeneratedMovements = null;
  render();
}

function generateBoatMovements() {
  if (bpSelectedCages.size === 0) return alert('Please select at least one cage to plan for the boat.');
  if (!bpBoatDate) return alert('Please set a boat loading date.');

  const selectedCages = [...bpSelectedCages].map(id => getCage(id)).filter(Boolean);
  const warnings = [];
  const assignments = [];

  // Available frames at facility (not fixed for shipping)
  const facilityFrames = STATE.frames.filter(f => f.location === 'facility' && !f.fixedForShipping);

  // Build a virtual map of frames with planned (not completed) movements adding cages to them
  // This ensures boat planner respects auto-planned movements from the movement planner
  const plannedFrameLoads = {}; // frameId -> [cageId, ...]
  STATE.plannedMovements.forEach(m => {
    if (m.completed) return;
    if (m.typeKey === 'facility-to-frame' && m.frameId && m.cageId) {
      if (!plannedFrameLoads[m.frameId]) plannedFrameLoads[m.frameId] = [];
      // Only count if this cage isn't already selected for the boat plan
      if (!bpSelectedCages.has(m.cageId)) {
        plannedFrameLoads[m.frameId].push(m.cageId);
      }
    }
  });

  // Helper: get effective cage count in a frame (including planned movements)
  function effectiveCageCount(f) {
    const realCages = f.cages.length;
    const plannedExtra = (plannedFrameLoads[f.id] || []).length;
    return realCages + plannedExtra;
  }

  function effectiveCages(f) {
    const real = f.cages.map(cid => getCage(cid)).filter(Boolean);
    const planned = (plannedFrameLoads[f.id] || []).map(cid => getCage(cid)).filter(Boolean);
    return [...real, ...planned];
  }

  // Helper: find the TIGHTEST fitting frame for a cage (smallest frame width that fits the cage)
  // Also respects waler requirement
  function findBestFrame(cage, usedFrameIds) {
    const cageNeedsWaler = needsWaler(cage);

    // Sort frames by width ascending so we pick the tightest fit first
    const sorted = [...facilityFrames].sort((a,b) => a.width - b.width);

    // Pass 1: try to pair with an existing cage in a frame already assigned
    for (const f of sorted) {
      if (usedFrameIds.has(f.id)) continue;
      if (cage.width > f.width) continue; // cage doesn't fit
      if (effectiveCageCount(f) >= 2) continue;
      if (cageNeedsWaler && !f.hasWaler) continue; // must have waler
      if (effectiveCageCount(f) === 1) {
        const allCages = effectiveCages(f);
        if (allCages.length > 0 && !canFitTwo(allCages[0], cage, f.width)) continue;
      }
      return f;
    }

    // Pass 2: any empty frame, tightest fit, respecting waler
    for (const f of sorted) {
      if (usedFrameIds.has(f.id)) continue;
      if (cage.width > f.width) continue;
      if (cageNeedsWaler && !f.hasWaler) continue;
      if (effectiveCageCount(f) === 0) return f;
    }

    // Pass 3: relax waler if no suitable frame found (will warn)
    for (const f of sorted) {
      if (usedFrameIds.has(f.id)) continue;
      if (cage.width > f.width) continue;
      if (effectiveCageCount(f) >= 2) continue;
      if (effectiveCageCount(f) === 1) {
        const allCages = effectiveCages(f);
        if (allCages.length > 0 && !canFitTwo(allCages[0], cage, f.width)) continue;
      }
      return f;
    }
    for (const f of sorted) {
      if (usedFrameIds.has(f.id)) continue;
      if (cage.width > f.width) continue;
      if (effectiveCageCount(f) === 0) return f;
    }

    return null;
  }

  const usedFrameIds = new Set();

  // Separate: already framed vs needs placing
  const alreadyFramed = selectedCages.filter(c => c.location === 'frame');
  const notFramed = selectedCages.filter(c => c.location !== 'frame');

  alreadyFramed.forEach(c => {
    const currentFrame = STATE.frames.find(f => f.cages.includes(c.id));
    if (currentFrame) {
      const cageNeedsWaler = needsWaler(c);
      let issues = [];
      if (c.width > currentFrame.width) issues.push(`frame ${currentFrame.name} too narrow (cage ${c.width}m > frame ${currentFrame.width}m)`);
      if (cageNeedsWaler && !currentFrame.hasWaler) issues.push(`frame ${currentFrame.name} has no waler`);
      if (issues.length > 0) {
        // Try to find a better frame
        const betterFrame = findBestFrame(c, usedFrameIds);
        if (betterFrame) {
          usedFrameIds.add(betterFrame.id);
          assignments.push({cage: c, frame: betterFrame, action: 'reframe',
            note: `Cage ${c.name} ‚Äî Reframe: move from ${currentFrame.name} ‚Üí ${betterFrame.name} (${betterFrame.width}m${betterFrame.hasWaler?' üî©':''})`,
            fromFrame: currentFrame});
          warnings.push(`‚ö† Cage ${c.name} was in ${currentFrame.name} but needed reframing: ${issues.join(', ')}.`);
        } else {
          assignments.push({cage: c, frame: null, action: 'no_frame',
            note: `No suitable frame for cage ${c.name}: ${issues.join(', ')}`});
        }
      } else {
        usedFrameIds.add(currentFrame.id);
        assignments.push({cage: c, frame: currentFrame, action: 'already_framed',
          note: `Already in ${currentFrame.name} (${currentFrame.width}m${currentFrame.hasWaler?' üî©':''}) ‚úì`});
      }
    }
  });

  notFramed.forEach(cage => {
    const frame = findBestFrame(cage, usedFrameIds);
    if (frame) {
      usedFrameIds.add(frame.id);
      const cageNeedsWaler = needsWaler(cage);
      if (cageNeedsWaler && !frame.hasWaler) {
        warnings.push(`‚ö† Cage ${cage.name} needs a waler (length ${cage.length}m < 6.5m) but best available frame ${frame.name} has no waler. Consider adding a waler to ${frame.name}.`);
      }
      let fromDesc = cage.location === 'rmd' ? cage.locationDetail : 'Facility';
      assignments.push({cage, frame, action: cage.location === 'rmd' ? 'rmd_to_frame' : 'facility_to_frame',
        note: `Cage ${cage.name} ‚Äî Move from ${fromDesc} ‚Üí ${frame.name} (${frame.width}m${frame.hasWaler?' üî©':''})`});
    } else {
      warnings.push(`‚ö† No suitable frame found for cage ${cage.name} (width ${cage.width}m${needsWaler(cage)?' + needs waler':''}). Check frame availability.`);
      assignments.push({cage, frame: null, action: 'no_frame',
        note: `No suitable frame available for cage ${cage.name}`});
    }
  });

  // ‚îÄ‚îÄ Spread lifts across working days ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Only movements that require a physical lift count toward the daily limit
  const liftActions = assignments.filter(a => a.action !== 'already_framed' && a.action !== 'no_frame');
  // Add fix-for-shipping steps
  const framesUsed = [...new Set(liftActions.filter(a=>a.frame).map(a=>a.frame))];
  const fixSteps = framesUsed.filter(f=>!f.fixedForShipping).map(f => ({
    isFixStep: true, frame: f, note: `Fix frame ${f.name} for shipping (bolt down cage(s))`
  }));

  // ‚îÄ‚îÄ Facility departure steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // For selected cages that are still in the FACILITY with a departure date,
  // auto-generate a "Facility ‚Üí RMD" step pinned to their departure date.
  // These precede the eventual RMD‚ÜíFrame lift, so they act as intake movements.
  const facilityDepartureSteps = [];
  liftActions.forEach(step => {
    if (step.action === 'facility_to_frame') {
      // Cage is coming directly facility‚Üíframe, no intermediate step needed
      return;
    }
  });
  // Check assignments: any cage currently in 'facility' with a departureDate 
  // that falls BEFORE the boat date needs a facility‚ÜíRMD/holding step
  assignments.forEach(a => {
    if (a.action === 'already_framed' || a.action === 'no_frame') return;
    if (a.cage.location !== 'facility') return; // only facility cages
    if (!a.cage.departureDate) return; // no scheduled departure
    const depDate = a.cage.departureDate;
    // Pin this to the departure date ‚Äî this is when they leave the facility
    // We create a preliminary "Facility exit" step
    facilityDepartureSteps.push({
      isFacilityExit: true,
      cage: a.cage,
      date: depDate,
      note: `Cage ${a.cage.name} ‚Äî Leaves facility ‚Üí holding area / RMD intake`,
    });
  });

  // Deduplicate and sort facility departure steps by date
  const allSteps = [...liftActions, ...fixSteps];
  const DAILY_LIMIT = STATE.settings.movementsPerDay || MAX_MOVES;

  // Build list of working days from today up to (but not including) boat date
  const boatDate = new Date(bpBoatDate + 'T12:00:00');
  const today = new Date(); today.setHours(12,0,0,0);
  let workDays = [];
  let d = new Date(today);
  while (d < boatDate) {
    const dow = d.getDay();
    if (dow !== 0 && dow !== 6) workDays.push(toISO(d)); // Mon-Fri only
    d.setDate(d.getDate() + 1);
  }

  if (workDays.length === 0) {
    warnings.push('‚ö† No working days available before the boat date. Movements will be scheduled on the boat date itself.');
    workDays = [bpBoatDate];
  }

  // Check how many movements already planned on each day
  const existingCounts = {};
  STATE.plannedMovements.forEach(m => {
    if (!m.completed) existingCounts[m.date] = (existingCounts[m.date] || 0) + 1;
  });

  // Schedule steps across days
  const scheduledSteps = [];
  let dayIdx = 0;
  let usedToday = existingCounts[workDays[0]] || 0;

  // Add facility departure steps first, pinned to their departure dates
  facilityDepartureSteps.forEach(step => {
    const stepDate = step.date;
    // Count this against that day's existing moves
    existingCounts[stepDate] = (existingCounts[stepDate] || 0) + 1;
    scheduledSteps.push({ ...step });
  });

  for (const step of allSteps) {
    // Find a day with capacity
    while (dayIdx < workDays.length - 1 && usedToday >= DAILY_LIMIT) {
      dayIdx++;
      usedToday = existingCounts[workDays[dayIdx]] || 0;
    }
    const assignedDay = workDays[Math.min(dayIdx, workDays.length - 1)];
    scheduledSteps.push({ ...step, date: assignedDay });
    usedToday++;
    if (usedToday >= DAILY_LIMIT && dayIdx < workDays.length - 1) {
      dayIdx++;
      usedToday = existingCounts[workDays[dayIdx]] || 0;
    }
  }

  // Sort all scheduled steps by date so display is chronological
  scheduledSteps.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

  if (allSteps.length > workDays.length * DAILY_LIMIT) {
    warnings.push(`‚ö† ${allSteps.length} moves needed but only ${workDays.length * DAILY_LIMIT} slots available (${workDays.length} days √ó ${DAILY_LIMIT} per day). Some days may exceed the limit.`);
  }

  // Build display list
  const moves = [];
  // Show already-framed first
  assignments.filter(a=>a.action==='already_framed').forEach(a => {
    moves.push({type:'‚úì Pre-positioned', desc:`Cage ${a.cage.name} ‚Äî ${a.note}`, category:'info'});
  });
  // Show no-frame warnings
  assignments.filter(a=>a.action==='no_frame').forEach(a => {
    moves.push({type:'‚ö† Warning', desc:a.note, category:'warning'});
  });
  // Show scheduled steps grouped by date
  let lastDate = null;
  let moveNum = 1;
  scheduledSteps.forEach(step => {
    if (step.date !== lastDate) {
      moves.push({type:'üìÖ Day', desc: fmt(step.date), category:'date-header'});
      lastDate = step.date;
    }
    if (step.isFacilityExit) {
      moves.push({type:`üì§ Intake`, desc:`${step.note} (${step.date})`, category:'facility-exit'});
    } else if (step.isFixStep) {
      moves.push({type:`Move ${moveNum++}`, desc: step.note, category:'move'});
    } else {
      const walerNote = needsWaler(step.cage) ? ' ‚ö† waler required' : '';
      moves.push({type:`Move ${moveNum++}`, desc:`${step.note}${walerNote}`, category:'move', cage:step.cage, frame:step.frame});
    }
  });

  bpGeneratedMovements = {moves, warnings, assignments, framesUsed, scheduledSteps};
  render();
}
function commitBoatPlan() {
  if (!bpGeneratedMovements) return;
  const {scheduledSteps} = bpGeneratedMovements;
  let added = 0;

  const newMovements = [];
  scheduledSteps.forEach(step => {
    if (step.isFacilityExit) {
      newMovements.push({
        id: uid(), date: step.date, type: 'Facility Exit',
        description: step.note,
        shift: 'day', notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`,
        cageId: step.cage ? step.cage.id : null,
        completed: false,
      });
    } else if (step.isFixStep) {
      newMovements.push({
        id: uid(), date: step.date, type: 'Shipping',
        description: step.note,
        shift: 'day', notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`, completed: false
      });
    } else {
      newMovements.push({
        id: uid(), date: step.date, type: step.action === 'rmd_to_frame' ? 'RMD ‚Üí Frame' : 'Facility ‚Üí Frame',
        description: step.note + (needsWaler(step.cage) ? ' [waler req.]' : ''),
        shift: 'day',
        notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`,
        cageId: step.cage ? step.cage.id : null,
        completed: false,
      });
    }
    added++;
  });
  STATE.plannedMovements.push(...newMovements);

  // Count unique days
  const days = new Set(scheduledSteps.map(s=>s.date));
  alert(`${added} movements added across ${days.size} working day${days.size!==1?'s':''} leading up to ${fmt(bpBoatDate)}!`);
  bpSelectedCages.clear();
  bpGeneratedMovements = null;
  render();
  await Promise.all(newMovements.map(m => addMovementToAPI(m)));
}

function renderBoatPlanner() {
  const today = new Date();
  const in7Days = new Date(today); in7Days.setDate(in7Days.getDate() + 7);

  // Cages to show: those leaving facility in next 7 days OR already in RMD/frame
  const eligibleCages = STATE.cages.filter(c => {
    if (c.location === 'shipped') return false;
    if (c.location === 'rmd' || c.location === 'frame') return true;
    if (c.location === 'facility' && c.departureDate) {
      const dep = new Date(c.departureDate + 'T12:00:00');
      return dep <= in7Days;
    }
    return false;
  }).sort((a,b) => {
    // Sort: facility with departure first, then rmd, then frame
    const order = {facility:0, rmd:1, frame:2};
    if (order[a.location] !== order[b.location]) return order[a.location] - order[b.location];
    return a.name.localeCompare(b.name, undefined, {numeric:true});
  });

  // Upcoming departures (cages with departure dates in next 7 days)
  const upcoming = STATE.cages
    .filter(c => c.departureDate && c.location !== 'shipped')
    .sort((a,b) => a.departureDate.localeCompare(b.departureDate));

  const cageCardsHTML = (() => {
    if (eligibleCages.length === 0) return '<div class="empty-msg">No cages leaving in the next 7 days, and no cages in RMD or frames.</div>';

    // Group by proposedShipDay
    const groups = {};
    const NO_GROUP = '__none__';
    eligibleCages.forEach(c => {
      const key = c.proposedShipDay || NO_GROUP;
      if (!groups[key]) groups[key] = [];
      groups[key].push(c);
    });

    // Sort group keys: dated groups first (ascending), then ungrouped
    const sortedKeys = Object.keys(groups).sort((a, b) => {
      if (a === NO_GROUP) return 1;
      if (b === NO_GROUP) return -1;
      return a.localeCompare(b);
    });

    const hasGroups = sortedKeys.some(k => k !== NO_GROUP);

    return sortedKeys.map(key => {
      const groupCages = groups[key];
      const groupHeader = key !== NO_GROUP
        ? `<div style="grid-column:1/-1;font:700 12px var(--font-mono);color:var(--purple);padding:6px 0 4px;border-bottom:1px solid var(--border);margin-bottom:4px">üö¢ Proposed Ship: ${fmt(key)} <span style="font-weight:400;color:var(--text-muted)">(${groupCages.length} cage${groupCages.length>1?'s':''})</span></div>`
        : hasGroups ? `<div style="grid-column:1/-1;font:700 12px var(--font-mono);color:var(--text-muted);padding:6px 0 4px;border-bottom:1px solid var(--border);margin-bottom:4px">No proposed shipping day</div>` : '';

      const cards = groupCages.map(c => {
        const sel = bpSelectedCages.has(c.id);
        const daysLeft = c.departureDate ? Math.ceil((new Date(c.departureDate+'T12:00:00') - new Date()) / 86400000) : null;
        const depTag = c.departureDate ? `<span style="color:${daysLeft !== null && daysLeft <= 3 ? 'var(--red)' : daysLeft <= 7 ? 'var(--orange)' : 'var(--text-muted)'}">üìÖ ${fmt(c.departureDate)} (${daysLeft}d)</span>` : '';
        const locTag = `<span class="badge badge-${locBadge(c.location)}" style="font-size:9px;padding:1px 5px">${esc(locLabel(c))}</span>`;
        return `<div class="bp-cage-card ${sel?'selected':''}" onclick="toggleBPCage('${c.id}')">
          <div class="bp-check">${sel?'‚úì':''}</div>
          <div class="bp-cage-info">
            <div class="bp-cage-name">${esc(c.name)} ${locTag}</div>
            <div class="bp-cage-meta">${c.width}m √ó ${c.height}m √ó ${c.length}m ¬∑ ${c.weight}t ${depTag}</div>
          </div>
        </div>`;
      }).join('');

      return groupHeader + cards;
    }).join('');
  })();

  // Generated movements panel
  let movementsHTML = '';
  if (bpGeneratedMovements) {
    const {moves, warnings} = bpGeneratedMovements;
    const warningsHTML = warnings.map(w => `<div class="bp-warning">${esc(w)}</div>`).join('');
    const movesListHTML = moves.map(m => {
      if (m.category === 'date-header') {
        return `<li style="list-style:none;border-top:2px solid var(--border);margin-top:8px;padding-top:6px"><span style="font:700 11px var(--font-mono);color:var(--blue)">${esc(m.type)} ‚Äî ${esc(m.desc)}</span></li>`;
      }
      const typeColor = m.category === 'info' ? 'var(--green)' : m.category === 'warning' ? 'var(--orange)' : m.category === 'facility-exit' ? 'var(--purple)' : 'var(--accent)';
      return `<li><div class="bp-movement-desc"><span class="bp-movement-type" style="color:${typeColor}">${esc(m.type)}</span> ‚Äî ${esc(m.desc)}</div></li>`;
    }).join('');
    const hasMoves = moves.some(m => m.category === 'move');
    movementsHTML = `
      <div class="card">
        <div class="card-title">Generated Movement Plan for ${fmt(bpBoatDate)}</div>
        ${warningsHTML}
        ${movesListHTML ? `<ul class="bp-movement-list">${movesListHTML}</ul>` : '<div class="empty-msg">No movements needed.</div>'}
        ${hasMoves ? `<div class="form-actions" style="margin-top:12px">
          <button class="btn btn-primary" onclick="commitBoatPlan()">‚úÖ Add to Planner</button>
          <button class="btn btn-secondary" onclick="bpGeneratedMovements=null;render()">Clear</button>
        </div>` : ''}
      </div>`;
  }

  // Upcoming departures panel
  const upcomingHTML = upcoming.length > 0
    ? upcoming.map(c => {
        const daysLeft = Math.ceil((new Date(c.departureDate+'T12:00:00') - new Date()) / 86400000);
        const urgColor = daysLeft < 0 ? 'var(--red)' : daysLeft <= 7 ? 'var(--orange)' : 'var(--green)';
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px">
          <span style="font-weight:600">${esc(c.name)}</span>
          <span class="badge badge-${locBadge(c.location)}">${esc(locLabel(c))}</span>
          <span style="color:${urgColor};font-family:var(--font-mono);font-size:12px">${fmt(c.departureDate)} (${daysLeft < 0 ? 'OVERDUE' : daysLeft+'d'})</span>
        </div>`;
      }).join('')
    : '<div class="empty-msg">No departure dates set. Edit cages to add expected departure dates.</div>';

  return `
    <h2 class="section-title" style="margin-bottom:4px">üö¢ Boat Planner</h2>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Showing cages leaving facility within 7 days, plus all cages already in RMD or frames. Frame availability reflects existing planned movements from the Movement Planner.</div>
    <div style="display:grid;grid-template-columns:1fr 340px;gap:16px">
      <div>
        <div class="card">
          <div class="flex-between" style="margin-bottom:12px">
            <div class="card-title" style="margin:0">Select Cages for Next Boat (${bpSelectedCages.size} selected)</div>
            <div style="display:flex;gap:8px;align-items:center">
              <div><label style="margin-bottom:2px">Boat Date</label><input type="date" value="${bpBoatDate}" onchange="bpBoatDate=this.value;bpGeneratedMovements=null;render()" style="width:160px"/></div>
              ${bpSelectedCages.size > 0 ? `<button class="btn btn-primary" onclick="generateBoatMovements()" style="align-self:flex-end">‚öô Generate Plan</button>` : ''}
              ${bpSelectedCages.size > 0 ? `<button class="btn btn-secondary" onclick="bpSelectedCages.clear();bpGeneratedMovements=null;render()" style="align-self:flex-end">Clear</button>` : ''}
            </div>
          </div>
          <div class="bp-cage-grid">${cageCardsHTML}</div>
        </div>
        ${movementsHTML}
      </div>
      <div>
        <div class="card">
          <div class="card-title">All Upcoming Departures</div>
          ${upcomingHTML}
        </div>
          <div class="card" style="margin-top:0">
          <div class="card-title">Frame Availability</div>
          ${STATE.frames.filter(f=>f.location==='facility').map(f => {
            const plannedExtra = (STATE.plannedMovements.filter(m=>!m.completed && m.typeKey==='facility-to-frame' && m.frameId===f.id)).length;
            const totalCages = f.cages.length + plannedExtra;
            const cls = totalCages === 0 ? 'badge-green' : totalCages === 1 ? 'badge-yellow' : 'badge-red';
            const lbl = totalCages === 0 ? 'Empty' : totalCages === 1 ? `1 cage${plannedExtra > 0 ? ' (planned)' : ''}` : 'Full';
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px">
              <span style="font-family:var(--font-mono)">${esc(f.name)}</span>
              <span style="color:var(--text-muted)">${f.width}m</span>
              <span class="badge ${cls}">${lbl}</span>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function init() {
  await loadState();
  render();
})();
</script>


</body></html>
