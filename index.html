<!DOCTYPE html>

<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cage Tracker ‚Äî Facility Management</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg-deep: #f0f2f5;
  --bg-base: #ffffff;
  --bg-card: #ffffff;
  --bg-elevated: #f6f7f9;
  --bg-input: #f0f2f5;
  --border: #dfe2e8;
  --border-light: #e8eaef;
  --text-primary: #1a1f2e;
  --text-secondary: #4a5568;
  --text-muted: #8895a7;
  --accent: #c08520;
  --accent-dim: rgba(192,133,32,0.08);
  --green: #1a8a4a;
  --blue: #2563b0;
  --red: #c93030;
  --orange: #b85c1a;
  --purple: #7040c0;
  --yellow: #9a7b10;
  --font-display: 'Outfit', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 8px;
  --radius-lg: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: var(--font-display);
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background: var(--bg-base); }
::-webkit-scrollbar-thumb { background: var(--border-light); border-radius:3px; }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  background: #1a2235;
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 56px;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-shrink: 0;
}
.header-logo {
  width: 34px; height: 34px; border-radius: var(--radius);
  background: linear-gradient(135deg, var(--accent), #b8862d);
  display: flex; align-items: center; justify-content: center;
  font: 700 15px var(--font-mono); color: #1a2235;
}
.header-title { font-weight: 700; font-size: 17px; color: #fff; letter-spacing: -0.02em; }
.header-sub { font: 600 10px var(--font-mono); color: #8899aa; letter-spacing: 0.08em; }

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.layout { display: flex; flex: 1; overflow: hidden; }
.sidebar {
  width: 190px; background: var(--bg-base); border-right: 1px solid var(--border);
  padding: 14px 0; flex-shrink: 0; overflow-y: auto;
}
.sidebar-btn {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 18px; border: none; width: 100%;
  background: transparent; color: var(--text-muted);
  font: 500 13px var(--font-display); cursor: pointer;
  border-left: 3px solid transparent; transition: all 0.12s;
  text-align: left;
}
.sidebar-btn:hover { color: var(--text-secondary); background: rgba(255,255,255,0.02); }
.sidebar-btn.active {
  color: var(--accent); background: var(--accent-dim);
  border-left-color: var(--accent); font-weight: 600;
}
.sidebar-icon { font-size: 15px; width: 22px; text-align: center; }
.main { flex:1; overflow-y: auto; padding: 24px 30px; max-height: calc(100vh - 56px); }
.tab-content { display: none; animation: fadeIn 0.2s ease; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

/* ‚îÄ‚îÄ Components ‚îÄ‚îÄ */
.section-title { font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; letter-spacing: -0.02em; }
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.card-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 12px; }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 12px;
  font: 600 11px var(--font-mono); letter-spacing: 0.02em;
}
.badge-accent { color: var(--accent); background: #f5e6c8; border: 1px solid #e0c880; }
.badge-green { color: var(--green); background: #e6f5ec; border: 1px solid #b0dcc0; }
.badge-blue { color: var(--blue); background: #e6f0fa; border: 1px solid #a0c8e8; }
.badge-red { color: var(--red); background: #fce8e8; border: 1px solid #e8b0b0; }
.badge-orange { color: var(--orange); background: #fef0e6; border: 1px solid #e8c8a0; }
.badge-purple { color: var(--purple); background: #f0e8fa; border: 1px solid #c8b0e8; }
.badge-yellow { color: var(--yellow); background: #fdf5dc; border: 1px solid #e0d8a0; }

.stat-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.stat-card { background: var(--bg-card); border:1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; text-align: center; flex: 1; min-width: 120px; }
.stat-val { font: 700 26px var(--font-mono); }
.stat-lbl { font-size: 11px; color: var(--text-muted); font-weight: 600; margin-top: 4px; }

.btn {
  border: none; border-radius: 6px; padding: 8px 16px; font: 600 13px var(--font-display);
  cursor: pointer; transition: all 0.12s; display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: linear-gradient(135deg, #e8a830, #c08520); color: #fff; }
.btn-primary:hover { filter: brightness(1.1); }
.btn-secondary { background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--border-light); color: var(--text-primary); }
.btn-danger { background: var(--bg-elevated); color: var(--red); border: 1px solid rgba(224,85,85,0.2); }
.btn-sm { padding: 4px 10px; font-size: 11px; }
.btn-xs { padding: 3px 8px; font-size: 10px; }
.btn-block { width: 100%; justify-content: center; }

input, select, textarea {
  background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
  padding: 8px 12px; color: var(--text-primary); font: 400 13px var(--font-display);
  width: 100%; transition: border-color 0.12s;
}
input:focus, select:focus { outline: none; border-color: var(--accent); }
label {
  display: block; font: 600 10px var(--font-mono); color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;
}
.form-grid { display: grid; gap: 12px; }
.form-grid-3 { grid-template-columns: repeat(3, 1fr); }
.form-grid-2 { grid-template-columns: repeat(2, 1fr); }
.form-actions { display: flex; gap: 8px; margin-top: 12px; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }
th {
  text-align: left; padding: 8px 10px; font: 600 10px var(--font-mono);
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em;
  border-bottom: 2px solid var(--border); background: var(--bg-elevated);
}
td { padding: 10px; border-bottom: 1px solid var(--border); }
tr:hover td { background: #f8f9fb; }

.filter-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.filter-btn {
  padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--bg-elevated); color: var(--text-muted); cursor: pointer;
  font: 500 12px var(--font-display); transition: all 0.12s;
}
.filter-btn.active { background: #f5e6c8; color: var(--accent); border-color: #e0c880; font-weight:600; }

.flex-between { display: flex; justify-content: space-between; align-items: center; }

/* ‚îÄ‚îÄ RMD Grid ‚îÄ‚îÄ */
.rmd-grid { display: flex; flex-direction: column; gap: 14px; }
.rmd-spatial-row { display: flex; gap: 10px; align-items: flex-start; }
.rmd-spatial-spacer { width: 60px; flex-shrink: 0; }
.rmd-spatial-label { font: 600 9px var(--font-mono); color: var(--text-muted); text-align: center; margin-bottom: 2px; text-transform: uppercase; }

/* Spatial layout for site-matching RMD view */
.rmd-site-layout { display: flex; flex-direction: column; gap: 18px; }
.rmd-site-row { display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; }
.rmd-site-row.row-top { justify-content: flex-start; }
.rmd-site-row.row-mid { justify-content: flex-start; padding-left: 0; }
.rmd-site-row.row-bot { justify-content: flex-start; }
.rmd-site-card { min-width: 380px; flex: 0 0 auto; }
.rmd-site-card .card { margin-bottom: 0; padding: 12px; }

/* Mini spatial for dashboard */
.rmd-site-mini { display: flex; flex-direction: column; gap: 10px; }
.rmd-site-mini-row { display: flex; gap: 6px; align-items: flex-start; flex-wrap: wrap; }

/* Planner sidebar compact spatial */
.planner-rmd-spatial { display: flex; flex-direction: column; gap: 8px; }
.planner-rmd-row { display: flex; gap: 4px; flex-wrap: wrap; }
.rmd-slot {
  display: flex; align-items: center; gap: 8px; background: var(--bg-input);
  border-radius: 6px; padding: 6px 10px; border: 1px solid var(--border); margin-bottom: 0;
  min-width: 0;
}
.rmd-slot-label { font: 600 10px var(--font-mono); color: var(--text-muted); width: 34px; flex-shrink:0; }
.rmd-slot-content { flex: 1; display: flex; justify-content: space-between; align-items: center; }
.rmd-slot select { font-size: 11px; padding: 4px 8px; }
.rmd-cage-info { font-size: 12px; }
.rmd-cage-name { font-weight: 600; color: var(--text-primary); }
.rmd-cage-detail { color: var(--text-muted); margin-left: 6px; }
.remove-btn { background:none; border:none; color:var(--red); cursor:pointer; font-size:15px; padding:0 4px; }

/* ‚îÄ‚îÄ Frame Cards ‚îÄ‚îÄ */
.frame-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 10px; }
.frame-card { padding: 13px; }
.frame-card.shipping-ready { border-color: #c0a050; background: #fdfaf0; }
.frame-name { font: 700 15px var(--font-mono); color: var(--text-primary); }
.frame-meta { font-size: 11px; color: var(--text-muted); margin: 4px 0 8px; }
.frame-cage-item {
  display: flex; justify-content: space-between; align-items: center;
  background: var(--bg-input); border-radius: 4px; padding: 4px 8px; margin-bottom: 4px; font-size: 12px;
}
.frame-actions { display: flex; flex-direction: column; gap: 5px; margin-top: 8px; }
.frame-actions select, .frame-actions .btn { font-size: 11px; }

/* ‚îÄ‚îÄ Week View ‚îÄ‚îÄ */
.week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.week-label { font: 600 14px var(--font-mono); color: var(--accent); }
.week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
.week-day {
  background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 8px; min-height: 110px;
}
.week-day.today { background: #fdf8ee; border-color: #e0c880; }
.week-day.weekend { opacity: 0.45; }
.week-day.weekend.has-moves { opacity: 1; }
.week-day-hdr { font: 700 10px var(--font-mono); color: var(--text-muted); margin-bottom: 4px; }
.week-day.today .week-day-hdr { color: var(--accent); }
.week-move-count { font: 600 10px var(--font-display); margin-bottom: 4px; }
.week-move-item {
  font-size: 10px; padding: 3px 5px; margin-bottom: 2px; border-radius: 4px;
  background: var(--bg-elevated); color: var(--text-secondary); cursor: default;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.week-move-item.completed { background: #e6f5ec; color: var(--green); text-decoration: line-through; }
.over-limit { color: var(--red) !important; }

/* ‚îÄ‚îÄ Shipping ‚îÄ‚îÄ */
.ship-frame-select {
  display: inline-flex; padding: 8px 12px; border-radius: 6px;
  background: var(--bg-input); border: 1px solid var(--border); cursor: pointer;
  margin: 0 6px 6px 0; transition: all 0.1s;
}
.ship-frame-select.selected { border: 2px solid var(--accent); background: var(--accent-dim); }
.ship-frame-name { font: 700 13px var(--font-mono); }
.ship-frame-cage { font-size: 11px; color: var(--text-muted); }

.shipment-row { padding: 12px 0; border-bottom: 1px solid var(--border); }
.shipment-row:last-child { border:none; }

/* ‚îÄ‚îÄ Report ‚îÄ‚îÄ */
.report-day-header {
  font: 700 13px var(--font-mono); color: var(--accent);
  padding: 8px 0; border-bottom: 1px solid var(--border); margin-bottom: 4px;
}
.report-move-row { display: flex; gap: 12px; padding: 7px 0; border-bottom: 1px solid rgba(30,42,58,0.5); font-size: 12px; align-items: center; }
.report-move-num { font: 400 12px var(--font-mono); color: var(--text-muted); width: 24px; }
.report-move-desc { flex:1; font-weight: 600; color: var(--text-primary); }
.report-move-type { color: var(--text-muted); }
.report-summary-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.report-summary-cell { background: var(--bg-input); border-radius: 6px; padding: 8px; text-align: center; }
.report-summary-val { font: 700 16px var(--font-mono); }
.report-summary-lbl { font-size: 10px; color: var(--text-muted); }

.empty-msg { color: var(--text-muted); font-size: 13px; font-style: italic; padding: 10px 0; }

/* ‚îÄ‚îÄ Inline cell editing ‚îÄ‚îÄ */
.editable-cell {
  cursor: pointer;
  border-radius: 4px;
  padding: 2px 4px;
  margin: -2px -4px;
  transition: background 0.1s;
  display: inline-block;
}
.editable-cell:hover {
  background: var(--accent-dim);
  outline: 1px dashed var(--accent);
}
.editable-cell::after {
  content: ' ‚úé';
  font-size: 9px;
  color: var(--accent);
  opacity: 0;
  transition: opacity 0.1s;
}
.editable-cell:hover::after { opacity: 1; }
.inline-edit-input {
  background: var(--bg-base) !important;
  border: 2px solid var(--accent) !important;
  border-radius: 4px;
  padding: 2px 6px !important;
  font-size: 12px;
  width: auto;
  min-width: 60px;
}

/* ‚îÄ‚îÄ Boat Planner ‚îÄ‚îÄ */
.bp-cage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; margin-bottom: 16px; }
.bp-cage-card {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  border: 2px solid var(--border); border-radius: 8px; background: var(--bg-elevated);
  cursor: pointer; transition: all 0.12s; user-select: none;
}
.bp-cage-card:hover { border-color: var(--accent); background: var(--accent-dim); }
.bp-cage-card.selected { border-color: var(--accent); background: var(--accent-dim); }
.bp-cage-card.selected .bp-check { background: var(--accent); border-color: var(--accent); color: #fff; }
.bp-check { width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;transition:all 0.1s; }
.bp-cage-info { flex:1; min-width:0; }
.bp-cage-name { font:700 13px var(--font-mono);color:var(--text-primary); }
.bp-cage-meta { font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.bp-movement-list { list-style:none; counter-reset: move-counter; }
.bp-movement-list li { counter-increment: move-counter; display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px; }
.bp-movement-list li:last-child { border:none; }
.bp-movement-list li::before { content: counter(move-counter); display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--accent-dim);color:var(--accent);font:700 11px var(--font-mono);flex-shrink:0;margin-top:1px; }
.bp-movement-desc { flex:1; }
.bp-movement-type { font-weight:600;color:var(--accent); }
.bp-warning { background:#fef0e6;border:1px solid #e8c8a0;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--orange);margin-bottom:8px; }

/* ‚îÄ‚îÄ Movements Map ‚îÄ‚îÄ */
.mv-layout { position: relative; }
.mv-canvas-wrap { position: relative; overflow: auto; }
#mv-svg-overlay { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10; }
.mv-rmd-zone { margin-bottom: 18px; }
.mv-rmd-zone-title { font: 700 11px var(--font-mono); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; }
.mv-rmd-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
.mv-rmd-card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
  padding: 8px 10px; min-width: 160px; flex: 0 0 auto;
  transition: box-shadow 0.12s;
}
.mv-rmd-card.has-movement { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(192,133,32,0.15); }
.mv-rmd-title { font: 700 13px var(--font-mono); color: var(--accent); margin-bottom: 6px; }
.mv-rmd-side-label { font: 600 9px var(--font-mono); color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
.mv-rmd-slot { font-size: 11px; padding: 3px 6px; border-radius: 4px; background: var(--bg-input); border: 1px solid var(--border); margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
.mv-rmd-slot.moving-out { background: #fef0e6; border-color: var(--orange); }
.mv-rmd-slot.moving-in { background: #e6f5ec; border-color: var(--green); }
.mv-rmd-slot-empty { font-size: 11px; color: var(--text-muted); font-style: italic; padding: 2px 6px; }
.mv-frames-zone { margin-top: 24px; }
.mv-frames-title { font: 700 11px var(--font-mono); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; }
.mv-frames-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 6px; }
.mv-frame-card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
  padding: 8px; font-size: 11px; min-height: 56px;
  transition: box-shadow 0.12s;
}
.mv-frame-card.has-movement { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(192,133,32,0.15); }
.mv-frame-name { font: 700 12px var(--font-mono); color: var(--text-primary); margin-bottom: 4px; }
.mv-frame-width { color: var(--text-muted); margin-bottom: 4px; font-size: 10px; }
.mv-frame-cage { padding: 2px 5px; border-radius: 3px; background: var(--bg-input); border: 1px solid var(--border); display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
.mv-frame-cage.moving-out { background: #fef0e6; border-color: var(--orange); }
.mv-frame-cage.moving-in { background: #e6f5ec; border-color: var(--green); }
.mv-legend { display: flex; gap: 12px; align-items: center; margin-bottom: 14px; flex-wrap: wrap; }
.mv-legend-item { display: flex; align-items: center; gap: 5px; font: 500 11px var(--font-display); color: var(--text-secondary); }
.mv-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.mv-filter-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }


.rmd-mini-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.rmd-mini {
  background: var(--bg-input); border-radius: 6px; padding: 8px; text-align: center;
  border: 1px solid var(--border); cursor: pointer; transition: all 0.1s;
}
.rmd-mini:hover { border-color: var(--border-light); }
.rmd-mini-name { font: 600 11px var(--font-mono); color: var(--text-muted); }
.rmd-mini-count { font: 700 16px var(--font-mono); }
.rmd-mini-count.empty { color: #d0d0d0; }

/* ‚îÄ‚îÄ Planner side panels ‚îÄ‚îÄ */
.planner-layout { display: grid; grid-template-columns: 1fr 340px; gap: 16px; }
.planner-sidebar { max-height: calc(100vh - 140px); overflow-y: auto; }
.planner-sidebar .card { padding: 12px; margin-bottom: 8px; }
.planner-mini-title { font: 700 12px var(--font-mono); color: var(--accent); margin-bottom: 6px; }
.planner-mini-slot {
  display: flex; justify-content: space-between; align-items: center;
  padding: 3px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px;
  background: var(--bg-elevated); border: 1px solid var(--border);
}
.planner-mini-slot .cage-name { font-weight: 600; }
.planner-mini-slot .cage-meta { color: var(--text-muted); font-size: 10px; }
.planner-frame-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 3px;
  background: var(--bg-elevated); border: 1px solid var(--border);
}

/* ‚îÄ‚îÄ Overview / Presentation tab ‚îÄ‚îÄ */
.overview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
.overview-rmd-row {
  display: grid; grid-template-columns: 72px 1fr 1fr; gap: 8px; align-items: start;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.overview-rmd-label { font: 700 14px var(--font-mono); color: var(--accent); padding-top: 4px; }
.overview-side-box {
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px;
  padding: 6px 10px; min-height: 36px;
}
.overview-side-label { font: 600 9px var(--font-mono); color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
.overview-cage-chip {
  display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px;
  font-weight: 600; margin: 1px 2px; border: 1px solid;
}
.overview-cage-chip.short { background: #e6f5ec; color: var(--green); border-color: #b0dcc0; }
.overview-cage-chip.medium { background: #fdf5dc; color: var(--yellow); border-color: #e0d8a0; }
.overview-cage-chip.tall { background: #fce8e8; color: var(--red); border-color: #e8b0b0; }
.overview-frame-card {
  display: flex; align-items: center; gap: 10px; padding: 8px 12px;
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px;
}
.overview-frame-card.has-cage { background: #e6f0fa; border-color: #a0c8e8; }
.overview-frame-card.shipping { background: #fdf8ee; border-color: #e0c880; }
.overview-frame-name { font: 700 13px var(--font-mono); width: 50px; }
.overview-frame-info { flex:1; font-size: 12px; }
.overview-frame-badges { display: flex; gap: 4px; flex-wrap: wrap; }

@media (max-width: 1100px) {
  .planner-layout { grid-template-columns: 1fr; }
  .overview-grid { grid-template-columns: 1fr; }
}

@media (max-width: 900px) {
  .sidebar { width: 52px; }
  .sidebar-btn span:not(.sidebar-icon) { display: none; }
  .sidebar-btn { padding: 9px 14px; justify-content: center; }
  .main { padding: 16px; }
  .form-grid-3 { grid-template-columns: 1fr 1fr; }
  .week-grid { grid-template-columns: repeat(4, 1fr); }
  .rmd-grid { grid-template-columns: 1fr; }
  .frame-grid { grid-template-columns: 1fr 1fr; }
  .stat-row { gap: 6px; }
  .stat-card { min-width: 90px; padding: 10px; }
}
</style>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODEL & CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FRAME_COUNT = 50;
const FRAME_WIDTHS = [1.1, 1.5, 2.3, 2.5];
const RMD_COUNT = 12;
const SIDES = ['A','B'];
const MAX_MOVES = 4;
const H_SHORT = 2.7, H_MED = 4.7;
const DOUBLE_SPARE = 0.3, DOUBLE_WT = 14;

const TABS = [
  {id:'dashboard', label:'Dashboard', icon:'‚óâ'},
  {id:'cages', label:'Cages', icon:'‚òê'},
  {id:'frames', label:'Frames', icon:'‚äû'},
  {id:'rmd', label:'RMD Storage', icon:'‚ñ¶'},
  {id:'planner', label:'Planner', icon:'‚áÑ'},
  {id:'movements', label:'Movements', icon:'‚Üî'},
  {id:'boatplan', label:'Boat Planner', icon:'üö¢'},
  {id:'shipping', label:'Shipping', icon:'‚õ¥'},
  {id:'report', label:'Report', icon:'‚éô'},
  {id:'audit', label:'Audit Log', icon:'üìã'},
];

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function hCat(h) { return h < H_SHORT ? 'Short' : h <= H_MED ? 'Medium' : 'Tall'; }
function lCat(l) { return l < 6.5 ? 'Stumpy' : 'Long'; }
function hBadge(h) { const c = hCat(h); return c === 'Short' ? 'green' : c === 'Medium' ? 'yellow' : 'red'; }
function locBadge(l) { return {facility:'blue', rmd:'green', frame:'orange', shipped:'purple'}[l] || 'accent'; }
function locLabel(c) {
  if (c.location === 'facility') return 'In Facility';
  if (c.location === 'rmd') return 'RMD ' + (c.locationDetail||'');
  if (c.location === 'frame') return 'Frame ' + (c.locationDetail||'');
  if (c.location === 'shipped') return 'Shipped';
  return c.location;
}
function canPairRMD(c1,c2) {
  const a=hCat(c1.height), b=hCat(c2.height);
  return ['Short-Tall','Tall-Short','Medium-Medium','Short-Medium','Medium-Short'].includes(a+'-'+b);
}
function canFitTwo(c1,c2,fw) {
  return c1.width+c2.width+DOUBLE_SPARE<=fw && c1.weight<=DOUBLE_WT && c2.weight<=DOUBLE_WT;
}
function needsWaler(cage) { return cage && cage.length < 6.5; }

// RMD spatial layout matching site: top=[12,11,10,gap,9] mid=[8,7] bot=[6,5,4,3,gap,2,1]
const RMD_LAYOUT = [
  {row:'top', items:[12,11,10,9]},
  {row:'mid', items:[8,7]},
  {row:'bot', items:[6,5,4,3,2,1]},
];
function getRMDByNum(n) { return STATE.rmdSlots.find(r=>r.number===n); }
function toISO(d) { return new Date(d).toISOString().split('T')[0]; }
function todayStr() { return toISO(new Date()); }
function fmt(d) { if(!d) return ''; return new Date(d+'T12:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}); }
function fmtShort(d) { if(!d) return ''; const dt=new Date(d+'T12:00:00'); return dt.toLocaleDateString('en-GB',{weekday:'short'})+' '+dt.getDate(); }
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

const PRELOAD_STATE = {"cages":[{"id":"19c76b4946ei9fmfw","name":"320","height":5.35,"width":1.84,"length":8.5,"weight":18.83,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4946fw9hcxa","name":"415","height":4.9,"width":1.5,"length":6.45,"weight":6.4,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4946fcrxl9j","name":"416","height":7.0,"width":0.85,"length":4.2,"weight":5.86,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49470okyutr","name":"445","height":4.1,"width":1.35,"length":11.45,"weight":11.3,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494701p7nuh","name":"433","height":5.96,"width":1.35,"length":7.1,"weight":8.3,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-08A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49471abpxbw","name":"589","height":3.5,"width":0.35,"length":5.1,"weight":1.11,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494713v1kk5","name":"454","height":6.5,"width":0.95,"length":9.4,"weight":9.22,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-01B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49472pf9hgm","name":"591","height":3.2,"width":0.66,"length":10.2,"weight":3.08,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49472ense8a","name":"597","height":3.2,"width":0.7,"length":10.0,"weight":3.13,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49473ixap4y","name":"914","height":0,"width":0,"length":0,"weight":1.66,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49473khk1l2","name":"915","height":0,"width":0,"length":0,"weight":0.84,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49474ps17zl","name":"917","height":0,"width":0,"length":0,"weight":1.53,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49474kod0zj","name":"918","height":0,"width":0,"length":0,"weight":0.81,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49475gh3x47","name":"911","height":3.05,"width":0.7,"length":5.95,"weight":2.79,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494752xbxyr","name":"410","height":4.49,"width":1.71,"length":6.03,"weight":4.91,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-07B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49476z7wc8o","name":"910","height":3.095,"width":0.74,"length":5.95,"weight":2.89,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-06B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49476lfbc8d","name":"955","height":4.785,"width":0.36,"length":4.5,"weight":2.16,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494773mvbs6","name":"957","height":4.8,"width":0.45,"length":6.4,"weight":2.96,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-12B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49477sk6twf","name":"407","height":5.8,"width":1.0,"length":9.6,"weight":6.49,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-02A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494783i24wf","name":"956","height":4.85,"width":0.36,"length":4.3,"weight":1.7,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-05A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49479yaw0d2","name":"950","height":4.8,"width":1.7,"length":11.0,"weight":15.07,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49479jnq6p1","name":"431","height":6.3,"width":1.4,"length":11.0,"weight":19.49,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-10A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947arldwi3","name":"406","height":4.1,"width":1.5,"length":5.9,"weight":5.04,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-01A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947aelzyy6","name":"398","height":6.325,"width":0.38,"length":8.46,"weight":6.43,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-12A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947bl05qd6","name":"901","height":4.6,"width":1.74,"length":10.8,"weight":19.62,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-08B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947b5av12x","name":"368","height":3.1,"width":0.88,"length":8.3,"weight":3.51,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-06B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947c9bxhvh","name":"919","height":4.7,"width":0.68,"length":5.95,"weight":4.58,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-12B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947c4ubj57","name":"389","height":7.0,"width":0.38,"length":9.6,"weight":15.15,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-07A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947dik2kvy","name":"595","height":3.2,"width":0.65,"length":6.0,"weight":1.78,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947eomqqa2","name":"500","height":3.4,"width":0.4,"length":5.1,"weight":0.97,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-02B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947evqyjps","name":"916","height":3.0,"width":0.75,"length":6.4,"weight":3.51,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-01A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947f2mn8q2","name":"587","height":3.5,"width":0.36,"length":5.3,"weight":1.15,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-08B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4947fzfoumf","name":"599","height":3.5,"width":0.35,"length":6.2,"weight":1.16,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-11A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49480dsffuq","name":"961","height":4.9,"width":0.4,"length":7.0,"weight":3.45,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-11B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49480n7jj8d","name":"383","height":5.8,"width":1.06,"length":5.3,"weight":4.38,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-09B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494812ytp1g","name":"437","height":6.0,"width":1.4,"length":7.1,"weight":6.27,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-11A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49481ju2zpj","name":"951","height":4.7,"width":1.7,"length":11.0,"weight":18.07,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-02B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49482a27le4","name":"401","height":5.5,"width":0.68,"length":6.8,"weight":4.54,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-09A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948357ve62","name":"417","height":7.0,"width":0.85,"length":4.0,"weight":5.07,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-04A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49483oc4mr3","name":"440","height":3.9,"width":1.35,"length":11.5,"weight":11.36,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-03A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49484p0s5o3","name":"962","height":4.8,"width":1.7,"length":10.0,"weight":17.93,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-06A","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49484jid8cu","name":"479","height":4.1,"width":1.4,"length":11.5,"weight":10.13,"notes":"Imported from Excel","location":"rmd","locationDetail":"RMD-03B","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49485whx2pe","name":"334","height":5.4,"width":0.84,"length":4.15,"weight":3.89,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49485kjycqu","name":"392","height":6.9,"width":1.1,"length":4.5,"weight":4.52,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494865qaq29","name":"418","height":6.0,"width":0.85,"length":4.0,"weight":7.03,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494862a4slt","name":"426","height":3.8,"width":0.95,"length":9.3,"weight":5.39,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49487k7woqz","name":"612","height":6.3,"width":0.35,"length":9.6,"weight":8.79,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49487i3dd1l","name":"639","height":6.6,"width":0.35,"length":9.6,"weight":7.77,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49488z7ody3","name":"474","height":6.9,"width":1.0,"length":7.4,"weight":6.68,"notes":"Imported from Excel","location":"frame","locationDetail":"TF-38","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494884kzx2r","name":"481","height":5.8,"width":0.95,"length":6.9,"weight":5.39,"notes":"Imported from Excel","location":"frame","locationDetail":"TF-33","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49489gzju80","name":"478","height":4.0,"width":1.38,"length":11.5,"weight":9.99,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948aoqdkmv","name":"281","height":4.9,"width":1.85,"length":10.0,"weight":15.16,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948aisoyfj","name":"424","height":3.1,"width":0.98,"length":10.3,"weight":4.5,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948bw6vxji","name":"429","height":3.1,"width":0.95,"length":4.4,"weight":2.32,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948b8e5aev","name":"439","height":5.9,"width":1.35,"length":5.4,"weight":12.8,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948crio165","name":"470","height":3.7,"width":0.96,"length":5.7,"weight":3.27,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948cfvk782","name":"604","height":6.6,"width":0.35,"length":9.6,"weight":9.06,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948d2f8htb","name":"613","height":5.0,"width":0.35,"length":9.6,"weight":7.73,"notes":"Imported from Excel","location":"frame","locationDetail":"TF-43","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948e2qul4b","name":"619","height":6.6,"width":0.35,"length":9.3,"weight":9.53,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948eyaq7is","name":"633","height":6.3,"width":0.35,"length":9.6,"weight":8.92,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948f3tv8f2","name":"921","height":0,"width":0,"length":0,"weight":2.88,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4948fwj4iyx","name":"972","height":0,"width":0,"length":0,"weight":2.93,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49490tkql55","name":"483","height":0,"width":0,"length":0,"weight":12.8,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494900hubx3","name":"432","height":3.7,"width":0.95,"length":5.9,"weight":3.6,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49491tu82ia","name":"624","height":6.6,"width":0.35,"length":9.6,"weight":9.06,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49491jw6k7a","name":"632","height":4.96,"width":0.35,"length":9.6,"weight":7.29,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49492le77ab","name":"920","height":0,"width":0,"length":0,"weight":3.36,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494933gj2bt","name":"472","height":0,"width":0,"length":0,"weight":3.42,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49493u2uljp","name":"966","height":0,"width":0,"length":0,"weight":19.02,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49494wfb8xm","name":"968","height":0,"width":0,"length":0,"weight":17.18,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494940l7ki8","name":"971","height":0,"width":0,"length":0,"weight":7.96,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494955ta20o","name":"979","height":0,"width":0,"length":0,"weight":1.12,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49495tj6upf","name":"977","height":0,"width":0,"length":0,"weight":6.89,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49496j8iph1","name":"438","height":3.7,"width":0.95,"length":10.3,"weight":6.11,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49496ff8r1r","name":"441","height":3.7,"width":0.95,"length":4.4,"weight":2.86,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49497lx0gyw","name":"471","height":3.6,"width":0,"length":7.2,"weight":3.83,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49497qgj965","name":"908","height":0,"width":0,"length":0,"weight":2.57,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494982q36ba","name":"909","height":0,"width":0,"length":0,"weight":2.82,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49499f6p592","name":"964","height":0,"width":0,"length":0,"weight":18.22,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49499vhop2j","name":"965","height":0,"width":0,"length":0,"weight":19.31,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949abbfi6n","name":"976","height":0,"width":0,"length":0,"weight":3.77,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949afzvfps","name":"954","height":0,"width":0,"length":0,"weight":4.35,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949b9qrzcd","name":"1800","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949ba2hbcd","name":"1801","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949c1yd4as","name":"967","height":0,"width":0,"length":0,"weight":19.23,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949c58tixd","name":"969","height":0,"width":0,"length":0,"weight":19.64,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949d1gl6zj","name":"970","height":0,"width":0,"length":0,"weight":19.34,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949e0iytbz","name":"975","height":0,"width":0,"length":0,"weight":4.78,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949efqgn1k","name":"978","height":0,"width":0,"length":0,"weight":6.46,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949f33grph","name":"974","height":0,"width":0,"length":0,"weight":3.04,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4949fj3kmke","name":"405","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a01q98sv","name":"482","height":0,"width":0,"length":0,"weight":10.03,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a091ub3y","name":"1804","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a1dhifd6","name":"1802","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a119oo4j","name":"1808","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a2ts3f33","name":"1809","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a27wgpax","name":"1803","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a3tn0v98","name":"1806","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a3uljaj0","name":"1807","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a4aos93w","name":"446","height":0,"width":0,"length":0,"weight":10.69,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a4rlpz62","name":"1810","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a5p4fqvv","name":"1100","height":0,"width":0,"length":0,"weight":18.83,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a67j3v9h","name":"1812","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a6gwj5c3","name":"1101","height":0,"width":0,"length":0,"weight":16.43,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a7nbxsae","name":"1811","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a7r0rwna","name":"1813","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a84lac7a","name":"973","height":0,"width":0,"length":0,"weight":2.12,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a8wo4c3h","name":"1814","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494a9577v1j","name":"1600","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aalz4u2p","name":"1602","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aa4m23y4","name":"1601","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494abaw0rmg","name":"1603","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ab8j9dao","name":"1815","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ac4bxlop","name":"1821","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494adkwcm4a","name":"1816","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494adtm5pbd","name":"1818","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aeph9o8u","name":"1700","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494aejj0dcq","name":"1701","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494afkjssrj","name":"1702","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b04m9aes","name":"1819","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b06x3hq3","name":"1823","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b1buhh8x","name":"1822","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b1rv2qek","name":"1817","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b2wpntgu","name":"1820","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b22a369h","name":"1824","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b3jva3uo","name":"1703","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b4z8cjep","name":"1300","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b4ze4q6m","name":"1301","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b5yp25zw","name":"1302","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b54acjj4","name":"1304","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b6f2p49e","name":"1104","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b6bl3375","name":"1825","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b77fjdme","name":"1826","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b7wsksbf","name":"1827","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b8p0bxbv","name":"1828","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b9wev51q","name":"1904","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494b9o6e4e6","name":"1905","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ba3yjuhd","name":"1704","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bap9vxfo","name":"1705","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bbd4pb0i","name":"1916","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bblngs34","name":"1103","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bc2nt4n6","name":"1106","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bcz787a6","name":"1105","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bdnbbsea","name":"1108","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bdd74b6p","name":"1829","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494be3pyccl","name":"1830","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bflkilvt","name":"1831","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494bf8k0aos","name":"1107","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c0yg84cm","name":"1400","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c14kt1si","name":"1832","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c14vx49n","name":"1833","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c296tht0","name":"1109","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c2yu3juy","name":"1915","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c3ef6o76","name":"1917","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c371dcyy","name":"1911","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c4zrh8ch","name":"1708","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c54arkka","name":"1709","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c598z4zo","name":"1710","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c6d2qytf","name":"1401","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c70qe2iw","name":"1607","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c7vgog8m","name":"1608","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c8en79jx","name":"1303","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494c9fi8ytt","name":"1706","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494caz6xmda","name":"1707","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ca11nqg2","name":"1613","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cbl1xyon","name":"1834","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cbbbveks","name":"1604","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cchyeg9c","name":"1605","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ccmtlo11","name":"1835","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cdgnwfbp","name":"1609","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cdecbk3x","name":"1610","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cesobnhq","name":"1919","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cfkbikch","name":"1900","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494cfppy1g9","name":"1918","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d0y7wj2h","name":"1402","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d0xx64pa","name":"1404","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d1olj72c","name":"1611","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d140lwix","name":"1606","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d21fw310","name":"1711","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d2hu9ua1","name":"1902","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d3ebeaqn","name":"1903","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d3dyp09l","name":"1403","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d432gyaj","name":"1901","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d4jqtyoc","name":"1908","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d5tqpzzl","name":"1909","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d685wx1y","name":"1612","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d86pwwm8","name":"1906","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d9pd4rfi","name":"1907","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494d9uvpu1u","name":"1912","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494dau7us61","name":"1910","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494darjj9ft","name":"1913","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494db5rgrq3","name":"1200","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494db7emy8m","name":"1201","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e0o27pk3","name":"655","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e1zgrc2b","name":"664","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e1hcvxks","name":"665","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e2v5tukn","name":"670","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e29usfl8","name":"675","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e3wu9f6h","name":"684","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e3gsz1zf","name":"1914","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e6q31ol1","name":"651","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e607luas","name":"652","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e7c50kjx","name":"656","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e7y0wrxt","name":"685","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e8g44g45","name":"690","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e85wuuaa","name":"1405","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494e9xl43xx","name":"1305","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ebvwzdxp","name":"653","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494eckzi2oo","name":"657","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ec0m4g2l","name":"658","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ed80nro6","name":"659","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494edaqu3kh","name":"660","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ee9ckbu0","name":"666","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ee50c6uy","name":"1406","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494efj1lfqx","name":"1202","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f0q8jnub","name":"1203","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f05c0nvu","name":"661","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f1onvovs","name":"667","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f1pua1wq","name":"668","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f2op4gi7","name":"671","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f2p9p5wy","name":"676","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f3knn1ux","name":"678","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f32ueujk","name":"1408","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f4sxixxv","name":"1409","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f4nf1gny","name":"1204","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f56pxiqp","name":"1205","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f5gcrx00","name":"672","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f6unab1z","name":"673","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f7r0azpw","name":"680","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f7mvhofl","name":"1410","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f8073dtq","name":"1411","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f8c4rzf1","name":"1306","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f99a9p0y","name":"1307","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494f9hbxhh0","name":"1308","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fa9y74ee","name":"1309","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fbmjab6f","name":"677","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fby5bgbm","name":"679","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fcy5kq4z","name":"681","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fd5wox9o","name":"686","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fdiv42kq","name":"687","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494fe4m4l8n","name":"688","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b494ff8ve0nu","name":"1310","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49500a3vnvj","name":"1206","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495008o0ye2","name":"1413","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49501cnf9wo","name":"1311","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49504ur679u","name":"1407","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950659sfo3","name":"1412","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495089mn8a0","name":"1314","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49508opcgig","name":"1207","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49509g6yeju","name":"1208","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950bdsa47y","name":"1414","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950dhun7er","name":"1312","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950e5olkop","name":"1313","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950e7imvbd","name":"1209","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4950f3kd6zl","name":"1210","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49516rs8qzt","name":"654","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495179zvfzu","name":"662","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951bkable5","name":"663","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951bgucnri","name":"1211","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951c3goyxx","name":"1212","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4951cv2n33x","name":"1213","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495217hvmxa","name":"669","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4952134i15p","name":"674","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49522snygbh","name":"682","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49522q6bwg7","name":"683","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49523fw1c85","name":"689","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495234jws3d","name":"1214","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49524868p96","name":"1215","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b495529u1m8y","name":"1805","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4958ct5xpsr","name":"1102","height":0,"width":0,"length":0,"weight":17.16,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4958d7zcsj3","name":"=COUNT(B4:B537)","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b4958fe9trb7","name":"Production Number","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49607cea4fv","name":"=COUNT(B542:B765)","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49609smpho4","name":"Production Number","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"},{"id":"19c76b49685pzi58f","name":"=COUNT(B770:B999)","height":0,"width":0,"length":0,"weight":0,"notes":"Imported from Excel","location":"facility","locationDetail":"","createdAt":"2026-02-19T12:00:00.000Z"}],"frames":[{"id":"19c76b49685vf2t3w","name":"TF-1","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685i3m9nw","name":"TF-2","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b4968547tyoy","name":"TF-3","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685iqw9r5","name":"TF-4","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496854uslgg","name":"TF-5","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685gdcbpt","name":"TF-6","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685p8fqo4","name":"TF-7","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496854b7xy5","name":"TF-8","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685r0rzvz","name":"TF-9","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685gj8x19","name":"TF-10","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685eln1gm","name":"TF-11","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685bfpfvl","name":"TF-12","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685asrzm1","name":"TF-13","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685mvmrb3","name":"TF-14","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496858z4v2o","name":"TF-15","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496858z0il7","name":"TF-16","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496853yq149","name":"TF-17","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685e5wixe","name":"TF-18","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685j1uiq7","name":"TF-19","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685fudpmy","name":"TF-20","width":2.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685dpm1bb","name":"TF-21","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496852qrymi","name":"TF-22","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685n2cyay","name":"TF-23","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ojnfts","name":"TF-24","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685spnqe9","name":"TF-25","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685i51qbb","name":"TF-26","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685wgqfye","name":"TF-27","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b496855dwzkw","name":"TF-28","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685fj8w0j","name":"TF-29","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685s3s3sh","name":"TF-30","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496857x06z9","name":"TF-31","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685xdd72e","name":"TF-32","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685yvwh4j","name":"TF-33","width":1.1,"location":"facility","cages":["19c76b494884kzx2r"],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685tlbfsu","name":"TF-34","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685skx3ia","name":"TF-35","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685hd8bqb","name":"TF-36","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685vm82n4","name":"TF-37","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685ly11ks","name":"TF-38","width":2.5,"location":"facility","cages":["19c76b49488z7ody3"],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b4968503mtlz","name":"TF-39","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685mcw8yk","name":"TF-40","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685265vko","name":"TF-41","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685p0e9xc","name":"TF-42","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ycmvy4","name":"TF-43","width":1.1,"location":"facility","cages":["19c76b4948d2f8htb"],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b496855ssvl0","name":"TF-44","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b49685gormow","name":"TF-45","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ixtgt1","name":"TF-46","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685rrayhh","name":"TF-47","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685iq13hq","name":"TF-48","width":1.5,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false},{"id":"19c76b49685ssy2th","name":"TF-49","width":1.1,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":true},{"id":"19c76b4968585hv1k","name":"TF-50","width":2.3,"location":"facility","cages":[],"fixedForShipping":false,"hasWaler":false}],"rmdSlots":[{"number":1,"A":{"cage1":"19c76b4947arldwi3","cage2":"19c76b4947evqyjps","overridden":false},"B":{"cage1":"19c76b494713v1kk5","cage2":null,"overridden":false}},{"number":2,"A":{"cage1":"19c76b49477sk6twf","cage2":null,"overridden":false},"B":{"cage1":"19c76b4947eomqqa2","cage2":"19c76b49481ju2zpj","overridden":false}},{"number":3,"A":{"cage1":"19c76b49483oc4mr3","cage2":null,"overridden":false},"B":{"cage1":"19c76b49484jid8cu","cage2":null,"overridden":false}},{"number":4,"A":{"cage1":"19c76b4946fcrxl9j","cage2":"19c76b4948357ve62","overridden":false},"B":{"cage1":"19c76b49475gh3x47","cage2":"19c76b49479yaw0d2","overridden":false}},{"number":5,"A":{"cage1":"19c76b49476lfbc8d","cage2":"19c76b494783i24wf","overridden":false},"B":{"cage1":"19c76b49472pf9hgm","cage2":"19c76b49472ense8a","overridden":false}},{"number":6,"A":{"cage1":"19c76b49484p0s5o3","cage2":null,"overridden":false},"B":{"cage1":"19c76b49476z7wc8o","cage2":"19c76b4947b5av12x","overridden":false}},{"number":7,"A":{"cage1":"19c76b4947c4ubj57","cage2":null,"overridden":false},"B":{"cage1":"19c76b494752xbxyr","cage2":null,"overridden":false}},{"number":8,"A":{"cage1":"19c76b494701p7nuh","cage2":null,"overridden":false},"B":{"cage1":"19c76b4947bl05qd6","cage2":"19c76b4947f2mn8q2","overridden":false}},{"number":9,"A":{"cage1":"19c76b49482a27le4","cage2":null,"overridden":false},"B":{"cage1":"19c76b49480n7jj8d","cage2":null,"overridden":false}},{"number":10,"A":{"cage1":"19c76b49479jnq6p1","cage2":null,"overridden":false},"B":{"cage1":null,"cage2":null,"overridden":false}},{"number":11,"A":{"cage1":"19c76b4947fzfoumf","cage2":"19c76b494812ytp1g","overridden":false},"B":{"cage1":"19c76b49480dsffuq","cage2":null,"overridden":false}},{"number":12,"A":{"cage1":"19c76b4947aelzyy6","cage2":null,"overridden":false},"B":{"cage1":"19c76b494773mvbs6","cage2":"19c76b4947c9bxhvh","overridden":false}}],"plannedMovements":[],"shipments":[],"settings":{"movementsPerDay":4}};

function initState() {
  return {
    cages: [],
    frames: Array.from({length:FRAME_COUNT},(_,i)=>({
      id:uid(), name:`TF-${i+1}`, width:2.5, location:'facility', cages:[], fixedForShipping:false, hasWaler:false
    })),
    rmdSlots: Array.from({length:RMD_COUNT},(_,i)=>{
      let o={number:i+1};
      SIDES.forEach(s=>{ o[s]={cage1:null,cage2:null,cage3:null,cage4:null,overridden:false}; });
      return o;
    }),
    plannedMovements: [],
    shipments: [],
    settings: { movementsPerDay: MAX_MOVES }
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let STATE = initState();
let activeTab = 'dashboard';

// ‚îÄ‚îÄ API config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Set this to your Worker URL, e.g. https://cage-tracker-api.yourname.workers.dev
const API_BASE = 'https://cage-tracker-api.exposurephotographer0.workers.dev';

async function api(path, method = 'GET', body = null) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 8000);
  try {
    const opts = { method, headers: { 'Content-Type': 'application/json' }, signal: controller.signal };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API_BASE + path, opts);
    if (!res.ok) {
      const e = await res.json().catch(() => ({}));
      throw new Error(e.error || `HTTP ${res.status}`);
    }
    return res.json();
  } finally {
    clearTimeout(timeout);
  }
}

// ‚îÄ‚îÄ Load all state from D1 on startup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadState() {
  // Load from embedded PRELOAD_STATE immediately so the UI is never blocked
  STATE = {
    ...initState(),
    cages: (PRELOAD_STATE.cages || []).map(normaliseCage),
    frames: PRELOAD_STATE.frames || [],
    rmdSlots: (PRELOAD_STATE.rmdSlots || []).map(r => ({
      ...r,
      A: { cage1: r.A?.cage1||null, cage2: r.A?.cage2||null, cage3: r.A?.cage3||null, cage4: r.A?.cage4||null, overridden: !!r.A?.overridden },
      B: { cage1: r.B?.cage1||null, cage2: r.B?.cage2||null, cage3: r.B?.cage3||null, cage4: r.B?.cage4||null, overridden: !!r.B?.overridden },
    })),
    plannedMovements: PRELOAD_STATE.plannedMovements || [],
    shipments: PRELOAD_STATE.shipments || [],
    settings: PRELOAD_STATE.settings || { movementsPerDay: MAX_MOVES },
  };

  // Then try to refresh from the API in the background
  try {
    const data = await api('/api/state');
    STATE = {
      ...initState(),
      cages: data.cages.map(normaliseCage),
      frames: data.frames,
      rmdSlots: data.rmdSlots.map(r => ({
        ...r,
        A: { cage1: r.A?.cage1||null, cage2: r.A?.cage2||null, cage3: r.A?.cage3||null, cage4: r.A?.cage4||null, overridden: !!r.A?.overridden },
        B: { cage1: r.B?.cage1||null, cage2: r.B?.cage2||null, cage3: r.B?.cage3||null, cage4: r.B?.cage4||null, overridden: !!r.B?.overridden },
      })),
      plannedMovements: data.plannedMovements,
      shipments: data.shipments,
      settings: { movementsPerDay: parseInt(data.settings?.movementsPerDay) || MAX_MOVES }
    };
    console.log('[CageTracker] State synced from API:', STATE.cages.length, 'cages');
    render();
  } catch(e) {
    console.warn('[CageTracker] API unavailable, using local data:', e.message);
  }
}

function normaliseCage(c) {
  return {
    id: c.id, name: c.name,
    height: c.height || 0, width: c.width || 0, length: c.length || 0, weight: c.weight || 0,
    location: c.location || 'facility',
    locationDetail: c.location_detail || c.locationDetail || '',
    departureDate: c.departure_date || c.departureDate || null,
    proposedShipDay: c.proposed_ship_day || c.proposedShipDay || null,
    notes: c.notes || '',
    createdAt: c.created_at || c.createdAt || new Date().toISOString(),
  };
}

// saveState is now a no-op ‚Äî we save directly to the API on each mutation
function saveState() {}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoadingOverlay(show) {
  if (!document.body) return; // DOM not ready yet
  let el = document.getElementById('api-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'api-loading';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(26,34,53,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;color:#fff;font:600 15px var(--font-display);gap:10px;';
    el.innerHTML = '<div style="width:22px;height:22px;border:3px solid rgba(255,255,255,0.3);border-top-color:#e8a830;border-radius:50%;animation:spin 0.8s linear infinite"></div> Loading‚Ä¶';
    document.body.appendChild(el);
    const style = document.createElement('style');
    style.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
    document.head.appendChild(style);
  }
  el.style.display = show ? 'flex' : 'none';
}

function showError(msg) {
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:16px;right:16px;background:#fce8e8;border:1px solid #e8b0b0;color:#c93030;padding:12px 18px;border-radius:8px;font-size:13px;z-index:9999;max-width:380px;box-shadow:0 4px 12px rgba(0,0,0,0.15)';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 6000);
}

function showSuccess(msg) {
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:16px;right:16px;background:#e6f5ec;border:1px solid #b0dcc0;color:#1a8a4a;padding:12px 18px;border-radius:8px;font-size:13px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15)';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ‚îÄ‚îÄ Granular save helpers (called after each mutation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveCage(cage) {
  try { await api('/api/cages', 'PUT', cage); }
  catch(e) { showError('Failed to save cage: ' + e.message); }
}
async function addCageToAPI(cage) {
  try { await api('/api/cages', 'POST', cage); }
  catch(e) { showError('Failed to add cage: ' + e.message); }
}
async function deleteCageFromAPI(id) {
  try { await api('/api/cages', 'DELETE', { id }); }
  catch(e) { showError('Failed to delete cage: ' + e.message); }
}
async function saveFrame(frame) {
  try { await api('/api/frames', 'PUT', frame); }
  catch(e) { showError('Failed to save frame: ' + e.message); }
}
async function saveRMD() {
  try { await api('/api/rmd', 'PUT', STATE.rmdSlots); }
  catch(e) { showError('Failed to save RMD: ' + e.message); }
}
async function addMovementToAPI(m) {
  try { await api('/api/movements', 'POST', m); }
  catch(e) { showError('Failed to add movement: ' + e.message); }
}
async function updateMovementInAPI(m) {
  try { await api('/api/movements', 'PUT', m); }
  catch(e) { showError('Failed to update movement: ' + e.message); }
}
async function deleteMovementFromAPI(id) {
  try { await api('/api/movements', 'DELETE', { id }); }
  catch(e) { showError('Failed to delete movement: ' + e.message); }
}
async function deleteAllMovementsFromAPI() {
  try { await api('/api/movements', 'DELETE', { deleteAll: true }); }
  catch(e) { showError('Failed to clear movements: ' + e.message); }
}
async function addShipmentToAPI(s) {
  try { await api('/api/shipments', 'POST', s); }
  catch(e) { showError('Failed to add shipment: ' + e.message); }
}
async function updateShipmentInAPI(s) {
  try { await api('/api/shipments', 'PUT', s); }
  catch(e) { showError('Failed to update shipment: ' + e.message); }
}
async function deleteShipmentFromAPI(id) {
  try { await api('/api/shipments', 'DELETE', { id }); }
  catch(e) { showError('Failed to delete shipment: ' + e.message); }
}

function getCage(id) { return STATE.cages.find(c=>c.id===id); }
function getFrame(id) { return STATE.frames.find(f=>f.id===id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSidebar() {
  document.getElementById('sidebar').innerHTML = TABS.map(t=>`
    <button class="sidebar-btn ${activeTab===t.id?'active':''}" onclick="switchTab('${t.id}')">
      <span class="sidebar-icon">${t.icon}</span><span>${t.label}</span>
    </button>
  `).join('');
}

function switchTab(id) {
  if (id !== 'movements') {
    const svg = document.getElementById('mv-svg-arrows');
    if (svg) svg.innerHTML = '';
  }
  activeTab=id; renderSidebar(); renderMain();
}

function renderMain() {
  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="tab-content active" id="tab-${activeTab}">
      ${renderTab(activeTab)}
    </div>
  `;
  // Schedule arrow draw after DOM settles when on movements tab
  if (activeTab === 'movements') {
    requestAnimationFrame(() => { setTimeout(mvRedraw, 50); });
  }
}

function renderTab(id) {
  switch(id) {
    case 'dashboard': return renderDashboard();
    case 'cages': return renderCages();
    case 'frames': return renderFrames();
    case 'rmd': return renderRMD();
    case 'planner': return renderPlanner();
    case 'movements': return renderMovementsMap();
    case 'boatplan': return renderBoatPlanner();
    case 'shipping': return renderShipping();
    case 'overview': return renderOverview();
    case 'report': return renderReport();
    case 'audit': return renderAuditLog();
    default: return '';
  }
}

function render() { renderSidebar(); renderMain(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Shipment shading helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getShipmentDays() {
  return [...new Set(
    STATE.cages
      .filter(c => (c.location === 'rmd' || c.location === 'frame') && c.proposedShipDay)
      .map(c => c.proposedShipDay)
  )].sort();
}
function shipmentShadeClass(cage, shipDays) {
  if (!cage || !cage.proposedShipDay || !shipDays.length) return null;
  if (cage.proposedShipDay === shipDays[0]) return 'next';
  if (shipDays[1] && cage.proposedShipDay === shipDays[1]) return 'second';
  return null;
}
function shipmentShadeBg(shade) {
  if (shade === 'next')   return 'background:#3b1d6e;';
  if (shade === 'second') return 'background:#c8b8e8;';
  return '';
}
function shipmentShadeNameColor(shade) {
  if (shade === 'next')   return 'color:#e0ccff;';
  if (shade === 'second') return 'color:#4a2a7a;';
  return '';
}
function shipmentShadeDetailColor(shade) {
  if (shade === 'next')   return 'color:#c0a8ee;';
  if (shade === 'second') return 'color:#6a4a9a;';
  return '';
}
function shipmentLegendHTML(shipDays) {
  if (!shipDays.length) return '';
  return `<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
    ${shipDays[0] ? `<span style="background:#3b1d6e;color:#e0ccff;font:700 9px var(--font-mono);padding:2px 10px;border-radius:10px">&#9632; Next shipment: ${fmt(shipDays[0])}</span>` : ''}
    ${shipDays[1] ? `<span style="background:#c8b8e8;color:#4a2a7a;font:700 9px var(--font-mono);padding:2px 10px;border-radius:10px">&#9632; 2nd shipment: ${fmt(shipDays[1])}</span>` : ''}
  </div>`;
}

function renderRMDHeatmap() {
  const total = STATE.rmdSlots.length;
  if (total === 0) return '';
  const slotKeys = ['cage1','cage2','cage3','cage4'];
  const maxSlots = 8; // 4 per side √ó 2 sides

  const cards = RMD_LAYOUT.flatMap(row => row.items).map(rmdNum => {
    const r = getRMDByNum(rmdNum);
    if (!r) return '';
    const used = ['A','B'].reduce((sum, side) =>
      sum + slotKeys.filter(k => !!r[side][k]).length, 0);
    const pct = used / maxSlots;
    const isEmpty = used === 0;
    const isFull = used === maxSlots;
    // Colour: green=empty, yellow=partial, orange=mostly full, red=full
    const bg = isEmpty ? '#e6f5ec' : isFull ? '#fce8e8' : pct >= 0.75 ? '#fff0e0' : '#fdf5dc';
    const border = isEmpty ? '#b0dcc0' : isFull ? '#e8b0b0' : pct >= 0.75 ? '#e8c8a0' : '#e0d8a0';
    const textCol = isEmpty ? 'var(--green)' : isFull ? 'var(--red)' : pct >= 0.75 ? 'var(--orange)' : 'var(--yellow)';

    // Mini slot grid: 4 rows (A-in, A-out, B-in, B-out), 2 cols each
    const slotDots = ['A','B'].map(side =>
      slotKeys.map(k => {
        const filled = !!r[side][k];
        return `<div style="width:8px;height:8px;border-radius:2px;background:${filled ? textCol : 'var(--bg-deep)'}"></div>`;
      }).join('')
    ).join('');

    return `<div onclick="switchTab('rmd')" style="background:${bg};border:1px solid ${border};border-radius:8px;padding:8px 10px;cursor:pointer;transition:all 0.1s;min-width:80px" title="RMD-${rmdNum}: ${used}/${maxSlots} slots used">
      <div style="font:700 12px var(--font-mono);color:${textCol};margin-bottom:6px">RMD-${rmdNum}</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:3px;margin-bottom:5px">${slotDots}</div>
      <div style="font-size:10px;font-weight:600;color:${textCol}">${used}/${maxSlots}</div>
    </div>`;
  }).join('');

  const totalUsed = STATE.rmdSlots.reduce((sum, r) =>
    sum + ['A','B'].reduce((s2, side) => s2 + slotKeys.filter(k => !!r[side][k]).length, 0), 0);
  const totalCapacity = STATE.rmdSlots.length * maxSlots;
  const overallPct = Math.round(totalUsed / totalCapacity * 100);

  return `<div class="card" style="margin-bottom:14px">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">üóÑ RMD Capacity Overview</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-size:12px;color:var(--text-muted)">${totalUsed} / ${totalCapacity} slots used</div>
        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:20px;padding:3px 12px;font:700 13px var(--font-mono);color:${overallPct>=90?'var(--red)':overallPct>=70?'var(--orange)':'var(--green)'}">${overallPct}%</div>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px;font-size:10px;align-items:center;flex-wrap:wrap">
      <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;border-radius:3px;background:#e6f5ec;border:1px solid #b0dcc0;display:inline-block"></span>Empty</span>
      <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;border-radius:3px;background:#fdf5dc;border:1px solid #e0d8a0;display:inline-block"></span>Partial</span>
      <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;border-radius:3px;background:#fff0e0;border:1px solid #e8c8a0;display:inline-block"></span>Mostly full</span>
      <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;border-radius:3px;background:#fce8e8;border:1px solid #e8b0b0;display:inline-block"></span>Full</span>
      <span style="margin-left:6px;font-size:10px;color:var(--text-muted)">Each dot = one cage slot ¬∑ Click any bay to manage</span>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">${cards}</div>
  </div>`;
}

function renderDashboard() {
  const cages = STATE.cages;
  const inFac = cages.filter(c=>c.location==='facility').length;
  const inRMD = cages.filter(c=>c.location==='rmd').length;
  const inFrm = cages.filter(c=>c.location==='frame').length;
  const shipped = cages.filter(c=>c.location==='shipped').length;
  const fFac = STATE.frames.filter(f=>f.location==='facility').length;
  const fBoat = STATE.frames.filter(f=>f.location==='boat').length;
  const fClient = STATE.frames.filter(f=>f.location==='client').length;
  const ready = STATE.frames.filter(f=>f.fixedForShipping && f.location==='facility').length;
  const todayMoves = STATE.plannedMovements.filter(m=>m.date===todayStr()&&!m.completed).length;
  const pending = STATE.plannedMovements.filter(m=>!m.completed).length;

  const _dashShipDays = getShipmentDays();

  function renderRMDSlot(side, slot, posLabel, r) {
    const cid = r[side][slot];
    const cage = cid ? getCage(cid) : null;
    if (cage) {
      const shade = shipmentShadeClass(cage, _dashShipDays);
      const slotBg = shade ? shipmentShadeBg(shade) + 'border-radius:4px;padding:2px 4px;' : '';
      const nameColor = shipmentShadeNameColor(shade);
      const detailColor = shipmentShadeDetailColor(shade);
      return `<div class="rmd-slot" style="${slotBg}">
        <span class="rmd-slot-label">${posLabel}</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name" style="${nameColor}">${esc(cage.name)}</span><span class="rmd-cage-detail" style="${detailColor}">${cage.width}m ¬∑ ${lCat(cage.length)} ¬∑ ${hCat(cage.height)}</span></span>
        </div>
      </div>`;
    } else {
      return `<div class="rmd-slot">
        <span class="rmd-slot-label">${posLabel}</span>
        <div class="rmd-slot-content" style="color:var(--text-muted);font-size:11px;font-style:italic">empty</div>
      </div>`;
    }
  }

  const rmdLegendHTML = shipmentLegendHTML(_dashShipDays);


  let rmdMiniHTML = RMD_LAYOUT.map(row=>{
    let items = row.items.map(item=>{
      const r = getRMDByNum(item);
      if (!r) return '';
      const cnt = [r.A.cage1,r.A.cage2,r.A.cage3,r.A.cage4,r.B.cage1,r.B.cage2,r.B.cage3,r.B.cage4].filter(Boolean).length;
      function renderSidePaired(side) {
        return `<div style="font:600 9px var(--font-mono);color:var(--blue);margin-bottom:2px">Inside</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px">
            ${renderRMDSlot(side,'cage1',side+' In 1',r)}${renderRMDSlot(side,'cage3',side+' In 2',r)}
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--green);margin-bottom:2px">Outside</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
            ${renderRMDSlot(side,'cage2',side+' Out 1',r)}${renderRMDSlot(side,'cage4',side+' Out 2',r)}
          </div>`;
      }
      return `<div class="rmd-site-card" onclick="switchTab('rmd')" style="cursor:pointer">
        <div class="card" style="padding:10px">
          <div class="flex-between" style="margin-bottom:6px">
            <span style="font:700 14px var(--font-mono);color:var(--accent)">RMD-${item}</span>
            <span style="font-size:10px;color:var(--text-muted)">${cnt}/8</span>
          </div>
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-bottom:3px;text-transform:uppercase">Side A</div>
          ${renderSidePaired('A')}
          <div style="font:600 9px var(--font-mono);color:var(--text-muted);margin-top:8px;margin-bottom:3px;text-transform:uppercase">Side B</div>
          ${renderSidePaired('B')}
        </div>
      </div>`;
    }).join('');
    return `<div class="rmd-site-row row-${row.row}">${items}</div>`;
  }).join('');

  let todayMovesHTML = STATE.plannedMovements.filter(m=>m.date===todayStr()&&!m.completed).map(m=>`
    <div style="padding:7px 0;border-bottom:1px solid var(--border);font-size:13px">
      <span style="color:var(--accent);font-weight:600">${esc(m.type)}</span> ‚Äî ${esc(m.description)}
    </div>
  `).join('') || '<div class="empty-msg">No movements planned for today</div>';

  return `
    <h2 class="section-title">Dashboard Overview</h2>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)">${cages.length}</div><div class="stat-lbl">Total Cages</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${inFac}</div><div class="stat-lbl">In Facility</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--green)">${inRMD}</div><div class="stat-lbl">In RMD</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">${inFrm}</div><div class="stat-lbl">In Frames</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--red)">${ready}</div><div class="stat-lbl">Ready to Ship</div></div>
    </div>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)">${fFac}</div><div class="stat-lbl">Frames at Facility</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${fBoat}</div><div class="stat-lbl">Frames on Boat</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--purple)">${fClient}</div><div class="stat-lbl">Frames w/ Client</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--orange)">${todayMoves}</div><div class="stat-lbl">Today's Moves</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--yellow)">${pending}</div><div class="stat-lbl">Pending Plans</div></div>
    </div>
    ${renderRMDHeatmap()}
    ${renderNextDueDelivery()}
    ${renderDashboardFrames()}
    <div style="display:grid;grid-template-columns:1fr;gap:14px">
      <div class="card" style="overflow-x:auto">
        <div class="card-title">RMD Storage ‚Äî Live View <span style="font-size:11px;font-weight:400;color:var(--text-muted)">(click any bay to manage)</span></div>
        ${rmdLegendHTML}
        <div class="rmd-site-layout" style="min-width:700px">${rmdMiniHTML}</div>
      </div>
      <div class="card">
        <div class="card-title">Today's Planned Movements</div>
        ${todayMovesHTML}
      </div>
    </div>
  `;
}

function renderNextDueDelivery() {
  const today = new Date();
  // Use proposedShipDay as the primary sort/urgency field
  const activeCages = STATE.cages.filter(c => c.location !== 'shipped' && c.proposedShipDay);
  if (activeCages.length === 0) return '';

  const sorted = [...activeCages].sort((a, b) => a.proposedShipDay.localeCompare(b.proposedShipDay));
  const earliestShipDay = sorted[0].proposedShipDay;

  const cageRows = sorted.map(c => {
    const shipDate = new Date(c.proposedShipDay + 'T12:00:00');
    const daysLeft = Math.ceil((shipDate - today) / 86400000);
    const isNext = c.proposedShipDay === earliestShipDay;
    const isOverdue = daysLeft < 0;
    const isUrgent = !isOverdue && daysLeft <= 3;
    const isWarning = !isOverdue && !isUrgent && daysLeft <= 7;

    let rowBg, highlightBar, urgencyBadge;
    if (isOverdue) {
      rowBg = 'background:linear-gradient(90deg,rgba(201,48,48,0.12) 0%,rgba(201,48,48,0.04) 100%);';
      highlightBar = 'border-left:3px solid var(--red);';
      urgencyBadge = `<span style="background:#c93030;color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">OVERDUE</span>`;
    } else if (isNext) {
      rowBg = 'background:linear-gradient(90deg,rgba(184,92,26,0.13) 0%,rgba(184,92,26,0.04) 100%);';
      highlightBar = 'border-left:3px solid var(--orange);';
      urgencyBadge = `<span style="background:var(--orange);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">NEXT UP ¬∑ ${daysLeft}d</span>`;
    } else if (isUrgent) {
      rowBg = 'background:linear-gradient(90deg,rgba(154,123,16,0.10) 0%,rgba(154,123,16,0.04) 100%);';
      highlightBar = 'border-left:3px solid var(--yellow);';
      urgencyBadge = `<span style="background:var(--yellow);color:#fff;font:700 10px var(--font-mono);padding:2px 8px;border-radius:10px">${daysLeft}d</span>`;
    } else if (isWarning) {
      rowBg = '';
      highlightBar = 'border-left:3px solid var(--border);';
      urgencyBadge = `<span style="font:600 11px var(--font-mono);color:var(--text-muted)">${daysLeft}d</span>`;
    } else {
      rowBg = '';
      highlightBar = 'border-left:3px solid transparent;';
      urgencyBadge = `<span style="font:600 11px var(--font-mono);color:var(--text-muted)">${daysLeft}d</span>`;
    }

    return `<div style="display:flex;align-items:center;gap:12px;padding:8px 12px;${rowBg}${highlightBar}border-radius:0 6px 6px 0;margin-bottom:4px">
      <div style="min-width:110px"><span style="font:700 13px var(--font-mono);color:var(--text-primary)">${esc(c.name)}</span></div>
      <div style="flex:1;font-size:11px;color:var(--text-muted)">${c.width}m √ó ${c.height}m √ó ${c.length}m ¬∑ ${c.weight}t</div>
      <div style="min-width:80px"><span class="badge badge-${locBadge(c.location)}" style="font-size:9px">${esc(locLabel(c))}</span></div>
      <div style="font:600 10px var(--font-mono);color:var(--purple);min-width:100px">üö¢ ${fmt(c.proposedShipDay)}</div>
      <div style="font:600 11px var(--font-mono);color:var(--text-secondary);min-width:90px">${c.departureDate ? fmt(c.departureDate) : '<span style="color:var(--text-muted)">‚Äî</span>'}</div>
      <div style="min-width:90px;text-align:right">${urgencyBadge}</div>
    </div>`;
  }).join('');

  const overdueCount = sorted.filter(c => Math.ceil((new Date(c.proposedShipDay+'T12:00:00') - today) / 86400000) < 0).length;
  const urgentCount = sorted.filter(c => { const d = Math.ceil((new Date(c.proposedShipDay+'T12:00:00') - today) / 86400000); return d >= 0 && d <= 3; }).length;

  return `<div class="card" style="margin-bottom:14px;border-color:${overdueCount > 0 ? 'var(--red)' : urgentCount > 0 ? '#e8c8a0' : 'var(--border)'}">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">
        üö¢ Next Due for Delivery
        ${overdueCount > 0 ? `<span style="background:var(--red);color:#fff;font:700 10px var(--font-mono);padding:2px 7px;border-radius:10px;margin-left:8px">${overdueCount} OVERDUE</span>` : ''}
        ${urgentCount > 0 ? `<span style="background:var(--orange);color:#fff;font:700 10px var(--font-mono);padding:2px 7px;border-radius:10px;margin-left:8px">${urgentCount} URGENT</span>` : ''}
      </div>
      <button class="btn btn-secondary btn-sm" onclick="switchTab('boatplan')">Boat Planner ‚Üí</button>
    </div>
    <div style="display:flex;gap:6px;font:600 9px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0 12px;margin-bottom:6px">
      <span style="min-width:110px">Cage</span><span style="flex:1">Dimensions ¬∑ Weight</span>
      <span style="min-width:80px">Location</span><span style="min-width:100px">Prop. Ship Day</span>
      <span style="min-width:90px">Leaves Facility</span><span style="min-width:90px;text-align:right">Due In</span>
    </div>
    ${cageRows}
  </div>`;
}

function renderDashboardFrames() {
  const facilityFrames = STATE.frames.filter(f => f.location === 'facility');
  if (facilityFrames.length === 0) return '';

  const _dfShipDays = getShipmentDays();
  function shipmentShade(cage) { return shipmentShadeClass(cage, _dfShipDays); }
  const nextShipDay = _dfShipDays[0] || null;
  const secondShipDay = _dfShipDays[1] || null;

  const frameCards = facilityFrames.map(f => {
    const fCages = f.cages.map(cid => getCage(cid)).filter(Boolean);
    const status = f.fixedForShipping ? 'ready' : f.cages.length === 0 ? 'empty' : 'loaded';
    const statusColor = status === 'ready' ? 'var(--accent)' : status === 'empty' ? 'var(--text-muted)' : 'var(--green)';
    const statusLabel = status === 'ready' ? '‚úì SHIP READY' : status === 'empty' ? 'EMPTY' : `${fCages.length} CAGE${fCages.length>1?'S':''}`;
    const borderStyle = status === 'ready' ? 'border-color:#c0a050;background:#fdfaf0' : status === 'empty' ? '' : 'border-color:#b0dcc0;background:#f0faf4';

    const cageList = fCages.length > 0
      ? fCages.map(c => {
          const shade = shipmentShade(c);
          const shadeBg = shade === 'next'
            ? 'background:#3b1d6e;color:#e0ccff;border-radius:4px;padding:2px 6px;'
            : shade === 'second'
            ? 'background:#c8b8e8;color:#4a2a7a;border-radius:4px;padding:2px 6px;'
            : '';
          const shipLabel = shade === 'next'
            ? `<span style="font:700 9px var(--font-mono);background:#5a2d9a;color:#e0ccff;padding:1px 5px;border-radius:3px;margin-left:4px">NEXT SHIP</span>`
            : shade === 'second'
            ? `<span style="font:700 9px var(--font-mono);background:#c8b8e8;color:#4a2a7a;padding:1px 5px;border-radius:3px;margin-left:4px">2ND SHIP</span>`
            : '';
          const dep = c.departureDate;
          const daysLeft = dep ? Math.ceil((new Date(dep+'T12:00:00') - new Date()) / 86400000) : null;
          const depStr = dep ? ` ¬∑ ${fmt(dep)} (${daysLeft}d)` : '';
          const depColor = daysLeft !== null && daysLeft <= 3 ? 'var(--red)' : 'var(--orange)';
          return `<div style="font-size:11px;padding:3px 0;display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600;font-family:var(--font-mono);${shadeBg}">${esc(c.name)}${shipLabel}</span>
            <span style="color:${dep ? depColor : 'var(--text-muted)'}">${c.width}m ¬∑ ${lCat(c.length)} ¬∑ ${hCat(c.height)}${depStr}</span>
          </div>`;
        }).join('')
      : '<div style="font-size:11px;color:var(--text-muted);font-style:italic">No cages loaded</div>';

    return `<div class="card" style="padding:10px;${borderStyle}">
      <div class="flex-between" style="margin-bottom:5px">
        <span style="font:700 13px var(--font-mono);color:var(--accent)">${esc(f.name)}</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span style="font:600 10px var(--font-mono);color:${statusColor}">${statusLabel}</span>
          ${f.hasWaler ? '<span class="badge badge-blue" style="font-size:8px;padding:1px 4px">üî©</span>' : ''}
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px">${f.width}m frame</div>
      ${cageList}
    </div>`;
  }).join('');


  return `<div class="card" style="margin-bottom:14px">
    <div class="flex-between" style="margin-bottom:10px">
      <div class="card-title" style="margin:0">Frames at Facility (${facilityFrames.length})</div>
      <button class="btn btn-secondary btn-sm" onclick="switchTab('frames')">Manage Frames ‚Üí</button>
    </div>
    ${shipmentLegendHTML(_dfShipDays)}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
      ${frameCards}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cageFormOpen = false;
let cageSearch = '';
let cageFilter = 'all';
let cageSort = 'number'; // 'number' | 'name'
let cageHeightFilter = 'all'; // 'all' | 'short' | 'medium' | 'tall'
let cageEditing = null;
let cageSelected = new Set(); // for multi-delete
let cageHideShipped = true;

function renderCages() {
  const filtered = STATE.cages.filter(c=>{
    if (cageHideShipped && c.location === 'shipped') return false;
    if (cageSearch && !c.name.toLowerCase().includes(cageSearch.toLowerCase())) return false;
    if (cageFilter === 'has-departure') return !!c.departureDate;
    if (cageFilter === 'has-shipday') return !!c.proposedShipDay;
    if (cageFilter !== 'all' && c.location !== cageFilter) return false;
    if (cageHeightFilter === 'short' && hCat(c.height) !== 'Short') return false;
    if (cageHeightFilter === 'medium' && hCat(c.height) !== 'Medium') return false;
    if (cageHeightFilter === 'tall' && hCat(c.height) !== 'Tall') return false;
    return true;
  }).sort((a, b) => {
    if (cageSort === 'number') {
      return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
    }
    return a.name.localeCompare(b.name);
  });

  let formHTML = '';
  if (cageFormOpen) {
    formHTML = `<div class="card">
      <div class="form-grid form-grid-3">
        <div><label>Cage Name / ID</label><input id="cf-name" placeholder="e.g. CAGE-001"/></div>
        <div><label>Height (m) ‚Äî max 10</label><input id="cf-h" type="number" step="0.1" max="10"/></div>
        <div><label>Width (m) ‚Äî max 2.5</label><input id="cf-w" type="number" step="0.1" max="2.5"/></div>
        <div><label>Length (m) ‚Äî max 11.5</label><input id="cf-l" type="number" step="0.1" max="11.5"/></div>
        <div><label>Weight (t) ‚Äî max 28</label><input id="cf-wt" type="number" step="0.1" max="28"/></div>
        <div><label>Notes</label><input id="cf-notes"/></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addCage()">Save Cage</button>
        <button class="btn btn-secondary" onclick="cageFormOpen=false;render()">Cancel</button>
      </div>
    </div>`;
  }

  // Build per-cage location options based on compatibility
  function cageLocationOpts(c) {
    // Frame options: cage must fit by width
    let frameOpts = STATE.frames.filter(f=>{
      if(f.location!=='facility') return false;
      if(f.cages.length >= 2) return false;
      // If frame already has a cage, check double-fit rules
      if(f.cages.length === 1) {
        const existing = getCage(f.cages[0]);
        if(!existing) return false;
        return canFitTwo(existing, c, f.width);
      }
      // Empty frame: cage width must fit
      return c.width <= f.width;
    }).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>{
      const existing = f.cages.length===1 ? getCage(f.cages[0]) : null;
      const note = existing ? ` [with ${existing.name}]` : '';
      return `<option value="frame:${f.id}">‚Üí ${esc(f.name)} (${f.width}m)${note}</option>`;
    }).join('');

    // RMD options: check height pairing rules
    let rmdOptsList = [];
    STATE.rmdSlots.forEach(r=>{
      SIDES.forEach(side=>{
        // inside slots: cage1, cage3 (group)
        // outside slots: cage2, cage4 (group)
        [['cage1','cage3'],['cage2','cage4']].forEach(groupSlots => {
          const posLabel = groupSlots[0]==='cage1' ? 'inside' : 'outside';
          groupSlots.forEach(slot => {
            if(r[side][slot]) return; // slot occupied
            // 13m length check
            const usedLen = groupSlots.filter(s=>s!==slot).reduce((sum,s)=>{const c2=r[side][s]?getCage(r[side][s]):null;return sum+(c2?c2.length||0:0);},0);
            if((c.length||0)+usedLen > 13) return; // cage too long for this group
            const otherCid = r[side][groupSlots.find(s=>s!==slot)] || null;
            const pairSlot = slot==='cage1'?'cage2':slot==='cage2'?'cage1':slot==='cage3'?'cage4':'cage3';
            const pairCid = r[side][pairSlot];
            if(pairCid) {
              const other = getCage(pairCid);
              if(other && canPairRMD(other, c)) {
                rmdOptsList.push(`<option value="rmd:${r.number}:${side}:${slot}">‚Üí RMD-${r.number}${side} (${posLabel}${slot==='cage3'||slot==='cage4'?' #2':''}) [with ${other.name}]</option>`);
              }
            } else {
              rmdOptsList.push(`<option value="rmd:${r.number}:${side}:${slot}">‚Üí RMD-${r.number}${side} (${posLabel}${slot==='cage3'||slot==='cage4'?' #2':''})</option>`);
            }
          });
        });
      });
    });
    let rmdOpts = rmdOptsList.sort((a,b)=>{
      const na = parseInt(a.match(/RMD-(\d+)/)?.[1]||0), nb = parseInt(b.match(/RMD-(\d+)/)?.[1]||0);
      return na!==nb ? na-nb : a.localeCompare(b);
    }).join('');

    let opts = '<option value="">Move to...</option>';
    if(c.location !== 'facility') opts += '<option value="facility">‚Üí Facility</option>';
    if(frameOpts) opts += `<optgroup label="Frames (${STATE.frames.filter(f=>f.location==='facility'&&c.width<=f.width&&f.cages.length<2).length} available)">${frameOpts}</optgroup>`;
    if(rmdOpts) opts += `<optgroup label="RMD Storage">${rmdOpts}</optgroup>`;
    return opts;
  }

  let rows = filtered.length === 0
    ? `<tr><td colspan="11" style="text-align:center;padding:20px" class="empty-msg">No cages found</td></tr>`
    : filtered.map(c=>{
      if (cageEditing === c.id) {
        return `<tr style="background:#fdf8ee">
          <td></td>
          <td><input id="ce-name-${c.id}" value="${esc(c.name)}" style="width:90px;font-size:12px"/></td>
          <td><input id="ce-h-${c.id}" type="number" step="0.01" value="${c.height}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-w-${c.id}" type="number" step="0.01" value="${c.width}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-l-${c.id}" type="number" step="0.01" value="${c.length}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-wt-${c.id}" type="number" step="0.01" value="${c.weight}" style="width:70px;font-size:12px"/></td>
          <td><input id="ce-dep-${c.id}" type="date" value="${c.departureDate||''}" style="width:130px;font-size:12px"/></td>
          <td><input id="ce-ship-${c.id}" type="date" value="${c.proposedShipDay||''}" style="width:130px;font-size:12px"/></td>
          <td><span class="badge badge-${hBadge(c.height)}">${hCat(c.height)}</span></td>
          <td><span class="badge badge-${locBadge(c.location)}">${esc(locLabel(c))}</span></td>
          <td colspan="2" style="white-space:nowrap">
            <button class="btn btn-primary btn-xs" onclick="saveCageEdit('${c.id}')">‚úì Save</button>
            <button class="btn btn-secondary btn-xs" style="margin-left:4px" onclick="cageEditing=null;render()">Cancel</button>
          </td>
        </tr>`;
      }
      const sel = cageSelected.has(c.id);
      const daysLeft = c.departureDate ? Math.ceil((new Date(c.departureDate+'T12:00:00') - new Date()) / 86400000) : null;
      const depBadge = daysLeft !== null ? (daysLeft < 0 ? '<span style="color:var(--red);font-size:10px">OVERDUE</span>' : daysLeft <= 7 ? `<span style="color:var(--orange);font-size:10px">‚ö† ${daysLeft}d</span>` : `<span style="color:var(--text-muted);font-size:10px">${daysLeft}d</span>`) : '';
      return `<tr style="${sel?'background:#fdf8ee':''}">
        <td style="width:32px;text-align:center">
          <input type="checkbox" ${sel?'checked':''} onchange="toggleCageSelect('${c.id}',this.checked)" style="width:14px;height:14px;cursor:pointer;accent-color:var(--accent)"/>
        </td>
        <td style="font-weight:600;color:var(--text-primary)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','name',this)">${esc(c.name)}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','height',this)">${c.height}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','width',this)">${c.width}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','length',this)">${c.length}</span></td>
        <td style="font-family:var(--font-mono)"><span class="editable-cell" onclick="startInlineEdit('${c.id}','weight',this)">${c.weight}</span></td>
        <td style="font-size:11px"><span class="editable-cell" onclick="startInlineEdit('${c.id}','departureDate',this)" title="Click to edit departure date">${c.departureDate ? fmt(c.departureDate) : '<span style="color:var(--text-muted)">‚Äî</span>'}</span> ${depBadge}</td>
        <td style="font-size:11px"><span class="editable-cell" onclick="startInlineEdit('${c.id}','proposedShipDay',this)" title="Click to edit proposed ship day">${c.proposedShipDay ? `<span style="color:var(--purple);font-family:var(--font-mono)">${fmt(c.proposedShipDay)}</span>` : '<span style="color:var(--text-muted)">‚Äî</span>'}</span></td>
        <td><span class="badge badge-${hBadge(c.height)}">${hCat(c.height)}</span></td>
        <td><span class="badge badge-${locBadge(c.location)}">${esc(locLabel(c))}</span></td>
        <td style="white-space:nowrap">
          <select style="font-size:11px;padding:3px 6px;max-width:180px" onchange="changeCageLocation('${c.id}',this.value);this.value=''">
            ${cageLocationOpts(c)}
          </select>
        </td>
        <td style="white-space:nowrap">
          <button class="btn btn-danger btn-xs" onclick="deleteCage('${c.id}')">‚úï</button>
        </td>
      </tr>`;
    }).join('');

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Cage Inventory</h2>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary" onclick="document.getElementById('excel-import').click()">üì• Import from Excel</button>
        <button class="btn btn-primary" onclick="cageFormOpen=!cageFormOpen;render()">+ Add Cage</button>
      </div>
    </div>
    ${formHTML}
    <div class="filter-bar">
      <div style="display:flex;gap:4px;align-items:center;max-width:280px;flex:1">
        <input id="cage-search-input" style="flex:1" placeholder="Search cages‚Ä¶ (Enter)" value="${esc(cageSearch)}"
          onkeydown="if(event.key==='Enter'){cageSearch=this.value;render();}"
          onkeyup="if(this.value===''){cageSearch='';render();}"/>
        ${cageSearch ? `<button class="btn btn-secondary btn-sm" style="white-space:nowrap;padding:4px 8px" onclick="cageSearch='';render()">‚úï</button>` : ''}
      </div>
      <button class="filter-btn ${cageFilter==='all'?'active':''}" onclick="cageFilter='all';render()">All</button>
      <button class="filter-btn ${cageFilter==='facility'?'active':''}" onclick="cageFilter='facility';render()">Facility</button>
      <button class="filter-btn ${cageFilter==='rmd'?'active':''}" onclick="cageFilter='rmd';render()">RMD</button>
      <button class="filter-btn ${cageFilter==='frame'?'active':''}" onclick="cageFilter='frame';render()">Frame</button>
      <button class="filter-btn ${cageFilter==='shipped'?'active':''}" onclick="cageFilter='shipped';cageHideShipped=false;render()">Shipped</button>
      <button class="filter-btn ${cageFilter==='has-departure'?'active':''}" onclick="cageFilter='has-departure';render()" title="Cages with a Leaves Facility date set">üìÖ Has Departure</button>
      <button class="filter-btn ${cageFilter==='has-shipday'?'active':''}" onclick="cageFilter='has-shipday';render()" title="Cages with a Proposed Ship Day set">üö¢ Has Ship Day</button>
      <button class="filter-btn ${cageHideShipped?'active':''}" onclick="cageHideShipped=!cageHideShipped;render()" title="Toggle visibility of shipped cages" style="${cageHideShipped?'':'opacity:0.6'}">üö´ Hide Shipped</button>
      <div style="width:1px;height:20px;background:var(--border);margin:0 4px"></div>
      <span style="font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase;white-space:nowrap">Height:</span>
      <button class="filter-btn ${cageHeightFilter==='all'?'active':''}" onclick="cageHeightFilter='all';render()">All</button>
      <button class="filter-btn ${cageHeightFilter==='short'?'active':''}" onclick="cageHeightFilter='short';render()" style="color:var(--green)">Short</button>
      <button class="filter-btn ${cageHeightFilter==='medium'?'active':''}" onclick="cageHeightFilter='medium';render()" style="color:var(--yellow)">Medium</button>
      <button class="filter-btn ${cageHeightFilter==='tall'?'active':''}" onclick="cageHeightFilter='tall';render()" style="color:var(--red)">Tall</button>
      <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
        <span style="font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">Sort:</span>
        <button class="filter-btn ${cageSort==='number'?'active':''}" onclick="cageSort='number';render()" title="Sort by cage number"># Number</button>
        <button class="filter-btn ${cageSort==='name'?'active':''}" onclick="cageSort='name';render()" title="Sort alphabetically">A‚ÄìZ</button>
      </div>
    </div>
    ${cageSelected.size > 0 ? `<div style="display:flex;align-items:center;gap:12px;background:#fef0e6;border:1px solid #e8c8a0;border-radius:8px;padding:8px 14px;margin-bottom:10px">
      <span style="font-weight:600;font-size:13px;color:var(--orange)">${cageSelected.size} cage${cageSelected.size>1?'s':''} selected</span>
      <button class="btn btn-danger btn-sm" onclick="deleteSelectedCages()">üóë Delete Selected</button>
      <button class="btn btn-secondary btn-sm" onclick="cageSelected.clear();render()">‚úï Clear Selection</button>
    </div>` : ''}
    <div class="card" style="overflow-x:auto">
      <table>
        <thead><tr>
          <th style="width:32px"><input type="checkbox" id="cage-select-all" style="width:14px;height:14px;cursor:pointer;accent-color:var(--accent)" onchange="toggleAllCages(this.checked,${JSON.stringify(filtered.map(c=>c.id))})"/></th>
          <th>Name <span style="font-weight:400;font-size:9px;color:var(--accent)">click to edit</span></th><th>H(m)</th><th>W(m)</th><th>L(m)</th><th>Wt(t)</th><th>Leaves Facility</th><th>Prop. Ship Day</th><th>Category</th><th>Location</th><th>Move</th><th>Del</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function addCage() {
  const name = document.getElementById('cf-name').value.trim();
  const h = parseFloat(document.getElementById('cf-h').value);
  const w = parseFloat(document.getElementById('cf-w').value);
  const l = parseFloat(document.getElementById('cf-l').value);
  const wt = parseFloat(document.getElementById('cf-wt').value);
  const notes = document.getElementById('cf-notes').value.trim();
  if (!name||isNaN(h)||isNaN(w)||isNaN(l)||isNaN(wt)) return alert('Please fill all required fields.');
  const cage = {id:uid(),name,height:h,width:w,length:l,weight:wt,notes,departureDate:null,location:'facility',locationDetail:'',createdAt:new Date().toISOString()};
  STATE.cages.push(cage);
  cageFormOpen = false;
  render();
  await addCageToAPI(cage);
}
function toggleCageSelect(id, checked) {
  if (checked) cageSelected.add(id);
  else cageSelected.delete(id);
  // Update select-all checkbox state
  render();
}

function toggleAllCages(checked, ids) {
  if (checked) ids.forEach(id => cageSelected.add(id));
  else ids.forEach(id => cageSelected.delete(id));
  render();
}

async function deleteSelectedCages() {
  if (cageSelected.size === 0) return;
  if (!confirm(`Delete ${cageSelected.size} selected cage${cageSelected.size>1?'s':''}? This cannot be undone.`)) return;
  const ids = [...cageSelected];
  ids.forEach(id => {
    STATE.cages = STATE.cages.filter(c => c.id !== id);
    STATE.frames.forEach(f => { f.cages = f.cages.filter(cid => cid !== id); });
    STATE.rmdSlots.forEach(r => {
      SIDES.forEach(s => {
        if (r[s].cage1 === id) r[s].cage1 = null;
        if (r[s].cage2 === id) r[s].cage2 = null;
      });
    });
  });
  cageSelected.clear();
  render();
  await Promise.all(ids.map(id => deleteCageFromAPI(id)));
  // Sync affected frames and RMD
  const affectedFrames = STATE.frames.filter(f => ids.some(id => f.cages.includes(id)));
  await Promise.all(affectedFrames.map(f => saveFrame(f)));
  await saveRMD();
}

function startInlineEdit(cageId, field, spanEl) {
  const c = getCage(cageId);
  if (!c) return;
  const isDate = field === 'departureDate' || field === 'proposedShipDay';
  const isNumber = ['height','width','length','weight'].includes(field);
  const currentVal = c[field] != null ? c[field] : '';
  const input = document.createElement('input');
  input.type = isDate ? 'date' : isNumber ? 'number' : 'text';
  input.value = currentVal;
  input.className = 'inline-edit-input';
  if (isNumber) { input.step = '0.01'; input.style.width = '75px'; }
  else if (isDate) { input.style.width = '145px'; }
  else { input.style.width = Math.max(80, (spanEl.offsetWidth || 80) + 20) + 'px'; }
  spanEl.replaceWith(input);
  input.focus();
  if (!isDate) input.select();
  const save = () => {
    const raw = input.value.trim();
    if (isNumber) { const n = parseFloat(raw); if (!isNaN(n)) c[field] = n; }
    else if (isDate) { c[field] = raw || null; }
    else { if (raw) c[field] = raw; }
    render();
    saveCage(c);
  };
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') { input.blur(); }
    if (e.key === 'Escape') { render(); }
  });
}

function saveCageEdit(id) {
  const c = getCage(id);
  if (!c) return;
  const name = document.getElementById('ce-name-'+id).value.trim();
  const h = parseFloat(document.getElementById('ce-h-'+id).value);
  const w = parseFloat(document.getElementById('ce-w-'+id).value);
  const l = parseFloat(document.getElementById('ce-l-'+id).value);
  const wt = parseFloat(document.getElementById('ce-wt-'+id).value);
  const dep = document.getElementById('ce-dep-'+id).value;
  const shipEl = document.getElementById('ce-ship-'+id);
  const ship = shipEl ? shipEl.value : '';
  if (!name) return alert('Name required.');
  c.name = name;
  if (!isNaN(h)) c.height = h;
  if (!isNaN(w)) c.width = w;
  if (!isNaN(l)) c.length = l;
  if (!isNaN(wt)) c.weight = wt;
  c.departureDate = dep || null;
  c.proposedShipDay = ship || null;
  cageEditing = null;
  render();
  saveCage(c);
}

async function deleteCage(id) {
  if (!confirm('Delete this cage? It will be removed from any frame or RMD slot.')) return;
  STATE.cages = STATE.cages.filter(c=>c.id!==id);
  STATE.frames.forEach(f=>{ f.cages = f.cages.filter(cid=>cid!==id); });
  STATE.rmdSlots.forEach(r=>{
    SIDES.forEach(s=>{
      if(r[s].cage1===id) r[s].cage1=null;
      if(r[s].cage2===id) r[s].cage2=null;
    });
  });
  render();
  await deleteCageFromAPI(id);
  await saveRMD();
  const affectedFrames = STATE.frames.filter(f => !f.cages.includes(id)); // already removed above
  // Save all frames to sync cage lists
  await Promise.all(STATE.frames.map(f => saveFrame(f)));
}

// Remove a cage from whatever frame/RMD it's currently in
function clearCageFromCurrentLocation(cid) {
  // Returns array of frames that were modified (need saving)
  const modifiedFrames = [];
  STATE.frames.forEach(f=>{
    if (f.cages.includes(cid)) {
      f.cages = f.cages.filter(id=>id!==cid);
      if(f.cages.length===0) f.fixedForShipping=false;
      modifiedFrames.push(f);
    }
  });
  STATE.rmdSlots.forEach(r=>{
    SIDES.forEach(s=>{
      if(r[s].cage1===cid) r[s].cage1=null;
      if(r[s].cage2===cid) r[s].cage2=null;
    });
  });
  return modifiedFrames;
}

async function changeCageLocation(cid, target) {
  if(!target) return;
  const cage = getCage(cid);
  if(!cage) return;

  // Clear from current location first (returns frames that were modified)
  const clearedFrames = clearCageFromCurrentLocation(cid);

  if (target === 'facility') {
    cage.location = 'facility';
    cage.locationDetail = '';
  } else if (target.startsWith('frame:')) {
    const frameId = target.split(':')[1];
    const frame = getFrame(frameId);
    if (!frame) return alert('Frame not found.');
    if (frame.cages.length >= 2) return alert('Frame already has max cages.');
    if (frame.cages.length === 1) {
      const existing = getCage(frame.cages[0]);
      if (existing && !canFitTwo(existing, cage, frame.width)) {
        return alert(`Cannot fit both cages. Need combined width + 0.3m ‚â§ ${frame.width}m and each cage ‚â§ 14t.`);
      }
    }
    frame.cages.push(cid);
    cage.location = 'frame';
    cage.locationDetail = frame.name;
    cage.departureDate = null; // already in frame ‚Äî no longer "leaving facility"
  } else if (target.startsWith('rmd:')) {
    const parts = target.split(':');
    const rmdNum = parseInt(parts[1]);
    const side = parts[2];
    const slot = parts[3];
    const rmdIdx = STATE.rmdSlots.findIndex(r=>r.number===rmdNum);
    if (rmdIdx === -1) return alert('RMD not found.');
    const r = STATE.rmdSlots[rmdIdx];
    // Determine group slots for 13m check
    const groupSlots = ['cage1','cage3'].includes(slot) ? ['cage1','cage3'] : ['cage2','cage4'];
    const usedLen = groupSlots.filter(s=>s!==slot).reduce((sum,s)=>{const c2=r[side][s]?getCage(r[side][s]):null;return sum+(c2?c2.length||0:0);},0);
    if((cage.length||0)+usedLen > 13) {
      cage.location = 'facility'; cage.locationDetail = '';
      render(); saveCage(cage);
      return alert(`Cannot place: combined length (${((cage.length||0)+usedLen).toFixed(1)}m) exceeds 13m limit.`);
    }
    const pairSlot = slot==='cage1'?'cage2':slot==='cage2'?'cage1':slot==='cage3'?'cage4':'cage3';
    const pairCid = r[side][pairSlot];
    if (pairCid) {
      const other = getCage(pairCid);
      if (other && !canPairRMD(other, cage)) {
        if (!confirm(`Height pairing ${hCat(cage.height)} + ${hCat(other.height)} not standard. Override?`)) {
          cage.location = 'facility'; cage.locationDetail = '';
          render(); saveCage(cage); return;
        }
        r[side].overridden = true;
      }
    }
    r[side][slot] = cid;
    cage.location = 'rmd';
    cage.locationDetail = `RMD-${rmdNum}${side}`;
    cage.departureDate = null;
  }

  render();
  await saveCage(cage);
  await saveRMD();
  // Save source frames (cleared) AND destination frame
  const framesToSave = new Map();
  clearedFrames.forEach(f => framesToSave.set(f.id, f));
  const destFrame = STATE.frames.find(f => f.cages.includes(cage.id));
  if (destFrame) framesToSave.set(destFrame.id, destFrame);
  await Promise.all([...framesToSave.values()].map(f => saveFrame(f)));
}

async function handleExcelImport(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];

      // Convert to array of arrays to find the header row
      const allRows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});

      // Find the header row by looking for "Production Number" in any row
      let headerIdx = -1;
      let headers = [];
      for (let i = 0; i < Math.min(20, allRows.length); i++) {
        const row = allRows[i];
        const found = row.findIndex(cell => String(cell).toLowerCase().includes('production number'));
        if (found !== -1) {
          headerIdx = i;
          headers = row.map(h => String(h).trim());
          break;
        }
      }
      if (headerIdx === -1) return alert('Could not find a "Production Number" column header in the first 20 rows.');

      // Map column indices
      const findIdx = (...keywords) => {
        for (const kw of keywords) {
          const idx = headers.findIndex(h => h.toLowerCase().includes(kw.toLowerCase()));
          if (idx !== -1) return idx;
        }
        return -1;
      };

      const colProdNum = findIdx('production number');
      const colLength = findIdx('armf length', 'length');
      const colWidth = findIdx('armf width', 'width');
      const colHeight = findIdx('armf height', 'height');
      const colWeight = findIdx('pw rof weight', 'pw rof');

      if (colProdNum === -1) return alert('Could not find "Production Number" column. Found headers: ' + headers.join(', '));

      let imported = 0, skipped = 0, duplicates = 0;
      const existingNames = new Set(STATE.cages.map(c => String(c.name).toLowerCase().trim()));

      const dataRows = allRows.slice(headerIdx + 1);
      dataRows.forEach(row => {
        const rawProd = row[colProdNum];
        if (rawProd === undefined || rawProd === null || String(rawProd).trim() === '') {
          skipped++;
          return;
        }
        const name = String(rawProd).trim();

        if (existingNames.has(name.toLowerCase())) {
          duplicates++;
          return;
        }

        // Parse dimensions: mm to m
        const parseMM = (val) => {
          if (val === undefined || val === null || String(val).trim() === '') return 0;
          const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
          return isNaN(n) ? 0 : Math.round((n / 1000) * 1000) / 1000;
        };
        const parseWt = (val) => {
          if (val === undefined || val === null || String(val).trim() === '') return 0;
          const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
          if (isNaN(n)) return 0;
          return n > 100 ? Math.round((n / 1000) * 100) / 100 : Math.round(n * 100) / 100;
        };

        const height = colHeight !== -1 ? parseMM(row[colHeight]) : 0;
        const width = colWidth !== -1 ? parseMM(row[colWidth]) : 0;
        const length = colLength !== -1 ? parseMM(row[colLength]) : 0;
        const weight = colWeight !== -1 ? parseWt(row[colWeight]) : 0;

        STATE.cages.push({
          id: uid(), name, height, width, length, weight,
          notes: 'Imported from Excel',
          location: 'facility', locationDetail: '',
          createdAt: new Date().toISOString()
        });
        existingNames.add(name.toLowerCase());
        imported++;
      });

      // ‚îÄ‚îÄ Validation: filter out formula/header rows ‚îÄ‚îÄ
      const validCages = [];
      const invalidRows = [];
      let duplicates2 = 0, skipped2 = 0;
      const existingNames2 = new Set(STATE.cages.map(c => String(c.name).toLowerCase().trim()));

      const dataRows2 = allRows.slice(headerIdx + 1);
      dataRows2.forEach(row => {
        const rawProd = row[colProdNum];
        if (rawProd === undefined || rawProd === null || String(rawProd).trim() === '') { skipped2++; return; }
        const name = String(rawProd).trim();
        // Reject formula cells, header repeats, and non-numeric names that look like metadata
        if (name.startsWith('=') || name.toLowerCase() === 'production number' || name.toLowerCase() === 'prod number') {
          invalidRows.push({ name, reason: 'Formula or header cell' }); return;
        }
        if (existingNames2.has(name.toLowerCase())) { duplicates2++; return; }
        const parseMM = (val) => {
          if (val === undefined || val === null || String(val).trim() === '') return 0;
          const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
          return isNaN(n) ? 0 : Math.round((n / 1000) * 1000) / 1000;
        };
        const parseWt = (val) => {
          if (val === undefined || val === null || String(val).trim() === '') return 0;
          const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
          if (isNaN(n)) return 0;
          return n > 100 ? Math.round((n / 1000) * 100) / 100 : Math.round(n * 100) / 100;
        };
        const height = colHeight !== -1 ? parseMM(row[colHeight]) : 0;
        const width = colWidth !== -1 ? parseMM(row[colWidth]) : 0;
        const length = colLength !== -1 ? parseMM(row[colLength]) : 0;
        const weight = colWeight !== -1 ? parseWt(row[colWeight]) : 0;
        existingNames2.add(name.toLowerCase());
        validCages.push({ id: uid(), name, height, width, length, weight, notes: 'Imported from Excel', location: 'facility', locationDetail: '', createdAt: new Date().toISOString() });
      });

      // Show review modal
      showImportReviewModal(validCages, invalidRows, duplicates2, skipped2, colHeight, colWidth, colLength, colWeight);

    } catch(err) {
      alert('Error reading Excel file: ' + err.message);
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
  input.value = '';
}

function showImportReviewModal(validCages, invalidRows, duplicates, skipped, colH, colW, colL, colWt) {
  // Remove existing modal if any
  const existing = document.getElementById('import-review-modal');
  if (existing) existing.remove();

  const missingCols = [];
  if (colH === -1) missingCols.push('Height');
  if (colW === -1) missingCols.push('Width');
  if (colL === -1) missingCols.push('Length');
  if (colWt === -1) missingCols.push('Weight');

  const previewRows = validCages.slice(0, 20).map(c => `
    <tr>
      <td style="font-family:var(--font-mono);font-weight:600">${esc(c.name)}</td>
      <td style="font-family:var(--font-mono)">${c.height}m</td>
      <td style="font-family:var(--font-mono)">${c.width}m</td>
      <td style="font-family:var(--font-mono)">${c.length}m</td>
      <td style="font-family:var(--font-mono)">${c.weight}t</td>
      <td><span class="badge badge-blue">Facility</span></td>
    </tr>`).join('');

  const invalidHTML = invalidRows.length > 0
    ? `<div style="margin-top:12px;padding:8px 12px;background:#fce8e8;border:1px solid #e8b0b0;border-radius:6px">
        <div style="font:600 11px var(--font-mono);color:var(--red);margin-bottom:4px">‚ö† ${invalidRows.length} invalid row${invalidRows.length>1?'s':''} will be skipped (formulas/headers detected):</div>
        ${invalidRows.slice(0,5).map(r=>`<div style="font-size:11px;color:var(--red)">"${esc(r.name)}" ‚Äî ${r.reason}</div>`).join('')}
        ${invalidRows.length > 5 ? `<div style="font-size:11px;color:var(--red)">...and ${invalidRows.length-5} more</div>` : ''}
      </div>` : '';

  const modal = document.createElement('div');
  modal.id = 'import-review-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(10,15,30,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--bg-card);border-radius:var(--radius-lg);padding:24px;max-width:700px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="font:700 16px var(--font-display);color:var(--text-primary)">üì• Review Import</div>
        <button onclick="document.getElementById('import-review-modal').remove()" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-muted)">‚úï</button>
      </div>

      <div style="display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap">
        <div style="background:#e6f5ec;border:1px solid #b0dcc0;border-radius:6px;padding:8px 14px;text-align:center">
          <div style="font:700 20px var(--font-mono);color:var(--green)">${validCages.length}</div>
          <div style="font-size:10px;color:var(--green);font-weight:600">Valid Cages</div>
        </div>
        <div style="background:#fce8e8;border:1px solid #e8b0b0;border-radius:6px;padding:8px 14px;text-align:center">
          <div style="font:700 20px var(--font-mono);color:var(--red)">${invalidRows.length}</div>
          <div style="font-size:10px;color:var(--red);font-weight:600">Invalid Rows</div>
        </div>
        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;padding:8px 14px;text-align:center">
          <div style="font:700 20px var(--font-mono);color:var(--text-muted)">${duplicates}</div>
          <div style="font-size:10px;color:var(--text-muted);font-weight:600">Duplicates Skipped</div>
        </div>
        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;padding:8px 14px;text-align:center">
          <div style="font:700 20px var(--font-mono);color:var(--text-muted)">${skipped}</div>
          <div style="font-size:10px;color:var(--text-muted);font-weight:600">Empty Rows</div>
        </div>
      </div>

      ${missingCols.length > 0 ? `<div style="margin-bottom:12px;padding:8px 12px;background:#fff7ed;border:1px solid #e8c8a0;border-radius:6px;font-size:12px;color:var(--orange)">‚ö† Columns not found ‚Äî will import as 0: ${missingCols.join(', ')}</div>` : ''}
      ${invalidHTML}

      ${validCages.length > 0 ? `
      <div style="margin-top:14px;font:600 11px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Preview (first ${Math.min(validCages.length,20)} of ${validCages.length})</div>
      <div style="overflow-x:auto;max-height:280px;overflow-y:auto;border:1px solid var(--border);border-radius:6px">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead style="position:sticky;top:0;background:var(--bg-elevated)">
            <tr><th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">Name</th>
            <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">H</th>
            <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">W</th>
            <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">L</th>
            <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">Wt</th>
            <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase">Location</th></tr>
          </thead>
          <tbody>${previewRows}${validCages.length > 20 ? `<tr><td colspan="6" style="padding:8px 10px;text-align:center;color:var(--text-muted);font-size:11px;font-style:italic">...and ${validCages.length - 20} more cages</td></tr>` : ''}</tbody>
        </table>
      </div>` : '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px">No valid cages to import.</div>'}

      <div style="display:flex;gap:10px;margin-top:18px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="document.getElementById('import-review-modal').remove()">Cancel</button>
        ${validCages.length > 0 ? `<button class="btn btn-primary" onclick="commitExcelImport(window._pendingImport)">‚úÖ Import ${validCages.length} Cage${validCages.length!==1?'s':''}</button>` : ''}
      </div>
    </div>
  `;
  window._pendingImport = validCages;
  document.body.appendChild(modal);
}

async function commitExcelImport(cages) {
  document.getElementById('import-review-modal')?.remove();
  if (!cages || cages.length === 0) return;
  cages.forEach(c => STATE.cages.push(c));
  render();
  showSuccess(`‚úÖ Imported ${cages.length} cage${cages.length!==1?'s':''}`);
  for (const cage of cages) {
    await addCageToAPI(cage);
  }
  window._pendingImport = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRAMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let frameFilter = 'all';
let frameEditing = null;

function renderFrames() {
  const filtered = STATE.frames.filter(f=> frameFilter==='all' || f.location===frameFilter);
  const counts = {all:STATE.frames.length, facility:STATE.frames.filter(f=>f.location==='facility').length, boat:STATE.frames.filter(f=>f.location==='boat').length, client:STATE.frames.filter(f=>f.location==='client').length};
  const availCages = STATE.cages.filter(c=>c.location==='facility'||c.location==='rmd').sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));

  let cardsHTML = filtered.map(f=>{
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    const isEditing = frameEditing===f.id;
    const locColors = {facility:'green',boat:'blue',client:'purple'};

    const _frmShipDays = getShipmentDays();
    let cageListHTML = fCages.map(c=>{
      const _shade = shipmentShadeClass(c, _frmShipDays);
      const _bg = _shade ? shipmentShadeBg(_shade)+'border-radius:4px;padding:2px 6px;display:flex;justify-content:space-between;align-items:center;' : '';
      const _nc = shipmentShadeNameColor(_shade);
      return `<div class="frame-cage-item" style="${_bg}">
        <span style="${_nc}">${esc(c.name)} (${c.width}m, ${c.weight}t)${needsWaler(c) ? ' <span style="color:var(--yellow);font-size:10px" title="Cage < 6.5m needs waler for shipping">‚ö† waler req.</span>' : ''}</span>
        ${f.location==='facility'&&!f.fixedForShipping ? `<button class="remove-btn" onclick="removeCageFromFrame('${f.id}','${c.id}')">√ó</button>` : ''}
      </div>`;
    }).join('');

    let actionsHTML = '';
    if (f.location==='facility' && !isEditing) {
      actionsHTML = `<button class="btn btn-secondary btn-sm btn-block" onclick="frameEditing='${f.id}';render()">Actions ‚ñæ</button>`;
    }
    if (isEditing && f.location==='facility') {
      let cageOpts = availCages.map(c=>`<option value="${c.id}">${esc(c.name)} (${c.width}m, ${c.weight}t)</option>`).join('');
      let widthOpts = FRAME_WIDTHS.map(w=>`<option value="${w}" ${f.width===w?'selected':''}>${w}m wide</option>`).join('');
      actionsHTML = `<div class="frame-actions">
        <select onchange="updateFrameWidth('${f.id}',this.value)">${widthOpts}</select>
        ${f.cages.length < 2 ? `<select onchange="assignCageToFrame('${f.id}',this.value);this.value=''"><option value="">+ Add cage...</option>${cageOpts}</select>` : ''}
        <button class="btn ${f.hasWaler?'btn-blue btn-secondary':'btn-secondary'} btn-sm" style="${f.hasWaler?'color:var(--blue);border-color:rgba(91,156,238,0.3)':''}" onclick="toggleWaler('${f.id}')">${f.hasWaler?'üî© Remove Waler':'+ Add Waler'}</button>
        ${f.cages.length === 1 ? `<button class="btn ${f.fixedForShipping?'btn-danger':'btn-primary'} btn-sm" onclick="toggleShipping('${f.id}')">${f.fixedForShipping?'Unfix from Shipping':'Fix for Shipping'}</button>` : ''}
        <select onchange="updateFrameLoc('${f.id}',this.value)">
          <option value="facility" selected>At Facility</option><option value="boat">On Boat</option><option value="client">With Client</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="frameEditing=null;render()">Close</button>
      </div>`;
    }
    if (f.location === 'boat') {
      actionsHTML = `<button class="btn btn-secondary btn-sm btn-block" style="margin-top:6px" onclick="updateFrameLoc('${f.id}','facility')">Return to Facility</button>`;
    }
    if (f.location === 'client') {
      const retDaysLeft = f.returnDate ? Math.ceil((new Date(f.returnDate+'T12:00:00') - new Date()) / 86400000) : null;
      const retBadge = retDaysLeft !== null ? (retDaysLeft < 0 ? '<span style="color:var(--red);font-size:10px">OVERDUE</span>' : retDaysLeft <= 7 ? `<span style="color:var(--orange);font-size:10px">‚ö† ${retDaysLeft}d</span>` : `<span style="color:var(--text-muted);font-size:10px">${retDaysLeft}d</span>`) : '';
      actionsHTML = `<div style="margin-top:8px">
        <label style="font:600 9px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px;display:block">üìÖ Expected Return</label>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
          <input type="date" value="${f.returnDate||''}" style="font-size:11px;padding:4px 8px;flex:1" onchange="setFrameReturnDate('${f.id}',this.value)" placeholder="Set return date"/>
          ${f.returnDate ? `<span style="font-size:10px;white-space:nowrap;font-family:var(--font-mono);color:#0e7490">${fmt(f.returnDate)}</span>` : ''}
          ${retBadge}
        </div>
        <button class="btn btn-primary btn-sm btn-block" onclick="returnFromClient('${f.id}')">üè≠ Return to Facility (unload cage)</button>
      </div>`;
    }

    return `<div class="card frame-card ${f.fixedForShipping?'shipping-ready':''}">
      <div class="flex-between" style="margin-bottom:4px">
        <span class="frame-name">${esc(f.name)}</span>
        <span class="badge badge-${locColors[f.location]||'accent'}">${f.location}</span>
      </div>
      <div class="frame-meta">
        Width: <span style="color:var(--text-secondary);font-family:var(--font-mono)">${f.width}m</span>
        ${f.hasWaler ? '<span class="badge badge-blue" style="margin-left:6px">üî© WALER</span>' : '<span class="badge badge-yellow" style="margin-left:6px;opacity:0.5">NO WALER</span>'}
        ${f.fixedForShipping ? '<span class="badge badge-accent" style="margin-left:6px">‚úì SHIPPING</span>' : ''}
      </div>
      ${cageListHTML}
      ${actionsHTML}
    </div>`;
  }).join('');

  const _framesTabShipDays = getShipmentDays();
  return `
    <h2 class="section-title">Frame Management</h2>
    ${shipmentLegendHTML(_framesTabShipDays)}
    <div class="filter-bar">
      ${['all','facility','boat','client'].map(f=>`
        <button class="filter-btn ${frameFilter===f?'active':''}" onclick="frameFilter='${f}';render()">${f==='all'?'All':f.charAt(0).toUpperCase()+f.slice(1)} (${counts[f]})</button>
      `).join('')}
    </div>
    <div class="frame-grid">${cardsHTML}</div>
  `;
}

function updateFrameWidth(fid,w) { const f=getFrame(fid); f.width=parseFloat(w); render(); saveFrame(f); }
async function updateFrameLoc(fid,loc) {
  const f=getFrame(fid);
  f.location=loc;
  if(loc!=='facility') f.fixedForShipping=false;
  // Clear returnDate when frame returns to facility
  if(loc==='facility') f.returnDate = null;
  if(loc!=='facility') {
    f.cages.forEach(cid=>{
      const c=getCage(cid);
      if(c) { c.location = loc==='boat'||loc==='client' ? 'shipped' : 'facility'; c.locationDetail = loc==='boat'?'In transit':loc==='client'?'With client':''; if (loc!=='facility') c.departureDate = null; }
    });
  }
  render();
  await saveFrame(f);
  await Promise.all(f.cages.map(cid => { const c=getCage(cid); return c ? saveCage(c) : Promise.resolve(); }));
}
async function assignCageToFrame(fid,cid) {
  if(!cid) return;
  const f=getFrame(fid), c=getCage(cid);
  if(f.cages.length>=2) return alert('Frame already has max cages.');
  if(f.cages.length===1) {
    const ex=getCage(f.cages[0]);
    if(ex && !canFitTwo(ex,c,f.width)) return alert(`Cannot fit both cages. Need combined width + 0.3m ‚â§ ${f.width}m and each ‚â§ 14t.`);
  }
  f.cages.push(cid);
  c.location='frame'; c.locationDetail=f.name;
  // Remove from any RMD slot
  STATE.rmdSlots.forEach(r=>{ SIDES.forEach(s=>{ if(r[s].cage1===cid) r[s].cage1=null; if(r[s].cage2===cid) r[s].cage2=null; }); });
  render();
  await saveFrame(f);
  await saveCage(c);
  await saveRMD();
}
async function removeCageFromFrame(fid,cid) {
  const f=getFrame(fid), c=getCage(cid);
  f.cages=f.cages.filter(id=>id!==cid); f.fixedForShipping=false;
  if(c) { c.location='facility'; c.locationDetail=''; }
  render();
  await saveFrame(f);
  if(c) await saveCage(c);
}
function toggleWaler(fid) {
  const f=getFrame(fid);
  f.hasWaler = !f.hasWaler;
  render(); saveFrame(f);
}
function toggleShipping(fid) {
  const f=getFrame(fid);
  if(!f.fixedForShipping && f.cages.length!==1) return alert('Exactly 1 cage must be in frame for shipping.');
  if(!f.fixedForShipping) {
    const cage = getCage(f.cages[0]);
    if(cage && needsWaler(cage) && !f.hasWaler) {
      return alert(`Cage "${cage.name}" is ${cage.length}m long (< 6.5m) and requires a waler on the frame for shipping. Please add a waler first.`);
    }
  }
  f.fixedForShipping = !f.fixedForShipping;
  render(); saveFrame(f);
}

async function setFrameReturnDate(fid, dateStr) {
  const f = getFrame(fid);
  if (!f) return;
  f.returnDate = dateStr || null;
  render();
  await saveFrame(f);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RMD STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRMD() {
  const RMD_MAX_LENGTH = 13;
  const avail = STATE.cages.filter(c=>c.location==='facility').sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
  const _rmdTabShipDays = getShipmentDays();

  function getSideGroupLength(sideObj, ...slots) {
    return slots.reduce((sum,s)=>{ const c=sideObj[s]?getCage(sideObj[s]):null; return sum+(c?c.length||0:0); },0);
  }

  function filteredCageOpts(sideObj, groupSlots, ownSlot) {
    const usedLen = getSideGroupLength(sideObj, ...groupSlots.filter(s=>s!==ownSlot));
    return avail.filter(c=>(c.length||0)+usedLen<=RMD_MAX_LENGTH)
      .map(c=>`<option value="${c.id}">${esc(c.name)} (${hCat(c.height)}, ${c.height}m, len:${c.length}m)</option>`).join('');
  }

  function renderSlotEl(idx, r, side, slot, posLabel, groupSlots) {
    const sideObj = r[side];
    const cid = sideObj[slot];
    const cage = cid ? getCage(cid) : null;
    if(cage) {
      const _ts = shipmentShadeClass(cage, _rmdTabShipDays);
      const _tBg = _ts ? shipmentShadeBg(_ts)+'border-radius:4px;padding:1px 4px;' : '';
      return `<div class="rmd-slot" style="${_tBg}">
        <span class="rmd-slot-label">${posLabel}</span>
        <div class="rmd-slot-content">
          <span class="rmd-cage-info"><span class="rmd-cage-name" style="${shipmentShadeNameColor(_ts)}">${esc(cage.name)}</span><span class="rmd-cage-detail" style="${shipmentShadeDetailColor(_ts)}">${cage.height}m ¬∑ ${cage.length}m</span></span>
          <button class="remove-btn" onclick="removeFromRMD(${idx},'${side}','${slot}')">√ó</button>
        </div>
      </div>`;
    } else {
      const usedLen = getSideGroupLength(sideObj, ...groupSlots.filter(s=>s!==slot));
      const remaining = (RMD_MAX_LENGTH-usedLen).toFixed(1);
      const opts = filteredCageOpts(sideObj, groupSlots, slot);
      const gs = groupSlots.join(',');
      return `<div class="rmd-slot">
        <span class="rmd-slot-label">${posLabel}</span>
        <select style="flex:1;font-size:11px;padding:4px 8px;min-width:0;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--text-primary)" onchange="assignToRMD(${idx},'${side}','${slot}',this.value,'${gs}');this.value=''">
          <option value="">‚Äî empty (‚â§${remaining}m) ‚Äî</option>${opts}
        </select>
      </div>`;
    }
  }

  let rmdHTML = STATE.rmdSlots.map((r,idx)=>{
    const cnt = [r.A.cage1,r.A.cage2,r.A.cage3,r.A.cage4,r.B.cage1,r.B.cage2,r.B.cage3,r.B.cage4].filter(Boolean).length;
    let sidesHTML = SIDES.map(side=>{
      const sObj = r[side];
      const insideLen = getSideGroupLength(sObj,'cage1','cage3');
      const outsideLen = getSideGroupLength(sObj,'cage2','cage4');
      const iBar = `<span style="font-size:9px;color:${insideLen>RMD_MAX_LENGTH?'var(--red)':'var(--text-muted)'};font-family:var(--font-mono);margin-left:4px">${insideLen.toFixed(1)}/${RMD_MAX_LENGTH}m</span>`;
      const oBar = `<span style="font-size:9px;color:${outsideLen>RMD_MAX_LENGTH?'var(--red)':'var(--text-muted)'};font-family:var(--font-mono);margin-left:4px">${outsideLen.toFixed(1)}/${RMD_MAX_LENGTH}m</span>`;
      return `<div style="margin-bottom:10px">
        <div style="font:700 10px var(--font-mono);color:var(--text-muted);margin-bottom:5px">SIDE ${side}</div>
        <div style="font:600 9px var(--font-mono);color:var(--blue);margin-bottom:3px;padding:2px 4px;background:rgba(37,99,176,0.06);border-radius:3px">INSIDE ${iBar}</div>
        <div style="display:flex;gap:6px;margin-bottom:6px">
          <div style="flex:1;min-width:0">${renderSlotEl(idx,r,side,'cage1','IN 1',['cage1','cage3'])}</div>
          <div style="flex:1;min-width:0">${renderSlotEl(idx,r,side,'cage3','IN 2',['cage1','cage3'])}</div>
        </div>
        <div style="font:600 9px var(--font-mono);color:var(--green);margin-bottom:3px;padding:2px 4px;background:rgba(26,138,74,0.06);border-radius:3px">OUTSIDE ${oBar}</div>
        <div style="display:flex;gap:6px">
          <div style="flex:1;min-width:0">${renderSlotEl(idx,r,side,'cage2','OUT 1',['cage2','cage4'])}</div>
          <div style="flex:1;min-width:0">${renderSlotEl(idx,r,side,'cage4','OUT 2',['cage2','cage4'])}</div>
        </div>
      </div>`;
    }).join('');
    return `<div class="card">
      <div class="flex-between" style="margin-bottom:10px">
        <span style="font:700 16px var(--font-mono);color:var(--accent)">RMD-${r.number}</span>
        <span style="font-size:11px;color:var(--text-muted)">${cnt}/8 occupied</span>
      </div>
      ${sidesHTML}
      ${r.A.overridden||r.B.overridden ? '<span class="badge badge-yellow">‚ö† Override Active</span>' : ''}
    </div>`;
  }).join('');

  return `
    <h2 class="section-title">RMD Storage Bays</h2>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Each side has 2 inside and 2 outside spaces. Combined length per inside or outside row must be ‚â§${RMD_MAX_LENGTH}m. Cages are filtered accordingly.</div>
    ${shipmentLegendHTML(_rmdTabShipDays)}
    <div class="rmd-site-layout">
      ${RMD_LAYOUT.map(row=>{
        let items = row.items.map(item=>{
          const idx2 = STATE.rmdSlots.findIndex(rr=>rr.number===item);
          const r2 = STATE.rmdSlots[idx2];
          if(!r2) return '';
          const cnt2 = [r2.A.cage1,r2.A.cage2,r2.A.cage3,r2.A.cage4,r2.B.cage1,r2.B.cage2,r2.B.cage3,r2.B.cage4].filter(Boolean).length;

          function renderCompact(side, slot, posLabel, groupSlots) {
            const sObj2 = r2[side];
            const cid2 = sObj2[slot];
            const cage2 = cid2 ? getCage(cid2) : null;
            if(cage2) {
              const _s = shipmentShadeClass(cage2, _rmdTabShipDays);
              const _b = _s ? shipmentShadeBg(_s)+'border-radius:4px;padding:1px 4px;' : '';
              return '<div class="rmd-slot" style="'+_b+'"><span class="rmd-slot-label">'+posLabel+'</span><div class="rmd-slot-content"><span class="rmd-cage-info"><span class="rmd-cage-name" style="'+shipmentShadeNameColor(_s)+'">'+esc(cage2.name)+'</span><span class="rmd-cage-detail" style="'+shipmentShadeDetailColor(_s)+'">'+cage2.height+'m¬∑'+cage2.length+'m</span></span><button class="remove-btn" onclick="removeFromRMD('+idx2+',\''+side+'\',\''+slot+'\')">&#215;</button></div></div>';
            } else {
              const used2 = groupSlots.filter(s=>s!==slot).reduce((sum,s)=>{const c2=sObj2[s]?getCage(sObj2[s]):null;return sum+(c2?c2.length||0:0);},0);
              const rem2 = (RMD_MAX_LENGTH-used2).toFixed(1);
              const opts2 = avail.filter(c2=>(c2.length||0)+used2<=RMD_MAX_LENGTH).map(c2=>`<option value="${c2.id}">${esc(c2.name)} (${c2.length}m)</option>`).join('');
              const gs2 = groupSlots.join(',');
              return '<div class="rmd-slot"><span class="rmd-slot-label">'+posLabel+'</span><select class="rmd-slot" style="flex:1;font-size:11px;padding:4px 8px" onchange="assignToRMD('+idx2+',\''+side+'\',\''+slot+'\',this.value,\''+gs2+'\');this.value=\'\'"><option value="">‚â§'+rem2+'m</option>'+opts2+'</select></div>';
            }
          }

          const insA = getSideGroupLength(r2.A,'cage1','cage3');
          const outA = getSideGroupLength(r2.A,'cage2','cage4');
          const insB = getSideGroupLength(r2.B,'cage1','cage3');
          const outB = getSideGroupLength(r2.B,'cage2','cage4');
          function pairRow(s1, s2) {
            return '<div style="display:flex;gap:6px;margin-bottom:4px"><div style="flex:1;min-width:0">'+s1+'</div><div style="flex:1;min-width:0">'+s2+'</div></div>';
          }
          const sideAhtml = '<div style="margin-bottom:8px"><div style="font:700 10px var(--font-mono);color:var(--text-muted);margin-bottom:4px">SIDE A</div>'
            + '<div style="font:600 8px var(--font-mono);color:var(--blue);margin-bottom:3px">INSIDE ('+insA.toFixed(1)+'m)</div>'
            + pairRow(renderCompact('A','cage1','IN1',['cage1','cage3']), renderCompact('A','cage3','IN2',['cage1','cage3']))
            + '<div style="font:600 8px var(--font-mono);color:var(--green);margin-bottom:3px">OUTSIDE ('+outA.toFixed(1)+'m)</div>'
            + pairRow(renderCompact('A','cage2','OUT1',['cage2','cage4']), renderCompact('A','cage4','OUT2',['cage2','cage4']))
            + '</div>';
          const sideBhtml = '<div><div style="font:700 10px var(--font-mono);color:var(--text-muted);margin-bottom:4px">SIDE B</div>'
            + '<div style="font:600 8px var(--font-mono);color:var(--blue);margin-bottom:3px">INSIDE ('+insB.toFixed(1)+'m)</div>'
            + pairRow(renderCompact('B','cage1','IN1',['cage1','cage3']), renderCompact('B','cage3','IN2',['cage1','cage3']))
            + '<div style="font:600 8px var(--font-mono);color:var(--green);margin-bottom:3px">OUTSIDE ('+outB.toFixed(1)+'m)</div>'
            + pairRow(renderCompact('B','cage2','OUT1',['cage2','cage4']), renderCompact('B','cage4','OUT2',['cage2','cage4']))
            + '</div>';

          return '<div class="rmd-site-card"><div class="card"><div class="flex-between" style="margin-bottom:8px"><span style="font:700 16px var(--font-mono);color:var(--accent)">RMD-'+r2.number+'</span><span style="font-size:11px;color:var(--text-muted)">'+cnt2+'/8</span></div>'+sideAhtml+sideBhtml+(r2.A.overridden||r2.B.overridden?'<span class="badge badge-yellow">‚ö† Override</span>':'')+'</div></div>';
        }).join('');
        return '<div class="rmd-site-row row-'+row.row+'">'+items+'</div>';
      }).join('')}
    </div>
  `;
}

async function assignToRMD(idx,side,slot,cid,groupSlotsStr) {
  if(!cid) return;
  const r = STATE.rmdSlots[idx];
  const cage = getCage(cid);
  if(!cage) return;
  // Check 13m length constraint for the group
  const RMD_MAX_LENGTH = 13;
  const groupSlots = groupSlotsStr ? groupSlotsStr.split(',') : (['cage1','cage2'].includes(slot) ? ['cage1','cage2'] : ['cage3','cage4']);
  const otherGroupSlots = groupSlots.filter(s=>s!==slot);
  const usedLen = otherGroupSlots.reduce((sum,s)=>{ const c=r[side][s]?getCage(r[side][s]):null; return sum+(c?c.length||0:0); },0);
  if((cage.length||0)+usedLen > RMD_MAX_LENGTH) {
    alert(`Cannot assign: combined length (${((cage.length||0)+usedLen).toFixed(1)}m) would exceed ${RMD_MAX_LENGTH}m limit for this row.`);
    return;
  }
  // Pairing check against opposite position in same side (cage1 pairs with cage2, cage3 pairs with cage4)
  const pairSlot = slot==='cage1'?'cage2':slot==='cage2'?'cage1':slot==='cage3'?'cage4':'cage3';
  const pairCid = r[side][pairSlot];
  if (pairCid) {
    const other = getCage(pairCid);
    if (other && !canPairRMD(other,cage)) {
      if (!confirm(`Height pairing ${hCat(cage.height)} + ${hCat(other.height)} not standard. Override?`)) return;
      r[side].overridden = true;
    }
  }
  r[side][slot] = cid;
  cage.location = 'rmd';
  cage.locationDetail = `${r.number}${side}`;
  render();
  await saveCage(cage);
  await saveRMD();
}

async function removeFromRMD(idx,side,slot) {
  const cid = STATE.rmdSlots[idx][side][slot];
  if(!cid) return;
  STATE.rmdSlots[idx][side][slot] = null;
  const c = getCage(cid);
  if(c) { c.location='facility'; c.locationDetail=''; }
  render();
  if(c) await saveCage(c);
  await saveRMD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOVEMENT PLANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let planFormOpen = false;
let planFormType = 'facility-to-frame';
let planWeekStart = (() => { const d=new Date(); d.setDate(d.getDate()-d.getDay()+1); return toISO(d); })();

const MOVE_TYPES = [
  {value:'facility-to-frame', label:'Facility ‚Üí Frame (out of facility)'},
  {value:'frame-to-rmd', label:'Frame ‚Üí RMD Storage'},
  {value:'rmd-to-frame', label:'RMD ‚Üí Frame'},
  {value:'frame-fix-shipping', label:'Fix cage to frame for shipping'},
  {value:'frame-return-from-client', label:'Frame returns from client ‚Üí Facility'},
];

function onPlanTypeChange(val) {
  planFormType = val;
  render();
}

// Called when cage is selected in RMD‚ÜíFrame form ‚Äî auto-selects best fitting frame
function updateFrameSuggestion(cageId) {
  const cage = getCage(cageId);
  const frameEl = document.getElementById('pf-frame');
  if (!cage || !frameEl) return;

  // Find best frame: must fit cage width, prefer smallest adequate frame, check waler
  const sortedFrames = [...STATE.frames]
    .filter(f => f.location === 'facility' && f.cages.length < 2 && cage.width <= f.width)
    .sort((a, b) => {
      // Prefer frames that already have a compatible cage (better space usage)
      const aHas = a.cages.length;
      const bHas = b.cages.length;
      if (aHas !== bHas) return bHas - aHas; // prefer frames that already have one cage
      return a.width - b.width; // then smallest adequate width
    });

  // Waler check ‚Äî prefer frames with waler if needed
  let best = null;
  if (needsWaler(cage)) {
    best = sortedFrames.find(f => f.hasWaler && (f.cages.length === 0 || canFitTwo(getCage(f.cages[0]), cage, f.width)));
  }
  if (!best) {
    best = sortedFrames.find(f => f.cages.length === 0 || canFitTwo(getCage(f.cages[0]), cage, f.width));
  }

  if (best) {
    frameEl.value = best.id;
    // Briefly highlight the dropdown
    frameEl.style.borderColor = 'var(--accent)';
    frameEl.style.background = '#fdfaf0';
    setTimeout(() => { frameEl.style.borderColor = ''; frameEl.style.background = ''; }, 2000);
  }
}

function renderPlanner() {
  const typeOpts = MOVE_TYPES.map(t=>`<option value="${t.value}" ${planFormType===t.value?'selected':''}>${t.label}</option>`).join('');

  // Build cage options based on movement type
  let cageOpts = '';
  let frameOpts = '';
  let showFrame = true;
  let showRmd = false;

  if (planFormType === 'facility-to-frame') {
    // Cages in facility
    cageOpts = [...STATE.cages.filter(c=>c.location==='facility')].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(c=>`<option value="${c.id}">${esc(c.name)} (${hCat(c.height)}, ${c.width}m)</option>`).join('');
    frameOpts = STATE.frames.filter(f=>f.location==='facility'&&f.cages.length<2).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>`<option value="${f.id}">${esc(f.name)} (${f.width}m)</option>`).join('');
    showRmd = false;
  } else if (planFormType === 'frame-to-rmd') {
    // Cages in frames, PLUS cages in facility that have a pending facility-to-frame movement planned
    const pendingInFrameCageIds = new Set(
      STATE.plannedMovements
        .filter(m => !m.completed && m.typeKey === 'facility-to-frame')
        .map(m => m.cageId)
    );
    const frameOrPendingCages = STATE.cages.filter(c =>
      c.location === 'frame' || (c.location === 'facility' && pendingInFrameCageIds.has(c.id))
    ).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
    cageOpts = frameOrPendingCages.map(c => {
      const label = c.location === 'frame' ? c.locationDetail : `(pending ‚Üí frame)`;
      return `<option value="${c.id}">${esc(c.name)} (${label})</option>`;
    }).join('');
    showFrame = false;
    showRmd = true;
  } else if (planFormType === 'rmd-to-frame') {
    // Cages in RMD
    cageOpts = [...STATE.cages.filter(c=>c.location==='rmd')].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(c=>`<option value="${c.id}">${esc(c.name)} (${c.locationDetail})</option>`).join('');
    frameOpts = STATE.frames.filter(f=>f.location==='facility'&&f.cages.length<2).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>`<option value="${f.id}">${esc(f.name)} (${f.width}m)</option>`).join('');
    showRmd = false;
  } else if (planFormType === 'frame-fix-shipping') {
    // Only cages that are alone in a frame (exactly 1 cage in frame)
    const singleCageFrames = STATE.frames.filter(f=>f.location==='facility' && f.cages.length===1 && !f.fixedForShipping);
    cageOpts = singleCageFrames.map(f=>{
      const c = getCage(f.cages[0]);
      return c ? `<option value="${c.id}">${esc(c.name)} (in ${esc(f.name)})</option>` : '';
    }).filter(Boolean).join('');
    showFrame = false;
    showRmd = false;
  } else if (planFormType === 'frame-return-from-client') {
    // Frames currently with client or on boat
    cageOpts = '';
    frameOpts = STATE.frames.filter(f=>f.location==='client'||f.location==='boat').sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f=>`<option value="${f.id}">${esc(f.name)} (${f.width}m ‚Äî ${f.location})</option>`).join('');
    showFrame = true;
    showRmd = false;
  }

  // Build RMD slot dropdown options for Frame‚ÜíRMD
  let rmdSlotOpts = '';
  if (planFormType === 'frame-to-rmd') {
    const seenSides = new Set();
    const sortedRmd = [...STATE.rmdSlots].sort((a,b)=>a.number-b.number);
    sortedRmd.forEach(r => {
      [...SIDES].sort().forEach(side => {
        const sideKey = r.number + side;
        if (seenSides.has(sideKey)) return;
        const hasFree = !r[side].cage1 || !r[side].cage2;
        if (!hasFree) return;
        seenSides.add(sideKey);
        const occupiedCount = [r[side].cage1, r[side].cage2].filter(Boolean).length;
        const otherCid = r[side].cage1 || r[side].cage2;
        const other = otherCid ? getCage(otherCid) : null;
        const pairNote = other ? ` ‚Äî pairs with ${other.name} (${hCat(other.height)})` : ` ‚Äî empty side`;
        const freeSlots = occupiedCount === 0 ? '2 free' : '1 slot free';
        rmdSlotOpts += `<option value="${sideKey}">RMD-${r.number}${side} (${freeSlots}${pairNote})</option>`;
      });
    });
    if (!rmdSlotOpts) rmdSlotOpts = '<option value="" disabled>No free RMD slots</option>';
  }

  // For RMD‚ÜíFrame, annotate frames with suitability note
  if (planFormType === 'rmd-to-frame') {
    frameOpts = STATE.frames.filter(f => f.location === 'facility' && f.cages.length < 2).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})).map(f => {
      const existing = f.cages.length === 1 ? getCage(f.cages[0]) : null;
      const note = existing ? ` [has ${existing.name}]` : ' [empty]';
      return `<option value="${f.id}">${esc(f.name)} (${f.width}m${f.hasWaler ? ' üî©' : ''})${note}</option>`;
    }).join('');
  }

  let formHTML = '';
  if (planFormOpen) {
    const cageOnChange = planFormType === 'rmd-to-frame' ? 'onchange="updateFrameSuggestion(this.value)"' : '';
    formHTML = `<div class="card">
      <div class="form-grid form-grid-3">
        <div><label>Movement Type</label><select id="pf-type" onchange="onPlanTypeChange(this.value)">${typeOpts}</select></div>
        ${planFormType !== 'frame-return-from-client' ? `<div><label>Cage</label><select id="pf-cage" ${cageOnChange}><option value="">Select cage...</option>${cageOpts}</select></div>` : '<div></div>'}
        ${showFrame ? `<div><label>Frame${planFormType==='rmd-to-frame'?' <span style="font-size:9px;color:var(--accent)">(auto-highlights on cage select)</span>':planFormType==='frame-return-from-client'?' <span style="font-size:9px;color:#0e7490">(returning empty from client/boat)</span>':''}</label><select id="pf-frame"><option value="">Select frame...</option>${frameOpts}</select></div>` : '<div id="pf-frame-placeholder"></div>'}
        <div><label>Date</label><input id="pf-date" type="date" value="${todayStr()}"/></div>
        <div><label>Shift</label><select id="pf-shift"><option value="day">Day Shift</option><option value="night">Night Shift</option></select></div>
        ${showRmd ? `<div><label>RMD Slot (Suggested)</label><select id="pf-rmd"><option value="">Select slot...</option>${rmdSlotOpts}</select></div>` : '<div id="pf-rmd-placeholder"></div>'}
        <div style="grid-column:span 3"><label>Notes</label><input id="pf-notes"/></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addMovement()">Add to Plan</button>
        <button class="btn btn-secondary" onclick="planFormOpen=false;render()">Cancel</button>
      </div>
    </div>`;
  }

  // 2-week days
  const ws = new Date(planWeekStart + 'T12:00:00');
  let weekDays = [];
  for(let i=0;i<14;i++) { const d=new Date(ws); d.setDate(d.getDate()+i); weekDays.push(toISO(d)); }

  // Build departure-date index for visible window
  const depByDay = {};
  STATE.cages.forEach(c => {
    if (c.departureDate && c.location === 'facility') {
      if (!depByDay[c.departureDate]) depByDay[c.departureDate] = [];
      depByDay[c.departureDate].push(c.name);
    }
  });

  // Build frame return-date index (frames with client that have a returnDate set)
  const returnByDay = {};
  STATE.frames.forEach(f => {
    if (f.returnDate && (f.location === 'client' || f.location === 'boat')) {
      if (!returnByDay[f.returnDate]) returnByDay[f.returnDate] = [];
      returnByDay[f.returnDate].push(f.name);
    }
  });

  function renderWeekDay(day) {
    const dayMoves = STATE.plannedMovements.filter(m=>m.date===day);
    const pending = dayMoves.filter(m=>!m.completed).length;
    const isToday = day===todayStr();
    const dow = new Date(day+'T12:00:00').getDay();
    const isWeekend = dow===0||dow===6;
    const departures = depByDay[day] || [];
    const frameReturns = returnByDay[day] || [];
    const hasMoves = dayMoves.length > 0 || departures.length > 0 || frameReturns.length > 0;

    let movesHTML = dayMoves.map(m=>`
      <div class="week-move-item ${m.completed?'completed':''}" title="${esc(m.notes||m.description)}" style="${m.typeKey==='frame-return-from-client'?'background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490;':''}">
        ${m.typeKey==='frame-return-from-client'?'üö¢ ': m.shift==='night'?'üåô ':''}${esc(m.description.slice(0,26))}
      </div>
    `).join('');

    return `<div class="week-day ${isToday?'today':''} ${isWeekend&&!hasMoves?'weekend':''} ${hasMoves?'has-moves':''}">
      <div class="week-day-hdr">${fmtShort(day)}</div>
      ${pending>0 ? `<div class="week-move-count ${pending>MAX_MOVES?'over-limit':''}" style="color:${pending>MAX_MOVES?'var(--red)':'var(--green)'}">${pending} moves${pending>MAX_MOVES?' ‚ö† OVER':''}</div>` : ''}
      ${departures.map(n=>`<div style="font-size:9px;padding:2px 4px;margin-bottom:1px;border-radius:3px;background:#fce8e8;color:var(--red);border:1px solid #e8b0b0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="Cage ${n} leaves facility">üöö ${esc(n)}</div>`).join('')}
      ${frameReturns.map(n=>`<div style="font-size:9px;padding:2px 4px;margin-bottom:1px;border-radius:3px;background:#ecfeff;color:#0e7490;border:1px solid #a5f3fc;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="Frame ${n} expected back">üö¢ ${esc(n)} returns</div>`).join('')}
      ${movesHTML}
    </div>`;
  }
  const week1HTML = weekDays.slice(0,7).map(renderWeekDay).join('');
  const week2HTML = weekDays.slice(7).map(renderWeekDay).join('');

  // All movements table
  let sorted = [...STATE.plannedMovements].sort((a,b)=>a.date.localeCompare(b.date));
  let tableRows = sorted.length === 0
    ? '<tr><td colspan="7" class="empty-msg" style="text-align:center;padding:20px">No movements planned</td></tr>'
    : sorted.map(m=>`
      <tr style="opacity:${m.completed?'0.5':'1'}">
        <td style="font-family:var(--font-mono)">
          ${!m.completed ? `<input type="date" value="${m.date}" title="Click to change date" style="border:none;background:transparent;font:600 12px var(--font-mono);color:var(--accent);cursor:pointer;width:130px;padding:2px 4px;border-radius:4px;border:1px solid transparent" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='transparent'" onchange="rescheduleMove('${m.id}',this.value)" />` : `<span>${fmt(m.date)}</span>`}
        </td>
        <td>${m.shift==='night'?'üåô Night':'‚òÄ Day'}</td>
        <td>${esc(m.type)}</td>
        <td style="font-weight:600;color:var(--text-primary)">${esc(m.description)}</td>
        <td style="color:var(--text-muted)">${esc(m.notes||'')}</td>
        <td><span class="badge ${m.completed?'badge-green':'badge-yellow'}">${m.completed?'Done':'Pending'}</span></td>
        <td style="white-space:nowrap">
          ${!m.completed ? `<button class="btn btn-primary btn-xs" onclick="completeMove('${m.id}')">‚úì</button> ` : ''}
          <button class="btn btn-danger btn-xs" onclick="deleteMove('${m.id}')">Del</button>
        </td>
      </tr>
    `).join('');

  // Build RMD & Frame summary sidebar for planner
  const _plannerShipDays = getShipmentDays();
  let rmdSummary = STATE.rmdSlots.map(r => {
    const slots4 = [
      {side:'A', slot:'cage2', lbl:'A Outside 1'},
      {side:'A', slot:'cage4', lbl:'A Outside 2'},
      {side:'A', slot:'cage1', lbl:'A Inside 1'},
      {side:'A', slot:'cage3', lbl:'A Inside 2'},
      {side:'B', slot:'cage1', lbl:'B Inside 1'},
      {side:'B', slot:'cage3', lbl:'B Inside 2'},
      {side:'B', slot:'cage2', lbl:'B Outside 1'},
      {side:'B', slot:'cage4', lbl:'B Outside 2'},
    ];
    const occupied = slots4.map(s => {
      const cid = r[s.side][s.slot];
      const c = cid ? getCage(cid) : null;
      return { ...s, c };
    });
    const hasAnyCage = occupied.some(s => s.c);
    if (!hasAnyCage) return `<div style="padding:6px 8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;opacity:0.45">
      <div style="font:700 11px var(--font-mono);color:var(--text-muted)">RMD-${r.number} ‚Äî empty</div>
    </div>`;
    const slotsHTML = occupied.map(s => {
      if (!s.c) return `<div style="display:flex;justify-content:space-between;padding:3px 6px;font-size:11px;color:var(--text-muted);font-style:italic">
        <span>${s.lbl}</span><span>‚Äî</span>
      </div>`;
      // Determine minimum frame size needed for shipping
      const minFrame = FRAME_WIDTHS.find(w => w >= s.c.width) || FRAME_WIDTHS[FRAME_WIDTHS.length-1];
      const walerNote = needsWaler(s.c) ? ' + waler' : '';
      const _ps = shipmentShadeClass(s.c, _plannerShipDays);
      const _pBg = _ps ? shipmentShadeBg(_ps) : (s.side==='A'?'background:rgba(37,99,176,0.06)':'background:rgba(26,138,74,0.06)');
      const _pNc = shipmentShadeNameColor(_ps) || 'color:var(--text-primary)';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 6px;${_pBg};border-radius:4px;margin-bottom:2px">
        <span style="font:600 11px var(--font-mono);${_pNc}">${esc(s.c.name)}</span>
        <span style="font-size:10px;${shipmentShadeDetailColor(_ps)||'color:var(--text-muted)'};">${s.lbl} ¬∑ ${s.c.height}m ¬∑ ${hCat(s.c.height)}</span>
        <span style="font-size:9px;background:#fdf5dc;color:var(--yellow);border:1px solid #e0d8a0;border-radius:3px;padding:1px 5px;margin-left:4px" title="Minimum frame size needed for shipping">‚ñ£ ${minFrame}m${walerNote}</span>
      </div>`;
    }).join('');
    return `<div style="padding:8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;margin-bottom:6px">
      <div style="font:700 12px var(--font-mono);color:var(--accent);margin-bottom:5px">RMD-${r.number} <span style="font-weight:400;color:var(--text-muted);font-size:10px">${occupied.filter(s=>s.c).length}/8 occupied</span></div>
      ${slotsHTML}
    </div>`;
  }).join('');

  let frameSummary = STATE.frames.filter(f=>f.cages.length>0 && f.location==='facility').map(f=>{
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    let cageChips = fCages.map(c=>{
      const _fs = shipmentShadeClass(c, _plannerShipDays);
      const _fBg = _fs ? 'background:'+(_fs==='next'?'#3b1d6e':'#c8b8e8')+';color:'+(_fs==='next'?'#e0ccff':'#4a2a7a')+';border-radius:3px;padding:1px 5px;' : '';
      return `<span style="font-size:11px;${_fBg}">${esc(c.name)} (${c.weight}t)</span>`;
    }).join(', ');
    return `<div class="planner-frame-item">
      <span style="font-weight:700;font-family:var(--font-mono)">${esc(f.name)}</span>
      <span>${cageChips}</span>
      <span style="font-size:10px;color:var(--text-muted)">${f.width}m${f.hasWaler?' üî©':''}${f.fixedForShipping?' ‚úìSHIP':''}</span>
    </div>`;
  }).join('') || '<div class="empty-msg">No cages in frames</div>';

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Movement Planner</h2>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="openDashboardWindow()" title="Open Dashboard in a second window">üìä Open Dashboard</button>
        <button class="btn btn-secondary btn-sm" onclick="autoplanDepartures()" title="Auto-plan cages due to leave the facility into suitable frames">‚ö° Auto-Plan Departures</button>
        <button class="btn btn-danger btn-sm" onclick="blankCanvasPlanner()" title="Clear all planned movements and reset calendar">üóë Blank Canvas</button>
        <button class="btn btn-primary" onclick="planFormOpen=!planFormOpen;render()">+ Plan Movement</button>
      </div>
    </div>
    ${formHTML}
    <div class="planner-layout" style="grid-template-columns:1fr 420px">
      <div>
        <div class="card">
          <div class="week-nav">
            <button class="btn btn-secondary btn-sm" onclick="shiftWeek(-1)">‚óÑ Prev 2 Weeks</button>
            <span class="week-label">${fmt(weekDays[0])} ‚Äî ${fmt(weekDays[13])}</span>
            <button class="btn btn-secondary btn-sm" onclick="shiftWeek(1)">Next 2 Weeks ‚ñ∫</button>
          </div>
          <div style="display:flex;gap:12px;margin-bottom:8px;font-size:10px;align-items:center;flex-wrap:wrap">
            <span style="padding:2px 6px;background:#fce8e8;color:var(--red);border:1px solid #e8b0b0;border-radius:3px">üöö Cage leaves facility</span>
            <span style="padding:2px 6px;background:#ecfeff;color:#0e7490;border:1px solid #a5f3fc;border-radius:3px">üö¢ Frame returns</span>
            <span style="color:var(--text-muted)">Departure dates and frame returns shown in calendar</span>
          </div>
          <div style="font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Week 1</div>
          <div class="week-grid" style="margin-bottom:10px">${week1HTML}</div>
          <div style="font:600 10px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Week 2</div>
          <div class="week-grid">${week2HTML}</div>
        </div>
        <div class="card">
          <div class="card-title">All Planned Movements</div>
          <div style="overflow-x:auto">
            <table><thead><tr>
              <th>Date</th><th>Shift</th><th>Type</th><th>Description</th><th>Notes</th><th>Status</th><th>Actions</th>
            </tr></thead><tbody>${tableRows}</tbody></table>
          </div>
        </div>
      </div>
      <div class="planner-sidebar" style="max-height:calc(100vh - 140px);overflow-y:auto">
        <div class="card">
          <div class="card-title">Cages in RMD Storage</div>
          ${shipmentLegendHTML(_plannerShipDays)}
          <div>
          ${rmdSummary}
          </div>
        </div>
        <div class="card">
          <div class="card-title">Cages in Frames (at facility)</div>
          ${frameSummary}
        </div>
        ${(() => {
          const clientFrames = STATE.frames.filter(f => f.location === 'client' || f.location === 'boat');
          if (!clientFrames.length) return '';
          const today = todayStr();
          const rows = clientFrames.map(f => {
            const daysLeft = f.returnDate ? Math.ceil((new Date(f.returnDate+'T12:00:00') - new Date()) / 86400000) : null;
            const retCol = daysLeft === null ? 'color:var(--text-muted)' : daysLeft < 0 ? 'color:var(--red)' : daysLeft <= 7 ? 'color:var(--orange)' : 'color:#0e7490';
            const retLabel = f.returnDate ? fmt(f.returnDate) : '‚Äî';
            const retDaysStr = daysLeft !== null ? (daysLeft < 0 ? ` (${Math.abs(daysLeft)}d overdue)` : daysLeft === 0 ? ' (today)' : ` (${daysLeft}d)`) : '';
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:11px">
              <span style="font:700 11px var(--font-mono)">${esc(f.name)}</span>
              <span style="font-size:10px;padding:1px 6px;border-radius:10px;background:${f.location==='client'?'#f0e8fa':'#e6f0fa'};color:${f.location==='client'?'var(--purple)':'var(--blue)'};font-weight:600">${f.location}</span>
              <span style="${retCol};font-family:var(--font-mono)">${retLabel}${retDaysStr}</span>
            </div>`;
          }).join('');
          return `<div class="card">
            <div class="card-title">üö¢ Frames Away (Client / Boat)</div>
            ${rows}
            ${clientFrames.length === 0 ? '<div class="empty-msg">None away</div>' : ''}
          </div>`;
        })()}
      </div>
    </div>
  `;
}

function openDashboardWindow() {
  // Serialize current page HTML and open as blob so it has same-origin access
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const win = window.open(url, 'cage-tracker-dashboard', 'width=1280,height=860,scrollbars=yes,resizable=yes');
  if (!win) { alert('Pop-up blocked. Please allow pop-ups for this page.'); return; }
  win.addEventListener('load', () => {
    try {
      // Sync localStorage state to the new window
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) win.localStorage.setItem(STORAGE_KEY, data);
      // Switch to dashboard tab
      setTimeout(() => {
        try { win.activeTab = 'dashboard'; win.render(); } catch(e) {}
      }, 100);
    } catch(e) { console.warn('Dashboard sync error:', e); }
  });
}

async function addMovement() {
  const type = document.getElementById('pf-type').value;
  const cageId = document.getElementById('pf-cage').value;
  const frameEl = document.getElementById('pf-frame');
  const frameId = frameEl ? frameEl.value : '';
  const date = document.getElementById('pf-date').value;
  const shift = document.getElementById('pf-shift').value;
  const rmdEl = document.getElementById('pf-rmd');
  const rmdSlot = rmdEl ? rmdEl.value.trim() : '';
  const notes = document.getElementById('pf-notes').value.trim();
  if(!date) return alert('Please select a date.');

  const cage = getCage(cageId);

  // For fix-shipping, auto-find the frame the cage is in
  let resolvedFrameId = frameId;
  if (type === 'frame-fix-shipping' && cage) {
    const autoFrame = STATE.frames.find(f=>f.cages.includes(cageId));
    if(autoFrame) resolvedFrameId = autoFrame.id;
  }

  // For frame-to-rmd, auto-find the frame the cage is in (or pending into)
  if (type === 'frame-to-rmd' && cage && !resolvedFrameId) {
    // First check: cage is currently in a frame
    const currentFrame = STATE.frames.find(f => f.cages.includes(cageId));
    if (currentFrame) {
      resolvedFrameId = currentFrame.id;
    } else {
      // Second check: cage has a pending facility-to-frame movement ‚Äî use that target frame
      const pendingMove = STATE.plannedMovements.find(
        m => !m.completed && m.cageId === cageId && m.typeKey === 'facility-to-frame' && m.frameId
      );
      if (pendingMove) resolvedFrameId = pendingMove.frameId;
    }
  }

  const frame = getFrame(resolvedFrameId);
  const parts = [];
  if(type === 'frame-return-from-client') {
    if(frame) parts.push(frame.name);
    parts.push('Facility');
  } else {
    if(cage) parts.push(cage.name);
    if(frame) parts.push(frame.name);
    if(rmdSlot) parts.push('RMD-'+rmdSlot);
  }
  const desc = parts.join(' ‚Üí ') || notes || 'Movement';
  const typeLabel = MOVE_TYPES.find(t=>t.value===type)?.label || type;

  const move = {
    id:uid(), type:typeLabel, typeKey:type, cageId, frameId:resolvedFrameId, rmdSlot,
    date, shift, notes, completed:false, description:desc, createdAt:new Date().toISOString()
  };
  STATE.plannedMovements.push(move);
  planFormOpen = false;
  render();
  await addMovementToAPI(move);
}
async function completeMove(id) {
  const m = STATE.plannedMovements.find(x=>x.id===id);
  if(!m) return;

  const cage = getCage(m.cageId);
  const frame = getFrame(m.frameId);

  // Execute the actual movement based on type
  if (m.typeKey === 'facility-to-frame' && cage && frame) {
    // Clear cage from any current location
    clearCageFromCurrentLocation(cage.id);
    // Check frame capacity
    if (frame.cages.length >= 2) { alert(`Cannot complete: ${frame.name} already has max cages.`); return; }
    if (frame.cages.length === 1) {
      const existing = getCage(frame.cages[0]);
      if (existing && !canFitTwo(existing, cage, frame.width)) {
        alert(`Cannot complete: cages don't fit together in ${frame.name}.`); return;
      }
    }
    frame.cages.push(cage.id);
    cage.location = 'frame';
    cage.locationDetail = frame.name;
    cage.departureDate = null; // cage has left facility
  }
  else if (m.typeKey === 'frame-to-rmd' && cage && m.rmdSlot) {
    // Parse RMD slot like "3A" or "3a"
    const rmdMatch = m.rmdSlot.match(/^(\d+)\s*([ABab])/);
    if (rmdMatch) {
      const rmdNum = parseInt(rmdMatch[1]);
      const side = rmdMatch[2].toUpperCase();
      const rmdIdx = STATE.rmdSlots.findIndex(r=>r.number===rmdNum);
      if (rmdIdx !== -1) {
        const r = STATE.rmdSlots[rmdIdx];
        const slot = !r[side].cage1 ? 'cage1' : !r[side].cage2 ? 'cage2' : null;
        if (!slot) { alert(`Cannot complete: RMD-${rmdNum}${side} is full.`); return; }
        clearCageFromCurrentLocation(cage.id);
        r[side][slot] = cage.id;
        cage.location = 'rmd';
        cage.locationDetail = `RMD-${rmdNum}${side}`;
      }
    } else {
      // Just move to facility if can't parse RMD
      clearCageFromCurrentLocation(cage.id);
      cage.location = 'facility';
      cage.locationDetail = '';
    }
  }
  else if (m.typeKey === 'rmd-to-frame' && cage && frame) {
    clearCageFromCurrentLocation(cage.id);
    if (frame.cages.length >= 2) { alert(`Cannot complete: ${frame.name} already has max cages.`); return; }
    if (frame.cages.length === 1) {
      const existing = getCage(frame.cages[0]);
      if (existing && !canFitTwo(existing, cage, frame.width)) {
        alert(`Cannot complete: cages don't fit together in ${frame.name}.`); return;
      }
    }
    frame.cages.push(cage.id);
    cage.location = 'frame';
    cage.locationDetail = frame.name;
    cage.departureDate = null;
  }
  else if (m.typeKey === 'frame-fix-shipping' && frame) {
    if (frame.cages.length === 1) {
      const c = getCage(frame.cages[0]);
      if (c && needsWaler(c) && !frame.hasWaler) {
        alert(`Cannot complete: cage ${c.name} is ${c.length}m (< 6.5m) and requires a waler.`); return;
      }
      frame.fixedForShipping = true;
    } else {
      alert('Frame must have exactly 1 cage to fix for shipping.'); return;
    }
  }
  else if (m.typeKey === 'frame-return-from-client' && frame) {
    frame.location = 'facility';
    frame.fixedForShipping = false;
    // Any cages in this frame should also be cleared (it should be empty, but just in case)
    frame.cages = [];
  }

  // Clear departure date whenever a cage physically leaves the facility
  if (cage && cage.location !== 'facility') {
    cage.departureDate = null;
  }

  m.completed = true;
  m.completedAt = new Date().toISOString();
  render();
  await updateMovementInAPI(m);
  if (cage) await saveCage(cage);
  if (frame) await saveFrame(frame);
  await saveRMD();
}
async function autoplanDepartures() {
  // Find all cages in 'facility' that have a departureDate set
  const dueToLeave = STATE.cages.filter(c => c.location === 'facility' && c.departureDate);

  if (dueToLeave.length === 0) {
    return alert('No facility cages have a departure date set. Edit cages to add expected departure dates.');
  }

  // Sort by departure date ascending
  dueToLeave.sort((a, b) => a.departureDate.localeCompare(b.departureDate));

  const warnings = [];
  const newMovements = [];
  const DAILY_LIMIT = STATE.settings.movementsPerDay || MAX_MOVES;

  // Build daily count from existing planned movements
  const existingCounts = {};
  STATE.plannedMovements.forEach(m => {
    if (!m.completed) existingCounts[m.date] = (existingCounts[m.date] || 0) + 1;
  });

  // Track frames being used across this auto-plan run (in addition to already loaded frames)
  // A frame is "in use" if it already has cages, or we've assigned it in this run
  const frameAssignments = {}; // cageId -> frameId (planned this run)

  // Available frames at facility (not currently fixed for shipping)
  const facilityFrames = STATE.frames.filter(f => f.location === 'facility' && !f.fixedForShipping);

  // Helper to find the best fitting frame for a cage, considering this run's assignments
  function findFrameForCage(cage) {
    const cageNeedsWaler = needsWaler(cage);
    const sorted = [...facilityFrames].sort((a, b) => a.width - b.width);

    // Count how many cages are virtually assigned to each frame this run
    const virtualCounts = {};
    Object.values(frameAssignments).forEach(fid => {
      virtualCounts[fid] = (virtualCounts[fid] || 0) + 1;
    });

    for (const f of sorted) {
      if (cage.width > f.width) continue;
      const realCount = f.cages.length;
      const virtualExtra = virtualCounts[f.id] || 0;
      const totalCount = realCount + virtualExtra;
      if (totalCount >= 2) continue;

      // Check waler
      if (cageNeedsWaler && !f.hasWaler) continue;

      // Check if pairing fits
      if (totalCount === 1) {
        // Find the partner cage (real or planned)
        const partnerCid = f.cages[0] || Object.keys(frameAssignments).find(cid => frameAssignments[cid] === f.id);
        if (partnerCid) {
          const partner = getCage(partnerCid);
          if (partner && !canFitTwo(partner, cage, f.width)) continue;
        }
      }
      return f;
    }

    // Relax waler restriction
    for (const f of sorted) {
      if (cage.width > f.width) continue;
      const realCount = f.cages.length;
      const virtualExtra = (Object.values(frameAssignments).filter(fid => fid === f.id).length);
      const totalCount = realCount + virtualExtra;
      if (totalCount >= 2) continue;
      if (totalCount === 1) {
        const partnerCid = f.cages[0] || Object.keys(frameAssignments).find(cid => frameAssignments[cid] === f.id);
        if (partnerCid) {
          const partner = getCage(partnerCid);
          if (partner && !canFitTwo(partner, cage, f.width)) continue;
        }
      }
      return f;
    }
    return null;
  }

  // Helper: find a free working day on or before a target date, respecting daily limits
  function findWorkingDay(targetDateStr, lookBackDays = 7) {
    // Try from target date backwards
    let d = new Date(targetDateStr + 'T12:00:00');
    for (let i = 0; i <= lookBackDays; i++) {
      const attempt = new Date(d);
      attempt.setDate(attempt.getDate() - i);
      const dow = attempt.getDay();
      if (dow === 0 || dow === 6) continue; // skip weekends
      const iso = toISO(attempt);
      if ((existingCounts[iso] || 0) < DAILY_LIMIT) return iso;
    }
    // Fallback: try days after target date
    d = new Date(targetDateStr + 'T12:00:00');
    for (let i = 1; i <= lookBackDays; i++) {
      const attempt = new Date(d);
      attempt.setDate(attempt.getDate() + i);
      const dow = attempt.getDay();
      if (dow === 0 || dow === 6) continue;
      const iso = toISO(attempt);
      if ((existingCounts[iso] || 0) < DAILY_LIMIT) return iso;
    }
    return targetDateStr; // last resort
  }

  let planned = 0;
  let skipped = 0;

  for (const cage of dueToLeave) {
    // Check if this cage already has a planned facility-to-frame movement
    const alreadyPlanned = STATE.plannedMovements.some(m =>
      m.cageId === cage.id && !m.completed &&
      (m.typeKey === 'facility-to-frame' || (m.type && m.type.includes('Facility') && m.type.includes('Frame')))
    );
    if (alreadyPlanned) {
      skipped++;
      continue;
    }

    // Find a suitable frame
    const frame = findFrameForCage(cage);
    if (!frame) {
      warnings.push(`‚ö† No suitable frame found for cage ${cage.name} (${cage.width}m wide${needsWaler(cage) ? ' + needs waler' : ''}). Check frame availability.`);
      continue;
    }

    // Schedule the movement on the departure date itself (or nearest working day)
    const depDate = cage.departureDate;
    const plannedDate = findWorkingDay(depDate, 10);

    // Register in existingCounts
    existingCounts[plannedDate] = (existingCounts[plannedDate] || 0) + 1;
    frameAssignments[cage.id] = frame.id;

    const walerNote = needsWaler(cage) && !frame.hasWaler ? ' [‚ö† waler may be needed]' : '';
    const desc = `${cage.name} ‚Üí ${frame.name} (${frame.width}m${frame.hasWaler ? ' üî©' : ''})`;

    newMovements.push({
      id: uid(),
      type: 'Facility ‚Üí Frame',
      typeKey: 'facility-to-frame',
      cageId: cage.id,
      frameId: frame.id,
      date: plannedDate,
      shift: 'day',
      notes: `Auto-planned ¬∑ Departs ${fmt(depDate)}${walerNote}`,
      completed: false,
      description: desc,
      createdAt: new Date().toISOString()
    });

    // Also add a fix-for-shipping step if only 1 cage will be in frame after this
    // (schedule it on the same day, it counts as 1 move)
    // We'll let the user manually fix ‚Äî don't auto-generate fix steps to avoid confusion

    planned++;
  }

  if (planned === 0 && skipped === 0 && warnings.length === 0) {
    return alert('No cages need auto-planning at this time.');
  }

  STATE.plannedMovements.push(...newMovements);

  let msg = `‚úÖ Auto-planned ${planned} movement${planned !== 1 ? 's' : ''}.`;
  if (skipped > 0) msg += ` ${skipped} cage${skipped !== 1 ? 's' : ''} already had planned movements (skipped).`;
  if (warnings.length > 0) msg += '\n\n' + warnings.join('\n');

  render();
  alert(msg);
  await Promise.all(newMovements.map(m => addMovementToAPI(m)));
}

async function blankCanvasPlanner() {
  const count = STATE.plannedMovements.length;
  if (count === 0) return alert('No planned movements to clear.');
  if (!confirm(`Clear all ${count} planned movement${count!==1?'s':''}? This cannot be undone.`)) return;
  STATE.plannedMovements = [];
  planWeekStart = (() => { const d=new Date(); d.setDate(d.getDate()-d.getDay()+1); return toISO(d); })();
  render();
  await deleteAllMovementsFromAPI();
}

async function rescheduleMove(id, newDate) {
  const m = STATE.plannedMovements.find(m=>m.id===id);
  if (!m) return;
  m.date = newDate;
  await updateMovementInAPI(m);
  render();
  showSuccess('Movement rescheduled to ' + fmt(newDate));
}

async function deleteMove(id) {
  STATE.plannedMovements = STATE.plannedMovements.filter(m=>m.id!==id);
  render();
  await deleteMovementFromAPI(id);
}
function shiftWeek(dir) {
  const d = new Date(planWeekStart+'T12:00:00');
  d.setDate(d.getDate()+dir*14);
  planWeekStart = toISO(d);
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHIPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let shipFormOpen = false;
let shipSelected = [];

function renderShipping() {
  const ready = STATE.frames.filter(f=>f.fixedForShipping && f.location==='facility');

  let readyHTML = ready.length === 0
    ? '<div class="empty-msg">No frames fixed for shipping. Go to Frames tab to fix cages to frames.</div>'
    : '<div style="display:flex;flex-wrap:wrap;gap:0">' + ready.map(f=>{
      const cage = f.cages.map(cid=>getCage(cid)).filter(Boolean)[0];
      const sel = shipSelected.includes(f.id);
      return `<div class="ship-frame-select ${sel?'selected':''}" onclick="${shipFormOpen?`toggleShipSelect('${f.id}')`:''}" style="cursor:${shipFormOpen?'pointer':'default'};opacity:${shipFormOpen?1:0.7}">
        <div><div class="ship-frame-name">${esc(f.name)}</div>${cage ? `<div class="ship-frame-cage">${esc(cage.name)}${f.hasWaler?' üî©':''}</div>` : ''}</div>
      </div>`;
    }).join('') + '</div>';

  let formHTML = '';
  if (shipFormOpen) {
    formHTML = `<div class="card">
      <div class="form-grid form-grid-2">
        <div><label>Ship Date</label><input id="sf-date" type="date" value="${todayStr()}"/></div>
        <div><label>Notes</label><input id="sf-notes"/></div>
      </div>
      <div style="font-size:12px;color:var(--text-muted);margin:8px 0">Selected: ${shipSelected.length} frames ‚Äî click frames above to select</div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="createShipment()">Ship ${shipSelected.length} Frames</button>
        <button class="btn btn-secondary" onclick="shipFormOpen=false;shipSelected=[];render()">Cancel</button>
      </div>
    </div>`;
  }

  let historyHTML = STATE.shipments.length === 0
    ? '<div class="empty-msg">No shipments yet</div>'
    : [...STATE.shipments].sort((a,b)=>b.date.localeCompare(a.date)).map(sh=>{
      const statusBadge = {['in-transit']:'blue', delivered:'purple', ['frames-returned']:'green'}[sh.status]||'accent';
      const frameNames = sh.frameIds.map(fid=>{ const f=getFrame(fid); return f?f.name:'?'; }).join(', ');
      let actions = '';
      if(sh.status==='in-transit') actions = `<button class="btn btn-secondary btn-xs" onclick="markDelivered('${sh.id}')">Mark Delivered</button>`;
      if(sh.status==='delivered') actions = `<button class="btn btn-secondary btn-xs" onclick="returnFrames('${sh.id}')">Frames Returned</button>`;
      return `<div class="shipment-row">
        <div class="flex-between">
          <div>
            <span style="font-weight:600;color:var(--text-primary)">${fmt(sh.date)}</span>
            <span style="margin-left:12px;font-size:12px;color:var(--text-muted)">${sh.frameIds.length} frames: ${esc(frameNames)}</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="badge badge-${statusBadge}">${sh.status}</span>
            ${actions}
          </div>
        </div>
        ${sh.notes ? `<div style="font-size:12px;color:var(--text-muted);margin-top:4px">${esc(sh.notes)}</div>` : ''}
      </div>`;
    }).join('');

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Shipping Management</h2>
      <button class="btn btn-primary" onclick="shipFormOpen=!shipFormOpen;shipSelected=[];render()">+ New Shipment</button>
    </div>
    <div class="card">
      <div class="card-title">Ready to Ship (${ready.length} frames fixed)</div>
      ${readyHTML}
    </div>
    ${formHTML}
    <div class="card">
      <div class="flex-between" style="margin-bottom:12px">
        <div class="card-title" style="margin:0">Shipment History</div>
        ${STATE.shipments.length > 0 ? `<button class="btn btn-danger btn-sm" onclick="clearShipmentHistory()">üóë Clear History</button>` : ''}
      </div>
      ${historyHTML}
    </div>
  `;
}

function toggleShipSelect(fid) {
  if(shipSelected.includes(fid)) shipSelected=shipSelected.filter(id=>id!==fid);
  else shipSelected.push(fid);
  render();
}
async function createShipment() {
  if(shipSelected.length===0) return alert('Select frames to ship.');
  const date = document.getElementById('sf-date').value;
  const notes = document.getElementById('sf-notes').value.trim();
  const shipment = {id:uid(), date, notes, frameIds:[...shipSelected], status:'in-transit', createdAt:new Date().toISOString()};
  STATE.shipments.push(shipment);
  const updatedFrames = [];
  const updatedCages = [];
  shipSelected.forEach(fid=>{
    const f=getFrame(fid);
    f.location='boat';
    updatedFrames.push(f);
    f.cages.forEach(cid=>{ const c=getCage(cid); if(c){c.location='shipped';c.locationDetail='In transit'; updatedCages.push(c);} });
  });
  shipFormOpen=false; shipSelected=[];
  render();
  await addShipmentToAPI(shipment);
  await Promise.all(updatedFrames.map(f => saveFrame(f)));
  await Promise.all(updatedCages.map(c => saveCage(c)));
}
async function markDelivered(sid) {
  const sh = STATE.shipments.find(s=>s.id===sid);
  sh.status = 'delivered';
  const updatedFrames = [];
  sh.frameIds.forEach(fid=>{ const f=getFrame(fid); if(f) { f.location='client'; updatedFrames.push(f); } });
  render();
  await updateShipmentInAPI(sh);
  await Promise.all(updatedFrames.map(f => saveFrame(f)));
}
async function clearShipmentHistory() {
  const count = STATE.shipments.length;
  if (count === 0) return;
  if (!confirm(`Clear all ${count} shipment record${count!==1?'s':''}? This cannot be undone.`)) return;
  const ids = STATE.shipments.map(s=>s.id);
  STATE.shipments = [];
  render();
  await Promise.all(ids.map(id => deleteShipmentFromAPI(id)));
}

async function returnFrames(sid) {
  const sh = STATE.shipments.find(s=>s.id===sid);
  sh.status = 'frames-returned';
  const updatedFrames = [];
  sh.frameIds.forEach(fid=>{
    const f=getFrame(fid);
    if(f){ f.location='facility'; f.cages=[]; f.fixedForShipping=false; f.hasWaler=false; updatedFrames.push(f); }
  });
  render();
  await updateShipmentInAPI(sh);
  await Promise.all(updatedFrames.map(f => saveFrame(f)));
}

async function returnFromClient(fid) {
  const f = getFrame(fid);
  if (!f) return;
  const updatedCages = [];
  f.cages.forEach(cid => {
    const c = getCage(cid);
    if (c) { c.location = 'facility'; c.locationDetail = ''; c.departureDate = null; updatedCages.push(c); }
  });
  f.cages = [];
  f.fixedForShipping = false;
  f.hasWaler = false;
  f.location = 'boat';
  render();
  await saveFrame(f);
  await Promise.all(updatedCages.map(c => saveCage(c)));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let reportFrom = todayStr();
let reportTo = (() => { const d=new Date(); d.setDate(d.getDate()+7); return toISO(d); })();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW / PRESENTATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview() {
  const chipClass = (h) => hCat(h).toLowerCase();
  const cageChip = (c) => `<span class="overview-cage-chip ${chipClass(c.height)}">${esc(c.name)}</span>`;

  // RMD section - spatial layout, A on top, B on bottom, inside slots face each other
  let rmdRows = RMD_LAYOUT.map(row=>{
    let items = row.items.map(item=>{
      const r = getRMDByNum(item);
      if(!r) return '';
      // Side A: outside (cage2) on top row, inside (cage1) on bottom row
      // Side B: inside (cage1) on top row, outside (cage2) on bottom row
      function chipOrEmpty(side, slot) {
        const cid = r[side][slot];
        if(!cid) return '';
        const c = getCage(cid);
        return c ? cageChip(c) : '';
      }
      let aOut = chipOrEmpty('A','cage2');
      let aIn = chipOrEmpty('A','cage1');
      let bIn = chipOrEmpty('B','cage1');
      let bOut = chipOrEmpty('B','cage2');

      return `<div style="flex:0 0 auto;min-width:160px">
        <div style="font:700 13px var(--font-mono);color:var(--accent);text-align:center;margin-bottom:4px">RMD-${item}</div>
        <div class="overview-side-box" style="margin-bottom:2px">
          <div class="overview-side-label">A outside</div>${aOut || '<span style="font-size:10px;color:var(--text-muted)">‚Äî</span>'}
        </div>
        <div class="overview-side-box" style="margin-bottom:2px;border-color:var(--accent);border-style:dashed">
          <div class="overview-side-label">A inside / B inside</div>${aIn} ${bIn || ''} ${!aIn && !bIn ? '<span style="font-size:10px;color:var(--text-muted)">‚Äî</span>' : ''}
        </div>
        <div class="overview-side-box">
          <div class="overview-side-label">B outside</div>${bOut || '<span style="font-size:10px;color:var(--text-muted)">‚Äî</span>'}
        </div>
      </div>`;
    }).join('');
    return `<div class="rmd-site-row row-${row.row}">${items}</div>`;
  }).join('');

  // Frames with cages
  let framesWithCages = STATE.frames.filter(f=>f.cages.length>0).map(f=>{
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    const cls = f.fixedForShipping ? 'shipping' : 'has-cage';
    let badges = `<div class="overview-frame-badges">`;
    badges += `<span class="badge badge-blue" style="font-size:9px;padding:1px 6px">${f.width}m</span>`;
    if(f.hasWaler) badges += `<span class="badge badge-blue" style="font-size:9px;padding:1px 6px">üî©</span>`;
    if(f.fixedForShipping) badges += `<span class="badge badge-accent" style="font-size:9px;padding:1px 6px">SHIP</span>`;
    const locBdg = f.location!=='facility' ? `<span class="badge badge-purple" style="font-size:9px;padding:1px 6px">${f.location}</span>` : '';
    badges += locBdg + `</div>`;
    let cageInfo = fCages.map(c=>`${cageChip(c)} <span style="font-size:10px;color:var(--text-muted)">${c.height}m √ó ${c.width}m √ó ${c.length}m | ${c.weight}t</span>`).join('<br/>');
    return `<div class="overview-frame-card ${cls}">
      <div class="overview-frame-name">${esc(f.name)}</div>
      <div class="overview-frame-info">${cageInfo}</div>
      ${badges}
    </div>`;
  }).join('') || '<div class="empty-msg">No cages in any frames</div>';

  // Empty frames at facility
  let emptyFrames = STATE.frames.filter(f=>f.cages.length===0 && f.location==='facility');
  let emptyFramesSummary = emptyFrames.length > 0
    ? `<div style="font-size:12px;color:var(--text-muted);margin-top:8px">${emptyFrames.length} empty frames at facility: <span style="font-family:var(--font-mono);font-size:11px">${emptyFrames.map(f=>f.name).join(', ')}</span></div>`
    : '';

  // Stats
  const totalInRMD = STATE.cages.filter(c=>c.location==='rmd').length;
  const totalInFrames = STATE.cages.filter(c=>c.location==='frame').length;
  const totalReady = STATE.frames.filter(f=>f.fixedForShipping).length;

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Storage & Frame Overview</h2>
      <div style="display:flex;gap:12px;font-size:13px">
        <span><strong style="color:var(--green)">${totalInRMD}</strong> in RMD</span>
        <span><strong style="color:var(--blue)">${totalInFrames}</strong> in Frames</span>
        <span><strong style="color:var(--accent)">${totalReady}</strong> ready to ship</span>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">RMD Storage Bays</div>
        <div style="display:flex;gap:8px;margin-bottom:10px;font-size:10px">
          <span class="overview-cage-chip short">Short &lt;${H_SHORT}m</span>
          <span class="overview-cage-chip medium">Medium ‚â§${H_MED}m</span>
          <span class="overview-cage-chip tall">Tall &gt;${H_MED}m</span>
        </div>
        <div class="rmd-site-layout">${rmdRows}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
        <div class="card">
          <div class="card-title">Frames with Cages (${STATE.frames.filter(f=>f.cages.length>0).length})</div>
          ${framesWithCages}
        </div>
        <div class="card">
          <div class="card-title">Empty Frames at Facility (${emptyFrames.length})</div>
          ${emptyFramesSummary || '<div class="empty-msg">None</div>'}
        </div>
      </div>
    </div>
  `;
}

async function clearReportMovements() {
  const inRange = STATE.plannedMovements.filter(m => m.date >= reportFrom && m.date <= reportTo);
  if (inRange.length === 0) return alert('No movements in the selected date range.');
  if (!confirm(`Clear ${inRange.length} movement${inRange.length!==1?'s':''} between ${fmt(reportFrom)} and ${fmt(reportTo)}? This cannot be undone.`)) return;
  const ids = inRange.map(m=>m.id);
  STATE.plannedMovements = STATE.plannedMovements.filter(m => !(m.date >= reportFrom && m.date <= reportTo));
  render();
  await Promise.all(ids.map(id => deleteMovementFromAPI(id)));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let auditFilter = 'all'; // 'all' | 'completed' | 'pending' | 'rmd-to-frame' | 'frame-to-rmd' | 'facility-to-frame'
let auditSearch = '';
let auditSort = 'date-desc'; // 'date-desc' | 'date-asc'

function renderAuditLog() {
  const MVCOLS = {'rmd-to-frame':'#27a060','frame-to-rmd':'#7040c0','facility-to-frame':'#2563b0','frame-fix-shipping':'#c08520'};
  const MVLABELS = {'rmd-to-frame':'RMD ‚Üí Frame','frame-to-rmd':'Frame ‚Üí RMD','facility-to-frame':'Facility ‚Üí Frame','frame-fix-shipping':'Fix for Shipping'};

  let movements = [...STATE.plannedMovements];

  // Apply filters
  if (auditFilter === 'completed') movements = movements.filter(m => m.completed);
  else if (auditFilter === 'pending') movements = movements.filter(m => !m.completed);
  else if (auditFilter !== 'all') movements = movements.filter(m => m.typeKey === auditFilter);

  if (auditSearch) {
    const q = auditSearch.toLowerCase();
    movements = movements.filter(m => {
      const cage = getCage(m.cageId);
      return m.description?.toLowerCase().includes(q)
        || cage?.name?.toLowerCase().includes(q)
        || m.type?.toLowerCase().includes(q)
        || m.notes?.toLowerCase().includes(q);
    });
  }

  // Sort
  movements.sort((a, b) => {
    const da = a.date || '', db = b.date || '';
    const ca = a.completedAt || '', cb = b.completedAt || '';
    if (auditSort === 'date-asc') return da.localeCompare(db) || ca.localeCompare(cb);
    return db.localeCompare(da) || cb.localeCompare(ca);
  });

  // Stats
  const total = STATE.plannedMovements.length;
  const completed = STATE.plannedMovements.filter(m => m.completed).length;
  const pending = total - completed;
  const byType = {};
  STATE.plannedMovements.forEach(m => { byType[m.typeKey] = (byType[m.typeKey]||0)+1; });

  const typeFilterBtns = [
    {k:'all', label:`All (${total})`},
    {k:'completed', label:`‚úÖ Done (${completed})`},
    {k:'pending', label:`‚è≥ Pending (${pending})`},
    {k:'rmd-to-frame', label:`RMD‚ÜíFrame (${byType['rmd-to-frame']||0})`},
    {k:'frame-to-rmd', label:`Frame‚ÜíRMD (${byType['frame-to-rmd']||0})`},
    {k:'facility-to-frame', label:`Facility‚ÜíFrame (${byType['facility-to-frame']||0})`},
    {k:'frame-fix-shipping', label:`Fix Ship (${byType['frame-fix-shipping']||0})`},
  ].map(b => `<button class="filter-btn ${auditFilter===b.k?'active':''}" onclick="auditFilter='${b.k}';render()">${b.label}</button>`).join('');

  const rows = movements.length === 0
    ? `<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted);font-style:italic">No movements match this filter</td></tr>`
    : movements.map(m => {
        const cage = getCage(m.cageId);
        const frame = getFrame(m.frameId);
        const col = MVCOLS[m.typeKey] || 'var(--accent)';
        const typeLabel = MVLABELS[m.typeKey] || m.type || m.typeKey;
        const statusBadge = m.completed
          ? `<span class="badge badge-green">‚úÖ Done</span>`
          : `<span class="badge badge-yellow">‚è≥ Pending</span>`;
        const completedAtStr = m.completedAt
          ? `<div style="font-size:9px;color:var(--text-muted);margin-top:2px">Completed ${new Date(m.completedAt).toLocaleDateString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</div>`
          : '';
        return `<tr style="opacity:${m.completed?0.75:1}">
          <td style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);white-space:nowrap">${m.date ? fmt(m.date) : '‚Äî'}
            ${m.shift === 'night' ? '<span style="font-size:9px;color:#7040c0;margin-left:4px">üåô Night</span>' : '<span style="font-size:9px;color:#c08520;margin-left:4px">‚òÄ Day</span>'}
          </td>
          <td>
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${col};margin-right:5px"></span>
            <span style="font-size:12px;font-weight:600;color:${col}">${esc(typeLabel)}</span>
          </td>
          <td style="font:700 12px var(--font-mono)">${cage ? esc(cage.name) : '‚Äî'}</td>
          <td style="font-size:12px;color:var(--text-secondary)">${esc(m.description||'')}</td>
          <td style="font-size:11px;color:var(--text-muted)">${m.notes ? esc(m.notes) : '‚Äî'}</td>
          <td>${statusBadge}${completedAtStr}</td>
          <td style="white-space:nowrap">
            ${!m.completed ? `<button class="btn btn-primary btn-xs" onclick="completeMove('${m.id}')">‚úì Done</button>` : ''}
            <button class="btn btn-danger btn-xs" style="margin-left:3px" onclick="deleteMovement('${m.id}')">‚úï</button>
          </td>
        </tr>`;
      }).join('');

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">üìã Audit Log</h2>
      <div style="font-size:12px;color:var(--text-muted)">${total} total movement${total!==1?'s':''} recorded</div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <div class="stat-card" style="flex:0 0 auto;min-width:110px">
        <div class="stat-val" style="color:var(--green)">${completed}</div>
        <div class="stat-lbl">Completed</div>
      </div>
      <div class="stat-card" style="flex:0 0 auto;min-width:110px">
        <div class="stat-val" style="color:var(--orange)">${pending}</div>
        <div class="stat-lbl">Pending</div>
      </div>
      <div class="stat-card" style="flex:0 0 auto;min-width:110px">
        <div class="stat-val" style="color:var(--accent)">${total > 0 ? Math.round(completed/total*100) : 0}%</div>
        <div class="stat-lbl">Complete Rate</div>
      </div>
      <div class="stat-card" style="flex:0 0 auto;min-width:110px">
        <div class="stat-val" style="color:var(--blue)">${byType['rmd-to-frame']||0}</div>
        <div class="stat-lbl">RMD‚ÜíFrame</div>
      </div>
      <div class="stat-card" style="flex:0 0 auto;min-width:110px">
        <div class="stat-val" style="color:var(--purple)">${byType['frame-to-rmd']||0}</div>
        <div class="stat-lbl">Frame‚ÜíRMD</div>
      </div>
      <div class="stat-card" style="flex:0 0 auto;min-width:110px">
        <div class="stat-val" style="color:var(--blue)">${byType['facility-to-frame']||0}</div>
        <div class="stat-lbl">Fac‚ÜíFrame</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
      ${typeFilterBtns}
      <div style="display:flex;gap:6px;margin-left:auto;align-items:center">
        <input placeholder="Search movements‚Ä¶" value="${esc(auditSearch)}" style="width:200px;font-size:12px"
          oninput="auditSearch=this.value;render()"/>
        <select style="font-size:12px;padding:6px 10px" onchange="auditSort=this.value;render()">
          <option value="date-desc" ${auditSort==='date-desc'?'selected':''}>Newest first</option>
          <option value="date-asc" ${auditSort==='date-asc'?'selected':''}>Oldest first</option>
        </select>
      </div>
    </div>

    <div class="card" style="overflow-x:auto">
      <table>
        <thead><tr>
          <th>Date / Shift</th><th>Type</th><th>Cage</th><th>Description</th><th>Notes</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div style="margin-top:8px;font-size:11px;color:var(--text-muted);text-align:right">Showing ${movements.length} of ${total} movements</div>
  `;
}

async function deleteMovement(id) {
  if (!confirm('Delete this movement record? This cannot be undone.')) return;
  STATE.plannedMovements = STATE.plannedMovements.filter(m => m.id !== id);
  render();
  await deleteMovementFromAPI(id);
}

function renderReport() {
  const planned = STATE.plannedMovements.filter(m=>m.date>=reportFrom && m.date<=reportTo);
  const grouped = {};
  planned.forEach(m=>{ if(!grouped[m.date]) grouped[m.date]=[]; grouped[m.date].push(m); });

  const inFac = STATE.cages.filter(c=>c.location==='facility').length;
  const inRMD = STATE.cages.filter(c=>c.location==='rmd').length;
  const inFrm = STATE.cages.filter(c=>c.location==='frame').length;
  const shipped = STATE.cages.filter(c=>c.location==='shipped').length;

  let daysHTML = Object.keys(grouped).sort().map(date=>{
    const moves = grouped[date];
    const pending = moves.filter(m=>!m.completed).length;
    let movesHTML = moves.map((m,i)=>`
      <div class="report-move-row" style="opacity:${m.completed?0.5:1}">
        <span class="report-move-num">${i+1}.</span>
        <span class="report-move-desc">${esc(m.description)}</span>
        <span class="report-move-type">(${esc(m.type)})</span>
        <span style="color:var(--text-muted)">${m.shift==='night'?'üåô Night':'‚òÄ Day'}</span>
        <span class="badge ${m.completed?'badge-green':'badge-yellow'}">${m.completed?'Done':'Pending'}</span>
      </div>
    `).join('');

    return `<div style="margin-bottom:16px">
      <div class="report-day-header">${fmt(date)} ‚Äî ${pending} pending${pending>MAX_MOVES?` <span style="color:var(--red)">‚ö† Exceeds daily limit!</span>`:''}</div>
      ${movesHTML}
    </div>`;
  }).join('') || '<div class="empty-msg">No movements in this date range</div>';

  return `
    <div class="flex-between" style="margin-bottom:16px">
      <h2 class="section-title" style="margin:0">Printable Report</h2>
      <div style="display:flex;gap:8px">
        <button class="btn btn-danger btn-sm" onclick="clearReportMovements()">üóë Clear Range Data</button>
        <button class="btn btn-primary" onclick="printReport()">üñ® Print Report</button>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;gap:12px;align-items:end">
        <div><label>From</label><input type="date" value="${reportFrom}" onchange="reportFrom=this.value;render()"/></div>
        <div><label>To</label><input type="date" value="${reportTo}" onchange="reportTo=this.value;render()"/></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Report Preview</div>
      ${daysHTML}
      <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:14px">
        <div class="card-title">Inventory Summary</div>
        <div class="report-summary-grid">
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--blue)">${inFac}</div><div class="report-summary-lbl">In Facility</div></div>
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--green)">${inRMD}</div><div class="report-summary-lbl">In RMD</div></div>
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--orange)">${inFrm}</div><div class="report-summary-lbl">In Frames</div></div>
          <div class="report-summary-cell"><div class="report-summary-val" style="color:var(--purple)">${shipped}</div><div class="report-summary-lbl">Shipped</div></div>
        </div>
      </div>
    </div>
  `;
}

function printReport() {
  const planned = STATE.plannedMovements.filter(m=>m.date>=reportFrom && m.date<=reportTo);
  const grouped = {};
  planned.forEach(m=>{ if(!grouped[m.date]) grouped[m.date]=[]; grouped[m.date].push(m); });

  let daysHTML = Object.keys(grouped).sort().map(date=>{
    const moves = grouped[date];
    return `<h2>${fmt(date)} (${moves.filter(m=>!m.completed).length} pending)</h2>
    <table><tr><th>#</th><th>Type</th><th>Description</th><th>Shift</th><th>Notes</th><th>Status</th></tr>
    ${moves.map((m,i)=>`<tr class="${m.completed?'done':''}"><td>${i+1}</td><td>${esc(m.type)}</td><td>${esc(m.description)}</td><td>${m.shift}</td><td>${esc(m.notes||'-')}</td><td>${m.completed?'‚úì Done':'Pending'}</td></tr>`).join('')}
    </table>`;
  }).join('') || '<p style="color:#999">No movements planned in this date range.</p>';

  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>Movement Report</title><style>
    body{font-family:Arial,sans-serif;padding:20px;color:#333}
    h1{font-size:20px;border-bottom:2px solid #333;padding-bottom:8px}
    h2{font-size:16px;margin-top:20px;color:#555}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #ccc;padding:6px 10px;text-align:left;font-size:13px}
    th{background:#f5f5f5;font-weight:bold}
    .done{text-decoration:line-through;color:#999}
    @media print{body{padding:0}}
  </style></head><body>
    <h1>Cage Movement Report ‚Äî ${fmt(reportFrom)} to ${fmt(reportTo)}</h1>
    <p>Generated: ${new Date().toLocaleString('en-GB')} | Max movements/day: ${MAX_MOVES}</p>
    ${daysHTML}
    <hr style="margin-top:24px"/>
    <h2>Current Inventory Summary</h2>
    <table><tr><th>Location</th><th>Count</th></tr>
    <tr><td>In Facility</td><td>${STATE.cages.filter(c=>c.location==='facility').length}</td></tr>
    <tr><td>In RMD Storage</td><td>${STATE.cages.filter(c=>c.location==='rmd').length}</td></tr>
    <tr><td>In Frames</td><td>${STATE.cages.filter(c=>c.location==='frame').length}</td></tr>
    <tr><td>Shipped</td><td>${STATE.cages.filter(c=>c.location==='shipped').length}</td></tr></table>
    <h2>Frame Status</h2>
    <table><tr><th>Location</th><th>Count</th></tr>
    <tr><td>At Facility</td><td>${STATE.frames.filter(f=>f.location==='facility').length}</td></tr>
    <tr><td>On Boat</td><td>${STATE.frames.filter(f=>f.location==='boat').length}</td></tr>
    <tr><td>With Client</td><td>${STATE.frames.filter(f=>f.location==='client').length}</td></tr>
    <tr><td>Fixed for Shipping</td><td>${STATE.frames.filter(f=>f.fixedForShipping).length}</td></tr>
    <tr><td>Frames with Waler</td><td>${STATE.frames.filter(f=>f.hasWaler).length}</td></tr></table>
  </body></html>`);
  w.document.close();
  w.print();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOAT PLANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bpBoatDate = todayStr();
let bpSelectedCages = new Set();
let bpGeneratedMovements = null;

function toggleBPCage(id) {
  if (bpSelectedCages.has(id)) bpSelectedCages.delete(id);
  else bpSelectedCages.add(id);
  bpGeneratedMovements = null;
  render();
}

function generateBoatMovements() {
  if (bpSelectedCages.size === 0) return alert('Please select at least one cage to plan for the boat.');
  if (!bpBoatDate) return alert('Please set a boat loading date.');

  const selectedCages = [...bpSelectedCages].map(id => getCage(id)).filter(Boolean);
  const warnings = [];
  const assignments = [];

  // ‚îÄ‚îÄ Frame availability simulation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Virtual frame state: starts from real state, then layered with planned movements
  // frameSim[frameId] = { frame, cages: [cageId,...] }
  const frameSim = {};
  STATE.frames.filter(f => f.location === 'facility').forEach(f => {
    frameSim[f.id] = { frame: f, cages: [...f.cages] };
  });

  // Layer in existing planned (not completed) movements
  STATE.plannedMovements.filter(m => !m.completed).forEach(m => {
    if (m.typeKey === 'facility-to-frame' && m.frameId && m.cageId && !bpSelectedCages.has(m.cageId)) {
      if (frameSim[m.frameId]) frameSim[m.frameId].cages.push(m.cageId);
    }
    if (m.typeKey === 'frame-to-rmd' && m.frameId && m.cageId) {
      if (frameSim[m.frameId]) frameSim[m.frameId].cages = frameSim[m.frameId].cages.filter(id => id !== m.cageId);
    }
  });

  function simCageCount(fid) { return (frameSim[fid]?.cages || []).length; }
  function simCages(fid) { return (frameSim[fid]?.cages || []).map(id => getCage(id)).filter(Boolean); }

  // ‚îÄ‚îÄ Frame finder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function findBestFrame(cage, reservedIds) {
    const needsW = needsWaler(cage);
    const all = Object.values(frameSim)
      .map(s => s.frame)
      .filter(f => !f.fixedForShipping && !reservedIds.has(f.id) && cage.width <= f.width && simCageCount(f.id) < 2)
      .sort((a, b) => a.width - b.width);

    // Pass 1: prefer frames already carrying a compatible cage (space efficiency)
    for (const f of all) {
      if (simCageCount(f.id) !== 1) continue;
      if (needsW && !f.hasWaler) continue;
      const existing = simCages(f.id);
      if (existing.length && !canFitTwo(existing[0], cage, f.width)) continue;
      return f;
    }
    // Pass 2: empty frames with waler if needed
    for (const f of all) {
      if (simCageCount(f.id) !== 0) continue;
      if (needsW && !f.hasWaler) continue;
      return f;
    }
    // Pass 3: relax waler
    for (const f of all) {
      if (simCageCount(f.id) === 1) {
        const existing = simCages(f.id);
        if (existing.length && !canFitTwo(existing[0], cage, f.width)) continue;
      }
      return f;
    }
    return null;
  }

  const reservedFrameIds = new Set();

  // ‚îÄ‚îÄ Step 1: Classify selected cages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // already_framed    ‚Äì cage is in a frame, frame is suitable ‚Üí just need fix-for-shipping
  // reframe           ‚Äì cage is in a frame but it's wrong ‚Üí move to better frame
  // rmd_to_frame      ‚Äì cage is in RMD ‚Üí lift to frame
  // facility_to_frame ‚Äì cage is in facility ‚Üí lift directly to frame (1 lift)

  selectedCages.forEach(cage => {
    if (cage.location === 'frame') {
      const currentFrame = STATE.frames.find(f => f.cages.includes(cage.id));
      if (!currentFrame) { assignments.push({ cage, frame: null, action: 'no_frame', note: `Cannot find frame for cage ${cage.name}` }); return; }
      const issues = [];
      if (cage.width > currentFrame.width) issues.push(`frame ${currentFrame.name} too narrow`);
      if (needsWaler(cage) && !currentFrame.hasWaler) issues.push(`no waler on ${currentFrame.name}`);
      if (issues.length === 0) {
        reservedFrameIds.add(currentFrame.id);
        assignments.push({ cage, frame: currentFrame, action: 'already_framed', note: `Already in ${currentFrame.name} ‚úì` });
      } else {
        // Remove from sim so it looks available
        if (frameSim[currentFrame.id]) frameSim[currentFrame.id].cages = frameSim[currentFrame.id].cages.filter(id => id !== cage.id);
        const better = findBestFrame(cage, reservedFrameIds);
        if (better) {
          reservedFrameIds.add(better.id);
          frameSim[better.id]?.cages.push(cage.id);
          assignments.push({ cage, frame: better, action: 'reframe', note: `Reframe: ${currentFrame.name} ‚Üí ${better.name}`, fromFrame: currentFrame });
          warnings.push(`‚ö† Cage ${cage.name} reframed: ${issues.join(', ')}`);
        } else {
          assignments.push({ cage, frame: null, action: 'no_frame', note: `No suitable frame for ${cage.name}` });
          warnings.push(`‚ö† No suitable frame for cage ${cage.name} (${issues.join(', ')})`);
        }
      }
    } else if (cage.location === 'rmd') {
      const frame = findBestFrame(cage, reservedFrameIds);
      if (frame) {
        reservedFrameIds.add(frame.id);
        frameSim[frame.id]?.cages.push(cage.id);
        if (needsWaler(cage) && !frame.hasWaler) warnings.push(`‚ö† Cage ${cage.name} needs waler but ${frame.name} has none`);
        assignments.push({ cage, frame, action: 'rmd_to_frame', note: `${cage.locationDetail || 'RMD'} ‚Üí ${frame.name}` });
      } else {
        assignments.push({ cage, frame: null, action: 'no_frame', note: `No suitable frame for ${cage.name}` });
        warnings.push(`‚ö† No suitable frame for cage ${cage.name} (width ${cage.width}m${needsWaler(cage)?' + waler':''})`);
      }
    } else {
      // facility (or unknown) ‚Üí direct to frame
      const frame = findBestFrame(cage, reservedFrameIds);
      if (frame) {
        reservedFrameIds.add(frame.id);
        frameSim[frame.id]?.cages.push(cage.id);
        if (needsWaler(cage) && !frame.hasWaler) warnings.push(`‚ö† Cage ${cage.name} needs waler but ${frame.name} has none`);
        assignments.push({ cage, frame, action: 'facility_to_frame', note: `Facility ‚Üí ${frame.name}` });
      } else {
        assignments.push({ cage, frame: null, action: 'no_frame', note: `No suitable frame for ${cage.name}` });
        warnings.push(`‚ö† No suitable frame for cage ${cage.name} (width ${cage.width}m${needsWaler(cage)?' + waler':''})`);
      }
    }
  });

  // ‚îÄ‚îÄ Step 2: Fix-for-shipping steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Every assigned frame needs to be bolted down before boat loading
  const framesNeedingFix = [...new Set(
    assignments.filter(a => a.frame && a.action !== 'no_frame').map(a => a.frame)
  )].filter(f => !f.fixedForShipping);

  const fixSteps = framesNeedingFix.map(f => ({
    isFixStep: true, frame: f,
    note: `Fix frame ${f.name} for shipping (bolt cage(s) to frame)`
  }));

  // ‚îÄ‚îÄ Step 3: Facility-exit steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Cages coming from facility that have a departureDate (when they physically
  // need to leave the compound) get an additional intake/movement note pinned
  // to that date. This is informational ‚Äî the actual "Facility ‚Üí Frame" lift
  // may happen before the boat date.
  const facilityExitSteps = [];
  assignments.forEach(a => {
    if (a.action !== 'facility_to_frame' && a.action !== 'reframe') return;
    if (a.cage.location !== 'facility') return;
    if (!a.cage.departureDate) return;
    facilityExitSteps.push({
      isFacilityExit: true, cage: a.cage,
      date: a.cage.departureDate,
      note: `Cage ${a.cage.name} ‚Äî must leave facility by this date`,
    });
  });

  // ‚îÄ‚îÄ Step 4: Schedule lifts across working days ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const liftSteps = assignments.filter(a => a.action !== 'already_framed' && a.action !== 'no_frame');
  const allSteps = [...liftSteps, ...fixSteps]; // lifts first, then fixes

  const boatDate = new Date(bpBoatDate + 'T12:00:00');
  const todayD = new Date(); todayD.setHours(12,0,0,0);
  let workDays = [];
  let d = new Date(todayD);
  while (d < boatDate) {
    const dow = d.getDay();
    if (dow !== 0 && dow !== 6) workDays.push(toISO(d));
    d.setDate(d.getDate() + 1);
  }
  if (workDays.length === 0) {
    warnings.push('‚ö† No working days before boat date ‚Äî scheduling on boat date.');
    workDays = [bpBoatDate];
  }

  const DAILY_LIMIT = STATE.settings.movementsPerDay || MAX_MOVES;
  const existingCounts = {};
  STATE.plannedMovements.filter(m => !m.completed).forEach(m => {
    existingCounts[m.date] = (existingCounts[m.date] || 0) + 1;
  });

  const scheduledSteps = [];

  // Pin facility exit notes to their departure dates (don't count vs daily limit ‚Äî informational)
  facilityExitSteps.forEach(step => scheduledSteps.push({ ...step }));

  // Schedule actual lifts across days, back-loading from the boat date
  // (we fill days closest to the boat date last, so breathing room is at the start)
  let dayIdx = 0;
  let usedToday = existingCounts[workDays[0]] || 0;
  for (const step of allSteps) {
    while (dayIdx < workDays.length - 1 && usedToday >= DAILY_LIMIT) {
      dayIdx++;
      usedToday = existingCounts[workDays[dayIdx]] || 0;
    }
    const assignedDay = workDays[Math.min(dayIdx, workDays.length - 1)];
    existingCounts[assignedDay] = (existingCounts[assignedDay] || 0) + 1;
    scheduledSteps.push({ ...step, date: assignedDay });
    usedToday++;
  }

  // Sort chronologically
  scheduledSteps.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

  const moveSlotsNeeded = allSteps.length;
  const slotsAvailable = workDays.length * DAILY_LIMIT;
  if (moveSlotsNeeded > slotsAvailable) {
    warnings.push(`‚ö† ${moveSlotsNeeded} lifts needed but only ${slotsAvailable} slots available (${workDays.length} days √ó ${DAILY_LIMIT}). Some days will exceed the limit.`);
  }

  // ‚îÄ‚îÄ Step 5: Build display list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const moves = [];
  const summary = [];
  assignments.filter(a => a.action === 'already_framed').forEach(a => {
    moves.push({ type: '‚úì Ready', desc: `Cage ${a.cage.name} ‚Äî ${a.note}`, category: 'info' });
    summary.push(`${a.cage.name} already framed`);
  });
  assignments.filter(a => a.action === 'no_frame').forEach(a => {
    moves.push({ type: '‚ö† Warning', desc: a.note, category: 'warning' });
  });

  let lastDate = null;
  let moveNum = 1;
  scheduledSteps.forEach(step => {
    if (step.date !== lastDate) {
      moves.push({ type: 'üìÖ', desc: fmt(step.date), category: 'date-header' });
      lastDate = step.date;
    }
    if (step.isFacilityExit) {
      moves.push({ type: 'üì§ Facility exit deadline', desc: step.note, category: 'facility-exit' });
    } else if (step.isFixStep) {
      moves.push({ type: `üî© Move ${moveNum++}`, desc: step.note, category: 'move' });
    } else {
      const typeLabel = step.action === 'rmd_to_frame' ? 'üèó RMD‚ÜíFrame'
        : step.action === 'reframe' ? 'üîÑ Reframe'
        : 'üè≠ Facility‚ÜíFrame';
      const walerNote = needsWaler(step.cage) ? ' ‚ö† waler req.' : '';
      moves.push({
        type: `${typeLabel} ¬∑ Move ${moveNum++}`,
        desc: `${step.cage.name}: ${step.note}${walerNote}`,
        category: 'move', cage: step.cage, frame: step.frame
      });
    }
  });

  bpGeneratedMovements = { moves, warnings, assignments, framesUsed: framesNeedingFix, scheduledSteps };
  render();
}
async function commitBoatPlan() {
  if (!bpGeneratedMovements) return;
  const {scheduledSteps} = bpGeneratedMovements;
  const newMovements = [];

  scheduledSteps.forEach(step => {
    if (step.isFacilityExit) {
      // Informational deadline note ‚Äî shows in planner as a reminder
      newMovements.push({
        id: uid(), date: step.date,
        type: 'Facility Exit Deadline',
        typeKey: 'facility-to-frame', // closest type so it shows on the calendar
        description: step.note,
        shift: 'day', notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`,
        cageId: step.cage?.id || null,
        frameId: null, completed: false,
      });
    } else if (step.isFixStep) {
      newMovements.push({
        id: uid(), date: step.date,
        type: 'Fix for Shipping',
        typeKey: 'frame-fix-shipping',
        description: step.note,
        shift: 'day', notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`,
        cageId: null,
        frameId: step.frame?.id || null, completed: false,
      });
    } else {
      // Actual lift movement
      const typeKey = step.action === 'rmd_to_frame' ? 'rmd-to-frame'
        : step.action === 'reframe' ? 'frame-to-rmd' // reframe = take out of old frame first; second step added below
        : 'facility-to-frame';
      const typeLabel = step.action === 'rmd_to_frame' ? 'RMD ‚Üí Frame'
        : step.action === 'reframe' ? 'Reframe'
        : 'Facility ‚Üí Frame';
      const walerNote = needsWaler(step.cage) ? ' [waler req.]' : '';
      newMovements.push({
        id: uid(), date: step.date,
        type: typeLabel,
        typeKey,
        description: `${step.cage.name}: ${step.note}${walerNote}`,
        shift: 'day', notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`,
        cageId: step.cage.id,
        frameId: step.frame?.id || null, completed: false,
      });
      // For reframe: also add an explicit "move into new frame" step on same day
      if (step.action === 'reframe' && step.frame) {
        newMovements.push({
          id: uid(), date: step.date,
          type: 'Reframe ‚Üí Frame',
          typeKey: 'rmd-to-frame',
          description: `${step.cage.name}: Load into ${step.frame.name}${walerNote}`,
          shift: 'day', notes: `Boat plan ‚Äî load date: ${fmt(bpBoatDate)}`,
          cageId: step.cage.id,
          frameId: step.frame?.id || null, completed: false,
        });
      }
    }
  });

  STATE.plannedMovements.push(...newMovements);
  const days = new Set(scheduledSteps.map(s => s.date).filter(Boolean));
  const liftCount = newMovements.filter(m => m.typeKey !== 'frame-fix-shipping' && !m.type.includes('Deadline')).length;
  alert(`Plan committed!

‚Ä¢ ${liftCount} lift movements
‚Ä¢ ${newMovements.filter(m=>m.typeKey==='frame-fix-shipping').length} fix-for-shipping steps
‚Ä¢ Spread across ${days.size} working day${days.size!==1?'s':''} before ${fmt(bpBoatDate)}`);
  bpSelectedCages.clear();
  bpGeneratedMovements = null;
  render();
  await Promise.all(newMovements.map(m => addMovementToAPI(m)));
}

function renderBoatPlanner() {
  const today = new Date();
  const in7Days = new Date(today); in7Days.setDate(in7Days.getDate() + 7);

  // Cages to show: those leaving facility in next 7 days OR already in RMD/frame
  const eligibleCages = STATE.cages.filter(c => {
    if (c.location === 'shipped') return false;
    if (c.location === 'rmd' || c.location === 'frame') return true;
    if (c.location === 'facility' && c.departureDate) {
      const dep = new Date(c.departureDate + 'T12:00:00');
      return dep <= in7Days;
    }
    return false;
  }).sort((a,b) => {
    // Sort: facility with departure first, then rmd, then frame
    const order = {facility:0, rmd:1, frame:2};
    if (order[a.location] !== order[b.location]) return order[a.location] - order[b.location];
    return a.name.localeCompare(b.name, undefined, {numeric:true});
  });

  // Upcoming departures (cages with departure dates in next 7 days)
  const upcoming = STATE.cages
    .filter(c => c.departureDate && c.location !== 'shipped')
    .sort((a,b) => a.departureDate.localeCompare(b.departureDate));

  const cageCardsHTML = (() => {
    if (eligibleCages.length === 0) return '<div class="empty-msg">No cages leaving in the next 7 days, and no cages in RMD or frames.</div>';

    // Group by proposedShipDay
    const groups = {};
    const NO_GROUP = '__none__';
    eligibleCages.forEach(c => {
      const key = c.proposedShipDay || NO_GROUP;
      if (!groups[key]) groups[key] = [];
      groups[key].push(c);
    });

    // Sort group keys: dated groups first (ascending), then ungrouped
    const sortedKeys = Object.keys(groups).sort((a, b) => {
      if (a === NO_GROUP) return 1;
      if (b === NO_GROUP) return -1;
      return a.localeCompare(b);
    });

    const hasGroups = sortedKeys.some(k => k !== NO_GROUP);

    return sortedKeys.map(key => {
      const groupCages = groups[key];
      const groupHeader = key !== NO_GROUP
        ? `<div style="grid-column:1/-1;font:700 12px var(--font-mono);color:var(--purple);padding:6px 0 4px;border-bottom:1px solid var(--border);margin-bottom:4px">üö¢ Proposed Ship: ${fmt(key)} <span style="font-weight:400;color:var(--text-muted)">(${groupCages.length} cage${groupCages.length>1?'s':''})</span></div>`
        : hasGroups ? `<div style="grid-column:1/-1;font:700 12px var(--font-mono);color:var(--text-muted);padding:6px 0 4px;border-bottom:1px solid var(--border);margin-bottom:4px">No proposed shipping day</div>` : '';

      const cards = groupCages.map(c => {
        const sel = bpSelectedCages.has(c.id);
        const daysLeft = c.departureDate ? Math.ceil((new Date(c.departureDate+'T12:00:00') - new Date()) / 86400000) : null;
        const depTag = c.departureDate ? `<span style="color:${daysLeft !== null && daysLeft <= 3 ? 'var(--red)' : daysLeft <= 7 ? 'var(--orange)' : 'var(--text-muted)'}">üìÖ ${fmt(c.departureDate)} (${daysLeft}d)</span>` : '';
        const locTag = `<span class="badge badge-${locBadge(c.location)}" style="font-size:9px;padding:1px 5px">${esc(locLabel(c))}</span>`;
        return `<div class="bp-cage-card ${sel?'selected':''}" onclick="toggleBPCage('${c.id}')">
          <div class="bp-check">${sel?'‚úì':''}</div>
          <div class="bp-cage-info">
            <div class="bp-cage-name">${esc(c.name)} ${locTag}</div>
            <div class="bp-cage-meta">${c.width}m √ó ${c.height}m √ó ${c.length}m ¬∑ ${c.weight}t ${depTag}</div>
          </div>
        </div>`;
      }).join('');

      return groupHeader + cards;
    }).join('');
  })();

  // Generated movements panel
  let movementsHTML = '';
  if (bpGeneratedMovements) {
    const {moves, warnings} = bpGeneratedMovements;
    const warningsHTML = warnings.map(w => `<div class="bp-warning">${esc(w)}</div>`).join('');
    const movesListHTML = moves.map(m => {
      if (m.category === 'date-header') {
        return `<li style="list-style:none;border-top:2px solid var(--border);margin-top:8px;padding-top:6px"><span style="font:700 11px var(--font-mono);color:var(--blue)">${esc(m.type)} ‚Äî ${esc(m.desc)}</span></li>`;
      }
      const typeColor = m.category === 'info' ? 'var(--green)' : m.category === 'warning' ? 'var(--orange)' : m.category === 'facility-exit' ? 'var(--purple)' : 'var(--accent)';
      return `<li><div class="bp-movement-desc"><span class="bp-movement-type" style="color:${typeColor}">${esc(m.type)}</span> ‚Äî ${esc(m.desc)}</div></li>`;
    }).join('');
    const hasMoves = moves.some(m => m.category === 'move');
    movementsHTML = `
      <div class="card">
        <div class="card-title">Generated Movement Plan for ${fmt(bpBoatDate)}</div>
        ${warningsHTML}
        ${movesListHTML ? `<ul class="bp-movement-list">${movesListHTML}</ul>` : '<div class="empty-msg">No movements needed.</div>'}
        ${hasMoves ? `<div class="form-actions" style="margin-top:12px">
          <button class="btn btn-primary" onclick="commitBoatPlan()">‚úÖ Add to Planner</button>
          <button class="btn btn-secondary" onclick="bpGeneratedMovements=null;render()">Clear</button>
        </div>` : ''}
      </div>`;
  }

  // Upcoming departures panel
  const upcomingHTML = upcoming.length > 0
    ? upcoming.map(c => {
        const daysLeft = Math.ceil((new Date(c.departureDate+'T12:00:00') - new Date()) / 86400000);
        const urgColor = daysLeft < 0 ? 'var(--red)' : daysLeft <= 7 ? 'var(--orange)' : 'var(--green)';
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px">
          <span style="font-weight:600">${esc(c.name)}</span>
          <span class="badge badge-${locBadge(c.location)}">${esc(locLabel(c))}</span>
          <span style="color:${urgColor};font-family:var(--font-mono);font-size:12px">${fmt(c.departureDate)} (${daysLeft < 0 ? 'OVERDUE' : daysLeft+'d'})</span>
        </div>`;
      }).join('')
    : '<div class="empty-msg">No cages have a Leaves Facility date set.</div>';

  return `
    <h2 class="section-title" style="margin-bottom:4px">üö¢ Boat Planner</h2>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Showing cages leaving facility within 7 days, plus all cages already in RMD or frames. Frame availability reflects existing planned movements from the Movement Planner.</div>
    <div style="display:grid;grid-template-columns:1fr 340px;gap:16px">
      <div>
        <div class="card">
          <div class="flex-between" style="margin-bottom:12px">
            <div class="card-title" style="margin:0">Select Cages for Next Boat (${bpSelectedCages.size} selected)</div>
            <div style="display:flex;gap:8px;align-items:center">
              <div><label style="margin-bottom:2px">Boat Date</label><input type="date" value="${bpBoatDate}" onchange="bpBoatDate=this.value;bpGeneratedMovements=null;render()" style="width:160px"/></div>
              ${bpSelectedCages.size > 0 ? `<button class="btn btn-primary" onclick="generateBoatMovements()" style="align-self:flex-end">‚öô Generate Plan</button>` : ''}
              ${bpSelectedCages.size > 0 ? `<button class="btn btn-secondary" onclick="bpSelectedCages.clear();bpGeneratedMovements=null;render()" style="align-self:flex-end">Clear</button>` : ''}
            </div>
          </div>
          <div class="bp-cage-grid">${cageCardsHTML}</div>
        </div>
        ${movementsHTML}
      </div>
      <div>
        <div class="card">
          <div class="card-title">Upcoming Cages Out of Facility</div>
          ${upcomingHTML}
        </div>
          <div class="card" style="margin-top:0">
          <div class="card-title">Frame Availability</div>
          ${STATE.frames.filter(f=>f.location==='facility').map(f => {
            const plannedExtra = (STATE.plannedMovements.filter(m=>!m.completed && m.typeKey==='facility-to-frame' && m.frameId===f.id)).length;
            const totalCages = f.cages.length + plannedExtra;
            const cls = totalCages === 0 ? 'badge-green' : totalCages === 1 ? 'badge-yellow' : 'badge-red';
            const lbl = totalCages === 0 ? 'Empty' : totalCages === 1 ? `1 cage${plannedExtra > 0 ? ' (planned)' : ''}` : 'Full';
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px">
              <span style="font-family:var(--font-mono)">${esc(f.name)}</span>
              <span style="color:var(--text-muted)">${f.width}m</span>
              <span class="badge ${cls}">${lbl}</span>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOVEMENTS MAP TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mvFilter = 'all';

function renderMovementsMap() {
  const pendingMoves = STATE.plannedMovements.filter(m => !m.completed);

  if (pendingMoves.length === 0) {
    return `
      <h2 class="section-title" style="margin-bottom:4px">‚Üî Movements Map</h2>
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:20px">Visual map of all planned (not yet actioned) cage movements.</div>
      <div class="card" style="text-align:center;padding:40px">
        <div style="font-size:32px;margin-bottom:10px">‚úÖ</div>
        <div style="font-weight:600;font-size:15px">No pending movements</div>
        <div style="font-size:13px;color:var(--text-muted);margin-top:6px">All movements completed or none planned yet.</div>
        <button class="btn btn-primary" style="margin-top:14px" onclick="switchTab('planner')">Go to Planner ‚Üí</button>
      </div>`;
  }

  const filtered = mvFilter === 'all' ? pendingMoves : pendingMoves.filter(m => m.typeKey === mvFilter);
  const ct = {};
  pendingMoves.forEach(m => { ct[m.typeKey] = (ct[m.typeKey]||0)+1; });

  const filterBtns = [
    {k:'all',              label:`All (${pendingMoves.length})`},
    {k:'rmd-to-frame',     label:`RMD ‚Üí Frame (${ct['rmd-to-frame']||0})`},
    {k:'frame-to-rmd',     label:`Frame ‚Üí RMD (${ct['frame-to-rmd']||0})`},
    {k:'facility-to-frame',label:`Facility ‚Üí Frame (${ct['facility-to-frame']||0})`},
    {k:'frame-fix-shipping',label:`Fix Shipping (${ct['frame-fix-shipping']||0})`},
    {k:'frame-return-from-client',label:`üö¢ Frame Return (${ct['frame-return-from-client']||0})`},
  ].map(b=>`<button class="filter-btn ${mvFilter===b.k?'active':''}" onclick="mvFilter='${b.k}';render()">${b.label}</button>`).join('');

  // Helper: resolve rmdSlot from cage's current RMD location when not stored
  function resolveRmdSlot(m) {
    if (m.rmdSlot) return m.rmdSlot;
    if (m.typeKey === 'rmd-to-frame' || m.typeKey === 'frame-to-rmd') {
      const cage = getCage(m.cageId);
      if (cage && cage.location === 'rmd' && cage.locationDetail) return cage.locationDetail;
    }
    return '';
  }

  const activeRmds   = new Set(filtered.map(m=>resolveRmdSlot(m)).filter(Boolean).map(s=>String(s).replace(/[ABab]$/,'')));

  // Helper: resolve frameId for a movement (handles old data where frame-to-rmd has no frameId)
  function resolveFrameId(m) {
    if (m.frameId) return m.frameId;
    if (m.typeKey === 'frame-to-rmd' || m.typeKey === 'rmd-to-frame') {
      const cage = getCage(m.cageId);
      if (cage && cage.location === 'frame') {
        const f = STATE.frames.find(fr => fr.cages.includes(m.cageId));
        if (f) return f.id;
      }
      const pending = STATE.plannedMovements.find(
        pm => !pm.completed && pm.cageId === m.cageId && pm.typeKey === 'facility-to-frame' && pm.frameId
      );
      if (pending) return pending.frameId;
    }
    return '';
  }

  const activeFrames = new Set(filtered.map(m => resolveFrameId(m)).filter(Boolean));

  // ‚îÄ‚îÄ RMD cards HTML ‚îÄ‚îÄ
  function buildRmdCard(rmdNum) {
    const r = getRMDByNum(rmdNum);
    if (!r) return '';
    const isActive = activeRmds.has(String(rmdNum));
    const movesForRmd = filtered.filter(m => String(resolveRmdSlot(m)).replace(/[ABab]$/,'') === String(rmdNum));
    const sides = ['A','B'];
    const slotKeys = ['cage1','cage2','cage3','cage4'];
    const slotLabels = {cage1:'In 1', cage2:'Out 1', cage3:'In 2', cage4:'Out 2'};
    let slotsHTML = '';
    sides.forEach(side => {
      slotsHTML += `<div style="font:700 8px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin:5px 0 3px">Side ${side}</div>`;
      let sideHasContent = false;
      slotKeys.forEach(sk => {
        const cid = r[side][sk];
        const cage = cid ? getCage(cid) : null;
        if (cage) {
          sideHasContent = true;
          const mvOut = movesForRmd.some(m => m.cageId===cid && m.typeKey==='rmd-to-frame');
          const mvIn  = movesForRmd.some(m => m.cageId===cid && m.typeKey==='frame-to-rmd');
          const bg = mvOut ? 'background:#fff7ed;border-color:#f5a742;' : mvIn ? 'background:#f0faf4;border-color:#4aad72;' : 'border-color:var(--border);';
          const arrow = mvOut ? '<span style="color:#c08520;font-weight:800;margin-right:4px">‚Üí</span>'
                      : mvIn  ? '<span style="color:#27a060;font-weight:800;margin-right:4px">‚Üê</span>' : '';
          slotsHTML += `<div style="font-size:10px;padding:3px 6px;border-radius:4px;border:1px solid;background:var(--bg-input);margin-bottom:2px;display:flex;align-items:center;${bg}">
            ${arrow}<span style="font:600 10px var(--font-mono)">${esc(cage.name)}</span>
            <span style="color:var(--text-muted);margin-left:5px">${cage.height}m</span>
          </div>`;
        }
      });
      if (!sideHasContent) {
        slotsHTML += `<div style="font-size:10px;color:var(--text-muted);font-style:italic;padding:2px 6px;margin-bottom:2px">empty</div>`;
      }
    });

    const border = isActive ? 'border:2px solid var(--accent);box-shadow:0 0 0 3px rgba(192,133,32,0.15);' : 'border:1px solid var(--border);';
    return `<div id="mvr-${rmdNum}" style="background:var(--bg-card);${border}border-radius:8px;padding:9px 11px;min-width:145px;flex:0 0 auto;">
      <div style="font:700 13px var(--font-mono);color:${isActive?'var(--accent)':'var(--text-primary)'};margin-bottom:1px;">RMD-${rmdNum}</div>
      ${slotsHTML}
    </div>`;
  }

  const rmdRowsHTML = RMD_LAYOUT.map(row =>
    `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">${row.items.map(n=>buildRmdCard(n)).join('')}</div>`
  ).join('');

  // ‚îÄ‚îÄ Frame cards HTML ‚îÄ‚îÄ
  const facilityFrames = STATE.frames.filter(f=>f.location==='facility');
  const sortedFrames = [...facilityFrames].sort((a,b)=>{
    return (activeFrames.has(b.id)?1:0)-(activeFrames.has(a.id)?1:0);
  });

  function buildFrameCard(f) {
    const isActive = activeFrames.has(f.id);
    const movesForFrame = filtered.filter(m => resolveFrameId(m) === f.id);
    const fCages = f.cages.map(cid=>getCage(cid)).filter(Boolean);
    const outIds = movesForFrame.filter(m=>m.typeKey==='frame-to-rmd').map(m=>m.cageId);
    const inIds  = movesForFrame.filter(m=>m.typeKey==='rmd-to-frame'||m.typeKey==='facility-to-frame').map(m=>m.cageId);
    let html = '';
    fCages.forEach(c=>{
      const out = outIds.includes(c.id);
      html += `<div style="font-size:10px;padding:2px 5px;border-radius:4px;border:1px solid ${out?'#f5a742':'var(--border)'};background:${out?'#fff7ed':'var(--bg-input)'};margin-bottom:2px;display:flex;align-items:center;gap:3px;">
        ${out?'<span style="color:#c08520;font-weight:800">‚Üí</span>':''}
        <span style="font:600 10px var(--font-mono)">${esc(c.name)}</span>
        <span style="color:var(--text-muted)">${c.height}m</span>
      </div>`;
    });
    inIds.forEach(cid=>{
      const c=getCage(cid); if(!c)return;
      if(fCages.find(x=>x.id===cid))return; // already shown
      html+=`<div style="font-size:10px;padding:2px 5px;border-radius:4px;border:1px solid #4aad72;background:#f0faf4;margin-bottom:2px;display:flex;align-items:center;gap:3px;">
        <span style="color:#27a060;font-weight:800">‚Üê</span>
        <span style="font:600 10px var(--font-mono)">${esc(c.name)}</span>
        <span style="color:var(--text-muted)">${c.height}m</span>
      </div>`;
    });
    if(!html) html='<div style="font-size:10px;color:var(--text-muted);font-style:italic">empty</div>';
    const border = isActive ? 'border:2px solid var(--accent);box-shadow:0 0 0 3px rgba(192,133,32,0.15);' : 'border:1px solid var(--border);';
    return `<div id="mvf-${f.id}" style="background:var(--bg-card);${border}border-radius:8px;padding:9px 10px;min-width:100px;">
      <div style="font:700 12px var(--font-mono);color:${isActive?'var(--accent)':'var(--text-primary)'}">${esc(f.name)}</div>
      <div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${f.width}m${f.hasWaler?' üî©':''}</div>
      ${html}
    </div>`;
  }

  const framesHTML = sortedFrames.map(f=>buildFrameCard(f)).join('');

  // ‚îÄ‚îÄ Facility movements (for facility box display) ‚îÄ‚îÄ
  const facilityMoves = filtered.filter(m => m.typeKey === 'facility-to-frame');
  const boatMoves = filtered.filter(m => m.typeKey === 'frame-return-from-client');

  // ‚îÄ‚îÄ Movement list sidebar ‚îÄ‚îÄ
  const MVCOLS = {'rmd-to-frame':'#27a060','frame-to-rmd':'#7040c0','facility-to-frame':'#2563b0','frame-fix-shipping':'#c08520'};
  const moveListHTML = filtered.map((m,i)=>{
    const col = MVCOLS[m.typeKey]||'var(--accent)';
    const cage = getCage(m.cageId);
    // Resolve frame: use stored frameId, or find from cage location / pending moves
    let frame = getFrame(m.frameId);
    if (!frame && cage && (m.typeKey === 'frame-to-rmd' || m.typeKey === 'rmd-to-frame')) {
      if (cage.location === 'frame') {
        frame = STATE.frames.find(f => f.cages.includes(m.cageId)) || null;
      }
      if (!frame) {
        const pending = STATE.plannedMovements.find(
          pm => !pm.completed && pm.cageId === m.cageId && pm.typeKey === 'facility-to-frame' && pm.frameId
        );
        if (pending) frame = getFrame(pending.frameId);
      }
    }
    const resolvedRmdSlot = resolveRmdSlot(m);
    const dir = m.typeKey==='rmd-to-frame' ? `RMD-${resolvedRmdSlot||'?'} ‚Üí ${frame?frame.name:'?'}`
              : m.typeKey==='frame-to-rmd' ? `${frame?frame.name:'?'} ‚Üí RMD-${resolvedRmdSlot||'?'}`
              : m.typeKey==='facility-to-frame' ? `Facility ‚Üí ${frame?frame.name:'?'}`
              : m.typeKey==='frame-return-from-client' ? `üö¢ ${frame?frame.name:'?'} ‚Üí Facility`
              : m.description;
    return `<div style="display:flex;align-items:flex-start;gap:8px;padding:7px 0;border-bottom:1px solid var(--border-light)">
      <div style="width:22px;height:22px;border-radius:50%;background:${col};color:#fff;font:700 11px var(--font-mono);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px">${i+1}</div>
      <div style="flex:1;min-width:0">
        <div style="font:700 12px var(--font-mono);color:var(--text-primary)">${cage?esc(cage.name):'?'}</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:1px">${dir}</div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);white-space:nowrap">${m.date?fmt(m.date):''}</div>
    </div>`;
  }).join('');

  // Store moves globally so the draw function can access them after DOM update
  // Resolve missing frameId for frame-to-rmd movements (older data may lack it)
  window._mvMovesData = filtered.map(m=>{
    let frameId = m.frameId || '';
    let rmdSlot = m.rmdSlot || '';
    if (!frameId && (m.typeKey === 'frame-to-rmd' || m.typeKey === 'rmd-to-frame')) {
      // Try to find the frame from the cage's current location
      const cage = getCage(m.cageId);
      if (cage && cage.location === 'frame') {
        const f = STATE.frames.find(fr => fr.cages.includes(m.cageId));
        if (f) frameId = f.id;
      }
      // Or from a pending facility-to-frame movement
      if (!frameId) {
        const pending = STATE.plannedMovements.find(
          pm => !pm.completed && pm.cageId === m.cageId && pm.typeKey === 'facility-to-frame' && pm.frameId
        );
        if (pending) frameId = pending.frameId;
      }
    }
    // Resolve missing rmdSlot for frame-to-rmd: use cage's current RMD location
    if (!rmdSlot && (m.typeKey === 'frame-to-rmd' || m.typeKey === 'rmd-to-frame')) {
      const cage = getCage(m.cageId);
      if (cage && cage.location === 'rmd' && cage.locationDetail) {
        rmdSlot = cage.locationDetail; // e.g. "7b" ‚Üí will be cleaned to "7"
      }
    }
    return {
      id:m.id, typeKey:m.typeKey, cageId:m.cageId,
      rmdSlot:rmdSlot, frameId:frameId,
      description:m.description, date:m.date,
    };
  });

  // Also inject virtual "frame-return-from-client" entries for frames that have a returnDate set
  // These appear as arrows in the map without needing a planned movement
  STATE.frames.forEach(f => {
    if ((f.location === 'client' || f.location === 'boat') && f.returnDate) {
      window._mvMovesData.push({
        id: 'ret-' + f.id, typeKey: 'frame-return-from-client', cageId: null,
        rmdSlot: '', frameId: f.id,
        description: f.name + ' ‚Üí Facility', date: f.returnDate, isReturnDate: true,
      });
    }
  });


  return `
    <h2 class="section-title" style="margin-bottom:4px">‚Üî Movements Map</h2>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:14px">Arrows show all planned, not-yet-actioned movements between RMD storage and frames.</div>

    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
      ${filterBtns}
      <button class="btn btn-secondary btn-sm" style="margin-left:auto" onclick="mvRedraw()">‚Ü∫ Redraw</button>
    </div>

    <div style="display:flex;gap:6px;align-items:center;margin-bottom:14px;flex-wrap:wrap">
      <span style="display:inline-flex;align-items:center;gap:5px;font:500 11px var(--font-display);color:var(--text-secondary)"><span style="width:24px;height:3px;background:#27a060;border-radius:2px;display:inline-block"></span>RMD ‚Üí Frame</span>
      <span style="display:inline-flex;align-items:center;gap:5px;font:500 11px var(--font-display);color:var(--text-secondary)"><span style="width:24px;height:3px;background:#7040c0;border-radius:2px;display:inline-block"></span>Frame ‚Üí RMD</span>
      <span style="display:inline-flex;align-items:center;gap:5px;font:500 11px var(--font-display);color:var(--text-secondary)"><span style="width:24px;height:3px;background:#2563b0;border-radius:2px;display:inline-block;border-top:3px dashed #2563b0"></span>Facility ‚Üí Frame</span>
      <span style="display:inline-flex;align-items:center;gap:5px;font:500 11px var(--font-display);color:var(--text-secondary)"><span style="width:24px;height:3px;background:#0e7490;border-radius:2px;display:inline-block;border-top:3px dashed #0e7490"></span>Boat ‚Üí Frame</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text-muted)">${filtered.length} movement${filtered.length!==1?'s':''}</span>
    </div>

    <div style="display:grid;grid-template-columns:1fr 260px;gap:16px;align-items:start">

      <!-- Canvas map -->
      <div style="position:relative">
        <div id="mv-content">

          <!-- RMD zone -->
          <div style="display:flex;gap:16px;align-items:flex-start">
            <div style="flex:1">
              <div style="font:700 11px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üóÑ RMD Storage</div>
              <div id="mv-rmd-zone">
                ${rmdRowsHTML}
              </div>
            </div>
            <div>
              <div style="font:700 11px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üè≠ Facility</div>
              <div id="mv-facility-box" style="background:var(--bg-card);border:${facilityMoves.length?'2px solid #2563b0;box-shadow:0 0 0 3px rgba(37,99,176,0.12);':'1px solid var(--border);'}border-radius:8px;padding:12px 16px;min-width:130px;">
                <div style="font:700 13px var(--font-mono);color:${facilityMoves.length?'#2563b0':'var(--text-muted)'};margin-bottom:8px">Facility</div>
                ${facilityMoves.length ? facilityMoves.map(m=>{
                  const c=getCage(m.cageId); if(!c) return '';
                  return `<div style="font-size:10px;padding:2px 5px;border-radius:4px;border:1px solid #93c5fd;background:#eff6ff;margin-bottom:2px;display:flex;align-items:center;gap:3px;">
                    <span style="color:#2563b0;font-weight:800">‚Üí</span>
                    <span style="font:600 10px var(--font-mono)">${esc(c.name)}</span>
                    <span style="color:var(--text-muted)">${c.height}m</span>
                  </div>`;
                }).join('') : '<div style="font-size:10px;color:var(--text-muted);font-style:italic">no movements</div>'}
              </div>
            </div>
            <div>
              <div style="font:700 11px var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üö¢ Boat / Client</div>
              <div id="mv-boat-box" style="background:var(--bg-card);border:${(boatMoves.length||STATE.frames.some(f=>(f.location==='client'||f.location==='boat')&&f.returnDate))?'2px solid #0e7490;box-shadow:0 0 0 3px rgba(14,116,144,0.12);':'1px solid var(--border);'}border-radius:8px;padding:12px 16px;min-width:145px;">
                <div style="font:700 13px var(--font-mono);color:#0e7490;margin-bottom:8px">Boat / Client</div>
                ${boatMoves.length ? boatMoves.map(m=>{
                  const fr=getFrame(m.frameId); if(!fr) return '';
                  return `<div style="font-size:10px;padding:2px 5px;border-radius:4px;border:1px solid #a5f3fc;background:#ecfeff;margin-bottom:2px;display:flex;align-items:center;gap:3px;">
                    <span style="color:#0e7490;font-weight:800">‚Üí</span>
                    <span style="font:600 10px var(--font-mono)">${esc(fr.name)}</span>
                    <span style="color:var(--text-muted)">${fr.width}m</span>
                  </div>`;
                }).join('') : ''}
                ${STATE.frames.filter(f=>(f.location==='client'||f.location==='boat')).map(f=>{
                  const daysLeft = f.returnDate ? Math.ceil((new Date(f.returnDate+'T12:00:00') - new Date()) / 86400000) : null;
                  const retCol = daysLeft === null ? '#8895a7' : daysLeft < 0 ? 'var(--red)' : daysLeft <= 7 ? 'var(--orange)' : '#0e7490';
                  const retStr = f.returnDate ? fmt(f.returnDate) + (daysLeft !== null ? ` (${daysLeft < 0 ? Math.abs(daysLeft)+'d OVR' : daysLeft+'d'})` : '') : 'no return date';
                  return `<div id="mvboat-${f.id}" style="font-size:10px;padding:3px 6px;border-radius:4px;border:1px solid ${f.returnDate?'#a5f3fc':'var(--border)'};background:${f.returnDate?'#ecfeff':'var(--bg-elevated)'};margin-bottom:3px;">
                    <div style="font:700 10px var(--font-mono);color:${f.returnDate?'#0e7490':'var(--text-primary)'}">${esc(f.name)} <span style="font-weight:400;font-size:9px;color:var(--text-muted)">${f.location}</span></div>
                    ${f.returnDate ? `<div style="font-size:9px;color:${retCol};font-family:var(--font-mono)">‚Ü© ${retStr}</div>` : '<div style="font-size:9px;color:var(--text-muted);font-style:italic">set return date in Frames tab</div>'}
                  </div>`;
                }).join('')}
                ${!boatMoves.length && !STATE.frames.some(f=>f.location==='client'||f.location==='boat') ? '<div style="font-size:10px;color:var(--text-muted);font-style:italic">no frames away</div>' : ''}
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div style="border-top:2px dashed var(--border);margin:20px 0 16px;position:relative">
            <span style="position:absolute;top:-9px;left:50%;transform:translateX(-50%);background:var(--bg-deep);padding:0 12px;font:600 10px var(--font-mono);color:var(--text-muted);letter-spacing:.06em">FRAMES AT FACILITY</span>
          </div>

          <!-- Frames zone -->
          <div id="mv-frame-zone" style="display:flex;gap:6px;flex-wrap:wrap;">
            ${framesHTML}
          </div>
        </div>

        <!-- SVG overlay: absolutely positioned within mv-content for reliable arrow drawing -->
        <svg id="mv-svg-arrows" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;overflow:visible"></svg>
      </div>

      <!-- Sidebar -->
      <div>
        <div class="card" style="position:sticky;top:20px;max-height:calc(100vh - 120px);overflow-y:auto">
          <div class="card-title" style="margin-bottom:10px">Planned Movements</div>
          ${moveListHTML||'<div class="empty-msg">No movements match filter</div>'}
        </div>
      </div>
    </div>
  `;
  // Note: mvRedraw is now called by renderMain() after DOM update
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOVEMENTS SVG DRAW ‚Äî uses absolute-positioned SVG within mv-content container
// Positions calculated relative to the container, not the viewport
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mvRedraw() {
  const svg = document.getElementById('mv-svg-arrows');
  const container = document.getElementById('mv-content');
  if (!svg || !container) return;

  svg.innerHTML = '';
  const MOVES = window._mvMovesData || [];
  if (!MOVES.length) return;

  const COLORS = {
    'rmd-to-frame':        '#27a060',
    'frame-to-rmd':        '#7040c0',
    'facility-to-frame':   '#2563b0',
    'frame-fix-shipping':  '#c08520',
    'frame-return-from-client': '#0e7490',
  };

  const cRect = container.getBoundingClientRect();

  // Get element position relative to the mv-content container
  function getPos(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    const r = el.getBoundingClientRect();
    return {
      left:   r.left - cRect.left,
      right:  r.right - cRect.left,
      top:    r.top - cRect.top,
      bottom: r.bottom - cRect.top,
      cx:     (r.left + r.right) / 2 - cRect.left,
      cy:     (r.top + r.bottom) / 2 - cRect.top,
      w:      r.width,
      h:      r.height
    };
  }

  // SVG namespace
  const NS = 'http://www.w3.org/2000/svg';
  function svgEl(tag, attrs) {
    const el = document.createElementNS(NS, tag);
    for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
    return el;
  }

  // Define arrow markers per color
  const defs = svgEl('defs', {});
  Object.entries(COLORS).forEach(([key, col]) => {
    const marker = svgEl('marker', {
      id: 'arrow-' + key, markerWidth: '10', markerHeight: '8',
      refX: '9', refY: '4', orient: 'auto', markerUnits: 'userSpaceOnUse'
    });
    const poly = svgEl('polygon', { points: '0,0 10,4 0,8', fill: col });
    marker.appendChild(poly);
    defs.appendChild(marker);
  });
  svg.appendChild(defs);

  // Count per node for offset spreading
  const rET={}, fET={}, fXT={}, rNT={};
  MOVES.forEach(m => {
    const rk = String(m.rmdSlot||'').replace(/[ABab]$/,'');
    const fk = String(m.frameId||'');
    if (m.typeKey === 'rmd-to-frame') { rET[rk]=(rET[rk]||0)+1; fET[fk]=(fET[fk]||0)+1; }
    if (m.typeKey === 'frame-to-rmd') { fXT[fk]=(fXT[fk]||0)+1; rNT[rk]=(rNT[rk]||0)+1; }
  });
  const rEI={}, fEI={}, fXI={}, rNI={};

  MOVES.forEach((m, idx) => {
    const color = COLORS[m.typeKey] || '#c08520';
    const cage = getCage(m.cageId);
    const cLabel = cage ? cage.name : '';
    const num = idx + 1;

    if (m.typeKey === 'rmd-to-frame' || m.typeKey === 'frame-to-rmd') {
      const rk = String(m.rmdSlot||'').replace(/[ABab]$/,'');
      const fk = String(m.frameId||'');
      const rPos = getPos('mvr-' + rk);
      const fPos = getPos('mvf-' + fk);
      if (!rPos || !fPos) {
        console.warn('[mvRedraw] missing element:', !rPos ? 'mvr-'+rk : '', !fPos ? 'mvf-'+fk : '', 'rmdSlot='+m.rmdSlot, 'frameId='+m.frameId);
        return;
      }

      let ri, fi, rTot, fTot;
      if (m.typeKey === 'rmd-to-frame') {
        ri=(rEI[rk]=(rEI[rk]||0)); rEI[rk]++;
        fi=(fEI[fk]=(fEI[fk]||0)); fEI[fk]++;
        rTot=rET[rk]||1; fTot=fET[fk]||1;
      } else {
        ri=(rNI[rk]=(rNI[rk]||0)); rNI[rk]++;
        fi=(fXI[fk]=(fXI[fk]||0)); fXI[fk]++;
        rTot=rNT[rk]||1; fTot=fXT[fk]||1;
      }

      const rX = rPos.left + rPos.w * (rTot > 1 ? (0.2 + 0.6 * ri / (rTot - 1)) : 0.5);
      const fX = fPos.left + fPos.w * (fTot > 1 ? (0.2 + 0.6 * fi / (fTot - 1)) : 0.5);

      // RMD is above, Frames below. Always draw: start ‚Üí end with arrowhead at end
      let sx, sy, ex, ey;
      if (m.typeKey === 'rmd-to-frame') {
        // FROM RMD (bottom edge) TO Frame (top edge)
        sx = rX; sy = rPos.bottom;
        ex = fX; ey = fPos.top;
      } else {
        // FROM Frame (top edge) TO RMD (bottom edge)
        sx = fX; sy = fPos.top;
        ex = rX; ey = rPos.bottom;
      }

      // Bezier control points ‚Äî always curve through the gap between RMD and frames
      const gap = Math.abs(ey - sy);
      const cpOff = Math.max(gap * 0.35, 40);
      let c1x, c1y, c2x, c2y;
      if (m.typeKey === 'rmd-to-frame') {
        c1x = sx; c1y = sy + cpOff;
        c2x = ex; c2y = ey - cpOff;
      } else {
        c1x = sx; c1y = sy - cpOff;
        c2x = ex; c2y = ey + cpOff;
      }

      // Draw the bezier path
      const path = svgEl('path', {
        d: `M${sx},${sy} C${c1x},${c1y} ${c2x},${c2y} ${ex},${ey}`,
        stroke: color, 'stroke-width': '2.5', fill: 'none',
        'stroke-linecap': 'round',
        'marker-end': `url(#arrow-${m.typeKey})`
      });
      svg.appendChild(path);

      // Midpoint label (numbered circle)
      const mt = 0.5;
      const bx = (1-mt)*(1-mt)*(1-mt)*sx + 3*(1-mt)*(1-mt)*mt*c1x + 3*(1-mt)*mt*mt*c2x + mt*mt*mt*ex;
      const by = (1-mt)*(1-mt)*(1-mt)*sy + 3*(1-mt)*(1-mt)*mt*c1y + 3*(1-mt)*mt*mt*c2y + mt*mt*mt*ey;

      const circle = svgEl('circle', { cx: bx, cy: by, r: '12', fill: color, stroke: '#fff', 'stroke-width': '2' });
      svg.appendChild(circle);
      const numText = svgEl('text', {
        x: bx, y: by, fill: '#fff', 'font-size': '11', 'font-weight': 'bold',
        'font-family': 'monospace', 'text-anchor': 'middle', 'dominant-baseline': 'central'
      });
      numText.textContent = String(num);
      svg.appendChild(numText);

      if (cLabel) {
        const labelBg = svgEl('text', {
          x: bx, y: by + 18, fill: '#fff', 'font-size': '10', 'font-weight': 'bold',
          'font-family': 'monospace', 'text-anchor': 'middle', 'dominant-baseline': 'hanging',
          stroke: '#fff', 'stroke-width': '3', 'paint-order': 'stroke'
        });
        labelBg.textContent = cLabel;
        svg.appendChild(labelBg);
        const labelTxt = svgEl('text', {
          x: bx, y: by + 18, fill: color, 'font-size': '10', 'font-weight': 'bold',
          'font-family': 'monospace', 'text-anchor': 'middle', 'dominant-baseline': 'hanging'
        });
        labelTxt.textContent = cLabel;
        svg.appendChild(labelTxt);
      }

    } else if (m.typeKey === 'frame-return-from-client') {
      // For isReturnDate frames: draw a dashed arrow from the individual frame's card in the boat box
      // pointing downward toward the facility frames zone (using mv-facility-box as anchor)
      const fk = String(m.frameId||'');
      const boatFramePos = getPos('mvboat-' + fk);
      const boatPos = getPos('mv-boat-box');
      const facilityPos = getPos('mv-facility-box');

      if (m.isReturnDate) {
        // Draw a short dashed arrow below/from the individual frame card inside the boat box
        const refPos = boatFramePos || boatPos;
        if (!refPos) return;
        const x = refPos.cx;
        const y1 = refPos.bottom + 4;
        const y2 = y1 + 36;
        const line = svgEl('line', { x1:x, y1:y1, x2:x, y2:y2-5, stroke:'#0e7490', 'stroke-width':'2.5', 'stroke-dasharray':'6,4', 'stroke-linecap':'round' });
        svg.appendChild(line);
        const tri = svgEl('polygon', { points:`${x},${y2+1} ${x-7},${y2-11} ${x+7},${y2-11}`, fill:'#0e7490' });
        svg.appendChild(tri);
        // Date label
        if (m.date) {
          const fr = getFrame(m.frameId);
          const lbl = (fr ? fr.name : '') + ' ‚Ü© ' + fmt(m.date);
          const t1 = svgEl('text',{x:x,y:y1-2,fill:'#fff','font-size':'8','font-weight':'bold','font-family':'monospace','text-anchor':'middle',stroke:'#fff','stroke-width':'3','paint-order':'stroke'}); t1.textContent=lbl; svg.appendChild(t1);
          const t2 = svgEl('text',{x:x,y:y1-2,fill:'#0e7490','font-size':'8','font-weight':'bold','font-family':'monospace','text-anchor':'middle'}); t2.textContent=lbl; svg.appendChild(t2);
        }
        return;
      }

      // Arrow from Boat box ‚Üí Frame card (planned frame-return-from-client movement)
      const fPos = getPos('mvf-' + fk);
      if (!boatPos || !fPos) return;
      const sx = boatPos.cx;
      const sy = boatPos.bottom;
      const ex = fPos.cx;
      const ey = fPos.top;
      const gap = Math.abs(ey - sy);
      const cpOff = Math.max(gap * 0.35, 40);
      // Add marker for this colour if not already added
      if (!document.getElementById('arrow-frame-return-from-client')) {
        const mk = svgEl('marker', { id:'arrow-frame-return-from-client', markerWidth:'10', markerHeight:'8', refX:'9', refY:'4', orient:'auto', markerUnits:'userSpaceOnUse' });
        mk.appendChild(svgEl('polygon', { points:'0,0 10,4 0,8', fill:'#0e7490' }));
        svg.querySelector('defs').appendChild(mk);
      }
      const bPath = svgEl('path', {
        d: `M${sx},${sy} C${sx},${sy+cpOff} ${ex},${ey-cpOff} ${ex},${ey}`,
        stroke: '#0e7490', 'stroke-width': '2.5', fill: 'none',
        'stroke-linecap': 'round', 'stroke-dasharray': '7,4',
        'marker-end': 'url(#arrow-frame-return-from-client)'
      });
      svg.appendChild(bPath);
      // Label at midpoint
      const mt2=0.5;
      const lbx=(1-mt2)**3*sx+3*(1-mt2)**2*mt2*sx+3*(1-mt2)*mt2**2*ex+mt2**3*ex;
      const lby=(1-mt2)**3*sy+3*(1-mt2)**2*mt2*(sy+cpOff)+3*(1-mt2)*mt2**2*(ey-cpOff)+mt2**3*ey;
      if (cLabel) {
        const fr = getFrame(m.frameId);
        const lbl = fr ? fr.name : cLabel;
        const lb1 = svgEl('text',{x:lbx+14,y:lby,fill:'#fff','font-size':'9','font-weight':'bold','font-family':'monospace','text-anchor':'middle',stroke:'#fff','stroke-width':'3','paint-order':'stroke'}); lb1.textContent=lbl; svg.appendChild(lb1);
        const lb2 = svgEl('text',{x:lbx+14,y:lby,fill:'#0e7490','font-size':'9','font-weight':'bold','font-family':'monospace','text-anchor':'middle'}); lb2.textContent=lbl; svg.appendChild(lb2);
      }

    } else if (m.typeKey === 'facility-to-frame' || m.typeKey === 'frame-fix-shipping') {
      if (m.typeKey === 'facility-to-frame') {
        // Draw bezier from Facility box to Frame card (similar to rmd-to-frame)
        const facPos = getPos('mv-facility-box');
        const fk = String(m.frameId||'');
        const fPos = getPos('mvf-' + fk);
        if (!facPos || !fPos) {
          // Fallback: draw dashed vertical line above the frame
          const fallbackFPos = fPos || getPos('mvf-' + fk);
          if (!fallbackFPos) return;
          const x = fallbackFPos.cx;
          const y2 = fallbackFPos.top;
          const y1 = y2 - 48;
          const line = svgEl('line', { x1: x, y1: y1, x2: x, y2: y2 - 5, stroke: color, 'stroke-width': '2.5', 'stroke-dasharray': '7,4', 'stroke-linecap': 'round' });
          svg.appendChild(line);
          const tri = svgEl('polygon', { points: `${x},${y2+1} ${x-7},${y2-11} ${x+7},${y2-11}`, fill: color });
          svg.appendChild(tri);
          return;
        }

        // FROM Facility box (bottom edge) TO Frame (top edge) ‚Äî bezier curve
        const sx = facPos.cx;
        const sy = facPos.bottom;
        const ex = fPos.cx;
        const ey = fPos.top;
        const gap = Math.abs(ey - sy);
        const cpOff = Math.max(gap * 0.35, 40);

        const path = svgEl('path', {
          d: `M${sx},${sy} C${sx},${sy+cpOff} ${ex},${ey-cpOff} ${ex},${ey}`,
          stroke: color, 'stroke-width': '2.5', fill: 'none',
          'stroke-linecap': 'round', 'stroke-dasharray': '7,4',
          'marker-end': `url(#arrow-facility-to-frame)`
        });
        svg.appendChild(path);

        // Midpoint label
        const mt = 0.5;
        const bx = (1-mt)*(1-mt)*(1-mt)*sx + 3*(1-mt)*(1-mt)*mt*sx + 3*(1-mt)*mt*mt*ex + mt*mt*mt*ex;
        const by = (1-mt)*(1-mt)*(1-mt)*sy + 3*(1-mt)*(1-mt)*mt*(sy+cpOff) + 3*(1-mt)*mt*mt*(ey-cpOff) + mt*mt*mt*ey;
        if (cLabel) {
          const lblBg = svgEl('text', { x: bx+14, y: by, fill: '#fff', 'font-size': '9', 'font-weight': 'bold', 'font-family': 'monospace', 'text-anchor': 'middle', stroke: '#fff', 'stroke-width': '3', 'paint-order': 'stroke' });
          lblBg.textContent = cLabel;
          svg.appendChild(lblBg);
          const lblTxt = svgEl('text', { x: bx+14, y: by, fill: color, 'font-size': '9', 'font-weight': 'bold', 'font-family': 'monospace', 'text-anchor': 'middle' });
          lblTxt.textContent = cLabel;
          svg.appendChild(lblTxt);
        }
      } else {
        // frame-fix-shipping: keep original dashed vertical line
        const fPos = getPos('mvf-' + String(m.frameId||''));
        if (!fPos) return;
        const x = fPos.cx;
        const y2 = fPos.top;
        const y1 = y2 - 48;

        // Dashed line
        const line = svgEl('line', {
          x1: x, y1: y1, x2: x, y2: y2 - 5,
          stroke: color, 'stroke-width': '2.5', 'stroke-dasharray': '7,4', 'stroke-linecap': 'round'
        });
        svg.appendChild(line);

        // Arrowhead triangle
        const tri = svgEl('polygon', {
          points: `${x},${y2+1} ${x-7},${y2-11} ${x+7},${y2-11}`, fill: color
        });
        svg.appendChild(tri);

        // Label
        const lbl = cLabel || 'FIX';
        const lblBg = svgEl('text', {
          x: x, y: y1 - 3, fill: '#fff', 'font-size': '9', 'font-weight': 'bold',
          'font-family': 'monospace', 'text-anchor': 'middle', 'dominant-baseline': 'auto',
          stroke: '#fff', 'stroke-width': '3', 'paint-order': 'stroke'
        });
        lblBg.textContent = lbl;
        svg.appendChild(lblBg);
        const lblTxt = svgEl('text', {
          x: x, y: y1 - 3, fill: color, 'font-size': '9', 'font-weight': 'bold',
          'font-family': 'monospace', 'text-anchor': 'middle', 'dominant-baseline': 'auto'
        });
        lblTxt.textContent = lbl;
        svg.appendChild(lblTxt);
      }
    }
  });
}


// Global resize handler ‚Äî redraw arrows on resize
window.addEventListener('resize', function() {
  if (typeof activeTab !== 'undefined' && activeTab === 'movements') {
    clearTimeout(window._mvResizeT);
    window._mvResizeT = setTimeout(mvRedraw, 120);
  }
});

function updateUKClock() {
  const now = new Date();
  const opts = { timeZone: 'Europe/London', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
  const dateOpts = { timeZone: 'Europe/London', weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
  const tEl = document.getElementById('hdr-time');
  const dEl = document.getElementById('hdr-date');
  if (tEl) tEl.textContent = now.toLocaleTimeString('en-GB', opts);
  if (dEl) dEl.textContent = now.toLocaleDateString('en-GB', dateOpts).toUpperCase();
}
setInterval(updateUKClock, 1000);
document.addEventListener("DOMContentLoaded", () => updateUKClock());

document.addEventListener("DOMContentLoaded", async function() {
  try {
    await loadState();
  } catch(e) {
    console.error('loadState failed:', e);
  }
  try {
    render();
  } catch(e) {
    console.error('render failed:', e);
    // Force replace main content with error so user isn't stuck on Loading...
    const main = document.getElementById('main-content');
    if (main) main.innerHTML = `<div style="padding:40px;color:#c93030;font-size:14px">
      <strong>Error rendering page:</strong> ${e.message}<br><br>
      <button onclick="location.reload()" style="padding:8px 16px;background:#e8a830;border:none;border-radius:6px;cursor:pointer;font-weight:600">Reload</button>
    </div>`;
  }
});

</script>
</head>
<body>

<header class="header">
  <div class="header-logo">CT</div>
  <div>
    <div class="header-title">Cage Tracker</div>
    <div class="header-sub">FACILITY MANAGEMENT SYSTEM</div>
  </div>
  <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end">
    <div id="hdr-time" style="font:700 15px var(--font-mono);color:#e8a830;letter-spacing:0.05em"></div>
    <div id="hdr-date" style="font:500 10px var(--font-mono);color:#8899aa;letter-spacing:0.06em"></div>
  </div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <button class="sidebar-btn active" onclick="switchTab(&#39;dashboard&#39;)">
      <span class="sidebar-icon">‚óâ</span><span>Dashboard</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;cages&#39;)">
      <span class="sidebar-icon">‚òê</span><span>Cages</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;frames&#39;)">
      <span class="sidebar-icon">‚äû</span><span>Frames</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;rmd&#39;)">
      <span class="sidebar-icon">‚ñ¶</span><span>RMD Storage</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;planner&#39;)">
      <span class="sidebar-icon">‚áÑ</span><span>Planner</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;boatplan&#39;)">
      <span class="sidebar-icon">üö¢</span><span>Boat Planner</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;shipping&#39;)">
      <span class="sidebar-icon">‚õ¥</span><span>Shipping</span>
    </button>
  
    <button class="sidebar-btn " onclick="switchTab(&#39;report&#39;)">
      <span class="sidebar-icon">‚éô</span><span>Report</span>
    </button>
  </nav>
  <main class="main" id="main-content">
    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#8895a7;font-size:14px">Loading...</div>
  </main>
<input type="file" id="excel-import" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcelImport(this)">


</body></html>
